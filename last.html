<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Solution ERP</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Firebase SDK import and initialization -->
<!-- Use module script to import Firebase and expose DB functions globally -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, push, child } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBN8R-f1bt7X9_gmIPEgZIIG6vxJHV4KHU",
      authDomain: "syst-87c33.firebaseapp.com",
      databaseURL: "https://syst-87c33-default-rtdb.firebaseio.com",
      projectId: "syst-87c33",
      storageBucket: "syst-87c33.firebasestorage.app",
      messagingSenderId: "165758129937",
      appId: "1:165758129937:web:5629b00814f905d0d09eb0"
    };

    // Initialize Firebase
    const firebaseApp = initializeApp(firebaseConfig);
    const db = getDatabase(firebaseApp);

    // Expose Firebase database utilities globally so that they can be used
    // in non-module scripts below. Without attaching to the window object,
    // Firebase helpers would be scoped to this module only.
    window.firebaseDB = db;
    window.firebaseRef = ref;
    window.firebaseGet = get;
    window.firebaseSet = set;
    window.firebaseUpdate = update;
    window.firebasePush = push;
    window.firebaseChild = child;
  </script>
<style>
    body {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .rtl { direction: rtl; }
    .print-area { display: none; }
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area { position: absolute; top: 0; left: 0; width: 100%; }
    }
    .loading { opacity: 0.6; pointer-events: none; }
    .scanner-input { 
      border: 2px dashed #3b82f6; 
      background: #eff6ff;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    .search-dropdown {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      background: white;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 50;
    }
    .search-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.2s;
    }
    .search-item:hover {
      background-color: #f9fafb;
    }
    .search-item:last-child {
      border-bottom: none;
    }
    
    /* Mobile optimizations */
    @media (max-width: 640px) {
      .container {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      
      /* Improve touch targets */
      button, input, select {
        min-height: 44px;
      }
      
      /* Better spacing for mobile */
      .space-y-3 > * + * {
        margin-top: 0.75rem;
      }
      
      /* Responsive text */
      .text-responsive {
        font-size: 0.875rem;
      }
      
      /* Mobile table improvements */
      table {
        font-size: 0.75rem;
      }
      
      /* Modal improvements for mobile */
      .fixed.inset-0 {
        padding: 1rem;
      }
    }
    
    /* Tablet optimizations */
    @media (min-width: 641px) and (max-width: 1024px) {
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
    }
    
    /* Ensure proper touch targets */
    @media (hover: none) and (pointer: coarse) {
      button, .nav-btn {
        min-height: 48px;
        padding: 12px 16px;
      }
    }
  
    /* Hide the loading overlay globally. This ensures the loading overlay never shows up. */
    #loading-overlay {
      display: none !important;
    }
</style>
<style>@view-transition { navigation: auto; }</style>
</head>
<body class="bg-gray-50 min-h-full">
<!-- Login Screen -->
<div class="min-h-full flex items-center justify-center bg-gradient-to-br from-blue-600 to-blue-800" id="login-screen">
<div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
<div class="text-center mb-8">
<div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
<span class="text-3xl">๐</span>
</div>
<h1 class="text-3xl font-bold text-gray-800 mb-2">Solution ERP</h1>
<p class="text-gray-600">ูุธุงู ุฅุฏุงุฑุฉ ุงูุฃุนูุงู ุงููุชูุงูู</p>
<!-- Date and Time Display -->
<div class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border">
<div class="text-sm text-gray-700 mb-1">
<span class="font-medium" id="login-current-date"></span>
</div>
<div class="text-lg font-bold text-blue-600" id="login-current-time"></div>
<div class="text-xs text-gray-500 mt-1" id="login-day-name"></div>
</div>
</div>
<form class="space-y-6" id="login-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" for="username"> ๐ค ุงุณู ุงููุณุชุฎุฏู </label>
<input class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" id="username" name="username" placeholder="ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" for="password"> ๐ ูููุฉ ุงููุฑูุฑ </label>
<input class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" id="password" name="password" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ" required="" type="password"/>
</div>
<div class="flex items-center justify-between">
<label class="flex items-center">
<input class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" type="checkbox"/>
<span class="mr-2 text-sm text-gray-600">ุชุฐูุฑูู</span>
</label>
<a class="text-sm text-blue-600 hover:text-blue-800" href="#">ูุณูุช ูููุฉ ุงููุฑูุฑุ</a>
</div>
<button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-colors transform hover:scale-105" type="submit"> ๐ ุชุณุฌูู ุงูุฏุฎูู </button>
</form>
<div class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center" id="login-error">
      ุงุณู ุงููุณุชุฎุฏู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ
    </div>
</div>
</div>
<!-- Main System (Hidden initially) -->
<div class="hidden" id="main-system">
<header class="bg-blue-600 text-white p-4 shadow-lg">
<div class="container mx-auto">
<div class="flex justify-between items-center mb-3">
<h1 class="text-2xl font-bold" id="system-title">Solution ERP</h1>
<div class="flex items-center gap-4">
<div class="text-lg" id="company-name">
            ูุธุงู ุฅุฏุงุฑุฉ ุงูุฃุนูุงู ุงููุชูุงูู
          </div>
<div class="flex items-center gap-2">
<span class="text-sm bg-blue-500 px-3 py-1 rounded-full" id="current-user"></span>
<!-- Synchronize button: saves local data to Firebase without fetching from the cloud -->
<button class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded-lg text-sm transition-colors" id="manual-save-btn" onclick="manualSave()"> ๐ ุญูุธ </button>
<button class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded-lg text-sm transition-colors" onclick="logout()"> ๐ช ุฎุฑูุฌ </button>
</div>
</div>
</div>
<!-- Date and Time Display for Main System -->
<div class="flex justify-between items-center text-sm bg-blue-500 bg-opacity-30 rounded-lg px-4 py-2">
<div class="flex items-center gap-4">
<div class="flex items-center gap-2">
<span class="text-blue-200">๐</span>
<span class="font-medium" id="main-current-date"></span>
</div>
<div class="flex items-center gap-2">
<span class="text-blue-200">๐</span>
<span class="font-bold" id="main-current-time"></span>
</div>
</div>
<div class="flex items-center gap-2">
<span class="text-blue-200">๐</span>
<span class="font-medium" id="main-day-name"></span>
</div>
</div>
</div>
</header>
<nav class="bg-white shadow-md border-b">
<div class="container mx-auto">
<div class="flex flex-wrap justify-center gap-2 p-4">
<button class="nav-btn bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('sales')"> ๐ฐ ูุงุชูุฑุฉ ุงูุจูุน </button>
<button class="nav-btn bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('purchases')"> ๐ ุงููุดุชุฑูุงุช </button>
<button class="nav-btn bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('inventory')"> ๐ฆ ุงููุฎุฒูู </button>
<button class="nav-btn bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('employees')"> ๐ฅ ุงูููุธููู </button>
<button class="nav-btn bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('invoices')"> ๐ ุงูููุงุชูุฑ </button>
<button class="nav-btn bg-rose-600 hover:bg-rose-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('customers')"> ๐ค ุงูุนููุงุก </button>
<button class="nav-btn bg-slate-600 hover:bg-slate-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('accounts')"> ๐ ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช </button>
<button class="nav-btn bg-amber-600 hover:bg-amber-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('discounts')"> ๐ธ ุงูุฎุตููุงุช </button>
<button class="nav-btn bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('accounting')"> ๐ ุงููุญุงุณุจุฉ </button>
<!-- ุฒุฑ ูุณู ุงููุฑุชุฌุนุงุช -->
<button class="nav-btn bg-lime-600 hover:bg-lime-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('returns')"> ๐ ุงููุฑุชุฌุนุงุช </button>

<!-- ุฒุฑ ูุณู ูุจูุนุงุช ุงููุณุชุฎุฏู -->
<button class="nav-btn bg-pink-600 hover:bg-pink-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('user-sales')"> ๐ค๐ผ ูุจูุนุงุช ุงููุณุชุฎุฏู </button>

<!-- ุฒุฑ ูุณู ุงูุฅุนุฏุงุฏุงุช -->
<button class="nav-btn bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors" onclick="showSection('settings')"> โ๏ธ ุงูุฅุนุฏุงุฏุงุช </button>
</div>
</div>
</nav>
<main class="container mx-auto p-4">
<!-- Sales Section -->
<section class="section" id="sales-section">
<div class="bg-white rounded-lg shadow-lg p-6">
<!-- ุฑุฃุณ ุตูุญุฉ ูุงุชูุฑุฉ ุงูุจูุน ูุชุถูู ุนููุงู ุงููุณู ูุฑูู ุงููุงุชูุฑุฉ ุงูุนุดูุงุฆู.
        ูุณุชุฎุฏู flex ููููุงุกูุฉ ุจูู ุงูุนููุงู ูุงูุฑูู ุจุญูุซ ูุธูุฑ ุงูุฑูู ูู ุงูุฌูุฉ
        ุงููุณุฑู ุจุฎุท ุฃุตุบุฑ ุฏุงุฎู ุฅุทุงุฑ ุดูุงู. -->
<div class="flex items-center justify-between mb-6">
<h2 class="text-2xl font-bold text-gray-800 flex items-center">๐ฐ ูุงุชูุฑุฉ ุงูุจูุน</h2>
<span class="inline-block px-2 py-1 text-xs text-blue-600 border border-blue-300 rounded bg-blue-50 bg-opacity-20" data-temp-number="" id="temp-invoice-number-display"></span>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<!-- Product Search -->
<div class="space-y-4">
<!-- ุฑูู ุงููุงุชูุฑุฉ ูุชู ุนุฑุถู ุจุฌุงูุจ ุนููุงู "ูุงุชูุฑุฉ ุงูุจูุน" ูู ุงูุฃุนููุ ูุฐุง ูุง ููุฑุฑ ุนุฑุถู ููุง. -->
<div class="bg-emerald-50 p-4 rounded-lg relative">
<label class="block text-sm font-medium text-gray-700 mb-2"> ๐ ุงูุจุญุซ ุนู ุงูููุชุฌ (ููุฏ ุฃู ุงุณู) </label>
<input autocomplete="off" class="scanner-input w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" id="product-search" placeholder="ุงูุณุญ ุงูููุฏ ุฃู ุงูุชุจ ุงุณู ุงูููุชุฌ..." type="text"/>
<!-- Search Options -->
<div class="mt-3 flex items-center space-x-4">
<label class="flex items-center space-x-2">
<input class="rounded border-gray-300 text-red-600 focus:ring-red-500" id="search-out-of-stock" type="checkbox"/>
<span class="text-sm text-red-600 font-medium">๐ซ ุงูุจุญุซ ูู ุงูุฃุตูุงู ุงููุงูุฏุฉ ููุท</span>
</label>
</div>
<!-- Search Results Dropdown -->
<div class="absolute top-full left-0 right-0 search-dropdown hidden mt-1" id="search-results">
<!-- Results will be populated here -->
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงูุณุนุฑ</label>
<input class="w-full p-2 border rounded-lg bg-gray-100" id="product-price" readonly="" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงููููุฉ</label>
<input class="w-full p-2 border rounded-lg" id="product-quantity" min="1" type="number" value="1"/>
</div>
</div>
<div class="grid grid-cols-2 gap-4 mt-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงูุฎุตู (ุฌ.ู)</label>
<div class="relative">
<input class="w-full p-2 border rounded-lg bg-gray-100" id="product-discount" placeholder="0.00" readonly="" step="0.01" type="number"/>
<button class="absolute left-2 top-1/2 transform -translate-y-1/2 text-blue-600 hover:text-blue-800 text-sm" onclick="requestDiscountPassword()"> ๐ ุฅุถุงูุฉ ุฎุตู </button>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู</label>
<input class="w-full p-2 border rounded-lg bg-green-50 font-bold text-green-700" id="final-price" readonly="" step="0.01" type="number"/>
</div>
</div>
<div class="bg-gray-50 p-3 rounded-lg">
<div class="text-sm text-gray-600">
                ุงูููุชุฌ ุงููุญุฏุฏ:
              </div>
<div class="font-medium text-gray-800" id="selected-product">
                ูู ูุชู ุงุฎุชูุงุฑ ููุชุฌ
              </div>
<div class="text-sm text-blue-600" id="available-stock"></div>
</div>
<button class="w-full bg-gray-400 text-white py-3 rounded-lg font-medium transition-colors" disabled="" id="add-to-invoice-btn" onclick="addToInvoice()"> โ ุฅุถุงูุฉ ูููุงุชูุฑุฉ </button>
</div>
<!-- Invoice Summary -->
<div class="bg-gray-50 p-4 rounded-lg">
<h3 class="text-lg font-semibold mb-4">ููุฎุต ุงููุงุชูุฑุฉ</h3>
<div class="space-y-2">
<div class="flex justify-between">
<span>ุงูุฅุฌูุงูู:</span>
<span class="font-bold text-green-600" id="invoice-total">0.00 ุฌ.ู</span>
</div>
<div class="flex justify-between">
<span>ุงููุฏููุน:</span>
<input class="w-24 p-1 border rounded text-center" id="paid-amount" onchange="calculateRemaining()" step="0.01" type="number"/>
</div>
<div class="flex justify-between border-t pt-2">
<span>ุงููุชุจูู:</span>
<span class="font-bold text-red-600" id="remaining-amount">0.00 ุฌ.ู</span>
</div>
</div>
<!-- Customer name and code inputs for the sales invoice are wrapped in relative containers so that
     predictive dropdowns can be positioned correctly.  Each input now has a companion results div
     that will display suggestion items when the user types a name or code. -->
<div class="mt-4 relative">
<label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงูุนููู</label>
<input class="w-full p-2 border rounded-lg" id="customer-name" placeholder="ุฃุฏุฎู ุงุณู ุงูุนููู" required="" type="text"/>
<!-- Suggestions for the customer name (sales invoice) will be injected here -->
<div class="search-dropdown hidden absolute left-0 right-0 mt-1 z-50" id="invoice-customer-name-results"></div>
</div>
<div class="mt-3 relative">
<label class="block text-sm font-medium text-gray-700 mb-1">ููุฏ ุงูุนููู</label>
<input class="w-full p-2 border rounded-lg" id="customer-code" placeholder="ุงุฎุชูุงุฑู" type="text"/>
<!-- Suggestions for the customer code (sales invoice) will be injected here -->
<div class="search-dropdown hidden absolute left-0 right-0 mt-1 z-50" id="invoice-customer-code-results"></div>
</div>
<!-- Duplicate customer warning for the invoice section -->
<div class="text-red-600 text-sm mt-1 hidden" id="invoice-customer-duplicate-warning">โ๏ธ ูุฐุง ุงูุนููู ูุณุฌู ูุณุจูุงู</div>
<div class="flex gap-2 mt-4">
<!--
      The save button is intentionally given type="button" so that it does not trigger
      a form submission when clicked. Without this attribute the default type
      of <button> inside a form is "submit", which causes the browser to reload
      the page and wipes out in-memory state before the saveInvoiceNew() function
      has a chance to persist data into allData and Firebase. Adding type="button"
      preserves the current page state and allows the click handler to run
      normally, ensuring invoices are saved correctly.
    -->
<button class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-2 rounded-lg" id="save-invoice-btn" onclick="openPaymentModal()" type="button">
      ๐พ ุญูุธ ุงููุงุชูุฑุฉ
    </button>
<button class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg" onclick="printInvoice()"> ๐จ๏ธ ุทุจุงุนุฉ </button>
</div>
<!-- Debug Button -->
<div class="mt-2">
<button class="w-full bg-blue-500 hover:bg-blue-600 text-white py-1 rounded text-sm" onclick="debugSystem()"> ๐ง ุชุดุฎูุต ุงููุธุงู </button>
</div>
<!-- Suspend and Suspended Invoices Buttons -->
<div class="mt-2 flex gap-2">
<!-- ุชุนููู ุงููุงุชูุฑุฉ (F6) -->
<button class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg text-sm" onclick="suspendCurrentInvoice()" type="button">
        โธ๏ธ ุชุนููู ุงููุงุชูุฑุฉ F6
      </button>
<!-- ูุงุฆูุฉ ุงูููุงุชูุฑ ุงููุนููุฉ (F7) ูุน ุนุฏุงุฏ -->
<button class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm" id="suspended-invoices-btn" onclick="showSuspendedInvoicesList()" type="button">
        ๐ ููุงุชูุฑ ูุนููุฉ F7 (0)
      </button>
</div>
</div>
</div>
<!-- Invoice Items Table -->
<div class="mt-6">
<h3 class="text-lg font-semibold mb-4">ุนูุงุตุฑ ุงููุงุชูุฑุฉ</h3>
      <!-- ุญุฏ ุฃูุตู ูุนุฏุฏ ุงูุตููู ุงููุนุฑูุถุฉ ูุฏูุชุฑ ุงูุฃุณุชุงุฐ ุงูุนุงู ูุน ุดุฑูุท ุชูุฑูุฑ ุนููุฏู -->
      <div class="overflow-x-auto max-h-60 overflow-y-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงูููุฏ</th>
<th class="border border-gray-300 p-2">ุงุณู ุงูููุชุฌ</th>
<th class="border border-gray-300 p-2">ุงูุณุนุฑ ุงูุฃุตูู</th>
<th class="border border-gray-300 p-2">ุงูุฎุตู</th>
<th class="border border-gray-300 p-2">ุงูุณุนุฑ ุงูููุงุฆู</th>
<th class="border border-gray-300 p-2">ุงููููุฉ</th>
<th class="border border-gray-300 p-2">ุงูุฅุฌูุงูู</th>
<th class="border border-gray-300 p-2">ุฅุฌุฑุงุกุงุช</th>
</tr>
</thead>
<tbody id="invoice-items">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="8">ูุง ุชูุฌุฏ ุนูุงุตุฑ ูู ุงููุงุชูุฑุฉ</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<!-- Purchases Section -->
<section class="section hidden" id="purchases-section">
<div class="bg-white rounded-lg shadow-lg p-6">
<h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">๐ ุงููุดุชุฑูุงุช</h2>
<!-- Product Selection Mode -->
<div class="bg-blue-50 p-4 rounded-lg mb-6">
<h3 class="text-lg font-semibold mb-4 text-blue-800">ุงุฎุชูุงุฑ ุงูููุชุฌ</h3>
<div class="flex gap-4 mb-4">
<label class="flex items-center space-x-2 bg-white p-3 rounded border cursor-pointer">
<input class="rounded" id="existing-product-mode" name="product-mode" onchange="toggleProductMode('existing')" type="radio" value="existing"/>
<span class="text-sm font-medium">๐ฆ ููุชุฌ ููุฌูุฏ</span>
</label>
<label class="flex items-center space-x-2 bg-white p-3 rounded border cursor-pointer">
<input checked="" class="rounded" id="new-product-mode" name="product-mode" onchange="toggleProductMode('new')" type="radio" value="new"/>
<span class="text-sm font-medium">โจ ููุชุฌ ุฌุฏูุฏ</span>
</label>
</div>
<!-- Existing Product Selection -->
<div class="hidden" id="existing-product-selection">
<label class="block text-sm font-medium text-gray-700 mb-2">ุงุฎุชุฑ ุงูููุชุฌ ุงูููุฌูุฏ</label>
<select class="w-full p-3 border rounded-lg bg-white" id="existing-product-select" onchange="selectExistingProduct()">
<option value="">-- ุงุฎุชุฑ ููุชุฌ ูู ุงููุงุฆูุฉ --</option>
</select>
<div class="mt-2 text-sm text-gray-600">
<span id="existing-product-info"></span>
</div>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงูููุชุฌ</label>
<input class="w-full p-3 border rounded-lg" id="purchase-product-name" placeholder="ุงุณู ุงูููุชุฌ" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ููุฏ ุงูููุชุฌ</label>
<input class="w-full p-3 border rounded-lg" id="purchase-product-code" placeholder="ููุฏ ุงูููุชุฌ" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงูููุฑุฏ</label>
<input class="w-full p-3 border rounded-lg" id="purchase-supplier" placeholder="ุงุณู ุงูููุฑุฏ" type="text"/>
</div>
</div>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงููููุฉ</label>
<input class="w-full p-3 border rounded-lg" id="purchase-quantity" min="1" placeholder="ุงููููุฉ" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุณุนุฑ ุงูุดุฑุงุก</label>
<input class="w-full p-3 border rounded-lg" id="purchase-price" placeholder="ุณุนุฑ ุงูุดุฑุงุก" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุณุนุฑ ุงูุจูุน</label>
<input class="w-full p-3 border rounded-lg" id="purchase-sale-price" placeholder="ุณุนุฑ ุงูุจูุน" step="0.01" type="number"/>
</div>
</div>
</div>
<button class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-medium mb-6" onclick="addPurchase()"> โ ุฅุถุงูุฉ ูุดุชุฑูุงุช </button>
<div class="overflow-x-auto overflow-y-auto max-h-60">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-2">ููุฏ ุงูููุชุฌ</th>
<th class="border border-gray-300 p-2">ุงูููุชุฌ</th>
<th class="border border-gray-300 p-2">ุณุนุฑ ุงูุจูุน</th>
<th class="border border-gray-300 p-2">ุงูููุฑุฏ</th>
<th class="border border-gray-300 p-2">ุงููููุฉ</th>
<th class="border border-gray-300 p-2">ุณุนุฑ ุงูุดุฑุงุก</th>
<th class="border border-gray-300 p-2">ุงูุฅุฌูุงูู</th>
<th class="border border-gray-300 p-2">ุฅุฌุฑุงุกุงุช</th>
</tr>
</thead>
<tbody id="purchases-list">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="9">ูุง ุชูุฌุฏ ูุดุชุฑูุงุช ูุณุฌูุฉ</td>
</tr>
</tbody>
</table>
</div>
<!-- Button to delete all purchases -->
<button class="mt-4 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg" onclick="deleteAllPurchasesPopup()">๐๏ธ ุญุฐู ุฌููุน ุงููุดุชุฑูุงุช</button>
<!-- Container for per-customer invoice tables -->
<div class="mt-6" id="customer-invoices-section"></div>
</div>
</section>

<!-- User Sales Section -->
<section class="section hidden" id="user-sales-section">
  <div class="bg-white rounded-lg shadow-lg p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">๐ค๐ผ ูุจูุนุงุช ุงููุณุชุฎุฏู</h2>
    <!-- User selector -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-1">ุงุฎุชุฑ ุงููุณุชุฎุฏู</label>
      <select id="user-sales-selector" class="w-full p-3 border rounded-lg" onchange="updateUserSalesDisplay(this.value)">
        <!-- Options will be populated dynamically -->
      </select>
    </div>
    <!-- Summary metrics -->
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6" id="user-sales-summary">
      <div class="bg-green-50 p-4 rounded-lg border border-green-200">
        <div class="text-gray-600">ุฅุฌูุงูู ุงููุจูุนุงุช</div>
        <div id="user-sales-total-sales" class="font-bold text-lg text-green-600">0.00 ุฌ.ู</div>
      </div>
      <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
        <div class="text-gray-600">ุนุฏุฏ ุงูููุงุชูุฑ</div>
        <div id="user-sales-invoice-count" class="font-bold text-lg text-blue-600">0</div>
      </div>
      <div class="bg-red-50 p-4 rounded-lg border border-red-200">
        <div class="text-gray-600">ุนุฏุฏ ุงููุฑุชุฌุนุงุช</div>
        <div id="user-sales-returns-count" class="font-bold text-lg text-red-600">0</div>
      </div>
      <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
        <div class="text-gray-600">ุฅุฌูุงูู ุงูุฎุตููุงุช</div>
        <div id="user-sales-discounts-total" class="font-bold text-lg text-purple-600">0.00 ุฌ.ู</div>
      </div>
    </div>
    <!-- Invoices table -->
    <h3 class="text-xl font-semibold mb-2">ุงูููุงุชูุฑ</h3>
    <!-- Limit the visible portion of the invoices table to roughly five rows.  The
         maxโhโ48 class corresponds to a maximum height of 12rem (~192px) which
         accommodates the table header plus about five body rows before the
         scrollbar appears. -->
    <div class="overflow-x-auto max-h-48 overflow-y-auto mb-6">
      <table class="w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
          <tr>
            <th class="border border-gray-300 p-2">ุฑูู ุงููุงุชูุฑุฉ</th>
            <th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
            <th class="border border-gray-300 p-2">ุงูุนููู</th>
            <th class="border border-gray-300 p-2">ุงูุฅุฌูุงูู</th>
            <th class="border border-gray-300 p-2">ุงููุฏููุน</th>
            <th class="border border-gray-300 p-2">ุงููุชุจูู</th>
          </tr>
        </thead>
        <tbody id="user-sales-invoices-table">
          <tr><td colspan="6" class="text-center text-gray-500 p-4">ุงุฎุชุฑ ูุณุชุฎุฏู ูุนุฑุถ ุงูููุงุชูุฑ</td></tr>
        </tbody>
      </table>
    </div>
    <!-- Returns table -->
    <h3 class="text-xl font-semibold mb-2">ุงููุฑุชุฌุนุงุช</h3>
    <!-- Limit the visible portion of the returns table to roughly five rows.  See
         comment above for invoices table. -->
    <div class="overflow-x-auto max-h-48 overflow-y-auto mb-6">
      <table class="w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
          <tr>
            <th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
            <th class="border border-gray-300 p-2">ููุฏ ุงูููุชุฌ</th>
            <th class="border border-gray-300 p-2">ุงูููุชุฌ</th>
            <th class="border border-gray-300 p-2">ุงููููุฉ</th>
            <th class="border border-gray-300 p-2">ุงูุณุจุจ</th>
          </tr>
        </thead>
        <tbody id="user-sales-returns-table">
          <tr><td colspan="5" class="text-center text-gray-500 p-4">ุงุฎุชุฑ ูุณุชุฎุฏู ูุนุฑุถ ุงููุฑุชุฌุนุงุช</td></tr>
        </tbody>
      </table>
    </div>
    <!-- Discounts table -->
    <h3 class="text-xl font-semibold mb-2">ุงูุฎุตููุงุช</h3>
    <!-- Limit the visible portion of the discounts table to roughly five rows.  See
         comment above for invoices table. -->
    <div class="overflow-x-auto max-h-48 overflow-y-auto">
      <table class="w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
          <tr>
            <th class="border border-gray-300 p-2">ุฑูู ุงููุงุชูุฑุฉ</th>
            <th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
            <th class="border border-gray-300 p-2">ุงูููุชุฌ</th>
            <th class="border border-gray-300 p-2">ูููุฉ ุงูุฎุตู</th>
            <th class="border border-gray-300 p-2">ูุณุจุฉ ุงูุฎุตู</th>
          </tr>
        </thead>
        <tbody id="user-sales-discounts-table">
          <tr><td colspan="5" class="text-center text-gray-500 p-4">ุงุฎุชุฑ ูุณุชุฎุฏู ูุนุฑุถ ุงูุฎุตููุงุช</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
<!-- Inventory Section -->
<section class="section hidden" id="inventory-section">
<div class="bg-white rounded-lg shadow-lg p-6">
<h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">๐ฆ ุฅุฏุงุฑุฉ ุงููุฎุฒูู</h2>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
<div class="bg-emerald-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-emerald-600" id="total-products">0</div>
<div class="text-sm text-gray-600">ุฅุฌูุงูู ุงูููุชุฌุงุช</div>
</div>
<div class="bg-green-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-green-600" id="in-stock">0</div>
<div class="text-sm text-gray-600">ูุชููุฑ</div>
</div>
<div class="bg-yellow-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-yellow-600" id="low-stock">0</div>
<div class="text-sm text-gray-600">ูุฎุฒูู ููุฎูุถ</div>
</div>
<div class="bg-red-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-red-600" id="out-of-stock">0</div>
<div class="text-sm text-gray-600">ูุงูุฏ</div>
</div>
</div>
<div class="overflow-x-auto overflow-y-auto max-h-60">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr><th class="border border-gray-300 p-2">ููุฏ ุงูููุชุฌ</th><th class="border border-gray-300 p-2">ุงุณู ุงูููุชุฌ</th><th class="border border-gray-300 p-2">ุณุนุฑ ุงูุดุฑุงุก</th><th class="border border-gray-300 p-2">ุณุนุฑ ุงูุจูุน</th><th class="border border-gray-300 p-2">ุฅุฌูุงูู ุงููุดุชุฑูุงุช</th><th class="border border-gray-300 p-2">ุฅุฌูุงูู ุงููุจูุนุงุช</th><th class="border border-gray-300 p-2">ุงููุฎุฒูู ุงูุฃุณุงุณู</th><th class="border border-gray-300 p-2 bg-orange-100">๐ ูุญุฌูุฒ ูููุงุชูุฑุฉ</th><th class="border border-gray-300 p-2 bg-green-100">โจ ุงููุชุงุญ ููุจูุน</th><th class="border border-gray-300 p-2">ุงูุญุงูุฉ</th></tr>
</thead>
<tbody id="inventory-list">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="10">ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ุงููุฎุฒูู</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<!-- Employees Section -->
<section class="section hidden" id="employees-section">
<div class="bg-white rounded-lg shadow-lg p-6">
<h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">๐ฅ ุฅุฏุงุฑุฉ ุงูููุธููู</h2>
<!-- Display the total number of employees -->
<div class="mb-4 font-bold text-right text-gray-700">ุนุฏุฏ ุงูููุธููู: <span id="employees-count">0</span></div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
<div class="space-y-4">
<input class="w-full p-3 border rounded-lg" id="employee-name" placeholder="ุงุณู ุงูููุธู" type="text"/>
<!-- ููุฏ ุงูููุธู: ูููู ุชุฑูู ูุงุฑุบุงู ูุชูููุฏ ููุฏ ุชููุงุฆู -->
<input class="w-full p-3 border rounded-lg" id="employee-code" placeholder="ููุฏ ุงูููุธู (ุชููุงุฆู)" type="text"/>
<select class="w-full p-3 border rounded-lg" id="employee-department">
<option value="">ุงุฎุชุฑ ุงููุณูู ุงููุธููู</option>
<option value="ูุฏูุฑ ุชูููุฐู">ูุฏูุฑ ุชูููุฐู</option>
<option value="ูุฏูุฑ ุนุงู">ูุฏูุฑ ุนุงู</option>
<option value="ูุฏูุฑ ุชุณููู">ูุฏูุฑ ุชุณููู</option>
<option value="ูุฏูุฑ ูุดุชุฑูุงุช">ูุฏูุฑ ูุดุชุฑูุงุช</option>
<option value="ูุฏูุฑ ูุจูุนุงุช">ูุฏูุฑ ูุจูุนุงุช</option>
<option value="ูุดุฑู">ูุดุฑู</option>
<option value="ูุงุดูุฑ">ูุงุดูุฑ</option>
<option value="ูุณุฆูู ูุดุชุฑูุงุช">ูุณุฆูู ูุดุชุฑูุงุช</option>
<option value="ูุญุงุณุจ">ูุญุงุณุจ</option>
<option value="ุงููู ุฎุฒูุฉ">ุงููู ุฎุฒูุฉ</option>
<option value="ูุณุคู ุชุณููู">ูุณุคู ุชุณููู</option>
<option value="ุงููู ูุฎุฒู">ุงููู ูุฎุฒู</option>
<option value="ุจุงุฆุน">ุจุงุฆุน</option>
<option value="ุณุงุฆู">ุณุงุฆู</option>
</select>
<input class="w-full p-3 border rounded-lg" id="employee-salary" placeholder="ุงูุฑุงุชุจ ุงูุฃุณุงุณู" step="0.01" type="number"/>
</div>
<div class="space-y-4">
<input class="w-full p-3 border rounded-lg" id="employee-age" max="65" min="18" placeholder="ุงูุนูุฑ" type="number"/>
<input class="w-full p-3 border rounded-lg" id="employee-address" placeholder="ุงูุนููุงู" type="text"/>
<!-- ุณุงุนุงุช ุงูุนูู: ุชู ุชุญููู ุงูุญูู ุฅูู ูุงุฆูุฉ ููุณุฏูุฉ ูุน ุฒุฑ ุชุนุฏูู ูุฅุถุงูุฉ ุฎูุงุฑุงุช ุฌุฏูุฏุฉ -->
<div class="flex items-center w-full">
<select class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500" id="employee-hours">
<!-- ุงูุฎูุงุฑุงุช ุงูุงูุชุฑุงุถูุฉ ูุณุงุนุงุช ุงูุนูู -->
<option value="9 ุต - 5 ู">9 ุต - 5 ู</option>
<option value="8 ุต - 4 ู">8 ุต - 4 ู</option>
<option value="10 ุต - 6 ู">10 ุต - 6 ู</option>
</select>
<button class="p-3 bg-blue-500 hover:bg-blue-600 text-white rounded-r-lg ml-2" onclick="editEmployeeHours()" type="button">โ๏ธ ุชุนุฏูู</button>
</div>
</div>
<div class="space-y-4">
<input class="w-full p-3 border rounded-lg" id="employee-late-deductions" min="0" oninput="calculateNetSalary()" placeholder="ุฎุตููุงุช ุงูุชุฃุฎูุฑ (ุฌ.ู)" step="0.01" type="number"/>
<!-- ุญูู ุงูุฌุฒุงุกุงุช ูุน ุณุจุจ -->
<input class="w-full p-3 border rounded-lg" id="employee-penalties" min="0" oninput="calculateNetSalary()" placeholder="ุงูุฌุฒุงุกุงุช (ุฌ.ู)" step="0.01" type="number"/>
<input class="w-full p-3 border rounded-lg" id="employee-penalties-reason" placeholder="ุณุจุจ ุงูุฌุฒุงุกุงุช" type="text"/>
<!-- ุญูู ุงูุณููุฉ -->
<input class="w-full p-3 border rounded-lg" id="employee-advance" min="0" oninput="calculateNetSalary()" placeholder="ุงูุณููุฉ (ุฌ.ู)" step="0.01" type="number"/>
<!-- ุญูู ุงูุญูุงูุฒ ูุน ุณุจุจ -->
<input class="w-full p-3 border rounded-lg" id="employee-incentives" min="0" oninput="calculateNetSalary()" placeholder="ุงูุญูุงูุฒ (ุฌ.ู)" step="0.01" type="number"/>
<input class="w-full p-3 border rounded-lg" id="employee-incentives-reason" placeholder="ุณุจุจ ุงูุญูุงูุฒ" type="text"/>
            <div class="bg-green-50 p-3 rounded-lg border border-green-200">
            <label class="block text-sm font-medium text-green-700 mb-1">๐ฐ ุตุงูู ุงูุฑุงุชุจ</label>
            <div class="text-lg font-bold text-green-600" id="net-salary-display">0.00 ุฌ.ู</div>
            <div class="text-sm mt-2 space-y-1">
              <div class="text-gray-600">ุฅุฌูุงูู ุงูุฎุตููุงุช: <span class="font-bold text-red-600" id="total-deductions-display">0.00 ุฌ.ู</span></div>
              <div class="text-gray-600">ุฅุฌูุงูู ุงูุณูู: <span class="font-bold text-blue-600" id="total-advance-display">0.00 ุฌ.ู</span></div>
              <div class="text-gray-600">ุฅุฌูุงูู ุงูุญูุงูุฒ: <span class="font-bold text-green-600" id="total-incentives-display">0.00 ุฌ.ู</span></div>
            </div>
            <!-- ุชูุถูุญ ุตูุบุฉ ุงูุฑุงุชุจ ุงูุตุงูู: ูููู ุจุทุฑุญ ุงูุฎุตููุงุช ูุงูุณูู ูู ุงูุฑุงุชุจ ุงูุฃุณุงุณู ุซู ุฅุถุงูุฉ ุงูุญูุงูุฒ -->
            <div class="text-xs text-gray-600 mt-1">ุงูุฑุงุชุจ ุงูุฃุณุงุณู - (ุฅุฌูุงูู ุงูุฎุตููุงุช + ุงูุณูู) + ุงูุญูุงูุฒ</div>
            </div>
</div>
</div>
<button class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-lg font-medium mb-6" onclick="addEmployee()"> โ ุฅุถุงูุฉ ููุธู </button>
<!-- Employee search box with predictive dropdown -->
<div class="mb-6 relative">
<label class="block text-sm font-medium text-gray-700 mb-1">๐ ุจุญุซ ุนู ููุธู (ุงูุงุณู ุฃู ุงูููุฏ)</label>
<input class="w-full p-3 border rounded-lg" id="employee-search" oninput="showEmployeeSuggestions(); updateEmployeesDisplay(this.value)" placeholder="ุงูุชุจ ุงุณู ุฃู ููุฏ ุงูููุธู" type="text"/>
<div class="search-dropdown hidden absolute left-0 right-0 mt-1 z-50 bg-white border border-gray-300 rounded-lg" id="employee-search-results"></div>
</div>
<!-- Button to delete all employees -->
<button class="mb-6 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg" onclick="deleteAllEmployeesPopup()">๐๏ธ ุญุฐู ุฌููุน ุงูููุธููู</button>
<div class="overflow-x-auto max-h-60 overflow-y-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงูุงุณู</th>
<th class="border border-gray-300 p-2">ุงูููุฏ</th>
<th class="border border-gray-300 p-2">ุงููุณูู ุงููุธููู</th>
<th class="border border-gray-300 p-2">ุงูุฑุงุชุจ ุงูุฃุณุงุณู</th>
<th class="border border-gray-300 p-2">ุฎุตููุงุช ุงูุชุฃุฎูุฑ</th>
<th class="border border-gray-300 p-2">ุงูุฌุฒุงุกุงุช</th>
<th class="border border-gray-300 p-2">ุณุจุจ ุงูุฌุฒุงุกุงุช</th>
<th class="border border-gray-300 p-2">ุงูุณููุฉ</th>
<th class="border border-gray-300 p-2">ุงูุญูุงูุฒ</th>
<th class="border border-gray-300 p-2">ุณุจุจ ุงูุญูุงูุฒ</th>
<th class="border border-gray-300 p-2">ุตุงูู ุงูุฑุงุชุจ</th>
<th class="border border-gray-300 p-2">ุงูุนูุฑ</th>
<th class="border border-gray-300 p-2">ุงูุนููุงู</th>
<th class="border border-gray-300 p-2">ููุงุนูุฏ ุงูุนูู</th>
<th class="border border-gray-300 p-2">ุฅุฌุฑุงุกุงุช</th>
</tr>
</thead>
<tbody id="employees-list">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="14">ูุง ููุฌุฏ ููุธููู ูุณุฌููู</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<!-- Invoices Section -->
<section class="section hidden" id="invoices-section">
<div class="bg-white rounded-lg shadow-lg p-6">
<h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">๐ ุณุฌู ุงูููุงุชูุฑ</h2>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
<div class="bg-emerald-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-emerald-600" id="total-invoices">0</div>
<div class="text-sm text-gray-600">ุฅุฌูุงูู ุงูููุงุชูุฑ</div>
</div>
<div class="bg-green-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-green-600" id="total-sales">0.00</div>
<div class="text-sm text-gray-600">ุฅุฌูุงูู ุงููุจูุนุงุช</div>
</div>
<div class="bg-yellow-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-yellow-600" id="pending-payments">0.00</div>
<div class="text-sm text-gray-600">ูุฏููุนุงุช ูุนููุฉ</div>
</div>
<div class="bg-purple-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-purple-600" id="today-sales">0.00</div>
<div class="text-sm text-gray-600">ูุจูุนุงุช ุงูููู</div>
</div>
</div>
<!-- Search for invoices by number -->
<div class="mb-4 flex flex-col md:flex-row gap-2 items-end">
<div class="flex-1">
<label class="block text-sm font-medium text-gray-700 mb-1" for="invoice-search-input">๐ ุงูุจุญุซ ุนู ูุงุชูุฑุฉ</label>
<input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="invoice-search-input" placeholder="ุฃุฏุฎู ุฑูู ุงููุงุชูุฑุฉ..." type="text"/>
</div>
<div>
<button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg" id="invoice-search-btn" type="button">ุจุญุซ</button>
</div>
</div>
<!-- Restrict the height of the invoices list to roughly five rows and enable vertical scrolling.
     This prevents extremely long lists from stretching the page while still allowing
     users to scroll through all invoices. -->
<div class="overflow-x-auto max-h-60 overflow-y-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุฑูู ุงููุงุชูุฑุฉ</th>
<th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-2">ุงูุนููู</th>
<th class="border border-gray-300 p-2">ููุฏ ุงูุนููู</th>
<th class="border border-gray-300 p-2">ุนุฏุฏ ุงูููุชุฌุงุช</th>
<th class="border border-gray-300 p-2">ุฅุฌูุงูู ุงููููุฉ</th>
<th class="border border-gray-300 p-2">ุชูุงุตูู ุงูููุชุฌุงุช</th>
<th class="border border-gray-300 p-2">ุงูุฅุฌูุงูู</th>
<th class="border border-gray-300 p-2">ุงููุฏููุน</th>
<th class="border border-gray-300 p-2">ุงููุชุจูู</th>
<!-- ุทุฑููุฉ ุงูุฏูุน ุชูุถุญ ูุง ุฅุฐุง ูุงูุช ุงููุงุชูุฑุฉ ูุฏููุนุฉ ุจุงูููุฒุง ุฃู ุงููุงุด ุฃู ูุฎุชูุทุฉ -->
<th class="border border-gray-300 p-2">ุทุฑููุฉ ุงูุฏูุน</th>
<th class="border border-gray-300 p-2">ุงูุญุงูุฉ</th>
<th class="border border-gray-300 p-2">ุฅุฌุฑุงุกุงุช</th>
</tr>
</thead>
<tbody id="invoices-list">
<tr>
<!-- ุนูุฏ ุนุฏู ูุฌูุฏ ููุงุชูุฑุ ูุฌุจ ุชุนุฏูู colspan ููุดูู ุนููุฏ ุทุฑููุฉ ุงูุฏูุน ุงูุฌุฏูุฏ -->
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="13">ูุง ุชูุฌุฏ ููุงุชูุฑ ูุณุฌูุฉ</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<!-- Customers Section -->
<section class="section hidden" id="customers-section">
<div class="bg-white rounded-lg shadow-lg p-6">
<!-- ุฑุฃุณ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุนููุงุก ูุน ุฒุฑ ููุชุญ ูุงูุฐุฉ ุชูุฑูุฑ ุงูุนููุงุก. ุงูุฒุฑ
      ููุชุญ ูููุฐุฌ ุจุญุซ ุนู ุงูุนููู ูุนุฑุถ ูู ููุงุชูุฑู ููุนูููุงุชู. -->
<div class="flex items-center justify-between mb-6">
<h2 class="text-2xl font-bold text-gray-800 flex items-center">๐ค ุฅุฏุงุฑุฉ ุงูุนููุงุก</h2>
<button class="text-sm bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg" onclick="openCustomerReportModal()" type="button">๐ ุชูุฑูุฑ</button>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div class="bg-emerald-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-emerald-600" id="total-customers">0</div>
<div class="text-sm text-gray-600">ุฅุฌูุงูู ุงูุนููุงุก</div>
</div>
<!-- Search and customer addition inputs with add button -->
<div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
<!-- Search box for customers by name or code -->
<div class="relative">
<label class="block text-sm font-medium text-gray-700 mb-1" for="customer-search">๐ ุงูุจุญุซ ุนู ุนููู</label>
<input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="customer-search" placeholder="ุงุจุญุซ ุจุงุณู ุงูุนููู ุฃู ุงูููุฏ..." type="text"/>
<!-- Dropdown for predictive search suggestions -->
<div class="search-dropdown hidden absolute left-0 right-0 mt-1 z-50" id="customer-search-results"></div>
</div>
<!-- Customer name input synchronized with sales invoice -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="customers-customer-name">๐ค ุงุณู ุงูุนููู</label>
<input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="customers-customer-name" placeholder="ุฃุฏุฎู ุงุณู ุงูุนููู" type="text"/>
</div>
<!-- Customer code input synchronized with sales invoice -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="customers-customer-code">๐ ููุฏ ุงูุนููู</label>
<input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="customers-customer-code" placeholder="ุฃุฏุฎู ููุฏ ุงูุนููู" type="text"/>
</div>
<!-- Add customer button -->
<div class="flex">
<button class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg" id="add-customer-btn" type="button">โ ุฅุถุงูุฉ ุนููู</button>
</div>
</div>
<!-- Duplicate customer warning for the customers management section -->
<div class="text-red-600 text-sm mb-4 hidden" id="customers-duplicate-warning">โ๏ธ ูุฐุง ุงูุนููู ูุณุฌู ูุณุจูุงู</div>
<div class="bg-green-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-green-600" id="active-customers">0</div>
<div class="text-sm text-gray-600">ุนููุงุก ูุดุทูู</div>
</div>
<div class="bg-red-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-red-600" id="customers-with-debt">0</div>
<div class="text-sm text-gray-600">ุนููุงุก ุจุฏููู</div>
</div>
</div>
<div class="overflow-x-auto overflow-y-auto max-h-60">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงุณู ุงูุนููู</th>
<th class="border border-gray-300 p-2">ุนุฏุฏ ุงูููุงุชูุฑ</th>
<th class="border border-gray-300 p-2">ุฅุฌูุงูู ุงููุดุชุฑูุงุช</th>
<th class="border border-gray-300 p-2">ุงููุจูุบ ุงููุณุชุญู</th>
<th class="border border-gray-300 p-2">ุขุฎุฑ ุนูููุฉ ุดุฑุงุก</th>
</tr>
</thead>
<tbody id="customers-list">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="5">ูุง ููุฌุฏ ุนููุงุก ูุณุฌููู</td>
</tr>
</tbody>
</table>
<!-- Button to delete all customers -->
<div class="mt-4">
<button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg" onclick="deleteAllCustomersPopup()" type="button">๐๏ธ ุญุฐู ุฌููุน ุงูุนููุงุก</button>
</div>
</div>
</div>
</section>
<!-- Discounts Section -->
<section class="section hidden" id="discounts-section">
<div class="bg-white rounded-lg shadow-lg p-6">
<h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">๐ธ ุฅุฏุงุฑุฉ ุงูุฎุตููุงุช</h2>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
<div class="bg-amber-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-amber-600" id="total-discounts-count">0</div>
<div class="text-sm text-gray-600">ุฅุฌูุงูู ุงูุฎุตููุงุช</div>
</div>
<div class="bg-red-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-red-600" id="total-discounts-amount">0.00</div>
<div class="text-sm text-gray-600">ุฅุฌูุงูู ูููุฉ ุงูุฎุตููุงุช</div>
</div>
<div class="bg-green-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-green-600" id="today-discounts">0.00</div>
<div class="text-sm text-gray-600">ุฎุตููุงุช ุงูููู</div>
</div>
<div class="bg-purple-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-purple-600" id="avg-discount">0.00</div>
<div class="text-sm text-gray-600">ูุชูุณุท ุงูุฎุตู</div>
</div>
</div>
<div class="overflow-x-auto overflow-y-auto max-h-60">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุฑูู ุงููุงุชูุฑุฉ</th>
<th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-2">ุงูุนููู</th>
<th class="border border-gray-300 p-2">ุงูููุชุฌ</th>
<th class="border border-gray-300 p-2">ุงูุณุนุฑ ุงูุฃุตูู</th>
<th class="border border-gray-300 p-2">ูููุฉ ุงูุฎุตู</th>
<th class="border border-gray-300 p-2">ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู</th>
<th class="border border-gray-300 p-2">ูุณุจุฉ ุงูุฎุตู</th>
<th class="border border-gray-300 p-2">ุงููููุฉ</th>
<th class="border border-gray-300 p-2">ุฅุฌูุงูู ุงูุฎุตู</th>
</tr>
</thead>
<tbody id="discounts-list">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="10">ูุง ุชูุฌุฏ ุฎุตููุงุช ูุทุจูุฉ</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<!-- Accounting Section -->
<!-- Returns Section -->
<section class="section hidden" id="returns-section">
<div class="bg-white rounded-lg shadow-lg p-6">
<h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">๐ ุฅุฏุงุฑุฉ ุงููุฑุชุฌุนุงุช</h2>
<!-- ุฅุญุตุงุฆูุงุช ุงููุฑุชุฌุนุงุช -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
<div class="bg-lime-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-lime-600" id="total-returns-count">0</div>
<div class="text-sm text-gray-600">ุนุฏุฏ ุนูููุงุช ุงููุฑุชุฌุน</div>
</div>
<div class="bg-emerald-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-emerald-600" id="total-returns-quantity">0</div>
<div class="text-sm text-gray-600">ุฅุฌูุงูู ุงููููุฉ ุงููุฑุชุฌุนุฉ</div>
</div>
<div class="bg-teal-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-teal-600" id="today-returns-count">0</div>
<div class="text-sm text-gray-600">ูุฑุชุฌุนุงุช ุงูููู</div>
</div>
<div class="bg-orange-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-orange-600" id="avg-return-quantity">0</div>
<div class="text-sm text-gray-600">ูุชูุณุท ุงููููุฉ/ูุฑุชุฌุน</div>
</div>
</div>
<!-- ูููุฐุฌ ุฅุถุงูุฉ ูุฑุชุฌุน -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<!-- Left column: product search and details -->
<div class="space-y-4">
<!-- Product search for returns (matches sales invoice search style) -->
<div class="bg-lime-50 p-4 rounded-lg relative">
<label class="block text-sm font-medium text-gray-700 mb-2"> ๐ ุงูุจุญุซ ุนู ุงูููุชุฌ (ููุฏ ุฃู ุงุณู) </label>
<input autocomplete="off" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" id="return-product-search" placeholder="ุงูุณุญ ุงูููุฏ ุฃู ุงูุชุจ ุงุณู ุงูููุชุฌ..." type="text"/>
<!-- Search results dropdown for returns -->
<div class="absolute top-full left-0 right-0 search-dropdown hidden mt-1 z-50" id="return-search-results">
<!-- Results will be populated here -->
</div>
</div>
<!-- Product code (filled automatically after selection) -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ููุฏ ุงูููุชุฌ</label>
<input class="w-full p-3 border rounded-lg bg-gray-100" id="return-product-code" placeholder="ููุฏ ุงูููุชุฌ" readonly="" type="text"/>
</div>
<!-- Product name (filled automatically after selection) -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงูููุชุฌ</label>
<input class="w-full p-3 border rounded-lg bg-gray-100" id="return-product-name" placeholder="ุงุณู ุงูููุชุฌ" readonly="" type="text"/>
</div>
</div>
<!-- Right column: quantity and reason -->
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงููููุฉ</label>
<input class="w-full p-3 border rounded-lg" id="return-quantity" min="1" placeholder="ุงููููุฉ" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุณุจุจ ุงููุฑุชุฌุน</label>
<input class="w-full p-3 border rounded-lg" id="return-reason" placeholder="ุณุจุจ ุงููุฑุชุฌุน" type="text"/>
</div>
</div>
</div>
<button class="w-full bg-lime-500 hover:bg-lime-600 text-white py-3 rounded-lg font-medium mb-6" onclick="addReturn()"> โ ุฅุถุงูุฉ ูุฑุชุฌุน </button>
<!-- ุฌุฏูู ุงููุฑุชุฌุนุงุช -->
<div class="overflow-x-auto max-h-60 overflow-y-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-2">ููุฏ ุงูููุชุฌ</th>
<th class="border border-gray-300 p-2">ุงูููุชุฌ</th>
<th class="border border-gray-300 p-2">ุงููููุฉ</th>
<th class="border border-gray-300 p-2">ุงูุณุจุจ</th>
<th class="border border-gray-300 p-2">ุจูุงุณุทุฉ</th>
<th class="border border-gray-300 p-2">ุฅุฌุฑุงุกุงุช</th>
</tr>
</thead>
<tbody id="returns-list">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="7">ูุง ุชูุฌุฏ ูุฑุชุฌุนุงุช ูุณุฌูุฉ</td>
</tr>
</tbody>
</table>
</div>
    <!-- ุฒุฑ ูุญุฐู ุฌููุน ุงููุฑุชุฌุนุงุช -->
    <button class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-medium mt-4" onclick="deleteAllReturns()">๐๏ธ ุญุฐู ุฌููุน ุงููุฑุชุฌุนุงุช</button>
</div>
</section>
<section class="section hidden" id="accounting-section">
<div class="bg-white rounded-lg shadow-lg p-6">
<h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">๐ ุงููุญุงุณุจุฉ ูุงูุชูุงุฑูุฑ ุงููุงููุฉ</h2>
<!-- Financial Overview Cards -->
<div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
<!-- Budget Card: displays the current budget and allows editing.  The budget amount
       is loaded from Firebase (erpBudget) via the loadBudget() helper.  Users can
       click "ุชุนุฏูู" to open a modal that lets them update the budget. -->
<div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-6 rounded-lg shadow-lg">
<div class="flex items-center justify-between">
<div>
<h3 class="text-lg font-semibold mb-2">๐ผ ุงูููุฒุงููุฉ</h3>
<!-- The budget amount will be updated dynamically by loadBudget() and saveBudget() -->
<p class="text-3xl font-bold" id="budget-amount">2,000,000 ุฌ.ู</p>
<p class="text-sm opacity-90">
<!-- Clicking the button triggers a modal to edit the budget -->
<button class="underline" onclick="editBudget()">ุชุนุฏูู</button>
</p>
</div>
        <!-- No separate base budget card: show only the current budget.  The icon goes here. -->
        <div class="text-4xl opacity-80">๐ผ</div>
      </div>
    </div>
<div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
<div class="flex items-center justify-between">
<div>
<h3 class="text-lg font-semibold mb-2">๐ฐ ุฅุฌูุงูู ุงูุฃุฑุจุงุญ</h3>
<p class="text-3xl font-bold" id="total-profits">0.00 ุฌ.ู</p>
<p class="text-sm opacity-90">ููุฐ ุจุฏุงูุฉ ุงูุนุงู</p>
</div>
<div class="text-4xl opacity-80">๐</div>
</div>
</div>
<div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
<div class="flex items-center justify-between">
<div>
<h3 class="text-lg font-semibold mb-2">๐ ุฅุฌูุงูู ุงููุจูุนุงุช</h3>
<p class="text-3xl font-bold" id="total-revenue">0.00 ุฌ.ู</p>
<p class="text-sm opacity-90">ููุฐ ุจุฏุงูุฉ ุงูุนุงู</p>
</div>
<div class="text-4xl opacity-80">๐ต</div>
</div>
</div>
<div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-6 rounded-lg shadow-lg">
<div class="flex items-center justify-between">
<div>
<h3 class="text-lg font-semibold mb-2">๐ธ ุฅุฌูุงูู ุงููุตุฑููุงุช</h3>
<p class="text-3xl font-bold" id="total-expenses">0.00 ุฌ.ู</p>
<p class="text-sm opacity-90">ููุฐ ุจุฏุงูุฉ ุงูุนุงู</p>
</div>
<div class="text-4xl opacity-80">๐</div>
</div>
</div>
<div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
<div class="flex items-center justify-between">
<div>
<h3 class="text-lg font-semibold mb-2">๐ ุชูููุฉ ุงูุชูุฑูุฏุงุช</h3>
<p class="text-3xl font-bold" id="total-purchases-cost">0.00 ุฌ.ู</p>
<p class="text-sm opacity-90">ููุฐ ุจุฏุงูุฉ ุงูุนุงู</p>
</div>
<div class="text-4xl opacity-80">๐ฆ</div>
</div>
</div>
</div>
<!-- Daily/Monthly/Yearly Toggle -->
<div class="flex justify-center mb-6">
<div class="bg-gray-100 p-1 rounded-lg">
<button class="px-6 py-2 rounded-md text-gray-600 hover:text-gray-800 font-medium transition-colors" id="daily-view-btn" onclick="switchAccountingView('daily')"> ๐ ุนุฑุถ ูููู </button>
<button class="px-6 py-2 rounded-md bg-cyan-600 text-white font-medium transition-colors" id="monthly-view-btn" onclick="switchAccountingView('monthly')"> ๐ ุนุฑุถ ุดูุฑู </button>
<button class="px-6 py-2 rounded-md text-gray-600 hover:text-gray-800 font-medium transition-colors" id="yearly-view-btn" onclick="switchAccountingView('yearly')"> ๐ ุนุฑุถ ุณููู </button>
</div>
</div>
<!-- Add Expense Form -->
<div class="bg-red-50 rounded-lg p-6 mb-8 border border-red-200">
<h3 class="text-lg font-semibold mb-4 text-red-800 flex items-center">๐ธ ุฅุถุงูุฉ ูุตุฑูู ุฌุฏูุฏ</h3>
<!-- Form with better validation -->
<form class="space-y-4" id="expense-form" onsubmit="customExpenseSubmit(event)">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" for="expense-type">
<span class="text-red-500">*</span> ููุน ุงููุตุฑูู
                </label>
<select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all" id="expense-type" required="">
<option value="">-- ุงุฎุชุฑ ููุน ุงููุตุฑูู --</option>
<option value="ุฅูุฌุงุฑ">๐ข ุฅูุฌุงุฑ</option>
<option value="ููุฑุจุงุก">โก ููุฑุจุงุก</option>
<option value="ููุงู">๐ง ููุงู</option>
<option value="ุฑูุงุชุจ">๐ฐ ุฑูุงุชุจ</option>
<option value="ุตูุงูุฉ">๐ง ุตูุงูุฉ</option>
<option value="ูููุฏ">โฝ ูููุฏ</option>
<option value="ุชุณููู">๐ข ุชุณููู</option>
<option value="ูุตุฑููุงุช ุฅุฏุงุฑูุฉ">๐ ูุตุฑููุงุช ุฅุฏุงุฑูุฉ</option>
<option value="ููุงุฏ ุฎุงู">๐ฆ ููุงุฏ ุฎุงู</option>
<option value="ุดุญู ูุชูุตูู">๐ ุดุญู ูุชูุตูู</option>
<option value="ุงุชุตุงูุงุช ูุฅูุชุฑูุช">๐ ุงุชุตุงูุงุช ูุฅูุชุฑูุช</option>
<option value="ุชุฃูููุงุช">๐ก๏ธ ุชุฃูููุงุช</option>
<option value="ุถุฑุงุฆุจ ูุฑุณูู">๐ ุถุฑุงุฆุจ ูุฑุณูู</option>
<option value="ุฃุฎุฑู">โ ุฃุฎุฑู</option>
</select>
<div class="text-red-600 text-xs mt-1 hidden" id="expense-type-error">
                  ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงููุตุฑูู
                </div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" for="expense-amount">
<span class="text-red-500">*</span> ุงููุจูุบ (ุฌ.ู)
                </label>
<div class="relative">
<input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all" id="expense-amount" max="1000000" min="0.01" oninput="customValidateExpenseAmount(this)" placeholder="0.00" required="" step="0.01" type="number"/>
<div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm pointer-events-none">
                    ุฌ.ู
                  </div>
</div>
<div class="text-red-600 text-xs mt-1 hidden" id="expense-amount-error">
                  ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ
                </div>
<div class="text-gray-500 text-xs mt-1">
                  ุงูุญุฏ ุงูุฃุฏูู: 0.01 ุฌ.ู | ุงูุญุฏ ุงูุฃูุตู: 1,000,000 ุฌ.ู
                </div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" for="expense-description">
                  ุงููุตู (ุงุฎุชูุงุฑู)
                </label>
<input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all" id="expense-description" maxlength="200" placeholder="ูุตู ุชูุตููู ูููุตุฑูู..." type="text"/>
<div class="text-gray-500 text-xs mt-1">
                  ุงูุญุฏ ุงูุฃูุตู: 200 ุญุฑู
                </div>
</div>
</div>
<!-- Preview Section -->
<div class="bg-white p-4 rounded-lg border border-gray-200 hidden" id="expense-preview">
<h4 class="text-sm font-semibold text-gray-700 mb-2">๐ ูุนุงููุฉ ุงููุตุฑูู:</h4>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
<div>
<span class="text-gray-600">ุงูููุน:</span>
<span class="font-medium text-gray-800 mr-2" id="preview-type">-</span>
</div>
<div>
<span class="text-gray-600">ุงููุจูุบ:</span>
<span class="font-bold text-red-600 mr-2" id="preview-amount">0.00 ุฌ.ู</span>
</div>
<div>
<span class="text-gray-600">ุงูุชุงุฑูุฎ:</span>
<span class="font-medium text-blue-600 mr-2" id="preview-date">-</span>
</div>
</div>
<div class="mt-2" id="preview-description-container" style="display: none;">
<span class="text-gray-600">ุงููุตู:</span>
<span class="font-medium text-gray-800 mr-2" id="preview-description">-</span>
</div>
</div>
<!-- Action Buttons -->
<div class="flex flex-wrap justify-center gap-3 pt-4 border-t border-red-200">
<button class="bg-red-600 hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2" id="add-expense-btn" type="submit">
<span class="text-lg">โ</span>
<span>ุฅุถุงูุฉ ุงููุตุฑูู</span>
</button>
<button class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2" onclick="customClearExpenseForm()" type="button">
<span class="text-lg">๐</span>
<span>ูุณุญ ุงููููุฐุฌ</span>
</button>
</div>
</form>
</div>
<!-- Removed legacy expenses table; a new expenses table is inserted below the add expense card -->
<!-- Accounting Tables Container -->
<div id="accounting-content">
<!-- Daily View -->
<div class="accounting-view hidden" id="daily-accounting">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Daily Profits -->
<div class="bg-green-50 rounded-lg p-6">
<h3 class="text-lg font-semibold mb-4 text-green-800 flex items-center">๐ ุงูุฃุฑุจุงุญ ุงูููููุฉ</h3>
<div class="overflow-x-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-green-100">
<tr>
<th class="border border-gray-300 p-3">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-3">ุงูููู</th>
<th class="border border-gray-300 p-3">ุงููุจูุนุงุช</th>
<th class="border border-gray-300 p-3">ุงูุชูููุฉ</th>
<th class="border border-gray-300 p-3">ุงูุฑุจุญ</th>
</tr>
</thead>
<tbody id="daily-profits-table">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="5">ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุฑุจุงุญ ููููุฉ</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- Daily Expenses -->
<div class="bg-red-50 rounded-lg p-6 hidden">
<h3 class="text-lg font-semibold mb-4 text-red-800 flex items-center">๐ธ ุงููุตุฑููุงุช ุงูููููุฉ</h3>
<div class="overflow-x-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-red-100">
<tr>
<th class="border border-gray-300 p-3">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-3">ุงูููู</th>
<th class="border border-gray-300 p-3">ุงููุตุฑููุงุช</th>
<th class="border border-gray-300 p-3">ุงูุชูุฑูุฏุงุช</th>
<th class="border border-gray-300 p-3">ุงูุฅุฌูุงูู</th>
</tr>
</thead>
<tbody id="daily-expenses-table">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="5">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุตุฑููุงุช ููููุฉ</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<!-- Daily Summary Cards removed -->
</div>
<!-- Monthly View -->
<div class="accounting-view" id="monthly-accounting">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Monthly Profits -->
<div class="bg-green-50 rounded-lg p-6">
<h3 class="text-lg font-semibold mb-4 text-green-800 flex items-center">๐ ุงูุฃุฑุจุงุญ ุงูุดูุฑูุฉ</h3>
<div class="overflow-x-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-green-100">
<tr>
<th class="border border-gray-300 p-3">ุงูุดูุฑ</th>
<th class="border border-gray-300 p-3">ุงููุจูุนุงุช</th>
<th class="border border-gray-300 p-3">ุงูุชูููุฉ</th>
<th class="border border-gray-300 p-3">ุงูุฑุจุญ</th>
</tr>
</thead>
<tbody id="monthly-profits-table">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="4">ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุฑุจุงุญ ุดูุฑูุฉ</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- Monthly Expenses -->
<div class="bg-red-50 rounded-lg p-6 hidden">
<h3 class="text-lg font-semibold mb-4 text-red-800 flex items-center">๐ธ ุงููุตุฑููุงุช ุงูุดูุฑูุฉ</h3>
<div class="overflow-x-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-red-100">
<tr>
<th class="border border-gray-300 p-3">ุงูุดูุฑ</th>
<th class="border border-gray-300 p-3">ุงููุตุฑููุงุช</th>
<th class="border border-gray-300 p-3">ุงูุชูุฑูุฏุงุช</th>
<th class="border border-gray-300 p-3">ุงูุฅุฌูุงูู</th>
</tr>
</thead>
<tbody id="monthly-expenses-table">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="4">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุตุฑููุงุช ุดูุฑูุฉ</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<!-- Expenses List Section -->
</div>
<!-- Yearly View -->
<div class="accounting-view hidden" id="yearly-accounting">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Yearly Profits -->
<div class="bg-green-50 rounded-lg p-6">
<h3 class="text-lg font-semibold mb-4 text-green-800 flex items-center">๐ ุงูุฃุฑุจุงุญ ุงูุณูููุฉ</h3>
<div class="overflow-x-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-green-100">
<tr>
<th class="border border-gray-300 p-3">ุงูุณูุฉ</th>
<th class="border border-gray-300 p-3">ุฅุฌูุงูู ุงููุจูุนุงุช</th>
<th class="border border-gray-300 p-3">ุฅุฌูุงูู ุงูุชูููุฉ</th>
<th class="border border-gray-300 p-3">ุตุงูู ุงูุฑุจุญ</th>
<th class="border border-gray-300 p-3">ูุงูุด ุงูุฑุจุญ</th>
</tr>
</thead>
<tbody id="yearly-profits-table">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="5">ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุฑุจุงุญ ุณูููุฉ</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- Yearly Expenses -->
<div class="bg-red-50 rounded-lg p-6 hidden">
<h3 class="text-lg font-semibold mb-4 text-red-800 flex items-center">๐ฐ ุงููุตุฑููุงุช ุงูุณูููุฉ</h3>
<div class="overflow-x-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-red-100">
<tr>
<th class="border border-gray-300 p-3">ุงูุณูุฉ</th>
<th class="border border-gray-300 p-3">ุงููุตุฑููุงุช</th>
<th class="border border-gray-300 p-3">ุงูุชูุฑูุฏุงุช</th>
<th class="border border-gray-300 p-3">ุงูุฅุฌูุงูู</th>
</tr>
</thead>
<tbody id="yearly-expenses-table">
<tr>
<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="4">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุตุฑููุงุช ุณูููุฉ</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<!-- Yearly Summary -->
<div class="mt-8 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-lg p-6">
<h3 class="text-lg font-semibold mb-4 text-cyan-800 flex items-center">๐ ููุฎุต ุงูุฃุฏุงุก ุงูุณููู</h3>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<div class="bg-white p-4 rounded-lg shadow">
<div class="text-center">
<div class="text-2xl font-bold text-green-600" id="yearly-net-profit">0.00 ุฌ.ู</div>
<div class="text-sm text-gray-600">ุตุงูู ุงูุฑุจุญ ุงูุณููู</div>
</div>
</div>
<div class="bg-white p-4 rounded-lg shadow">
<div class="text-center">
<div class="text-2xl font-bold text-blue-600" id="yearly-profit-margin">0.0%</div>
<div class="text-sm text-gray-600">ูุงูุด ุงูุฑุจุญ ุงูุณููู</div>
</div>
</div>
<div class="bg-white p-4 rounded-lg shadow">
<div class="text-center">
<div class="text-2xl font-bold text-purple-600" id="yearly-roi">0.0%</div>
<div class="text-sm text-gray-600">ุงูุนุงุฆุฏ ุนูู ุงูุงุณุชุซูุงุฑ</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- New Expenses Table Section -->
<div class="bg-red-50 rounded-lg p-6 mt-8 border border-red-200" id="expenses-list-section">
<h3 class="text-lg font-semibold mb-4 text-red-800 flex items-center">๐ ูุงุฆูุฉ ุงููุตุฑููุงุช</h3>
<!-- ุฒุฑ ุญุฐู ุฌููุน ุงููุตุฑููุงุช -->
<div class="flex justify-end mb-4">
<button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm" onclick="deleteAllExpenses()">
      ๐๏ธ ุญุฐู ุฌููุน ุงููุตุฑููุงุช
    </button>
</div>
<div class="overflow-x-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-red-100">
<tr>
<th class="border border-gray-300 p-3">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-3">ุงูููุน</th>
<th class="border border-gray-300 p-3">ุงููุจูุบ</th>
<th class="border border-gray-300 p-3">ุงููุตู</th>
<th class="border border-gray-300 p-3">ุงูููุดุฆ</th>
<th class="border border-gray-300 p-3">ุงูุฅุฌุฑุงุกุงุช</th>
</tr>
</thead>
<tbody id="expenses-list-table-body">
<tr><td class="border border-gray-300 p-4 text-center text-gray-500" colspan="6">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุตุฑููุงุช</td></tr>
</tbody>
</table>
</div>
</div>
<!-- Expense handling script -->
<script>
  // Initialize the expenses list specific to this custom expense table
  window.customExpensesList = [];

  // Validate expense amount within min/max range and show/hide error message
  function customValidateExpenseAmount(input) {
    const value = parseFloat(input.value);
    const min = parseFloat(input.min || "0");
    const max = parseFloat(input.max || "999999999");
    const errorEl = document.getElementById('expense-amount-error');
    if (isNaN(value) || value < min || value > max) {
      errorEl && errorEl.classList.remove('hidden');
    } else {
      errorEl && errorEl.classList.add('hidden');
    }
  }

  // Clear expense form inputs and reset preview
  function customClearExpenseForm() {
    const typeEl = document.getElementById('expense-type');
    const amountEl = document.getElementById('expense-amount');
    const descEl = document.getElementById('expense-description');
    if (typeEl) typeEl.value = '';
    if (amountEl) amountEl.value = '';
    if (descEl) descEl.value = '';
    // Hide preview section
    const preview = document.getElementById('expense-preview');
    if (preview) {
      preview.classList.add('hidden');
    }
    // Reset preview fields
    const previewType = document.getElementById('preview-type');
    const previewAmount = document.getElementById('preview-amount');
    const previewDate = document.getElementById('preview-date');
    const previewDesc = document.getElementById('preview-description');
    const previewDescContainer = document.getElementById('preview-description-container');
    if (previewType) previewType.textContent = '-';
    if (previewAmount) previewAmount.textContent = '0.00 ุฌ.ู';
    if (previewDate) previewDate.textContent = '-';
    if (previewDesc) previewDesc.textContent = '-';
    if (previewDescContainer) previewDescContainer.style.display = 'none';
  }

  // Update preview section whenever form inputs change
  function customUpdateExpensePreview() {
    const type = document.getElementById('expense-type')?.value;
    const amountVal = document.getElementById('expense-amount')?.value;
    const amount = parseFloat(amountVal);
    const desc = document.getElementById('expense-description')?.value?.trim();
    const preview = document.getElementById('expense-preview');
    if (!preview) return;
    if (type && !isNaN(amount)) {
      preview.classList.remove('hidden');
      const previewType = document.getElementById('preview-type');
      const previewAmount = document.getElementById('preview-amount');
      const previewDate = document.getElementById('preview-date');
      const previewDesc = document.getElementById('preview-description');
      const previewDescContainer = document.getElementById('preview-description-container');
      if (previewType) previewType.textContent = type;
      if (previewAmount) previewAmount.textContent = Number(amount).toFixed(2) + ' ุฌ.ู';
      if (previewDate) {
        const now = new Date();
        previewDate.textContent = now.toLocaleDateString('ar-EG');
      }
      if (desc) {
        if (previewDesc) previewDesc.textContent = desc;
        if (previewDescContainer) previewDescContainer.style.display = '';
      } else {
        if (previewDescContainer) previewDescContainer.style.display = 'none';
      }
    } else {
      preview.classList.add('hidden');
    }
  }

  // Handle expense form submission
async function customExpenseSubmit(event) {
    if (event && event.preventDefault) event.preventDefault();
    const type = document.getElementById('expense-type')?.value;
    const amountValue = document.getElementById('expense-amount')?.value;
    const amount = parseFloat(amountValue);
    const desc = document.getElementById('expense-description')?.value?.trim();
    // Simple validation: ensure type and amount are valid
    let valid = true;
    if (!type) {
      const typeErr = document.getElementById('expense-type-error');
      if (typeErr) typeErr.classList.remove('hidden');
      valid = false;
    } else {
      const typeErr = document.getElementById('expense-type-error');
      if (typeErr) typeErr.classList.add('hidden');
    }
    if (isNaN(amount) || amount <= 0) {
      const amountErr = document.getElementById('expense-amount-error');
      if (amountErr) amountErr.classList.remove('hidden');
      valid = false;
    } else {
      const amountErr = document.getElementById('expense-amount-error');
      if (amountErr) amountErr.classList.add('hidden');
    }
    if (!valid) return;
    // Construct expense object
    const now = new Date();
    const dateStr = now.toLocaleDateString('ar-EG');
    // Determine the creator based on the current user if available; fallback to 'ูุธุงู'
    const creatorName = (typeof currentUser !== 'undefined' && currentUser && currentUser.fullName) ? currentUser.fullName : 'ูุธุงู';
    // Generate a unique ID for this custom expense
    const expenseId = 'custom_expense_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    // Build the local expense object and include the id for later edits/deletions
    const expense = {
      id: expenseId,
      date: dateStr,
      type: type,
      amount: Number(amount).toFixed(2),
      description: desc || '',
      creator: creatorName
    };
    // Store locally for rendering in our custom table
    window.customExpensesList.push(expense);
    // Also add this expense into the unified allData array so that accounting totals update correctly
    if (typeof allData !== 'undefined') {
      const newExpenseRecord = {
        id: expenseId,
        type: 'expense',
        expense_type: type,
        amount: parseFloat(Number(amount).toFixed(2)),
        description: desc || '',
        date: new Date().toISOString(),
        status: 'ููุชูู',
        created_by: creatorName
      };
      allData.push(newExpenseRecord);
    }
    // ๐ป Update the budget: subtract this expense amount from the current budget.
    try {
      const amtNum = parseFloat(Number(amount).toFixed(2)) || 0;
      if (typeof window.currentBudget === 'undefined' || isNaN(parseFloat(window.currentBudget))) {
        window.currentBudget = 0;
      }
      window.currentBudget = parseFloat(window.currentBudget) - amtNum;
      // Reflect the new budget in the UI immediately
      const budgetEl = document.getElementById('budget-amount');
      if (budgetEl) {
        budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
      }
      // Persist the updated budget to Firebase; failure does not interrupt the flow
      try {
        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), window.currentBudget);
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูููุฒุงููุฉ ุจุนุฏ ุฅุถุงูุฉ ุงููุตุฑูู (ูููุฐุฌ ุงููุญุงุณุจุฉ):', err);
      }
    } catch (err) {
      console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุฎุตู ุงููุตุฑูู ูู ุงูููุฒุงููุฉ (ูููุฐุฌ ุงููุญุงุณุจุฉ):', err);
    }
    // Refresh the expenses table
    customUpdateExpensesTable();
    // Trigger accounting update so profits and totals reflect this new expense
    try {
      if (typeof updateAccountingDisplay === 'function') {
        updateAccountingDisplay();
      } else if (typeof updateAllDisplays === 'function') {
        updateAllDisplays();
      }
    } catch(e) {
      // ignore errors
    }
    // Save the updated allData to Firebase and reload data
    try {
      await saveDataToFirebase();
      await loadDataFromFirebase();
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุตุฑูู ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
    }
    // Clear the form for new entry
    customClearExpenseForm();
  }

  // Render the expenses list into the table
  function customUpdateExpensesTable() {
    const tbody = document.getElementById('expenses-list-table-body');
    if (!tbody) return;
    const list = window.customExpensesList;
    if (!Array.isArray(list) || list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุตุฑููุงุช</td></tr>';
      return;
    }
    const rows = list.map((exp, idx) => {
      const descCell = exp.description ? exp.description : '-';
      const creatorCell = exp.creator ? exp.creator : '-';
      return '<tr>' +
        '<td class="border border-gray-300 p-2 text-center">' + exp.date + '</td>' +
        '<td class="border border-gray-300 p-2">' + exp.type + '</td>' +
        '<td class="border border-gray-300 p-2">' + exp.amount + ' ุฌ.ู</td>' +
        '<td class="border border-gray-300 p-2">' + descCell + '</td>' +
        '<td class="border border-gray-300 p-2">' + creatorCell + '</td>' +
        '<td class="border border-gray-300 p-2 text-center">' +
        '<button onclick="openEditExpenseModal(' + idx + ')" class="text-blue-600 hover:text-blue-800 mr-2">โ๏ธ ุชุนุฏูู</button>' +
          // Use deleteExpense(exp.id) instead of customDeleteExpense() so that a confirmation popโup
          // appears and the deletion is persisted to Firebase.  The expense ID is passed as a
          // quoted string to handle special characters safely.
          '<button onclick="deleteExpense(\'' + exp.id + '\')" class="text-red-600 hover:text-red-800">๐๏ธ ุญุฐู</button>' +
        '</td>' +
        '</tr>';
    }).join('');
    tbody.innerHTML = rows;
  }

  // Remove an expense from the list by index and refresh the table
  function customDeleteExpense(index) {
    if (!Array.isArray(window.customExpensesList)) return;
    if (index < 0 || index >= window.customExpensesList.length) return;
    // Remove from our local list and capture the removed item
    const removed = window.customExpensesList.splice(index, 1)[0];
    customUpdateExpensesTable();
    // Remove corresponding record from allData using the stored id
    if (removed && removed.id && typeof allData !== 'undefined') {
      const idx = allData.findIndex(item => item.id === removed.id);
      if (idx !== -1) {
        allData.splice(idx, 1);
      }
    }
    // Refresh accounting displays so totals update
    try {
      if (typeof updateAccountingDisplay === 'function') {
        updateAccountingDisplay();
      } else if (typeof updateAllDisplays === 'function') {
        updateAllDisplays();
      }
    } catch(e) {}
  }

  /**
   * Show a confirmation popโup to delete all expense records.  This function
   * creates a modal overlay similar to the single expense deletion popโup,
   * prompting the user to confirm removal of all expenses.  If confirmed,
   * confirmDeleteAllExpenses() is invoked to perform the actual deletion and
   * persistence to Firebase.
   */
  function deleteAllExpenses() {
    // If there are no expenses, simply show an informational message
    const hasExpenses = allData.some(item => item && item.type === 'expense');
    if (!hasExpenses) {
      showMessage('โน๏ธ ูุง ุชูุฌุฏ ูุตุฑููุงุช ูุญุฐููุง', 'info');
      return;
    }
    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    confirmDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md">
        <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุญุฐู ุฌููุน ุงููุตุฑููุงุช</h3>
        <p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงููุตุฑููุงุชุ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.</p>
        <div class="flex gap-3 justify-end">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
            ุฅูุบุงุก
          </button>
          <button onclick="confirmDeleteAllExpenses(); this.parentElement.parentElement.parentElement.remove()" 
                  class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
            ุญุฐู ุงููู
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  }

  /**
   * Permanently remove all expense records from the unified data array and
   * persist the change to Firebase.  This function stops any running
   * background sync timer, filters out expenses from allData, saves the
   * updated data, reloads from Firebase, and then refreshes all displays.
   */
  async function confirmDeleteAllExpenses() {
    try {
      // Before deleting, calculate the total of all expense amounts so we can
      // restore this amount back to the budget.  Expenses reduce the budget
      // when recorded, so deleting them should increase the available budget
      // accordingly.  We coerce missing amounts to 0.
      let deletedExpenseTotal = 0;
      try {
        deletedExpenseTotal = allData
          .filter(item => item && item.type === 'expense')
          .reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
      } catch (calcErr) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุญุณุงุจ ุฅุฌูุงูู ุงููุตุฑููุงุช ุงููุญุฐููุฉ ุฃุซูุงุก ุญุฐู ุฌููุน ุงููุตุฑููุงุช:', calcErr);
      }
      // Adjust the current budget
      try {
        if (typeof window.currentBudget === 'undefined' || isNaN(parseFloat(window.currentBudget))) {
          window.currentBudget = 0;
        }
        window.currentBudget = parseFloat(window.currentBudget) + deletedExpenseTotal;
        // Update budget UI immediately if element exists
        const budgetEl = document.getElementById('budget-amount');
        if (budgetEl) {
          budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
        }
        // Persist updated budget to Firebase
        try {
          await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), window.currentBudget);
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูููุฒุงููุฉ ุจุนุฏ ุญุฐู ุฌููุน ุงููุตุฑููุงุช:', err);
        }
      } catch (budgetRestoreErr) {
        console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุนุงุฏุฉ ุงูููุฒุงููุฉ ุจุนุฏ ุญุฐู ุฌููุน ุงููุตุฑููุงุช:', budgetRestoreErr);
      }
      // Filter out expense items from allData
      allData = allData.filter(item => !(item && item.type === 'expense'));
      // Pause background sync to avoid overwriting the deletion
      const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
      if (wasAutoSyncActive) {
        clearInterval(window.autoSyncTimer);
        window.autoSyncTimer = null;
      }
      let saveSucceeded = false;
      try {
        await saveDataToFirebase();
        saveSucceeded = true;
      } catch (err) {
        console.error('Error saving data after deleting all expenses:', err);
      }
      if (saveSucceeded) {
        try {
          await loadDataFromFirebase();
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุฌููุน ุงููุตุฑููุงุช:', err);
        }
      }
      // Resume background sync if it was previously running
      if (wasAutoSyncActive) {
        window.autoSyncTimer = setInterval(() => {
          Promise.resolve(backgroundSync());
        }, 5000);
      }
      // Refresh all displays to reflect the deletion
      updateAllDisplays();
      showMessage('โ ุชู ุญุฐู ุฌููุน ุงููุตุฑููุงุช ุจูุฌุงุญ', 'success');
    } catch (err) {
      console.error('๐ฅ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุฌููุน ุงููุตุฑููุงุช:', err);
      showMessage('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุฌููุน ุงููุตุฑููุงุช', 'error');
    }
  }

  // Attach input listeners to update preview in real-time when the DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    const expenseForm = document.getElementById('expense-form');
    if (expenseForm) {
      expenseForm.addEventListener('input', customUpdateExpensePreview);
    }
  });
</script>
<!-- Edit Expense Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="edit-expense-modal">
<div class="bg-white rounded-lg p-6 w-full max-w-md">
<h3 class="text-lg font-bold mb-4">ุชุนุฏูู ุงููุตุฑูู</h3>
<form class="space-y-4" id="edit-expense-form" onsubmit="return false;">
<div>
<label class="block text-sm font-medium mb-1" for="edit-expense-type">ููุน ุงููุตุฑูู</label>
<select class="w-full p-2 border border-gray-300 rounded" id="edit-expense-type">
<option value="ุฅูุฌุงุฑ">๐ข ุฅูุฌุงุฑ</option>
<option value="ููุฑุจุงุก">โก ููุฑุจุงุก</option>
<option value="ููุงู">๐ง ููุงู</option>
<option value="ุฑูุงุชุจ">๐ฐ ุฑูุงุชุจ</option>
<option value="ุตูุงูุฉ">๐ง ุตูุงูุฉ</option>
<option value="ูููุฏ">โฝ ูููุฏ</option>
<option value="ุชุณููู">๐ข ุชุณููู</option>
<option value="ูุตุฑููุงุช ุฅุฏุงุฑูุฉ">๐ ูุตุฑููุงุช ุฅุฏุงุฑูุฉ</option>
<option value="ููุงุฏ ุฎุงู">๐ฆ ููุงุฏ ุฎุงู</option>
<option value="ุดุญู ูุชูุตูู">๐ ุดุญู ูุชูุตูู</option>
<option value="ุงุชุตุงูุงุช ูุฅูุชุฑูุช">๐ ุงุชุตุงูุงุช ูุฅูุชุฑูุช</option>
<option value="ุชุฃูููุงุช">๐ก๏ธ ุชุฃูููุงุช</option>
<option value="ุถุฑุงุฆุจ ูุฑุณูู">๐ ุถุฑุงุฆุจ ูุฑุณูู</option>
<option value="ุฃุฎุฑู">โ ุฃุฎุฑู</option>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="edit-expense-amount">ุงููุจูุบ (ุฌ.ู)</label>
<input class="w-full p-2 border border-gray-300 rounded" id="edit-expense-amount" min="0.01" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="edit-expense-description">ุงููุตู</label>
<input class="w-full p-2 border border-gray-300 rounded" id="edit-expense-description" maxlength="200" type="text"/>
</div>
<div class="flex justify-end gap-3 pt-2">
<button class="px-4 py-2 bg-gray-400 text-white rounded" onclick="closeEditExpenseModal()" type="button">ุฅูุบุงุก</button>
<button class="px-4 py-2 bg-red-600 text-white rounded" onclick="saveExpenseEdit()" type="button">ุญูุธ</button>
</div>
</form>
</div>
</div>
<!-- Sales Section -->
<div class="bg-blue-50 rounded-lg p-6 mt-8 border border-blue-200" id="sales-section">
<h3 class="text-lg font-semibold mb-4 text-blue-800 flex items-center">๐ฆ ุงููุจูุนุงุช</h3>
<!-- Date Filter -->
<div class="flex flex-wrap items-end gap-4 mb-4">
<div>
<label class="block text-sm font-medium mb-1" for="sales-start-date">ูู ุชุงุฑูุฎ</label>
<input class="p-2 border border-gray-300 rounded" id="sales-start-date" type="date"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="sales-end-date">ุฅูู ุชุงุฑูุฎ</label>
<input class="p-2 border border-gray-300 rounded" id="sales-end-date" type="date"/>
</div>
<button class="px-4 py-2 bg-blue-600 text-white rounded h-10" onclick="filterSalesByDate()" type="button">ุชุตููุฉ</button>
</div>
<!-- Sales Table -->
<div class="overflow-y-auto" style="max-height: 280px;">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-blue-100">
<tr>
<th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-2">ุงูููุชุฌ</th>
<th class="border border-gray-300 p-2">ุงููููุฉ</th>
<th class="border border-gray-300 p-2">ุงูุณุนุฑ (ุฌ.ู)</th>
</tr>
</thead>
<tbody id="sales-table-body">
<tr><td class="border border-gray-300 p-4 text-center text-gray-500" colspan="4">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุจูุนุงุช</td></tr>
</tbody>
</table>
</div>
</div>
<script>
    // Global variables for editing expenses and sales
    let editingExpenseIndex = null;
    window.salesList = [];

    /**
     * Open the expense editing modal and populate fields with existing data.
     * @param {number} index Index of the expense in customExpensesList.
     */
    function openEditExpenseModal(index) {
      const list = window.customExpensesList;
      if (!Array.isArray(list) || index < 0 || index >= list.length) return;
      editingExpenseIndex = index;
      const exp = list[index];
      // Populate modal fields
      const typeSelect = document.getElementById('edit-expense-type');
      const amountInput = document.getElementById('edit-expense-amount');
      const descInput = document.getElementById('edit-expense-description');
      if (typeSelect) typeSelect.value = exp.type;
      if (amountInput) amountInput.value = parseFloat(exp.amount);
      if (descInput) descInput.value = exp.description || '';
      // Show modal
      const modal = document.getElementById('edit-expense-modal');
      if (modal) modal.classList.remove('hidden');
    }

  /**
   * Build the customExpensesList from the unified `allData` array.  On page
   * load or after synchronizing with Firebase, the inโmemory custom
   * expenses list is empty.  This helper iterates over all expense
   * records in `allData`, normalizes their fields for display in the
   * custom expenses table, and then calls customUpdateExpensesTable()
   * to reโrender the table.  Without rebuilding the list from
   * `allData`, expenses saved to the database would not appear in the
   * interface after a refresh.
   */
  function initializeCustomExpenses() {
    // Reset the list
    window.customExpensesList = [];
    if (Array.isArray(allData)) {
      allData.forEach(function(item) {
        if (item && item.type === 'expense') {
          // Normalize date field: if ISO string is stored, format it to arโEG
          let dateStr = '';
          try {
            if (item.date) {
              const d = new Date(item.date);
              if (!isNaN(d.getTime())) {
                dateStr = d.toLocaleDateString('ar-EG');
              } else {
                dateStr = String(item.date);
              }
            }
          } catch (_) {
            dateStr = String(item.date || '');
          }
          const amt = parseFloat(item.amount);
          window.customExpensesList.push({
            id: item.id || item.expenseId || ('exp_' + Math.random().toString(36).substr(2)),
            date: dateStr || '-',
            type: item.expense_type || item.type || '-',
            amount: isNaN(amt) ? '0.00' : amt.toFixed(2),
            description: item.description || item.notes || '',
            creator: item.created_by || item.creator || ''
          });
        }
      });
    }
    // Re-render the expenses table based on the new list
    if (typeof customUpdateExpensesTable === 'function') {
      customUpdateExpensesTable();
    }
  }

    /**
     * Close the expense editing modal without saving changes.
     */
    function closeEditExpenseModal() {
      const modal = document.getElementById('edit-expense-modal');
      if (modal) modal.classList.add('hidden');
      editingExpenseIndex = null;
    }

    /**
     * Save changes made in the expense editing modal back to the customExpensesList.
     */
    async function saveExpenseEdit() {
      if (editingExpenseIndex === null) return;
      const list = window.customExpensesList;
      if (!Array.isArray(list) || editingExpenseIndex < 0 || editingExpenseIndex >= list.length) return;
      // Grab updated values
      const typeSelect = document.getElementById('edit-expense-type');
      const amountInput = document.getElementById('edit-expense-amount');
      const descInput = document.getElementById('edit-expense-description');
      const newType = typeSelect ? typeSelect.value : '';
      const newAmount = amountInput ? parseFloat(amountInput.value) : 0;
      const newDesc = descInput ? descInput.value.trim() : '';
      if (!newType || isNaN(newAmount) || newAmount <= 0) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ููุน ุงููุตุฑูู ูุงููุจูุบ ุจุดูู ุตุญูุญ');
        return;
      }
      // Update expense object in our local list
      const exp = list[editingExpenseIndex];
      // Capture the old amount before modification so we can adjust the budget accordingly.
      const oldAmount = parseFloat(exp.amount) || 0;
      exp.type = newType;
      // Store the new amount as a fixedโpoint string for display consistency
      exp.amount = Number(newAmount).toFixed(2);
      exp.description = newDesc;
      // Update the corresponding record in allData using the stored id
      if (exp && exp.id && typeof allData !== 'undefined') {
        const idx = allData.findIndex(item => item.id === exp.id);
        if (idx !== -1) {
          allData[idx].expense_type = newType;
          allData[idx].amount = parseFloat(Number(newAmount).toFixed(2));
          allData[idx].description = newDesc;
        }
      }

      /*
       * Adjust the budget to account for the change in the expense amount.
       * When editing an expense, we need to compare the previous amount with
       * the new amount.  If the new amount is lower, the difference should
       * be returned to the budget.  If the new amount is higher, the difference
       * should be deducted from the budget.  The budget adjustment is simply
       * (oldAmount - newAmount), which is added to the current budget.
       */
      try {
        if (typeof window.currentBudget === 'undefined' || isNaN(parseFloat(window.currentBudget))) {
          window.currentBudget = 0;
        }
        const difference = oldAmount - (parseFloat(newAmount) || 0);
        // Update the inโmemory budget
        window.currentBudget = parseFloat(window.currentBudget) + difference;
        // Update the budget display in the UI
        const budgetEl = document.getElementById('budget-amount');
        if (budgetEl) {
          budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
        }
        // Persist the updated budget to Firebase.  Use a nested try/catch so that
        // budget failures do not block the rest of the save operation.
        try {
          await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), window.currentBudget);
        } catch (budgetErr) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูููุฒุงููุฉ ุจุนุฏ ุชุนุฏูู ุงููุตุฑูู:', budgetErr);
        }
      } catch (budgetAdjustmentErr) {
        console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุนุฏูู ุงูููุฒุงููุฉ ุจุนุฏ ุชุนุฏูู ุงููุตุฑูู:', budgetAdjustmentErr);
      }
      // Hide modal and refresh the local expenses table
      closeEditExpenseModal();
      customUpdateExpensesTable();
      // Persist the updated expense to Firebase and reload data
      try {
        await saveDataToFirebase();
        await loadDataFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุตุฑูู ุงูููุนุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
      }
      // After reloading, update all displays to reflect changes across sections
      try {
        if (typeof updateAllDisplays === 'function') {
          updateAllDisplays();
        } else if (typeof updateAccountingDisplay === 'function') {
          updateAccountingDisplay();
        }
      } catch(e) {}
    }

    /**
     * Load initial sales data from allData (invoices) into salesList.
     * Each invoice is treated as a single sale record combining product names and quantities.
     */
    function loadInitialSalesList() {
      if (typeof allData === 'undefined') return;
      // Build sales list from individual sale records instead of invoices.
      window.salesList = allData
        .filter(item => item.type === 'sale')
        .map(item => ({
          date: item.date,
          product: item.product_name || '',
          quantity: item.quantity || 0,
          // Use the total revenue for this sale (price * quantity) for display.  If total is unavailable, fall back to unit price * quantity.
          price: (typeof item.total !== 'undefined' ? parseFloat(item.total) : (parseFloat(item.price) || 0) * (parseFloat(item.quantity) || 1)) || 0
        }));
      updateSalesTable();
    }

    /**
     * Update the sales table with optional date filtering.
     * @param {Date|null} startDate Starting date for filter (inclusive).
     * @param {Date|null} endDate Ending date for filter (inclusive).
     */
    function updateSalesTable(startDate, endDate) {
      const tbody = document.getElementById('sales-table-body');
      if (!tbody) return;
      const list = window.salesList || [];
      // Apply date filter if provided
      let filtered = list;
      if (startDate || endDate) {
        filtered = list.filter(record => {
          const recordDate = new Date(record.date);
          if (startDate && recordDate < startDate) return false;
          if (endDate && recordDate > endDate) return false;
          return true;
        });
      }
      if (!Array.isArray(filtered) || filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุจูุนุงุช</td></tr>';
        return;
      }
      // Build rows
      const rows = filtered.map(record => {
        const dateStr = new Date(record.date).toLocaleDateString('ar-EG');
        const product = record.product || '-';
        const qty = record.quantity || 0;
        const price = (record.price || 0).toFixed(2) + ' ุฌ.ู';
        return '<tr>' +
          '<td class="border border-gray-300 p-2 text-center">' + dateStr + '</td>' +
          '<td class="border border-gray-300 p-2">' + product + '</td>' +
          '<td class="border border-gray-300 p-2 text-center">' + qty + '</td>' +
          '<td class="border border-gray-300 p-2 text-center">' + price + '</td>' +
        '</tr>';
      }).join('');
      tbody.innerHTML = rows;
    }

    /**
     * Apply date filter to the sales list based on selected start and end dates.
     */
    function filterSalesByDate() {
      const startInput = document.getElementById('sales-start-date');
      const endInput = document.getElementById('sales-end-date');
      const startDate = startInput && startInput.value ? new Date(startInput.value) : null;
      const endDate = endInput && endInput.value ? new Date(endInput.value) : null;
      updateSalesTable(startDate, endDate);
    }

    // Initialize sales list and attach to DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
      // Load sales from existing data if available
      try {
        loadInitialSalesList();
      } catch (e) {
        console.warn('Unable to load initial sales list', e);
      }
    });
  </script>
<!-- Additional Accounting Sections -->
<div class="mt-12 space-y-12 hidden">
<!-- General Ledger -->
<div>
<h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">๐ ุฏูุชุฑ ุงูุฃุณุชุงุฐ ุงูุนุงู</h3>
<div class="overflow-x-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-2">ุงููุตู</th>
<th class="border border-gray-300 p-2">ุงููุฏูู</th>
<th class="border border-gray-300 p-2">ุงูุฏุงุฆู</th>
<th class="border border-gray-300 p-2">ุงูุฑุตูุฏ</th>
</tr>
</thead>
<tbody id="legacy-general-ledger-table">
<tr><td class="border border-gray-300 p-4 text-center text-gray-500" colspan="5">ูุง ุชูุฌุฏ ุจูุงูุงุช ูู ุฏูุชุฑ ุงูุฃุณุชุงุฐ ุงูุนุงู</td></tr>
</tbody>
</table>
</div>
</div>
<!-- Suppliers -->
<div>
<h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">๐จโ๐ผ ุงูููุฑุฏูู</h3>
<div class="overflow-x-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงุณู ุงูููุฑุฏ</th>
<th class="border border-gray-300 p-2">ุงูุฑุตูุฏ</th>
<th class="border border-gray-300 p-2">ุขุฎุฑ ูุนุงููุฉ</th>
</tr>
</thead>
<!-- ุงุณุชุฎุฏุงู ูุนุฑู ูุฎุชูู ููุฌุฏูู ุงูููุฌูุฏ ูู ุงููุณู ุงููุฎูู ูุชุฌูุจ ุงูุชุนุงุฑุถ ูุน ุงูุฌุฏูู ุงูุฌุฏูุฏ ููููุฑุฏูู -->
<tbody id="legacy-suppliers-table">
<tr><td class="border border-gray-300 p-4 text-center text-gray-500" colspan="3">ูุง ุชูุฌุฏ ุจูุงูุงุช ููููุฑุฏูู</td></tr>
</tbody>
</table>
</div>
</div>
<!-- Customers -->
<!-- Fixed Assets -->
<!-- Treasury -->
<div>
<h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">๐ต ุงูุฎุฒููุฉ</h3>
<div class="overflow-x-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-2">ุงูุนูููุฉ</th>
<th class="border border-gray-300 p-2">ุงููุจูุบ</th>
<th class="border border-gray-300 p-2">ุงูุฑุตูุฏ ุงูุญุงูู</th>
</tr>
</thead>
<tbody id="legacy-treasury-table">
<tr><td class="border border-gray-300 p-4 text-center text-gray-500" colspan="4">ูุง ุชูุฌุฏ ูุนุงููุงุช ูู ุงูุฎุฒููุฉ</td></tr>
</tbody>
</table>
</div>
</div>
<!-- Budgets -->
<!-- Costs -->
<!-- Salaries & HR -->
</div>
<!-- Collapsible Accounting Sections -->
<div class="mt-12 space-y-6">
<!-- General Ledger -->
<div>
<!-- Toggle button -->
<button class="w-full bg-gray-100 hover:bg-gray-200 p-3 rounded-lg font-bold flex items-center justify-between mb-2" onclick="toggleAccountingSection('general-ledger-section')">
<span>๐ ุฏูุชุฑ ุงูุฃุณุชุงุฐ ุงูุนุงู</span>
<span class="ml-2">+</span>
</button>
<!-- Collapsible content -->
<div class="hidden" id="general-ledger-section">
<div class="overflow-x-auto max-h-60 overflow-y-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-2">ุงููุตู</th>
<th class="border border-gray-300 p-2">ุงููุฏูู</th>
<th class="border border-gray-300 p-2">ุงูุฏุงุฆู</th>
<th class="border border-gray-300 p-2">ุงูุฑุตูุฏ</th>
</tr>
</thead>
<tbody id="general-ledger-table">
<tr><td class="border border-gray-300 p-4 text-center text-gray-500" colspan="5">ูุง ุชูุฌุฏ ุจูุงูุงุช ูู ุฏูุชุฑ ุงูุฃุณุชุงุฐ ุงูุนุงู</td></tr>
</tbody>
</table>
</div>
</div>
</div>
<!-- Suppliers -->
<div>
<button class="w-full bg-gray-100 hover:bg-gray-200 p-3 rounded-lg font-bold flex items-center justify-between mb-2" onclick="toggleAccountingSection('suppliers-section')">
<span>๐จโ๐ผ ุงูููุฑุฏูู</span>
<span class="ml-2">+</span>
</button>
<div class="hidden" id="suppliers-section">
<div class="overflow-x-auto max-h-60 overflow-y-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงุณู ุงูููุฑุฏ</th>
<th class="border border-gray-300 p-2">ุงูุฑุตูุฏ</th>
<th class="border border-gray-300 p-2">ุขุฎุฑ ูุนุงููุฉ</th>
</tr>
</thead>
<!-- ุงูุฌุฏูู ุงูุฑุฆูุณู ููููุฑุฏูู ูู ูุณู ุงููุญุงุณุจุฉ ุงููุฑุนู - ุงุณุชุฎุฏุงู ูุนุฑู ูุฑูุฏ -->
<tbody id="accounting-suppliers-table">
<tr><td class="border border-gray-300 p-4 text-center text-gray-500" colspan="3">ูุง ุชูุฌุฏ ุจูุงูุงุช ููููุฑุฏูู</td></tr>
</tbody>
</table>
</div>
</div>
</div>
<!-- Customers -->

<!-- Fixed Assets -->
<!-- Treasury -->
<div>
<button class="w-full bg-gray-100 hover:bg-gray-200 p-3 rounded-lg font-bold flex items-center justify-between mb-2" onclick="toggleAccountingSection('treasury-section')">
<span>๐ต ุงูุฎุฒููุฉ</span>
<span class="ml-2">+</span>
</button>
<div class="hidden" id="treasury-section">
<div class="overflow-x-auto max-h-60 overflow-y-auto">
<table class="w-full border-collapse border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงูุชุงุฑูุฎ</th>
<th class="border border-gray-300 p-2">ุงูุนูููุฉ</th>
<th class="border border-gray-300 p-2">ุงููุจูุบ</th>
<th class="border border-gray-300 p-2">ุงูุฑุตูุฏ ุงูุญุงูู</th>
</tr>
</thead>
<tbody id="treasury-table">
<tr><td class="border border-gray-300 p-4 text-center text-gray-500" colspan="4">ูุง ุชูุฌุฏ ูุนุงููุงุช ูู ุงูุฎุฒููุฉ</td></tr>
</tbody>
</table>
</div>
</div>
</div>
<!-- Budgets -->
<!-- Costs -->
<!-- Salaries & HR -->
</div>
</section>
<!-- Accounts Management Section -->
<section class="section hidden" id="accounts-section">
<div class="bg-white rounded-lg shadow-lg p-6">
<h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">๐ ุฅุฏุงุฑุฉ ุญุณุงุจุงุช ุงููุณุชุฎุฏููู</h2>
<!-- Add New Account Form -->
<div class="bg-emerald-50 rounded-lg p-6 mb-6">
<h3 class="text-lg font-semibold mb-4 text-emerald-800">ุฅุถุงูุฉ ุญุณุงุจ ุฌุฏูุฏ</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงููุณุชุฎุฏู</label>
<input class="w-full p-3 border rounded-lg" id="new-username" placeholder="ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ</label>
<input class="w-full p-3 border rounded-lg" id="new-password" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ" type="password"/>
</div>
</div>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงูุงุณู ุงููุงูู</label>
<input class="w-full p-3 border rounded-lg" id="new-fullname" placeholder="ุฃุฏุฎู ุงูุงุณู ุงููุงูู" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงูุฏูุฑ ุงููุธููู</label>
<select class="w-full p-3 border rounded-lg" id="new-role">
<!-- ูุงุฆูุฉ ุงููุณููุงุช ุงููุธูููุฉ ููุญุฏุฉ ูุน ูุณู ุงูููุธููู -->
<!-- ุฃุถู ุฎูุงุฑ "ูุฏูุฑ ุงููุธุงู" ูููุณููุงุช ุงูุฎุงุตุฉ ุจุงูุญุณุงุจ ุงูุฑุฆูุณู. ูุง ููุฎุชุงุฑ ูุฐุง ุงูุฎูุงุฑ ุนุงุฏุฉ ุฅูุง ููุญุณุงุจ ุงูุฃูู. -->
<option value="">ุงุฎุชุฑ ุงููุณูู ุงููุธููู</option>
<option value="ูุฏูุฑ ุงููุธุงู">ูุฏูุฑ ุงููุธุงู</option>
<option value="ูุฏูุฑ ุชูููุฐู">ูุฏูุฑ ุชูููุฐู</option>
<option value="ูุฏูุฑ ุนุงู">ูุฏูุฑ ุนุงู</option>
<option value="ูุฏูุฑ ุชุณููู">ูุฏูุฑ ุชุณููู</option>
<option value="ูุฏูุฑ ูุดุชุฑูุงุช">ูุฏูุฑ ูุดุชุฑูุงุช</option>
<option value="ูุฏูุฑ ูุจูุนุงุช">ูุฏูุฑ ูุจูุนุงุช</option>
<option value="ูุดุฑู">ูุดุฑู</option>
<option value="ูุงุดูุฑ">ูุงุดูุฑ</option>
<option value="ูุณุฆูู ูุดุชุฑูุงุช">ูุณุฆูู ูุดุชุฑูุงุช</option>
<option value="ูุญุงุณุจ">ูุญุงุณุจ</option>
<option value="ุงููู ุฎุฒูุฉ">ุงููู ุฎุฒูุฉ</option>
<option value="ูุณุคู ุชุณููู">ูุณุคู ุชุณููู</option>
<option value="ุงููู ูุฎุฒู">ุงููู ูุฎุฒู</option>
<option value="ุจุงุฆุน">ุจุงุฆุน</option>
<option value="ุณุงุฆู">ุณุงุฆู</option>
</select>
</div>
</div>
</div>
<!-- Permissions Section -->
<div class="mt-6">
<h4 class="text-md font-semibold mb-3 text-gray-700">ุงูุตูุงุญูุงุช</h4>
<div class="grid grid-cols-2 md:grid-cols-3 gap-3">
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-sales" type="checkbox"/>
<!-- ุงุณุชุฎุฏู ููุณ ุชุณููุฉ ุงููุณู ูู ุดุฑูุท ุงูุชููู -->
<span class="text-sm">๐ฐ ูุงุชูุฑุฉ ุงูุจูุน</span>
</label>
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-purchases" type="checkbox"/>
<span class="text-sm">๐ ุงููุดุชุฑูุงุช</span>
</label>
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-inventory" type="checkbox"/>
<span class="text-sm">๐ฆ ุงููุฎุฒูู</span>
</label>
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-employees" type="checkbox"/>
<span class="text-sm">๐ฅ ุงูููุธููู</span>
</label>
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-invoices" type="checkbox"/>
<span class="text-sm">๐ ุงูููุงุชูุฑ</span>
</label>
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-customers" type="checkbox"/>
<span class="text-sm">๐ค ุงูุนููุงุก</span>
</label>
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-accounting" type="checkbox"/>
<span class="text-sm">๐ ุงููุญุงุณุจุฉ</span>
</label>
<!-- ุตูุงุญูุฉ ุงูุฎุตููุงุช -->
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-discounts" type="checkbox"/>
<span class="text-sm">๐ธ ุงูุฎุตููุงุช</span>
</label>
<!-- ุตูุงุญูุฉ ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช -->
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-accounts" type="checkbox"/>
<span class="text-sm">๐ ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช</span>
</label>
<!-- ุตูุงุญูุฉ ุงููุฑุชุฌุนุงุช: ูููู ูููุณุชุฎุฏููู ุงูุฐูู ูุฏููู ูุฐู ุงูุตูุงุญูุฉ ุฑุคูุฉ ูุณู ุงููุฑุชุฌุนุงุช -->
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-returns" type="checkbox"/>
<span class="text-sm">๐ ุงููุฑุชุฌุนุงุช</span>
</label>

                <!-- ุตูุงุญูุฉ ูุจูุนุงุช ุงููุณุชุฎุฏู: ุชุณูุญ ูููุณุชุฎุฏู ุจุฑุคูุฉ ูุณู ูุจูุนุงุช ุงููุณุชุฎุฏู -->
                <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                  <input class="rounded" id="perm-user-sales" type="checkbox"/>
                  <span class="text-sm">๐ค๐ผ ูุจูุนุงุช ุงููุณุชุฎุฏู</span>
                </label>
<!-- ุตูุงุญูุฉ ุงูุฅุนุฏุงุฏุงุช: ูููู ูููุณุชุฎุฏููู ุงูุฐูู ูุฏููู ูุฐู ุงูุตูุงุญูุฉ ุฑุคูุฉ ูุณู ุงูุฅุนุฏุงุฏุงุช -->
<label class="flex items-center space-x-2 bg-white p-3 rounded border">
<input class="rounded" id="perm-settings" type="checkbox"/>
<span class="text-sm">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</span>
</label>
</div>
</div>
<div class="mt-6 flex gap-3">
<button class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-medium" onclick="addNewAccount()"> โ ุฅุถุงูุฉ ุงูุญุณุงุจ </button>
<button class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium" onclick="clearAccountForm()"> ๐ ูุณุญ ุงููููุฐุฌ </button>
</div>
</div>
<!-- Current Accounts Table -->
<div class="bg-gray-50 rounded-lg p-6">
<h3 class="text-lg font-semibold mb-4 text-gray-800">ุงูุญุณุงุจุงุช ุงูุญุงููุฉ</h3>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
<div class="bg-emerald-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-emerald-600" id="total-accounts">1</div>
<div class="text-sm text-gray-600">ุฅุฌูุงูู ุงูุญุณุงุจุงุช</div>
</div>
<div class="bg-green-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-green-600" id="active-accounts">1</div>
<div class="text-sm text-gray-600">ุญุณุงุจุงุช ูุดุทุฉ</div>
</div>
<div class="bg-purple-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-purple-600" id="admin-accounts">1</div>
<div class="text-sm text-gray-600">ูุฏูุฑูู</div>
</div>
<div class="bg-orange-50 p-4 rounded-lg text-center">
<div class="text-2xl font-bold text-orange-600" id="employee-accounts">0</div>
<div class="text-sm text-gray-600">ููุธููู</div>
</div>
</div>
<div class="overflow-x-auto overflow-y-auto max-h-60">
<table class="w-full border-collapse border border-gray-300 bg-white">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-3">ุงุณู ุงููุณุชุฎุฏู</th>
<th class="border border-gray-300 p-3">ุงูุงุณู ุงููุงูู</th>
<th class="border border-gray-300 p-3">ูููุฉ ุงููุฑูุฑ</th>
<th class="border border-gray-300 p-3">ุงูุฏูุฑ</th>
<th class="border border-gray-300 p-3">ุงูุตูุงุญูุงุช</th>
<th class="border border-gray-300 p-3">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
<th class="border border-gray-300 p-3">ุงูุญุงูุฉ</th>
<th class="border border-gray-300 p-3">ุฅุฌุฑุงุกุงุช</th>
</tr>
</thead>
<tbody id="accounts-list">
<!-- Default accounts will be populated here -->
</tbody>
</table>
</div>
<!-- Login Sessions Section -->
<div class="bg-gray-50 rounded-lg p-6 mt-6">
<h3 class="text-lg font-semibold mb-4 text-gray-800">๐ ุณุฌู ุชุณุฌููุงุช ุงูุฏุฎูู</h3>
<div class="overflow-x-auto">
<div class="max-h-40 overflow-y-auto">
<table class="w-full border-collapse border border-gray-300 bg-white">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงุณู ุงููุณุชุฎุฏู</th>
<th class="border border-gray-300 p-2">ุงูุงุณู ุงููุงูู</th>
<th class="border border-gray-300 p-2">ููุช ุงูุฏุฎูู</th>
<th class="border border-gray-300 p-2">ููุช ุงูุฎุฑูุฌ</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-200" id="login-history-list">
</tbody>
</table>
</div>
</div>
<h3 class="text-lg font-semibold mt-6 mb-4 text-gray-800">๐ข ุงูุญุณุงุจุงุช ุงููุดุทุฉ ุญุงููุงู</h3>
<div class="overflow-x-auto">
<div class="max-h-40 overflow-y-auto">
<table class="w-full border-collapse border border-gray-300 bg-white">
<thead class="bg-gray-100">
<tr>
<th class="border border-gray-300 p-2">ุงุณู ุงููุณุชุฎุฏู</th>
<th class="border border-gray-300 p-2">ุงูุงุณู ุงููุงูู</th>
<th class="border border-gray-300 p-2">ููุช ุงูุฏุฎูู</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-200" id="active-sessions-list">
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</section>
</main>
<!-- Settings Section -->
<section class="section hidden" id="settings-section">
  <div class="bg-white rounded-lg shadow-lg p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Discount Password Settings -->
      <div class="space-y-4">
        <h3 class="text-lg font-semibold mb-2">ูููุฉ ูุฑูุฑ ุงูุฎุตู</h3>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ</label>
          <input type="password" id="current-discount-password" class="w-full p-3 border rounded-lg" placeholder="โขโขโขโขโขโข">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
          <input type="password" id="new-discount-password" class="w-full p-3 border rounded-lg" placeholder="โขโขโขโขโขโข">
        </div>
        <button onclick="updateDiscountPassword()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">ุญูุธ ูููุฉ ูุฑูุฑ ุงูุฎุตู</button>
      </div>
      <!-- Manager Password Settings -->
      <div class="space-y-4">
        <h3 class="text-lg font-semibold mb-2">ูููุฉ ูุฑูุฑ ูุฏูุฑ ุงููุธุงู</h3>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ</label>
          <input type="password" id="current-manager-password" class="w-full p-3 border rounded-lg" placeholder="โขโขโขโขโขโข">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
          <input type="password" id="new-manager-password" class="w-full p-3 border rounded-lg" placeholder="โขโขโขโขโขโข">
        </div>
        <button onclick="updateManagerPassword()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">ุญูุธ ูููุฉ ูุฑูุฑ ุงููุฏูุฑ</button>
      </div>
    </div>
  </div>
</section>
<!-- Footer -->
<footer class="bg-gray-800 text-white py-4 sm:py-6 mt-6 sm:mt-8">
  <div class="container mx-auto text-center px-4">
    <!-- Developer credit with modern, thin typography and no icons -->
    <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-2 mb-2">
      <span class="text-sm sm:text-lg font-light tracking-wide">Developed By Ibrahim&nbsp;Al&nbsp;Sharkawi</span>
    </div>
    <!-- WhatsApp contact with custom icon (whats.webp) -->
    <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-2 mb-3">
      <a class="text-green-400 hover:text-green-300 font-medium transition-colors text-sm sm:text-base flex items-center gap-2" href="https://wa.me/201004287432" rel="noopener noreferrer" target="_blank">
        <img src="whats.webp" alt="WhatsApp" class="inline-block w-5 h-5 sm:w-6 sm:h-6">
        <span class="whitespace-nowrap">01004287432</span>
      </a>
    </div>
    <p class="text-gray-400 text-xs sm:text-sm">ูุธุงู ุฅุฏุงุฑุฉ ุงูุฃุนูุงู ุงููุชูุงูู - Solution ERP</p>
    <p class="text-gray-500 text-xs mt-2">ยฉ 2025 ุฌููุน ุงูุญููู ูุญููุธุฉ</p>
  </div>
</footer>
</div>
<!-- Print Area -->
<div class="print-area">
<div id="print-content"></div>
</div>
<!-- Loading Overlay -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="loading-overlay">
<div class="bg-white p-6 rounded-lg">
<div class="flex items-center space-x-3">
<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-emerald-600"></div>
<span>ุฌุงุฑู ุงูุญูุธ...</span>
</div>
</div>
</div>
<script>
  // Global variables
  let currentInvoiceItems = [];
  let allData = [];
  // ูุตูููุฉ ูุชุฎุฒูู ุฌูุณุงุช ุชุณุฌูู ุงูุฏุฎูู. ูู ุนูุตุฑ ูุญุชูู ุนูู ุงุณู ุงููุณุชุฎุฏูุ ุงูุงุณู ุงููุงููุ ููุช ุงูุฏุฎูู ูููุช ุงูุฎุฑูุฌ
  // ูุชู ุชุญููููุง ูู Firebase ุนูุฏ ุชููุฆุฉ ุงููุธุงูุ ููุชู ุชุญุฏูุซูุง ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู ุฃู ุงูุฎุฑูุฌ
  let loginSessions = [];
  let isLoading = false;
  let selectedProduct = null;
  let isLoggedIn = false;
  // Pending invoices loaded from the database. We no longer rely on
  // localStorage for persistence โ everything is saved in Firebase.
  let pendingInvoices = [];

  /*
   * Local backup helpers
   *
   * The ERP was designed to use Firebase as the single source of truth for
   * all data. In practice there are scenarios where the application
   * cannot reach Firebase at runtime (e.g. offline usage, network
   * restrictions or misconfigured security rules). In the original
   * implementation this meant that any newly added purchases, sales or
   * employee records would be lost once the page was closed because
   * they never reached the cloud. To mitigate this, a lightweight
   * fallback mechanism is provided. Whenever data is saved to
   * Firebase, a copy of the unified `allData` array is serialized
   * into `localStorage` under the key `erpAllDataBackup`. When
   * loading data from Firebase fails, or no data exists on the
   * server, the system will attempt to restore this backup so that
   * the user does not lose their work. This backup is automatically
   * updated whenever a save occurs and is transparently restored
   * during initialization or on load failures.
   */
  function saveLocalBackup() {
    try {
      const json = JSON.stringify(allData);
      localStorage.setItem('erpAllDataBackup', json);
      return true;
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุงููุญููุฉ:', err);
      return false;
    }
  }

  function loadLocalBackup() {
    try {
      const json = localStorage.getItem('erpAllDataBackup');
      if (!json) return false;
      const data = JSON.parse(json);
      if (Array.isArray(data)) {
        allData = data;
        return true;
      }
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุงุณุชุฑุฌุงุน ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุงููุญููุฉ:', err);
    }
    return false;
  }

  //
  // ๐ ุงุณุชุฑุฌุงุน ุงูุนูู ุนูู localStorage
  //
  // ุชู ุณุงุจููุง ุชุนุทูู localStorage ุชูุงููุง ูููุน ุงุณุชุฎุฏุงููุ ุงุนุชูุงุฏูุง ุนูู
  // Firebase ููุตุฏุฑ ูุญูุฏ ููุจูุงูุงุช. ููู ูู ุจุนุถ ุงูุจูุฆุงุช ูุฏ ูุง ุชููู
  // ูุงุนุฏุฉ Firebase ูุชุงุญุฉ (ูุซู ุงูุนูู ุจุฏูู ุงุชุตุงู ุจุงูุฅูุชุฑูุช)ุ ููุง ูุคุฏู
  // ุฅูู ููุฏุงู ุงูุจูุงูุงุช ุนูุฏ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ. ูุฐูู ุชูุช ุฅุนุงุฏุฉ ุชูุนูู
  // localStorage ูุน ุงุณุชุฎุฏุงูู ููุณุฎุฉ ุงุญุชูุงุทูุฉ. ุฅุฐุง ุชุนุฐุฑ ุงูุงุชุตุงู ุจู Firebase
  // ุณูุชู ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุฎุฒูุฉ ูุญูููุง ุนูุฏ ุงูุชุญููู. ูุนูุฏ ุงูุญูุธ
  // ุณูุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู localStorage ุฅูู ุฌุงูุจ ุญูุธ ุงูุจูุงูุงุช ูู Firebase.
  
  // Default configuration
  const defaultConfig = {
    company_name: "ูุธุงู ุฅุฏุงุฑุฉ ุงูุฃุนูุงู ุงููุชูุงูู",
    system_title: "Solution ERP"
  };
  
  // User credentials
  let users = {
    'ibrahim': { 
      password: '123456',
      role: 'ูุฏูุฑ ุงููุธุงู',
      fullName: 'ุฅุจุฑุงููู ุงูุดุฑูุงูู',
      // Include the user-sales permission for the default administrator so they
      // can access the user sales report without additional configuration.
      permissions: ['sales', 'purchases', 'inventory', 'employees', 'invoices', 'customers', 'accounts', 'discounts', 'accounting', 'returns', 'settings', 'user-sales'],
      createdAt: '2024-01-01',
      status: 'ูุดุท'
    }
  };
  
  let currentUser = null;
  // Global security settings.  These values will be loaded from Firebase
  // upon login. They define the passwords required for adding a discount
  // and for modifying the primary administrator account (ibrahim).  If
  // Firebase does not have stored settings, these defaults will be used.
  window.securitySettings = {
    discountPassword: '123456',
    managerPassword: '123456'
  };

  /**
   * Load security settings (discount and manager passwords) from Firebase.
   * If the erpSecurity node does not exist or an error occurs, fallback
   * to the default values defined above.  These settings are stored on
   * window.securitySettings so that other functions can reference them.
   */
  async function loadSecuritySettings() {
    try {
      const snap = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpSecurity'));
      if (snap.exists()) {
        const data = snap.val() || {};
        // Merge loaded values with defaults to ensure missing keys are filled
        window.securitySettings = {
          discountPassword: data.discountPassword || window.securitySettings.discountPassword,
          managerPassword: data.managerPassword || window.securitySettings.managerPassword
        };
      } else {
        // No settings saved yet; keep defaults
        console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ูู Firebase. ุณูุชู ุงุณุชุฎุฏุงู ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ.');
      }
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ูู Firebase:', err);
      // Keep defaults on error
    }
  }

  /**
   * Save the current security settings to Firebase.  This writes the
   * discountPassword and managerPassword properties to the erpSecurity
   * node.  If the save succeeds, a success message is shown; on error,
   * an error message is displayed.
   */
  async function saveSecuritySettings() {
    try {
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpSecurity'), window.securitySettings);
      showMessage('โ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ุจูุฌุงุญ', 'success');
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุฃูุงู:', err);
      showMessage('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุฅุนุฏุงุฏุงุช', 'error');
    }
  }

  // Flag to track whether the user has explicitly clicked the "ุฎุฑูุฌ" button.
  // If true, the beforeunload handler will skip logging out automatically.
  let manualLogout = false;
  
  // Save data to Firebase.  Each ERP module is persisted under its
  // own key (e.g. `erpPurchases`, `erpSales`, `erpInvoices`) rather
  // than storing everything in a single `erpData` object.  User
  // accounts are stored under `erpAccounts`.  This function replaces
  // the old localStorage implementation and ensures that the ERP
  // database is organized by section (ูุงุชูุฑุฉ ุงูุจูุนุ ุงููุดุชุฑูุงุชุ
  // ุงููุฎุฒููุ ุงููุญุงุณุจุฉุ ุงูุนููุงุกุ ุงูููุงุชูุฑุ ุงูุฎุตููุงุชุ ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุชุ
  // ุงูููุธููู).
  /**
   * Persist ERP data to Firebase in a structured format.  Instead of
   * saving the entire `allData` array under one key, this function
   * categorizes records by their type (purchases, sales, invoices,
   * discounts, expenses, employees) and writes each category to its
   * own dedicated Firebase node (erpPurchases, erpSales, etc.).  It
   * also computes aggregate lists for customers and inventory so that
   * these sections can be retrieved independently from the raw
   * transaction data.  User accounts continue to be saved separately
   * under the `erpAccounts` key.
   */
async function saveDataToFirebase() {
    try {
      // Separate the unified allData array into specific categories
      const purchases = [];
      const sales = [];
      const invoices = [];
      const discounts = [];
      const expenses = [];
      const employees = [];
      const returnsArr = [];

      // Iterate once over allData to distribute records into
      // appropriate buckets.  Unknown types are ignored so that
      // extensions of the system won't break the save process.
      for (const item of allData) {
        switch (item.type) {
          case 'purchase':
            purchases.push(item);
            break;
          case 'sale':
            sales.push(item);
            break;
          case 'invoice':
            invoices.push(item);
            break;
          case 'discount':
            discounts.push(item);
            break;
          case 'expense':
            expenses.push(item);
            break;
          case 'employee':
            employees.push(item);
            break;
          case 'return':
            returnsArr.push(item);
            break;
          default:
            // Skip any unknown types quietly
            break;
        }
      }

      // Build a customers list from invoice records.  Each customer
      // aggregates totals across their invoices so the customers
      // section can show how much each client has spent and paid.
      const customersMap = {};
      for (const invoice of invoices) {
        const code = invoice.customer_code || invoice.customer_name;
        if (!customersMap[code]) {
          customersMap[code] = {
            customer_name: invoice.customer_name,
            customer_code: invoice.customer_code || '',
            total_purchases: 0,
            total_payments: 0,
            total_remaining: 0
          };
        }
        customersMap[code].total_purchases += invoice.total || 0;
        customersMap[code].total_payments += invoice.payment_amount || 0;
        customersMap[code].total_remaining += invoice.remaining_amount || 0;
      }
      const customers = Object.values(customersMap);

      // -------------------------------------------------------------------------
      // ๐ฅ Merge manual customers into the aggregated customer list
      //
      // When invoices are saved, the customers list is built purely from the
      // invoice records.  However, users can also add customers manually from
      // the customer management section.  These manually added customers may
      // not have any associated invoices yet, so they won't appear in the
      // invoice-derived list.  To ensure they are included in the saved
      // erpCustomers node, iterate over window.manualCustomers (if defined)
      // and push any entries that don't already exist in the customers array.
      try {
        if (Array.isArray(window.manualCustomers)) {
          window.manualCustomers.forEach((c) => {
            if (!c) return;
            const code = c.code || c.customer_code || '';
            const name = c.name || c.customer_name || '';
            // Determine if this customer already exists in the computed list.
            const exists = customers.some(function(item) {
              return (
                (code && item.customer_code && String(item.customer_code) === String(code)) ||
                (!code && item.customer_name && String(item.customer_name).trim() === String(name).trim())
              );
            });
            if (!exists) {
              customers.push({
                customer_name: name,
                customer_code: code,
                total_purchases: 0,
                total_payments: 0,
                total_remaining: 0
              });
            }
          });
        }
      } catch (manErr) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุถุงูุฉ ุงูุนููุงุก ุงููุฏูููู ุฅูู ูุงุฆูุฉ ุงูุนููุงุก ุฃุซูุงุก ุงูุญูุธ:', manErr);
      }

      // Compute the latest inventory snapshot based on all purchase and
      // sale records.  This relies on the existing calculateInventory()
      // helper which reads from `allData` to generate a list of
      // inventory items.  If calculateInventory returns null or
      // undefined, default to an empty array.
      let inventorySnapshot = [];
      try {
        const inv = calculateInventory();
        if (Array.isArray(inv)) {
          inventorySnapshot = inv;
        }
      } catch (calcErr) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุญุณุงุจ ุงููุฎุฒูู ุฃุซูุงุก ุงูุญูุธ:', calcErr);
      }

      /*
       * Persist each ERP category into its own Firebase node.  The
       * system previously stored everything under a single `erpData`
       * object, but saving each section separately makes it easier
       * to query and manage data by module (ูุงุชูุฑุฉ ุงูุจูุนุ ุงููุดุชุฑูุงุชุ
       * ุงููุฎุฒููุ ุงููุญุงุณุจุฉุ ุงูุนููุงุกุ ุงูููุงุชูุฑุ ุงูุฎุตููุงุชุ ุฅุฏุงุฑุฉ
       * ุงูุญุณุงุจุงุชุ ุงูููุธููู).  These nodes are:
       *   - erpPurchases: ุฌููุน ุณุฌูุงุช ุงููุดุชุฑูุงุช
       *   - erpSales:     ุฌููุน ุนูููุงุช ุงูุจูุน ุงููุฑุฏูุฉ (Line items)
       *   - erpInvoices:  ุงูููุงุชูุฑ ุงููุฌููุนุฉ
       *   - erpDiscounts: ุงูุฎุตููุงุช
       *   - erpAccounting: ุงููุตุฑููุงุช
       *   - erpEmployees: ุงูููุธููู
       *   - erpCustomers: ุงูุนููุงุก
       *   - erpInventory: ุงููุฎุฒูู ุงูุญุงูู
       *   - erpAccounts:  ุญุณุงุจุงุช ุงููุณุชุฎุฏููู (ูุณู ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช)
       */
      // Persist each ERP section by accumulating promises and awaiting them together.
      // This ensures that the save operation finishes writing data to Firebase before
      // syncWithCloud() reloads data.  If any write fails, the error is logged
      // but does not halt the remainder of the writes.
      const savePromises = [];
      // Purchases
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpPurchases'), purchases).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุดุชุฑูุงุช ูู ูุณุงุฑ erpPurchases:', err);
        })
      );
      // Sales
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpSales'), sales).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุจูุนุงุช ูู ูุณุงุฑ erpSales:', err);
        })
      );
      // Invoices
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpInvoices'), invoices).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูููุงุชูุฑ ูู ูุณุงุฑ erpInvoices:', err);
        })
      );
      // Discounts
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpDiscounts'), discounts).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุฎุตููุงุช ูู ูุณุงุฑ erpDiscounts:', err);
        })
      );
      // Accounting / expenses
      // Firebase does not store arrays with numeric indexes reliably; deleted
      // entries can reappear as nulls or objects with holes.  To ensure
      // deterministic storage and deletion, convert the expenses array into
      // an object keyed by the expense id.  When loading, this object is
      // converted back into an array in loadDataFromFirebase().
      const expensesObject = {};
      for (const exp of expenses) {
        // Skip expenses without an id to avoid overwriting the object key
        if (exp && exp.id) {
          expensesObject[exp.id] = exp;
        }
      }
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpAccounting'), expensesObject).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุตุฑููุงุช ูู ูุณุงุฑ erpAccounting:', err);
        })
      );
      // Employees
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpEmployees'), employees).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูููุธููู ูู ูุณุงุฑ erpEmployees:', err);
        })
      );
      // Returns
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpReturns'), returnsArr).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุฑุชุฌุนุงุช ูู ูุณุงุฑ erpReturns:', err);
        })
      );
      // Customers (full metadata)
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpCustomers'), customers).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุนููุงุก ูู ูุณุงุฑ erpCustomers:', err);
        })
      );
      // Inventory snapshot
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpInventory'), inventorySnapshot).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุฎุฒูู ูู ูุณุงุฑ erpInventory:', err);
        })
      );
      // User accounts
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpAccounts'), users).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุญุณุงุจุงุช ุงููุณุชุฎุฏููู ูู ูุณุงุฑ erpAccounts:', err);
        })
      );

      // Login sessions
      // ูุชู ุญูุธ ุณุฌู ุงูุฌูุณุงุช ูู ูุณุงุฑ ูุณุชูู erpSessions ุจุญูุซ ูููู ุชุชุจุน
      // ุฃููุงุช ุงูุฏุฎูู ูุงูุฎุฑูุฌ ููู ุญุณุงุจ. ุฅุฐุง ูุดู ุงูุญูุธ ููุณุฌู ุงูุชุญุฐูุฑ
      // ููุง ูููู ุจุงูู ุนูููุงุช ุงูุญูุธ.
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpSessions'), loginSessions).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุณุฌูุงุช ุงูุฌูุณุงุช ูู ูุณุงุฑ erpSessions:', err);
        })
      );

      // Also update the legacy `erpData` node for backward compatibility.
      // The legacy structure groups records under a single object with
      // properties like `purchases`, `sales`, etc.  Updating this node
      // ensures older versions of the system can still read the latest
      // records and prevents duplication or data loss when both
      // structures coexist.
      const legacyDataToSave = {
        purchases: purchases,
        sales: sales,
        invoices: invoices,
        discounts: discounts,
        expenses: expenses,
        employees: employees
      };
      savePromises.push(
        window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpData'), legacyDataToSave).catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูุนูุฏุฉ ุงููุฏููุฉ erpData ุฃุซูุงุก ุงูุญูุธ:', err);
        })
      );
      // -------------------------------------------------------------------------
      // ๐ Additionally persist a list of customer names separately.
      // Build a deduplicated array of customer names sourced from both manual
      // customers (stored on window.manualCustomers) and the invoice-derived
      // customers list constructed above.  Saving this list to its own
      // Firebase node makes it easy for external systems to fetch just the
      // names of clients without additional metadata.  Any error during this
      // process is logged and does not interrupt the rest of the save.
      // -------------------------------------------------------------------------
      try {
        const nameSet = new Set();
        if (Array.isArray(window.manualCustomers)) {
          window.manualCustomers.forEach(function(c) {
            if (c && c.name) {
              nameSet.add(String(c.name).trim());
            }
          });
        }
        if (Array.isArray(customers)) {
          customers.forEach(function(c) {
            if (c && c.customer_name) {
              nameSet.add(String(c.customer_name).trim());
            }
          });
        }
        const customerNames = Array.from(nameSet);
        savePromises.push(
          window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpCustomerNames'), customerNames).then(() => {
            console.log('๐ ุชู ุญูุธ ูุงุฆูุฉ ุฃุณูุงุก ุงูุนููุงุก ูู ูุณุงุฑ erpCustomerNames');
          }).catch(err => {
            console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ูุงุฆูุฉ ุฃุณูุงุก ุงูุนููุงุก ูู ูุณุงุฑ erpCustomerNames:', err);
          })
        );
      } catch (nameErr) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅูุดุงุก ูุงุฆูุฉ ุฃุณูุงุก ุงูุนููุงุก ููุญูุธ ูู ูุณุงุฑ erpCustomerNames:', nameErr);
      }
      // Wait for all save operations to finish and determine if any succeeded.
      // Using Promise.allSettled allows us to inspect individual results and
      // decide whether at least one write to Firebase succeeded.  If none of
      // the operations succeeded (e.g. because there is no network
      // connectivity), the function will throw an error to notify callers.
      const results = await Promise.allSettled(savePromises);
      const anyFulfilled = results.some(r => r.status === 'fulfilled');
      if (!anyFulfilled) {
        // If no Firebase writes succeeded, throw an error so callers
        // can handle the failure appropriately.  Local backups are disabled.
        throw new Error('Firebase save operations failed');
      }
      console.log('๐พ ุชู ุญูุธ ูู ูุณู ูู Firebase ุจุดูู ูููุตู');
      // ุจุนุฏ ูุฌุงุญ ุนูููุฉ ุงูุญูุธ ุนูู ุงูุฃููุ ูุง ูุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุญููุฉ ุญูุซ ุชู ุชุนุทูู localStorage.

      // ุจุนุฏ ุญูุธ ุงูุฃูุณุงูุ ุงุญูุธ ุงูููุงุชูุฑ ุงููุนููุฉ ูู ูุณุงุฑ ูุณุชูู. ูุฐุง
      // ูุณูุญ ุจุงุณุชุฑุฌุงุนูุง ุจูู ุงูุฌูุณุงุช.  ูุง ูุคุซุฑ ุฃู ุฎุทุฃ ูู ุญูุธ
      // ุงูููุงุชูุฑ ุงููุนููุฉ ุนูู ุนูููุฉ ุงูุญูุธ ุงูุฑุฆูุณูุฉ.
      if (typeof saveSuspendedInvoices === 'function') {
        try {
          await saveSuspendedInvoices();
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูููุงุชูุฑ ุงููุนููุฉ ุถูู ุนูููุฉ ุงูุญูุธ ุงูุนุงูุฉ:', err);
        }
      }

      // ูุง ุชุนุชูุฏ ุนูู Firebase ูุญุฏู ููุตุฏุฑ ููุจูุงูุงุชุ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
      // ุงููุญููุฉ ุชูุณุชุฎุฏู ุนูุฏ ุงูุญุงุฌุฉ ูุถูุงู ุชุฒุงูู ุงูุจูุงูุงุช ุญุชู ุนูุฏ
      // ุงูุนูู ุจุฏูู ุงุชุตุงู.
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ูู Firebase:', error);
      // ุนูุฏ ูุดู ุงูุญูุธ ูู ูุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุญููุฉ ูุฃู ุงูุชุฎุฒูู ุงููุญูู ูุนุทู.
    }
  }
  
  // Load data from Firebase. This function reads persisted ERP data and
  // user accounts from Firebase, then merges them into the local
  // variables. It is asynchronous because database operations return
  // promises.
async function loadDataFromFirebase() {
    try {
      /*
       * Load each ERP section from its dedicated Firebase node.  If these
       * nodes do not exist (for example, when migrating from an older
       * unified structure), fall back to the previous `erpData` object
       * loader.  After loading, merge the relevant arrays into
       * allData so the rest of the system operates on a unified
       * dataset.  Skip the customers and inventory categories here
       * because they are computed dynamically.
       */
      let hasSeparateNodes = false;
      const sectionNames = {
        purchases: 'erpPurchases',
        sales: 'erpSales',
        invoices: 'erpInvoices',
        discounts: 'erpDiscounts',
        expenses: 'erpAccounting',
        employees: 'erpEmployees',
        returns: 'erpReturns'
      };
      const loadedSections = {};
      // Attempt to load each section individually
      for (const [key, path] of Object.entries(sectionNames)) {
        try {
          const snap = await window.firebaseGet(window.firebaseRef(window.firebaseDB, path));
          if (snap.exists()) {
            hasSeparateNodes = true;
            loadedSections[key] = snap.val() || [];
          }
        } catch (err) {
          console.warn(`โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ูุณู ${key} ูู Firebase:`, err);
        }
      }
      if (hasSeparateNodes) {
        // Combine the loaded sections into allData
        allData = [];
        Object.keys(sectionNames).forEach(cat => {
          const arr = loadedSections[cat];
          // Firebase may return arrays as objects with numeric keys.  Convert
          // such objects back into arrays so that expense, purchase, etc.
          // records are not dropped during loading.
          if (Array.isArray(arr)) {
            allData.push(...arr);
          } else if (arr && typeof arr === 'object') {
            allData.push(...Object.values(arr));
          }
        });
        // Normalize expense records so that numeric fields are numbers.  When
        // reading from Firebase, expense.amount may be stored as a string.
        allData.forEach((record) => {
          if (record && record.type === 'expense') {
            const parsed = parseFloat(record.amount);
            record.amount = isNaN(parsed) ? 0 : parsed;
          }
        });
        console.log('๐ ุชู ุชุญููู ุงูุจูุงูุงุช ูู Firebase (ุตูุบุฉ ูููุตูุฉ):', allData.length, 'ุนูุตุฑ');
      } else {
        /*
         * ๐งญ Fallback to the legacy `erpData` format when separate nodes
         * (erpPurchases, erpSales, etc.) do not exist.  Many older
         * installations store all ERP records under a single `erpData`
         * object with subโarrays like `purchases`, `expenses`, etc.
         * Without this fallback, allData would be empty and previously
         * saved records would disappear from the interface.  Loading
         * from erpData preserves these records and allows the system
         * to migrate them to the new structure on the next save.
         */
        allData = [];
        try {
          const legacySnap = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpData'));
          if (legacySnap.exists()) {
            const legacyData = legacySnap.val() || {};
            // List of known arrays in the legacy structure
        const legacyKeys = ['purchases', 'sales', 'invoices', 'discounts', 'expenses', 'employees', 'returns'];
            legacyKeys.forEach(key => {
              const dataArr = legacyData[key];
              if (!dataArr) return;
              if (Array.isArray(dataArr)) {
                allData.push(...dataArr);
              } else if (typeof dataArr === 'object') {
                allData.push(...Object.values(dataArr));
              }
            });
            // Ensure each record has a type property.  Legacy records may
            // omit the type or have it under a different key.  Assign
            // based on the legacy key if missing.
            allData.forEach((record) => {
              if (!record || typeof record !== 'object') return;
              if (!record.type) {
                // Derive type based on the presence of purchase_price/sale_price
                if (record.hasOwnProperty('purchase_price')) {
                  record.type = 'purchase';
                } else if (record.hasOwnProperty('sale_price')) {
                  record.type = 'sale';
                } else if (record.hasOwnProperty('amount') && record.hasOwnProperty('expense_type')) {
                  record.type = 'expense';
                }
              }
              // Normalize expense amounts to numbers
              if (record.type === 'expense') {
                const parsed = parseFloat(record.amount);
                record.amount = isNaN(parsed) ? 0 : parsed;
              }
            });
            console.log('๐ ุชู ุชุญููู ุงูุจูุงูุงุช ูู Firebase (erpData):', allData.length, 'ุนูุตุฑ');
            // After loading legacy data, persist it into the new nodes so that
            // subsequent loads will use the new structure.  This migration
            // runs once and errors are logged without stopping the loading.
            try {
              await saveDataToFirebase();
              console.log('๐ ุชู ุชุฑุญูู ุงูุจูุงูุงุช ุงููุฏููุฉ ุฅูู ุงููููู ุงูุฌุฏูุฏ (erpPurchases ูุบูุฑูุง)');
            } catch (migErr) {
              console.warn('โ๏ธ ุชุนุฐุฑ ุชุฑุญูู ุงูุจูุงูุงุช ูู ุงููููู ุงููุฏูู ุฅูู ุงูุฌุฏูุฏ:', migErr);
            }
          } else {
            console.log('๐ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃูุณุงู ูููุตูุฉ ุฃู ูููู erpData ูู Firebaseุ ุชู ุงูุชููุฆุฉ ุจูุตูููุฉ ูุงุฑุบุฉ.');
          }
        } catch (legacyErr) {
          console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ูุญุงููุฉ ุชุญููู ุงููููู ุงููุฏูู erpData ูู Firebase:', legacyErr);
        }
      }

      // Load user accounts from the new erpAccounts node.  If it doesn't
      // exist, fall back to the old erpUsers path.
      let accountsLoaded = false;
      try {
        const accountsSnapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpAccounts'));
        if (accountsSnapshot.exists()) {
          const loadedUsers = accountsSnapshot.val() || {};
          users = { ...users, ...loadedUsers };
          accountsLoaded = true;
          console.log('๐ค ุชู ุชุญููู ุญุณุงุจุงุช ุงููุณุชุฎุฏููู ูู Firebase (erpAccounts)');
        }
      } catch (err) {
        console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุญุณุงุจุงุช ุงููุณุชุฎุฏููู ูู erpAccounts:', err);
      }
      if (!accountsLoaded) {
        // Fallback to old key
        const usersSnapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpUsers'));
        if (usersSnapshot.exists()) {
          const loadedUsers = usersSnapshot.val() || {};
          users = { ...users, ...loadedUsers };
          console.log('๐ค ุชู ุชุญููู ุงููุณุชุฎุฏููู ูู Firebase (erpUsers)');
        }

      }

      // -------------------------------------------------------------------
      // ๐ ุชุญููู ุณุฌู ุฌูุณุงุช ุงูุฏุฎูู
      // ูุชู ุชุญููู ุงููุตูููุฉ ุงููุญููุธุฉ ูู ุงููุณุงุฑ erpSessions ุฅูู
      // ุงููุชุบูุฑ loginSessions. ุฅุฐุง ูู ููุฌุฏ ุงููุณุงุฑุ ุชูุชุฑู
      // loginSessions ููุง ูู ุจุฏูู ุชุนุฏูู.
      try {
        const sessionsSnapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpSessions'));
        if (sessionsSnapshot.exists()) {
          const loadedSessions = sessionsSnapshot.val() || [];
          // ุงุญุฑุต ุนูู ุฃู ุชููู ุงููุตูููุฉ ุจูุง undefined
          loginSessions = Array.isArray(loadedSessions) ? loadedSessions.filter(x => x) : [];
          console.log('๐ ุชู ุชุญููู ุณุฌู ุงูุฌูุณุงุช ูู Firebase');
        }
      } catch (err) {
        console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุณุฌูุงุช ุงูุฌูุณุงุช ูู Firebase:', err);
      }

      // ุจุนุฏ ุชุญููู ุงูุฌูุณุงุช ูู ุงูุณุญุงุจุฉุ ูู ุจุชุญุฏูุซ ุฌุฏุงูู ุงูุนุฑุถ. ุฅุฐุง ูู ุชูู
      // ุงูุฏุงูุฉ ูุนุฑููุฉ ุจุนุฏ (ูู ุญุงู ูู ุชูุญููู ุจุนุฏ)ุ ูุชู ุชุฌุงูู ุงูุฎุทุฃ.
      try {
        if (typeof updateLoginSessionsDisplay === 'function') {
          updateLoginSessionsDisplay();
        }
      } catch (_) {
        // ุชุฌุงูู ุฃู ุฎุทุฃ ุฃุซูุงุก ุงูุชุญุฏูุซ
      }

      // ูู ูุนุฏ ูุชู ุฏูุฌ ุญุณุงุจุงุช ุงููุณุชุฎุฏููู ูู localStorage. ูู ุญุงู ูุดู ุชุญููู
      // ุจูุงูุงุช ุงูุญุณุงุจุงุช ูู Firebaseุ ุณูุจูู ุงููุณุชุฎุฏููู ุงูุงูุชุฑุงุถููู ุงููุญุฏุฏูู ูู
      // ุงูููุฏ ููุง ูุชู ุงุณุชุฎุฏุงู ุฃูุฉ ูุณุฎ ุงุญุชูุงุทูุฉ ูุญููุฉ ูุถูุงู ุงูุงุชุณุงู.

      // -------------------------------------------------------------------
      // โ ุชุนููู ุญุงูุฉ ุงูุญุณุงุจ Jh ูู "ูุดุท" ุฅุฐุง ูุงูุช ุบูุฑ ุฐูู
      // ุจูุงุกู ุนูู ุทูุจ ุงููุณุชุฎุฏูุ ูุชู ุชูุนูู ุญุณุงุจ "Jh" ุจุดูู ุชููุงุฆู ุนูุฏ ุงูุชุญููู.
      try {
        const jhKey = Object.keys(users).find(k => k.toLowerCase() === 'jh');
        if (jhKey && users[jhKey]) {
          users[jhKey].status = 'ูุดุท';
          // ุงุญูุธ ุงูุชุบููุฑ ูู Firebase ุญุชู ูุชู ุชุทุจูู ุงูุชูุนูู ุจุดูู ุฏุงุฆู
          try {
            await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpAccounts'), users);
          } catch (err) {
            console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุญุงูุฉ ุญุณุงุจ Jh ูู Firebase:', err);
          }
        }
      } catch (_) {
        // ุชุฌุงูู ุฃู ุฎุทุฃ ูู ูุฐุง ุงูุฌุฒุก
      }

      // ุจุนุฏ ุชุญููู ุงูุจูุงูุงุช ุงูุฑุฆูุณูุฉ ูุงูุญุณุงุจุงุชุ ูู ุจุชุญููู ุงูููุงุชูุฑ ุงููุนููุฉ
      // ุงููุฎุฒูุฉ ูู Firebase.  ูุฐุง ูุถูู ุฃู ูุงุฆูุฉ ุงูููุงุชูุฑ ุงููุนููุฉ ุชุธูุฑ
      // ูุจุงุดุฑุฉ ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู ุฃู ุนูุฏ ุงููุฒุงููุฉ.
      if (typeof loadSuspendedInvoices === 'function') {
        try {
          await loadSuspendedInvoices();
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase:', err);
        }
      }

      // Load manual customers from Firebase each time data is loaded.  This
      // populates window.manualCustomers with the persisted customers list so
      // that manually added clients remain visible after reloads.  Wrap the
      // call in a try/catch to avoid aborting the data load if a network
      // error occurs.
      try {
        if (typeof loadManualCustomersFromFirebase === 'function') {
          await loadManualCustomersFromFirebase();
        }
      } catch (mcErr) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ุงูุนููุงุก ุงููุฏูููู ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช:', mcErr);
      }

      // ุจุนุฏ ุชุญููู ุงูุจูุงูุงุช ุจูุฌุงุญ ูุง ูุชู ุฅูุดุงุก ูุณุฎุฉ ูุญููุฉ ุงุญุชูุงุทูุฉ ูุฃู ุงูุชุฎุฒูู ุงููุญูู ูุนุทู.
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช ูู Firebase:', error);
      // ุฅุฐุง ูุดู ุงูุชุญููู ูู Firebase ููู ูุชู ุงุณุชุฑุฌุงุน ูุณุฎุฉ ูุญููุฉ ูุฃู ุงูุชุฎุฒูู ุงููุญูู ูุนุทู.
    }
  }
  
  // Save pending invoices to Firebase. Pending invoices are persisted in
  // a separate location in the Firebase database. This replaces the
  // old localStorage implementation.
  async function savePendingInvoices() {
    try {
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'pendingInvoices'), pendingInvoices);
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase:', error);
    }
  }

  // Load pending invoices from Firebase. This function populates the
  // pendingInvoices array with any invoices that have been saved but not
  // yet finalized. It should be called during application initialization.
  async function loadPendingInvoices() {
    try {
      const snapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'pendingInvoices'));
      if (snapshot.exists()) {
        const loaded = snapshot.val() || [];
        pendingInvoices = Array.isArray(loaded) ? loaded : [];
        console.log('๐ฅ ุชู ุชุญููู ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase:', pendingInvoices.length);
      }
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase:', error);
    }
  }

  /**
   * ุญูุธ ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase. ุชููู ูุฐู ุงูุฏุงูุฉ ุจุญูุธ
   * ูุตูููุฉ suspendedInvoices ูู ุนูุฏุฉ ูุณุชููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   * ('erpSuspendedInvoices') ุจุญูุซ ุชุจูู ุงูููุงุชูุฑ ุงููุนููุฉ ูุชููุฑุฉ
   * ุนูุฏ ุฅุนุงุฏุฉ ุชุดุบูู ุงููุธุงู ุฃู ุชุณุฌูู ุงูุฎุฑูุฌ/ุงูุฏุฎูู. ุฅุฐุง ุญุฏุซ ุฎุทุฃ
   * ุฃุซูุงุก ุงูุญูุธ ูุชู ุชุณุฌููู ูู ูุญุฏุฉ ุงูุชุญูู ุจุฏูู ุฅุนุงูุฉ ุงูุนูููุงุช ุงูุฃุฎุฑู.
   */
  async function saveSuspendedInvoices() {
    try {
      // ุงุณุชุฎุฏู ุงููุตูููุฉ ุงูููุฌูุฏุฉ ุนูู ุงููุงุฆู window ุฅุฐุง ูุงูุช ููุฌูุฏุฉุ ูุฅูุง ูุตูููุฉ ูุงุฑุบุฉ
      const list = Array.isArray(window.suspendedInvoices) ? window.suspendedInvoices : [];
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpSuspendedInvoices'), list);
      console.log('๐พ ุชู ุญูุธ ุงูููุงุชูุฑ ุงููุนููุฉ ูู erpSuspendedInvoices:', list.length);
    } catch (err) {
      console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase:', err);
    }
  }

  /**
   * ุชุญููู ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase. ุชููู ูุฐู ุงูุฏุงูุฉ ุจูุฑุงุกุฉ
   * ุงูุนูุฏุฉ 'erpSuspendedInvoices' ูุชููุฆุฉ window.suspendedInvoices
   * ุจูุญุชููุงุชูุง. ุฅุฐุง ูุงูุช ุงูุนูุฏุฉ ุบูุฑ ููุฌูุฏุฉ ุฃู ูุงุฑุบุฉ ูุชู ุชููุฆุฉ
   * ุงููุตูููุฉ ุจูููุฉ ูุงุฑุบุฉ. ุฃู ุฎุทุฃ ุฃุซูุงุก ุงูุชุญููู ูุชู ุชุณุฌููู.
   */
  async function loadSuspendedInvoices() {
    try {
      const snapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpSuspendedInvoices'));
      if (snapshot.exists()) {
        const data = snapshot.val() || [];
        window.suspendedInvoices = Array.isArray(data) ? data : [];
      } else {
        window.suspendedInvoices = [];
      }
      console.log('๐ฅ ุชู ุชุญููู ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase:', window.suspendedInvoices.length);

      // ุจุนุฏ ุชุญููู ุงูููุงุชูุฑ ุงููุนููุฉุ ุญุฏูุซ ูุต ุฒุฑ ุงูููุงุชูุฑ ุงููุนููุฉ
      if (typeof updateSuspendedInvoicesButton === 'function') {
        updateSuspendedInvoicesButton();
      }
    } catch (err) {
      console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase:', err);
    }
  }

  /**
   * ูุฒุงููุฉ ุงูุจูุงูุงุช ุงููุญููุฉ ูุน ุงูุณุญุงุจุฉ. ูููู ูุฐุง ุงูุฒุฑ ุจุฅุฑุณุงู ูุงูุฉ ุงูุจูุงูุงุช
   * ุงููุญููุฉ ุฅูู ูุงุนุฏุฉ ุจูุงูุงุช Firebase ุซู ูุนูุฏ ุชุญููู ุงูุจูุงูุงุช ูู ุงูุณุญุงุจุฉ
   * ุฅูู ุงูุฐุงูุฑุฉ ุงููุญููุฉ. ุจุนุฏ ุงูุชูุงู ุงูุนูููุฉ ูุชู ุชุญุฏูุซ ุฌููุน ุฃูุณุงู ุงููุธุงู
   * ูุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ. ูู ุญุงู ูููุน ุฎุทุฃ ูุชู ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ููุตูุฉ.
   */
  async function syncWithCloud() {
    // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู ุฃุซูุงุก ุงููุฒุงููุฉ
    // ุญุฐู ุดุงุดุฉ ุงูุชุญููู ุนูุฏ ุฅุถุงูุฉ ุงููุดุชุฑูุงุช
    // ูุง ูุนุฑุถ ูุงูุฐุฉ "ุฌุงุฑู ุงูุญูุธ" ููู ูุง ุชูุงุทุน ุงููุณุชุฎุฏู ุนูุฏ ุฅุถุงูุฉ ููุชุฌ ูู ุงููุดุชุฑูุงุช
    try {
      // ุฃููุงู: ูู ุจุญูุธ ูู ูุง ูู ููุฌูุฏ ูู allData ูุงููุณุชุฎุฏููู ุฅูู Firebase.
      // ูุญุชูุธ ุจุนูู ูุดูุฑ ุฅูู ูุง ุฅุฐุง ูุงูุช ุนูููุฉ ุงูุญูุธ ูุฏ ูุฌุญุช ุฃู ูุง.
      let saveSucceeded = false;
      try {
        await saveDataToFirebase();
        saveSucceeded = true;
      } catch (err) {
        console.error('Error saving data to Firebase:', err);
      }
      // ุซุงููุงู: ุฃุนุฏ ุชุญููู ุงูุจูุงูุงุช ูู Firebase ุฅูู allData ูุงููุณุชุฎุฏููู ููุท
      // ุฅุฐุง ุชูุช ุนูููุฉ ุงูุญูุธ ุจูุฌุงุญ. ูู ุญุงู ูุดู ุงูุญูุธุ ูุญุชูุธ
      // ุจุงูุจูุงูุงุช ุงููุญููุฉ ุฏูู ุฅุนุงุฏุฉ ุชุญููู ูุชุฌูุจ ููุฏุงู ุงูุชุบููุฑุงุช.
      if (saveSucceeded) {
        try {
          await loadDataFromFirebase();
        } catch (err) {
          console.error('Error loading data from Firebase after sync:', err);
        }
      }

      // ุซุงูุซุงู: ูู ุจุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู ุจุนุฏ ุชูุฑูุบ ุงูููุฏุณ ุงูุญุงูู.  ููุฏ ููุญุธ
      // ุฃู ุงุณุชุฏุนุงุก updateAllDisplays ูุจุงุดุฑุฉ ุจุนุฏ ุนูููุงุช ุงูุญูุธ ูุงูุชุญููู
      // ูุฏ ูุคุฏู ุฅูู ุชุฌุงูุฒ ุญุฌู ุงูููุฏุณ ุจุณุจุจ ุงูุชุฏุงุฎู ูุน ูุนุงูุฌุงุช ุงูุฃุญุฏุงุซ
      // ุงูุฃุฎุฑู. ุฅุณุชุฎุฏุงู setTimeout ูุณูุญ ูููุชุตูุญ ุจุงูุชุฎูุต ูู ุงูููุฏุณ
      // ุงูุญุงูู ุซู ุชุญุฏูุซ ุงููุงุฌูุฉ ุจุฃูุงู.
      setTimeout(() => {
        try {
          updateAllDisplays();
          hideLoading();
          // ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ ุจุงูููู ุงูุฃุฎุถุฑ ุจุนุฏ ุงูุชูุงู ุงูุชุญุฏูุซ
          showMessage('โ ุชูุช ุงููุฒุงููุฉ ูุน ุงูุณุญุงุจุฉ ุจูุฌุงุญ', 'success');
        } catch (updateErr) {
          hideLoading();
          console.error('โ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงููุงุฌูุฉ ุจุนุฏ ุงููุฒุงููุฉ:', updateErr);
          showMessage('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงููุงุฌูุฉ ุจุนุฏ ุงููุฒุงููุฉ: ' + (updateErr && updateErr.message ? updateErr.message : updateErr), 'error');
        }
      }, 0);
    } catch (err) {
      hideLoading();
      console.error('โ ุฎุทุฃ ูู ุงููุฒุงููุฉ ูุน ุงูุณุญุงุจุฉ:', err);
      showMessage('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุฒุงููุฉ: ' + (err && err.message ? err.message : err), 'error');
    }
  }

  /**
   * Perform a silent synchronization with Firebase.  This variant of
   * syncWithCloud() is intended for automatic background syncing: it
   * persists local changes to Firebase, reloads the latest data, and
   * updates the UI โ all without showing loading spinners or user
   * messages.  Any errors are logged to the console but do not
   * interrupt the user experience.  This function is used by the
   * automatic sync timer configured in showMainSystem().
   */
  async function silentSyncWithCloud() {
    try {
      // Load the latest data from Firebase first.  This will replace the current
      // allData and users with whatever is stored in the cloud.  By loading
      // before saving, we ensure that any records deleted remotely are not
      // immediately re-created by a premature save.
      await loadDataFromFirebase();

      // Reconcile manualCustomers with the list of customers stored in Firebase.
      // If a manual customer has been deleted in Firebase (e.g. via the console),
      // remove them from window.manualCustomers so that the UI reflects the
      // deletion.  Any errors during this process are logged silently.
      try {
        const custSnap = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpCustomers'));
        if (custSnap && custSnap.exists()) {
          const remoteCustomers = custSnap.val() || [];
          if (Array.isArray(window.manualCustomers) && Array.isArray(remoteCustomers)) {
            window.manualCustomers = window.manualCustomers.filter(function(c) {
              const cCode = (c.code || c.customer_code || '').toString();
              const cName = (c.name || c.customer_name || '').trim();
              return remoteCustomers.some(function(r) {
                if (!r) return false;
                const rCode = (r.customer_code || '').toString();
                const rName = (r.customer_name || '').trim();
                return (cCode && rCode && rCode === cCode) || (!cCode && rName === cName);
              });
            });
          }
        }
      } catch (custErr) {
        console.warn('โ๏ธ ุชุนุฐุฑ ูุฒุงููุฉ ูุงุฆูุฉ ุงูุนููุงุก ุงููุฏูููู ูุน Firebase:', custErr);
      }

      // After loading remote data and reconciling manual customers, persist the
      // latest in-memory state back to Firebase.  Because we loaded from
      // Firebase first, any deletions performed remotely will be retained when
      // saving; we will not accidentally re-create removed records.  Errors
      // during this save are logged silently.
      try {
        try {
        await saveDataToFirebase();
    } catch (err) {
        console.error('Error saving data to Firebase:', err);
    }
      } catch (saveErr) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุจูุงูุงุช ุฃุซูุงุก ุงููุฒุงููุฉ ุงูุฎูููุฉ:', saveErr);
      }

      // Update the displays after the current call stack unwinds to avoid
      // interfering with other event handlers.  Do not show a user-facing
      // message or spinner for background syncs.
      setTimeout(() => {
        try {
          updateAllDisplays();
        } catch (updateErr) {
          console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงููุงุฌูุฉ ุจุนุฏ ุงููุฒุงููุฉ ุงูุฎูููุฉ:', updateErr);
        }
      }, 0);
    } catch (err) {
      // Log background sync errors but do not surface them to the user.
      console.error('โ๏ธ ุฎุทุฃ ูู ุงููุฒุงููุฉ ุงูุฎูููุฉ ูุน ุงูุณุญุงุจุฉ:', err);
    }
  }
  
  // Login functions
  function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('login-error');
    
    // Hide previous error
    errorDiv.classList.add('hidden');
    
    // Check credentials
    if (users[username] && users[username].password === password && users[username].status === 'ูุดุท') {
      currentUser = {
        username: username,
        role: users[username].role,
        fullName: users[username].fullName,
        permissions: users[username].permissions
      };
      
      // ุณุฌู ุฌูุณุฉ ุงูุฏุฎูู ูุจู ุนุฑุถ ุงููุธุงู ุงูุฑุฆูุณู
      // ุชุณุฌูู ุฌูุณุฉ ุงูุฏุฎูู ุจุฏูู ุงูุชุธุงุฑ ูุชูุฌุชู
      try {
        logLogin(username);
      } catch (_) {
        // ุชุฌุงูู ุฃู ุฎุทุฃ ูู ุชุณุฌูู ุงูุฌูุณุฉ ูุฃู ุงูุฏุฎูู ูุฌุจ ุฃู ูุณุชูุฑ
      }
      // Show success animation
      showLoading();

      setTimeout(() => {
        hideLoading();
        showMainSystem();
      }, 1500);
      
    } else {
      // Add shake animation without showing error message
      const loginForm = document.getElementById('login-form');
      loginForm.style.animation = 'shake 0.5s';
      setTimeout(() => {
        loginForm.style.animation = '';
      }, 500);
    }
  }
  
  function showMainSystem() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('main-system').classList.remove('hidden');
    
    // Update user info
    document.getElementById('current-user').textContent = `${currentUser.fullName} (${currentUser.role})`;

    // Load security settings from Firebase asynchronously.  Do not
    // await this call so that the UI can render quickly.  If the
    // settings are loaded successfully, they will overwrite the
    // defaults in window.securitySettings.  Otherwise the defaults
    // remain in effect.
    try {
      loadSecuritySettings();
    } catch (_) {
      // ignore errors here; defaults will remain
    }
    
    // Hide/show navigation buttons based on permissions
    updateNavigationPermissions();
    
    // Show default section (first available section)
    const firstAvailableSection = getFirstAvailableSection();
    showSection(firstAvailableSection);

    // Mark the user as logged in immediately.  Setting isLoggedIn before
    // refreshing the displays ensures that navigation and other
    // login-dependent features are enabled even if an error occurs
    // during updateAllDisplays().
    isLoggedIn = true;

    // ุชููุฆุฉ ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ.  ูู ูุฐุง ุงููุถุนุ ูุชู ุชูููุฐ ุนูููุฉ ุญูุธ
    // ุงูุจูุงูุงุช ุงููุญููุฉ ุฅูู Firebase ูู ูฅ ุซูุงูู ูู ุงูุฎูููุฉ ุจุฏูู ุนุฑุถ
    // ุฃู ูุคุดุฑุงุช ุชุญููู ุฃู ุฑุณุงุฆู ูููุณุชุฎุฏู.  ูุฐุง ูุถูู ุฃู ุฃู ุชุนุฏููุงุช
    // ุชุชู ุนูู ุงููููุน ูุชู ูุฒุงููุชูุง ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุดูู ุฏูุฑู.
    if (window.autoSyncTimer) {
      clearInterval(window.autoSyncTimer);
    }
    /**
     * ุชููู ูุฐู ุงูุฏุงูุฉ ุจุนูููุฉ ูุฒุงููุฉ ุฎูููุฉ ุดุงููุฉุ ุญูุซ ุชุญูุธ ุงูุจูุงูุงุช
     * ุงูุญุงููุฉ ูู Firebase ุซู ุชุนูุฏ ุชุญููู ุงูุจูุงูุงุช ุงููุญุฏุซุฉ ุฅูู ุงููุธุงู
     * ุงููุญูู ูุชููู ุจุชุญุฏูุซ ุงูุนุฑูุถ. ูุชู ุงุณุชุฎุฏุงู async/await ูุถูุงู
     * ุชุณูุณู ุงูุนูููุงุช ุจุฏูู ุญุฌุจ ูุงุฌูุฉ ุงููุณุชุฎุฏู. ุฃู ุฃุฎุทุงุก ุฃุซูุงุก
     * ุงููุฒุงููุฉ ูุชู ุชุณุฌูููุง ููุท ูู ูุญุฏุฉ ุงูุชุญูู ุจุฏูู ุฅุฒุนุงุฌ ุงููุณุชุฎุฏู.
     */
    async function backgroundSync() {
      if (!isLoggedIn) return;
      try {
        let saveSucceeded = false;
        // Attempt to persist local changes to Firebase. If this throws
        // (due to network errors or other failures), we keep working
        // with the local data and skip reloading from the cloud.
        if (typeof saveDataToFirebase === 'function') {
          try {
            await saveDataToFirebase();
            saveSucceeded = true;
          } catch (saveErr) {
            // Log but do not rethrow; we still want to update the UI
            console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุจูุงูุงุช ุฃุซูุงุก ุงููุฒุงููุฉ ุงูุฎูููุฉ:', saveErr);
          }
        }
        // Reload the latest data from Firebase only if the save succeeded.
        if (saveSucceeded && typeof loadDataFromFirebase === 'function') {
          try {
            await loadDataFromFirebase();
          } catch (loadErr) {
            console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ุงูุจูุงูุงุช ุฃุซูุงุก ุงููุฒุงููุฉ ุงูุฎูููุฉ:', loadErr);
          }
        }
        // Always update the UI after attempting to save/load so that local
        // changes are visible immediately.
        updateAllDisplays();
      } catch (err) {
        console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุงููุฒุงููุฉ ุงูุฎูููุฉ:', err);
      }
    }
    window.autoSyncTimer = setInterval(() => {
      // ูุณุชุฏุนู backgroundSync ุจุงุณุชุฎุฏุงู Promise.resolve ูุชุฌูุจ ุงูุฃุฎุทุงุก ุบูุฑ ุงููุนุงูุฌุฉ
      Promise.resolve(backgroundSync());
    }, 5000);

    // After showing the main system, ensure all displays reflect the latest data.
    // Without this call, tables like purchases and inventory may not refresh when
    // the user first logs in.  Calling updateAllDisplays() here guarantees
    // the UI is synchronized with the underlying allData array and Firebase.
    try {
      updateAllDisplays();
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุนุฑูุถ ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู:', err);
    }

    // ุชุฃูุฏ ูู ุชุญุฏูุซ ูุต ุฒุฑ ุงูููุงุชูุฑ ุงููุนููุฉ ุนูุฏ ุงูุฏุฎูู ูููุธุงู
    if (typeof updateSuspendedInvoicesButton === 'function') {
      updateSuspendedInvoicesButton();
    }
  }
  
  function updateNavigationPermissions() {
    const navButtons = document.querySelectorAll('.nav-btn');
    const permissions = currentUser.permissions;
    
    navButtons.forEach(button => {
      const match = button.getAttribute('onclick').match(/showSection\('(.+?)'\)/);
      const section = match && match[1];
      if (!section) {
        button.style.display = 'none';
        return;
      }
      // Special handling for the user-sales navigation item.  Display it if
      // the user has either the "accounting" or "sales" permission.  Since
      // there is no dedicated permission called "user-sales", without
      // this check the button would always be hidden by the default logic.
      if (section === 'user-sales') {
        // Only display the User Sales section for accounts with the dedicated
        // "user-sales" permission.  Without this, the button would be hidden by
        // the default logic because there is no permission named after the section.
        if (permissions.includes('user-sales')) {
          button.style.display = 'inline-block';
        } else {
          button.style.display = 'none';
        }
      } else {
        if (permissions.includes(section)) {
          button.style.display = 'inline-block';
        } else {
          button.style.display = 'none';
        }
      }
    });
  }
  
  function getFirstAvailableSection() {
    const sections = ['sales', 'purchases', 'inventory', 'employees', 'invoices', 'customers', 'accounts', 'discounts', 'accounting', 'returns', 'settings'];
    const permissions = currentUser.permissions;
    
    for (const section of sections) {
      if (permissions.includes(section)) {
        return section;
      }
    }
    
    return 'sales'; // fallback
  }
  
  function logout() {
    // Mark that a manual logout is in progress so the beforeunload handler
    // does not record a duplicate logout time.
    manualLogout = true;
    // ุณุฌูู ุงูุฎุฑูุฌ ููุฌูุณุฉ ุงูุญุงููุฉ ูุจู ุชุตููุฑ currentUser
    try {
      if (currentUser && currentUser.username) {
        logLogout(currentUser.username);
      }
    } catch (_) {
      // ุฅุฐุง ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุฎุฑูุฌุ ูุณุชูุฑ ูู ุงูุนูููุฉ
    }
    currentUser = null;
    isLoggedIn = false;
    
    // Clear form
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('login-error').classList.add('hidden');
    
    // Show login screen
    document.getElementById('main-system').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
    
    showMessage('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ', 'success');

    // Reset manual flag after logout so that future sessions
    // can be autoโlogged out on unexpected reloads.  Without
    // resetting, autoโlogout would be skipped for subsequent sessions.
    manualLogout = false;
  }
  
  // Initialize app
  async function initializeApp() {
    console.log('๐ ุจุฏุก ุชููุฆุฉ ุงููุธุงู...');

    
    // Load data from Firebase instead of localStorage
    await loadDataFromFirebase();
    // Load any pending invoices from Firebase
    await loadPendingInvoices();

    // Load manually added customers from Firebase so that the
    // customers section retains manually added entries across sessions.  If
    // this fails, manualCustomers will remain unchanged.
    if (typeof loadManualCustomersFromFirebase === 'function') {
      try {
        await loadManualCustomersFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ุงูุนููุงุก ุงููุฏูููู ุฃุซูุงุก ุงูุชููุฆุฉ:', err);
      }
    }

    // Initialize the custom expenses list from allData.  Without this call,
    // expenses saved to Firebase would not populate the expenses table
    // until a manual addition occurs.  It is safe to ignore errors here.
    try {
      if (typeof initializeCustomExpenses === 'function') {
        initializeCustomExpenses();
      }
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชููุฆุฉ ุงููุตุฑููุงุช ุฃุซูุงุก ุงูุชููุฆุฉ:', err);
    }

    // Ensure the erpInvoices node exists in Firebase. If it does not exist,
    // create it as an empty array so that future invoices have a location
    // to be stored. Without this, the node might not appear until data is
    // pushed, which can be confusing when inspecting the database.  Note:
    // historically the system checked for a lowerโcase `erpinvoices` path
    // which caused discrepancies.  We now consistently use the camelโcased
    // `erpInvoices` key everywhere.
    try {
      const erpInvSnap = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpInvoices'));
      if (!erpInvSnap.exists()) {
        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpInvoices'), []);
      }
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุงูุชุญูู ูู ูุฌูุฏ ูุณุงุฑ erpInvoices:', err);
    }

    // Setup login form
    document.getElementById('login-form').addEventListener('submit', handleLogin);

    // Restore the default admin credentials in Firebase if they are missing or have been altered.
    // This ensures that the administrator account "ibrahim" always exists with the password "123456".
    // If the admin record is missing or the password does not match the default, update it and save.
    const defaultAdmin = {
      password: '123456',
      role: 'ูุฏูุฑ ุงููุธุงู',
      fullName: 'ุฅุจุฑุงููู ุงูุดุฑูุงูู',
      permissions: [
        'sales',
        'purchases',
        'inventory',
        'employees',
        'invoices',
        'customers',
        'accounts',
        'discounts',
        'accounting'
      ],
      createdAt: '2024-01-01',
      status: 'ูุดุท'
    };
    try {
      if (!users['ibrahim'] || users['ibrahim'].password !== defaultAdmin.password) {
        users['ibrahim'] = defaultAdmin;
        try {
        await saveDataToFirebase();
    } catch (err) {
        console.error('Error saving data to Firebase:', err);
    }
      }
    } catch (restoreErr) {
      console.warn('โ๏ธ ูู ูุชู ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุงูุชุฑุงุถู:', restoreErr);
    }


    console.log('โ ุชู ุชููุฆุฉ ุงููุธุงู ุจูุฌุงุญ');
    // ุจุนุฏ ุงูุชูุงู ุงูุชููุฆุฉ ูููู ุจุชูููุฏ ุฑูู ูุคูุช ูููุงุชูุฑุฉ ุงููุงุฏูุฉ
    // ุจุญูุซ ูุธูุฑ ุฃูุงู ุนููุงู "ูุงุชูุฑุฉ ุงูุจูุน". ุจุฏูู ูุฐุง ุงูุงุณุชุฏุนุงุก ูุฅู
    // ุงูุนูุตุฑ ุณูุธู ูุงุฑุบุงู ุญุชู ูุชู ุญูุธ ุฃูู ูุงุชูุฑุฉ.
    updateTempInvoiceNumberDisplay();
  }
  
  // Show loading state
  function showLoading() {
    isLoading = true;
    document.getElementById('loading-overlay').classList.remove('hidden');
  }
  
  // Hide loading state
  function hideLoading() {
    isLoading = false;
    document.getElementById('loading-overlay').classList.add('hidden');
  }
  
  // Navigation functions
  function showSection(sectionName) {
    if (!isLoggedIn) {
      return;
    }
    
    // Check if user has permission for this section.  The "user-sales" section
    // reuses the permissions of the "accounting" section because it is a
    // reporting feature.  If the section is "user-sales", map it to
    // "accounting" for permission checking.
    let permName = sectionName;
    // Map the user-sales section to its own dedicated permission.  Users must
    // possess the "user-sales" permission to access this section.
    if (sectionName === 'user-sales') {
      permName = 'user-sales';
    }
    if (!currentUser.permissions.includes(permName)) {
      return;
    }
    
    // Hide all sections immediately.  We intentionally delay revealing
    // the new section by a small amount to make navigation feel smoother.
    document.querySelectorAll('.section').forEach(section => {
      section.classList.add('hidden');
    });
    // Delay showing the requested section slightly.  This delay gives
    // the UI time to update its data displays (via updateAllDisplays below)
    // and produces a more gradual transition between sections.  The
    // duration has been kept short (~150ms) so that navigation still
    // feels responsive while appearing less abrupt.
    setTimeout(() => {
      const targetSection = document.getElementById(sectionName + '-section');
      if (targetSection) {
        targetSection.classList.remove('hidden');
      }
    }, 150);
    
    // Update nav buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.classList.remove('ring-2', 'ring-white');
    });
    // ุงุณุชุฎุฏู window.event ุฅุฐุง ูู ูุชู ุชูุฑูุฑ ุญุฏุซ ุตุฑูุญ ูููุน ุฃุฎุทุงุก ูุฑุฌุน ุบูุฑ ูุนุฑู
    const evt = typeof event !== 'undefined' ? event : (typeof window !== 'undefined' ? window.event : null);
    if (evt && evt.target) {
      evt.target.classList.add('ring-2', 'ring-white');
    }
    
    // Special handling for purchases section
    if (sectionName === 'purchases') {
      // Update existing products list when entering purchases section
      setTimeout(() => {
        if (document.getElementById('existing-product-mode').checked) {
          updateExistingProductsList();
        }
      }, 100);
    }

    // Whenever the user navigates to a different section, refresh displayed data
    // to ensure the UI remains in sync with allData. Without this call, tables
    // like purchases and inventory might show stale data until a record is added
    // or another action triggers an update.  Calling updateAllDisplays here
    // guarantees that when switching sections, the latest purchases, sales,
    // inventory and employee tables are rendered.  Updating before the timeout
    // ensures that data refresh happens during the short delay before the new
    // section is revealed.
    updateAllDisplays();

    // Additional handling for employees section: reset input fields and update code
    if (sectionName === 'employees') {
      try {
        clearEmployeeInputs();
      } catch (err) {
        console.warn('Unable to clear employee inputs on section change:', err);
      }
    }
  }
  
  // Calculate available stock for each product
  function calculateInventory() {
    const purchases = allData.filter(item => item.type === 'purchase');
    const sales = allData.filter(item => item.type === 'sale');
    const returns = allData.filter(item => item.type === 'return');
    const inventory = {};
    
    // Add purchases to inventory.  If a product already exists, update the total purchases
    // and update the latest purchase and sale prices.  This ensures the inventory
    // reflects the most recent pricing information for each product.
    //
    // To allow sorting the inventory table by recency, track the most recent
    // purchase date for each product on a new property `lastPurchaseDate`.  The
    // `date` field on each purchase is stored as an ISO string, so it can be
    // compared using Date objects.  When updating an existing product, only
    // overwrite `lastPurchaseDate` if the new purchase is more recent.
    purchases.forEach(purchase => {
      const code = purchase.product_code;
      const purchaseDate = purchase.date;
      if (inventory[code]) {
        inventory[code].totalPurchases += purchase.quantity;
        // Update purchase and sale prices with the latest values
        inventory[code].purchasePrice = purchase.purchase_price;
        inventory[code].salePrice = purchase.sale_price;
        // If this purchase happened after the stored lastPurchaseDate, update it
        const currentLast = inventory[code].lastPurchaseDate;
        if (!currentLast || new Date(purchaseDate) > new Date(currentLast)) {
          inventory[code].lastPurchaseDate = purchaseDate;
        }
      } else {
        inventory[code] = {
          code: purchase.product_code,
          name: purchase.product_name,
          totalPurchases: purchase.quantity,
          totalSales: 0,
          salePrice: purchase.sale_price,
          purchasePrice: purchase.purchase_price,
          lastPurchaseDate: purchaseDate
        };
      }
    });
    
    // Subtract sales from inventory
    sales.forEach(sale => {
      if (inventory[sale.product_code]) {
        inventory[sale.product_code].totalSales += sale.quantity;
      }
    });

    // Add returns back to inventory by reducing totalSales (reverse of a sale)
    returns.forEach(ret => {
      const code = ret.product_code;
      const qty = parseFloat(ret.quantity) || 0;
      if (inventory[code]) {
        // Reduce the total sales count by the return quantity
        inventory[code].totalSales -= qty;
        if (inventory[code].totalSales < 0) {
          inventory[code].totalSales = 0;
        }
      }
    });
    
    // Calculate available stock
    Object.keys(inventory).forEach(code => {
      inventory[code].availableStock = inventory[code].totalPurchases - inventory[code].totalSales;
      
      // ุทุฑุญ ุงููููุงุช ุงููุถุงูุฉ ูููุงุชูุฑุฉ ุงูุญุงููุฉ (ุงููุฎุฒูู ุงููุญุฌูุฒ)
      const reservedQuantity = currentInvoiceItems
        .filter(item => item.code === code)
        .reduce((sum, item) => sum + item.quantity, 0);
      
      inventory[code].reservedStock = reservedQuantity;
      inventory[code].actualAvailableStock = inventory[code].availableStock - reservedQuantity;
    });
    
    return inventory;
  }
  
  // Sales functions
  function searchProducts(searchTerm) {
    if (!searchTerm || searchTerm.length < 1) {
      hideSearchResults();
      return;
    }
    
    const inventory = calculateInventory();
    const searchOutOfStock = document.getElementById('search-out-of-stock').checked;
    
    let filteredProducts;
    
    if (searchOutOfStock) {
      // ุงูุจุญุซ ูู ุงูุฃุตูุงู ุงููุงูุฏุฉ ููุท
      filteredProducts = Object.values(inventory).filter(product => 
        product.availableStock <= 0 && (
          product.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
          product.name.toLowerCase().includes(searchTerm.toLowerCase())
        )
      );
    } else {
      // ุงูุจุญุซ ูู ุงูุฃุตูุงู ุงููุชููุฑุฉ ููุท
      filteredProducts = Object.values(inventory).filter(product => 
        product.availableStock > 0 && (
          product.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
          product.name.toLowerCase().includes(searchTerm.toLowerCase())
        )
      );
    }
    
    showSearchResults(filteredProducts, searchOutOfStock);
  }
  
  function showSearchResults(products, isOutOfStock = false) {
    const resultsDiv = document.getElementById('search-results');
    
    if (products.length === 0) {
      const message = isOutOfStock ? 'ูุง ุชูุฌุฏ ุฃุตูุงู ูุงูุฏุฉ ูุทุงุจูุฉ ููุจุญุซ' : 'ูุง ุชูุฌุฏ ููุชุฌุงุช ูุชุงุญุฉ ูุทุงุจูุฉ ููุจุญุซ';
      resultsDiv.innerHTML = `<div class="search-item text-gray-500 text-center">${message}</div>`;
      resultsDiv.classList.remove('hidden');
      return;
    }
    
    resultsDiv.innerHTML = products.map(product => {
      const isClickable = !isOutOfStock && product.availableStock > 0;
      const clickHandler = isClickable ? `onclick="selectProduct('${product.code}', '${product.name}', ${product.salePrice}, ${product.availableStock})"` : '';
      const cursorClass = isClickable ? 'cursor-pointer' : 'cursor-not-allowed';
      const bgClass = isOutOfStock ? 'bg-red-50' : '';
      
      return `
        <div class="search-item ${cursorClass} ${bgClass}" ${clickHandler}>
          <div class="flex justify-between items-center">
            <div>
              <div class="font-medium ${isOutOfStock ? 'text-red-800' : 'text-gray-800'}">${product.name}</div>
              <div class="text-sm text-gray-600">ููุฏ: ${product.code}</div>
              ${isOutOfStock ? '<div class="text-xs text-red-600 font-medium">โ๏ธ ุตูู ูุงูุฏ - ูููุฑุงุฌุนุฉ ููุท</div>' : ''}
            </div>
            <div class="text-left">
              <div class="font-medium ${isOutOfStock ? 'text-red-600' : 'text-green-600'}">${product.salePrice.toFixed(2)} ุฌ.ู</div>
              <div class="text-sm ${product.availableStock <= 0 ? 'text-red-600 font-bold' : product.availableStock < 10 ? 'text-yellow-600' : 'text-blue-600'}">
                ${isOutOfStock ? 'ูุงูุฏ' : `ูุชููุฑ: ${product.availableStock}`}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    resultsDiv.classList.remove('hidden');
  }
  
  function hideSearchResults() {
    document.getElementById('search-results').classList.add('hidden');
  }
  
  function selectProduct(code, name, price, availableStock) {
    // Create a fresh selectedProduct with baseline pricing.  When selecting
    // a product, preserve the original sale price so that discounts are
    // calculated relative to the original value rather than cumulatively.
    selectedProduct = {
      code: code,
      name: name,
      price: price,
      originalPrice: price,
      discount: 0,
      availableStock: availableStock
    };
    
    document.getElementById('product-search').value = `${code} - ${name}`;
    document.getElementById('product-price').value = price.toFixed(2);
    document.getElementById('product-discount').value = '0.00';
    document.getElementById('final-price').value = price.toFixed(2);
    document.getElementById('selected-product').textContent = `${name} (${code})`;
    
    // ุชุญุฏูุซ ูุนูููุงุช ุงููุฎุฒูู ูุน ูุฑุงุนุงุฉ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ
    updateSelectedProductInfo();
    
    // ุชูุนูู ุฒุฑ ุงูุฅุถุงูุฉ ููุฑุงู ุนูุฏ ุงุฎุชูุงุฑ ููุชุฌ
    const addBtn = document.getElementById('add-to-invoice-btn');
    if (availableStock > 0) {
      addBtn.disabled = false;
      addBtn.className = 'w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium transition-colors';
      addBtn.textContent = 'โ ุฅุถุงูุฉ ูููุงุชูุฑุฉ';
    }
    
    hideSearchResults();
    document.getElementById('product-quantity').focus();
  }
  
  // Discount functions
  function requestDiscountPassword() {
    if (!selectedProduct) {
      showMessage('ูุฌุจ ุงุฎุชูุงุฑ ููุชุฌ ุฃููุงู', 'error');
      return;
    }
    
    // Create password input modal
    const modalDiv = document.createElement('div');
    modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modalDiv.id = 'discount-modal'; // ุฅุถุงูุฉ ID ููุชุญูู ูู ุงููุงูุฐุฉ
    modalDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
        <div class="text-center mb-6">
          <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-2xl">๐</span>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">ุฅุถุงูุฉ ุฎุตู</h3>
          <p class="text-gray-600">ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ูุฅุถุงูุฉ ุฎุตู ุนูู ุงูููุชุฌ</p>
          <p class="text-sm text-blue-600 mt-2">ุงูููุชุฌ: ${selectedProduct.name}</p>
          <!-- Use the original sale price if it exists; otherwise fallback to current price -->
          <p class="text-sm text-gray-600">ุงูุณุนุฑ ุงูุฃุตูู: ${(selectedProduct.originalPrice != null ? selectedProduct.originalPrice : selectedProduct.price).toFixed(2)} ุฌ.ู</p>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ูููุฉ ุงููุฑูุฑ</label>
            <input type="password" id="discount-password"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ูุจูุบ ุงูุฎุตู (ุฌ.ู)</label>
            <input type="number" id="discount-amount"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="0.00" step="0.01" min="0" max="${((selectedProduct.originalPrice != null ? selectedProduct.originalPrice : selectedProduct.price) - 0.01).toFixed(2)}">
            <p class="text-xs text-gray-500 mt-1">ุงูุญุฏ ุงูุฃูุตู: ${((selectedProduct.originalPrice != null ? selectedProduct.originalPrice : selectedProduct.price) - 0.01).toFixed(2)} ุฌ.ู</p>
          </div>
          
          <div class="bg-blue-50 p-3 rounded-lg">
            <div class="text-sm">
              <div class="flex justify-between">
                <span>ุงูุณุนุฑ ุงูุฃุตูู:</span>
                <span class="font-bold">${(selectedProduct.originalPrice != null ? selectedProduct.originalPrice : selectedProduct.price).toFixed(2)} ุฌ.ู</span>
              </div>
              <div class="flex justify-between">
                <span>ุงูุฎุตู:</span>
                <span class="font-bold text-red-600" id="preview-discount">0.00 ุฌ.ู</span>
              </div>
              <div class="flex justify-between border-t pt-2 mt-2">
                <span>ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู:</span>
                <span class="font-bold text-green-600" id="preview-final-price">${(selectedProduct.originalPrice != null ? selectedProduct.originalPrice : selectedProduct.price).toFixed(2)} ุฌ.ู</span>
              </div>
            </div>
          </div>
        </div>
        <div id="discount-error" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center text-sm">
          ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ
        </div>
        <div class="flex gap-3 mt-6">
          <button onclick="closeDiscountModal()" 
                  class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-medium">
            ุฅูุบุงุก
          </button>
          <button onclick="applyDiscount()" 
                  class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium">
            ุชุทุจูู ุงูุฎุตู
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modalDiv);
    
    // Update preview when discount amount changes
    const discountInput = document.getElementById('discount-amount');
    const previewDiscount = document.getElementById('preview-discount');
    const previewFinalPrice = document.getElementById('preview-final-price');
    
    function updatePreview() {
      const discountAmount = parseFloat(discountInput.value) || 0;
      // Always calculate from the original price (before any discounts). If
      // originalPrice is defined on the selectedProduct, use it; otherwise
      // fallback to the current price. This prevents discount stacking
      // incorrectly when multiple discounts are applied.
      const basePrice = (selectedProduct.originalPrice != null ? selectedProduct.originalPrice : selectedProduct.price);
      const finalPrice = basePrice - discountAmount;
      previewDiscount.textContent = discountAmount.toFixed(2) + ' ุฌ.ู';
      previewFinalPrice.textContent = finalPrice.toFixed(2) + ' ุฌ.ู';
    }
    
    discountInput.addEventListener('input', updatePreview);
    
    // Focus on password input
    setTimeout(() => {
      document.getElementById('discount-password').focus();
    }, 100);
    
    // Handle Enter key
    modalDiv.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        applyDiscount();
      } else if (e.key === 'Escape') {
        closeDiscountModal();
      }
    });
  }
  
  function closeDiscountModal() {
    const modal = document.getElementById('discount-modal');
    if (modal) {
      modal.remove();
    }
  }
  
  function applyDiscount() {
    const password = document.getElementById('discount-password').value;
    const discountAmount = parseFloat(document.getElementById('discount-amount').value) || 0;
    const errorDiv = document.getElementById('discount-error');
    
    // Hide previous error
    errorDiv.classList.add('hidden');
    
    // Check password using the configured discount password.  If the
    // entered password does not match securitySettings.discountPassword,
    // show an error and prevent the discount from being applied.
    if (password !== window.securitySettings.discountPassword) {
      errorDiv.textContent = 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ';
      errorDiv.classList.remove('hidden');
      document.getElementById('discount-password').focus();
      return;
    }
    
    // Validate discount amount using the original (nonโdiscounted) price.
    // If originalPrice is already defined on the selected product, use it.
    // Otherwise fall back to the current price. This prevents multiple
    // discounts from stacking and ensures the discount is always based
    // on the original sale price.
    const originalPrice = (selectedProduct.originalPrice != null ? selectedProduct.originalPrice : selectedProduct.price);
    if (discountAmount < 0 || discountAmount >= originalPrice) {
      errorDiv.textContent = 'ูุจูุบ ุงูุฎุตู ุบูุฑ ุตุญูุญ - ูุฌุจ ุฃู ูููู ุฃูู ูู ุงูุณุนุฑ ุงูุฃุตูู';
      errorDiv.classList.remove('hidden');
      return;
    }
    
    // Apply discount to selected product
    const finalPrice = originalPrice - discountAmount;
    
    // ุชุญุฏูุซ ุงูููุชุฌ ุงููุญุฏุฏ ูุน ูุนูููุงุช ุงูุฎุตู
    selectedProduct.originalPrice = originalPrice; // ุญูุธ ุงูุณุนุฑ ุงูุฃุตูู ุฅุฐุง ูู ููู ููุฌูุฏุงู
    selectedProduct.discount = discountAmount; // ุญูุธ ูููุฉ ุงูุฎุตู
    selectedProduct.price = finalPrice; // ุงูุณุนุฑ ุงูููุงุฆู ุจุนุฏ ุงูุฎุตู
    
    // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู
    document.getElementById('product-discount').value = discountAmount.toFixed(2);
    document.getElementById('final-price').value = finalPrice.toFixed(2);
    
    // ุฅุบูุงู ุงููุงูุฐุฉ
    closeDiscountModal();
    
    // ุฑุณุงูุฉ ุชุฃููุฏ
    showMessage(`โ ุชู ุชุทุจูู ุฎุตู ${discountAmount.toFixed(2)} ุฌ.ู ุนูู ${selectedProduct.name}`, 'success');
    
    console.log('ุชู ุชุทุจูู ุงูุฎุตู:', {
      productName: selectedProduct.name,
      originalPrice: originalPrice,
      discount: discountAmount,
      finalPrice: finalPrice
    });
  }
  
  // ุฏุงูุฉ ุชุนุฏูู ุฎุตู ููุชุฌ ููุฌูุฏ ูู ุงููุงุชูุฑุฉ
  function editItemDiscount(itemIndex) {
    const item = currentInvoiceItems[itemIndex];
    if (!item) return;
    
    const originalPrice = item.originalPrice || item.price;
    const currentDiscount = item.discount || 0;
    
    // Create discount edit modal
    const modalDiv = document.createElement('div');
    // Give the modal a unique ID so it can be removed reliably.  Using a
    // specific ID avoids accidentally targeting other elements that may
    // share the "fixed" class (e.g. loading overlays or other popโups).
    modalDiv.id = 'edit-discount-modal';
    modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modalDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
        <div class="text-center mb-6">
          <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-2xl">๐</span>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">ุชุนุฏูู ุฎุตู ุงูููุชุฌ</h3>
          <p class="text-gray-600">ุชุนุฏูู ุฎุตู "${item.name}"</p>
          <p class="text-sm text-blue-600 mt-2">ุงูุณุนุฑ ุงูุฃุตูู: ${originalPrice.toFixed(2)} ุฌ.ู</p>
          <p class="text-sm text-gray-600">ุงูุฎุตู ุงูุญุงูู: ${currentDiscount.toFixed(2)} ุฌ.ู</p>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ูููุฉ ุงููุฑูุฑ</label>
            <input type="password" id="edit-discount-password"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ูุจูุบ ุงูุฎุตู ุงูุฌุฏูุฏ (ุฌ.ู)</label>
            <input type="number" id="edit-discount-amount"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="0.00" step="0.01" min="0" max="${originalPrice - 0.01}" value="${currentDiscount.toFixed(2)}">
            <p class="text-xs text-gray-500 mt-1">ุงูุญุฏ ุงูุฃูุตู: ${(originalPrice - 0.01).toFixed(2)} ุฌ.ู</p>
          </div>
          
          <div class="bg-blue-50 p-3 rounded-lg">
            <div class="text-sm">
              <div class="flex justify-between">
                <span>ุงูุณุนุฑ ุงูุฃุตูู:</span>
                <span class="font-bold">${originalPrice.toFixed(2)} ุฌ.ู</span>
              </div>
              <div class="flex justify-between">
                <span>ุงูุฎุตู ุงูุฌุฏูุฏ:</span>
                <span class="font-bold text-red-600" id="preview-discount">0.00 ุฌ.ู</span>
              </div>
              <div class="flex justify-between border-t pt-2 mt-2">
                <span>ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู:</span>
                <span class="font-bold text-green-600" id="preview-final-price">${originalPrice.toFixed(2)} ุฌ.ู</span>
              </div>
            </div>
          </div>
        </div>
        <div id="edit-discount-error" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center text-sm">
          ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ
        </div>
        <div class="flex gap-3 mt-6">
          <!-- Cancel button: remove only this edit discount modal -->
          <button onclick="document.getElementById('edit-discount-modal')?.remove()" 
                  class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-medium">
            ุฅูุบุงุก
          </button>
          <button onclick="applyItemDiscount(${itemIndex})" 
                  class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium">
            ุชุทุจูู ุงูุฎุตู
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modalDiv);
    
    // Update preview when discount amount changes
    const discountInput = document.getElementById('edit-discount-amount');
    const previewDiscount = document.getElementById('preview-discount');
    const previewFinalPrice = document.getElementById('preview-final-price');
    
    function updatePreview() {
      const newDiscount = parseFloat(discountInput.value) || 0;
      const finalPrice = originalPrice - newDiscount;
      previewDiscount.textContent = newDiscount.toFixed(2) + ' ุฌ.ู';
      previewFinalPrice.textContent = finalPrice.toFixed(2) + ' ุฌ.ู';
    }
    
    discountInput.addEventListener('input', updatePreview);
    updatePreview(); // Initial update
    
    // Focus on password input
    setTimeout(() => {
      document.getElementById('edit-discount-password').focus();
    }, 100);
    
    // Handle Enter key
    modalDiv.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        applyItemDiscount(itemIndex);
      }
    });
  }
  
  // ุฏุงูุฉ ุชุทุจูู ุงูุฎุตู ุงููุนุฏู ุนูู ุงูููุชุฌ ูู ุงููุงุชูุฑุฉ
  function applyItemDiscount(itemIndex) {
    const password = document.getElementById('edit-discount-password').value;
    const newDiscountAmount = parseFloat(document.getElementById('edit-discount-amount').value) || 0;
    const errorDiv = document.getElementById('edit-discount-error');
    
    // Hide previous error
    errorDiv.classList.add('hidden');

    // Check password using the configured discount password. If it
    // does not match, display an error. In addition to showing the
    // inline error message for context, also use the global message
    // component to provide a consistent popโup notification like the
    // main discount modal. This mirrors the behaviour when the
    // discount password is entered incorrectly in the main invoice
    // header.
    if (password !== window.securitySettings.discountPassword) {
      errorDiv.textContent = 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ';
      errorDiv.classList.remove('hidden');
      // Show a popโup message at the top right of the page for
      // consistency with other error notifications
      showMessage('ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ', 'error');
      document.getElementById('edit-discount-password').focus();
      return;
    }
    
    const item = currentInvoiceItems[itemIndex];
    if (!item) {
      errorDiv.textContent = 'ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุชุฌ';
      errorDiv.classList.remove('hidden');
      return;
    }
    
    const originalPrice = item.originalPrice || item.price;
    
    // Validate discount amount
    if (newDiscountAmount < 0 || newDiscountAmount >= originalPrice) {
      errorDiv.textContent = 'ูุจูุบ ุงูุฎุตู ุบูุฑ ุตุญูุญ';
      errorDiv.classList.remove('hidden');
      return;
    }
    
    // Apply new discount
    const newFinalPrice = originalPrice - newDiscountAmount;
    
    // Update item in invoice
    currentInvoiceItems[itemIndex] = {
      ...item,
      originalPrice: originalPrice,
      discount: newDiscountAmount,
      price: newFinalPrice,
      total: newFinalPrice * item.quantity
    };
    
    // Update display
    updateInvoiceDisplay();
    
    // Close only the edit discount modal.  In previous versions this
    // used document.querySelector('.fixed'), which could select the
    // wrong element (e.g. a loading overlay).  By targeting the
    // specific ID assigned when the modal is created, the popโup
    // reliably disappears once the discount is applied.
    const editModal = document.getElementById('edit-discount-modal');
    if (editModal) {
      editModal.remove();
    }
    
    const discountMessage = newDiscountAmount > 0 
      ? `โ ุชู ุชุทุจูู ุฎุตู ${newDiscountAmount.toFixed(2)} ุฌ.ู ุนูู ${item.name}`
      : `โ ุชู ุฅุฒุงูุฉ ุงูุฎุตู ูู ${item.name}`;
    
    showMessage(discountMessage, 'success');
  }
  
  function addToInvoice() {
    if (!selectedProduct) {
      return;
    }
    
    const quantity = parseInt(document.getElementById('product-quantity').value) || 1;
    
    // ุฅุนุงุฏุฉ ุญุณุงุจ ุงููุฎุฒูู ุงููุชุงุญ ูุน ูุฑุงุนุงุฉ ุงูุนูุงุตุฑ ุงููุถุงูุฉ ูููุงุชูุฑุฉ ุงูุญุงููุฉ
    const currentInvoiceQuantity = currentInvoiceItems
      .filter(item => item.code === selectedProduct.code)
      .reduce((sum, item) => sum + item.quantity, 0);
    
    const actualAvailableStock = selectedProduct.availableStock - currentInvoiceQuantity;
    
    if (quantity > actualAvailableStock) {
      return;
    }
    
    // Check if the same product with the same discount is already in the invoice.
    // If found, simply increase its quantity rather than creating a new row.  This
    // prevents duplicate lines for the same product and ensures that discounts
    // apply uniformly across all quantities.  We compare both the product code
    // and the discount amount because the same product may be added with
    // different discount levels in separate rows.
    const existingIndex = currentInvoiceItems.findIndex(item => 
      item.code === selectedProduct.code && 
      (item.discount || 0) === (selectedProduct.discount || 0)
    );
    if (existingIndex !== -1) {
      // Update existing item by increasing the quantity.  Since the existing
      // item already has the appropriate price and discount (matching the
      // selected product by virtue of the findIndex filter), we simply
      // increment the quantity and recompute the total.
      const existingItem = currentInvoiceItems[existingIndex];
      existingItem.quantity += quantity;
      existingItem.total = existingItem.price * existingItem.quantity;
      currentInvoiceItems[existingIndex] = existingItem;
    } else {
      // Create a new invoice item
      const item = {
        code: selectedProduct.code,
        name: selectedProduct.name,
        price: selectedProduct.price,
        originalPrice: selectedProduct.originalPrice || selectedProduct.price,
        discount: selectedProduct.discount || 0,
        quantity: quantity,
        total: selectedProduct.price * quantity
      };
      currentInvoiceItems.push(item);
    }
    
    updateInvoiceDisplay();
    
    // ุชุญุฏูุซ ุงููุฎุฒูู ุงููุนุฑูุถ ููุฑุงู
    updateInventoryDisplay();
    
    // ุชุญุฏูุซ ูุนูููุงุช ุงูููุชุฌ ุงููุญุฏุฏ
    updateSelectedProductInfo();
    
    clearProductInputs();
    
    const discountMessage = selectedProduct.discount > 0 ? ` (ุจุฎุตู ${selectedProduct.discount.toFixed(2)} ุฌ.ู)` : '';
    showMessage(`โ ุชู ุฅุถุงูุฉ ${quantity} ูู ${selectedProduct.name} ูููุงุชูุฑุฉ${discountMessage}`, 'success');
  }
  
  function clearProductInputs() {
    selectedProduct = null;
    document.getElementById('product-search').value = '';
    document.getElementById('product-price').value = '';
    document.getElementById('product-discount').value = '';
    document.getElementById('final-price').value = '';
    document.getElementById('product-quantity').value = '1';
    document.getElementById('selected-product').textContent = 'ูู ูุชู ุงุฎุชูุงุฑ ููุชุฌ';
    document.getElementById('available-stock').textContent = '';
    
    const addBtn = document.getElementById('add-to-invoice-btn');
    addBtn.disabled = true;
    addBtn.className = 'w-full bg-gray-400 text-white py-3 rounded-lg font-medium transition-colors';
    
    hideSearchResults();
  }
  
  function updateInvoiceDisplay() {
    const tbody = document.getElementById('invoice-items');
    const totalElement = document.getElementById('invoice-total');
    
    if (currentInvoiceItems.length === 0) {
      // Desktop table
      tbody.innerHTML = '<tr><td colspan="8" class="border border-gray-300 p-4 text-center text-gray-500 text-sm">ูุง ุชูุฌุฏ ุนูุงุตุฑ ูู ุงููุงุชูุฑุฉ</td></tr>';
      
      totalElement.textContent = '0.00 ุฌ.ู';
      return;
    }
    
    let total = 0;
    
    // Desktop table view
    tbody.innerHTML = currentInvoiceItems.map((item, index) => {
      total += item.total;
      const originalPrice = item.originalPrice || item.price;
      const discount = item.discount || 0;
      const finalPrice = item.price;
      
      return `
        <tr>
          <td class="border border-gray-300 p-1 sm:p-2 text-xs">${item.code}</td>
          <td class="border border-gray-300 p-1 sm:p-2 text-xs">${item.name}</td>
          <td class="border border-gray-300 p-1 sm:p-2 text-xs">${originalPrice.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-1 sm:p-2">
            <div class="flex items-center justify-center gap-1">
              <span class="text-xs ${discount > 0 ? 'text-red-600 font-bold' : 'text-gray-500'}">${discount > 0 ? discount.toFixed(2) + ' ุฌ.ู' : '-'}</span>
              <button onclick="editItemDiscount(${index})" class="bg-yellow-500 hover:bg-yellow-600 text-white w-5 h-5 rounded text-xs flex items-center justify-center" title="ุชุนุฏูู ุงูุฎุตู">
                ๐
              </button>
            </div>
          </td>
          <td class="border border-gray-300 p-1 sm:p-2 text-xs ${discount > 0 ? 'text-green-600 font-bold' : ''}">${finalPrice.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-1 sm:p-2">
            <div class="flex items-center justify-center gap-1">
              <button onclick="decreaseQuantity(${index})" class="bg-red-500 hover:bg-red-600 text-white w-5 h-5 rounded text-xs flex items-center justify-center" ${item.quantity <= 1 ? 'disabled' : ''}>
                -
              </button>
              <input type="number" value="${item.quantity}" min="1"
                     onchange="updateItemQuantity(${index}, this.value)"
                     class="w-12 text-center border rounded px-1 py-1 text-xs font-bold">
              <button onclick="increaseQuantity(${index})" class="bg-green-500 hover:bg-green-600 text-white w-5 h-5 rounded text-xs flex items-center justify-center">
                +
              </button>
            </div>
          </td>
          <td class="border border-gray-300 p-1 sm:p-2 font-bold text-xs">${item.total.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-1 sm:p-2">
            <button onclick="removeFromInvoice(${index})" class="bg-red-500 hover:bg-red-600 text-white px-1 py-1 rounded text-xs">
              ุญุฐู
            </button>
          </td>
        </tr>
      `;
    }).join('');
    
    totalElement.textContent = total.toFixed(2) + ' ุฌ.ู';
    calculateRemaining();
  }
  
  function removeFromInvoice(index) {
    const removedItem = currentInvoiceItems[index];
    currentInvoiceItems.splice(index, 1);
    updateInvoiceDisplay();
    
    // ุชุญุฏูุซ ุงููุฎุฒูู ุงููุนุฑูุถ ููุฑุงู
    updateInventoryDisplay();
    
    // ุฅุฐุง ูุงู ุงูููุชุฌ ุงููุญุฐูู ูู ููุณ ุงูููุชุฌ ุงููุญุฏุฏุ ูู ุจุชุญุฏูุซ ูุนูููุงุชู
    if (selectedProduct && selectedProduct.code === removedItem.code) {
      updateSelectedProductInfo();
    }
    
    showMessage(`โ ุชู ุญุฐู ${removedItem.quantity} ูู ${removedItem.name} ูู ุงููุงุชูุฑุฉ`, 'success');
  }
  
  function updateItemQuantity(index, newQuantity) {
    const quantity = parseInt(newQuantity) || 1;
    const item = currentInvoiceItems[index];
    
    if (!item) return;
    
    // ุงูุชุญูู ูู ุชููุฑ ุงููุฎุฒูู
    const inventory = calculateInventory();
    const productInventory = inventory[item.code];
    
    if (!productInventory) {
      showMessage('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุนูููุงุช ุงููุฎุฒูู ููููุชุฌ', 'error');
      updateInvoiceDisplay();
      return;
    }
    
    // ุญุณุงุจ ุงููููุฉ ุงููุญุฌูุฒุฉ ูู ุงูููุชุฌุงุช ุงูุฃุฎุฑู ูู ุงููุงุชูุฑุฉ
    const otherReservedQuantity = currentInvoiceItems
      .filter((otherItem, otherIndex) => otherItem.code === item.code && otherIndex !== index)
      .reduce((sum, otherItem) => sum + otherItem.quantity, 0);
    
    const availableForThisItem = productInventory.availableStock - otherReservedQuantity;
    
    if (quantity > availableForThisItem) {
      showMessage(`โ ุงููููุฉ ุงููุทููุจุฉ (${quantity}) ุฃูุจุฑ ูู ุงููุชุงุญ ูู ุงููุฎุฒูู (${availableForThisItem})`, 'error');
      updateInvoiceDisplay();
      return;
    }
    
    if (quantity < 1) {
      showMessage('โ ุงููููุฉ ูุฌุจ ุฃู ุชููู 1 ุนูู ุงูุฃูู', 'error');
      updateInvoiceDisplay();
      return;
    }
    
    // ุชุญุฏูุซ ุงููููุฉ ูุงูุฅุฌูุงูู
    const oldQuantity = item.quantity;
    item.quantity = quantity;
    item.total = item.price * quantity;
    
    updateInvoiceDisplay();
    updateInventoryDisplay();
    
    // ุฅุฐุง ูุงู ุงูููุชุฌ ุงููุญุฏุซ ูู ููุณ ุงูููุชุฌ ุงููุญุฏุฏุ ูู ุจุชุญุฏูุซ ูุนูููุงุชู
    if (selectedProduct && selectedProduct.code === item.code) {
      updateSelectedProductInfo();
    }
    
    showMessage(`โ ุชู ุชุญุฏูุซ ูููุฉ ${item.name} ูู ${oldQuantity} ุฅูู ${quantity}`, 'success');
  }
  
  function increaseQuantity(index) {
    const item = currentInvoiceItems[index];
    if (!item) return;
    
    updateItemQuantity(index, item.quantity + 1);
  }
  
  function decreaseQuantity(index) {
    const item = currentInvoiceItems[index];
    if (!item || item.quantity <= 1) return;
    
    updateItemQuantity(index, item.quantity - 1);
  }
  
  // ุฏุงูุฉ ุชุญุฏูุซ ูุนูููุงุช ุงูููุชุฌ ุงููุญุฏุฏ
  function updateSelectedProductInfo() {
    if (!selectedProduct) return;
    
    const currentInvoiceQuantity = currentInvoiceItems
      .filter(item => item.code === selectedProduct.code)
      .reduce((sum, item) => sum + item.quantity, 0);
    
    const actualAvailableStock = selectedProduct.availableStock - currentInvoiceQuantity;
    
    document.getElementById('available-stock').innerHTML = `
      <div class="text-sm">
        <div class="text-blue-600">๐ฆ ูู ุงููุฎุฒูู: ${selectedProduct.availableStock} ูุทุนุฉ</div>
        ${currentInvoiceQuantity > 0 ? `<div class="text-orange-600">๐ ูู ุงููุงุชูุฑุฉ: ${currentInvoiceQuantity} ูุทุนุฉ</div>` : ''}
        <div class="font-bold ${actualAvailableStock > 0 ? 'text-green-600' : 'text-red-600'}">
          โจ ุงููุชุงุญ ููุจูุน: ${actualAvailableStock} ูุทุนุฉ
        </div>
      </div>
    `;
    
    // ุชุญุฏูุซ ุงูุญุฏ ุงูุฃูุตู ูููููุฉ
    const quantityInput = document.getElementById('product-quantity');
    quantityInput.max = actualAvailableStock;
    
    // ุฅุฐุง ูุงูุช ุงููููุฉ ุงููุฏุฎูุฉ ุฃูุจุฑ ูู ุงููุชุงุญุ ูู ุจุชุนุฏูููุง
    if (parseInt(quantityInput.value) > actualAvailableStock) {
      quantityInput.value = Math.max(1, actualAvailableStock);
    }
    
    // ุชุนุทูู ุฒุฑ ุงูุฅุถุงูุฉ ุฅุฐุง ูู ูุนุฏ ููุงู ูุฎุฒูู ูุชุงุญ
    const addBtn = document.getElementById('add-to-invoice-btn');
    if (actualAvailableStock <= 0) {
      addBtn.disabled = true;
      addBtn.className = 'w-full bg-gray-400 text-white py-3 rounded-lg font-medium transition-colors';
      addBtn.textContent = 'โ ููุฏ ุงููุฎุฒูู';
    } else {
      addBtn.disabled = false;
      addBtn.className = 'w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium transition-colors';
      addBtn.textContent = 'โ ุฅุถุงูุฉ ูููุงุชูุฑุฉ';
    }
  }
  
  function calculateRemaining() {
    const total = currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
    const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
    const remaining = total - paid;
    
    // Determine the string to display for the remaining amount. When the
    // paid amount is less than the total (remaining > 0), prefix the value
    // with a minus sign to indicate a deficit. When the paid amount is
    // greater than or equal to the total (remaining <= 0), display the
    // absolute value without a minus sign.
    const displayRemaining = remaining > 0
      ? '-' + remaining.toFixed(2)
      : Math.abs(remaining).toFixed(2);
    document.getElementById('remaining-amount').textContent = displayRemaining + ' ุฌ.ู';

    // Colour logic: highlight deficits in red and surpluses/zero in green.
    document.getElementById('remaining-amount').className = remaining > 0
      ? 'font-bold text-red-600'
      : 'font-bold text-green-600';
  }
  
  async function saveInvoice() {
    // This legacy function has been superseded by saveInvoiceNew().
    // To avoid executing the old implementation, immediately log a warning and return.
    console.warn('saveInvoice() is deprecated. Use saveInvoiceNew() instead.');
    return;
    
    // ุงูุชุญูู ูู ูุฌูุฏ ุนูุงุตุฑ ูู ุงููุงุชูุฑุฉ
    if (currentInvoiceItems.length === 0) {
      showMessage('โ ูุง ุชูุฌุฏ ุนูุงุตุฑ ูู ุงููุงุชูุฑุฉ ููุญูุธ! ูุฌุจ ุฅุถุงูุฉ ููุชุฌุงุช ุฃููุงู', 'error');
      return;
    }
    
    // ุฅุบูุงู ุฃู ููุงูุฐ ููุชูุญุฉ
    closeDiscountModal();
    const openModals = document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50');
    openModals.forEach(modal => modal.remove());
    
    showLoading();
    
    try {
      // Collect invoice data
      const customerName = document.getElementById('customer-name').value.trim() || 'ุนููู ุบูุฑ ูุญุฏุฏ';
      const customerCode = document.getElementById('customer-code').value.trim() || 'ุจุฏูู ููุฏ';
      const paid = parseFloat(document.getElementById('paid-amount').value) || 0;

      // Generate a random invoice code instead of sequential numbering.
      // This ensures each invoice has a unique, nonโpredictable identifier.
      const randomInvoiceCode =
        'INV-' + Math.random().toString(36).substr(2, 8).toUpperCase();

      console.log('๐ ูุนูููุงุช ุงููุงุชูุฑุฉ:');
      console.log('   - ููุฏ ุงููุงุชูุฑุฉ ุงูุนุดูุงุฆู:', randomInvoiceCode);
      console.log('   - ุงูุนููู:', customerName, '| ุงูููุฏ:', customerCode);
      console.log('   - ุนุฏุฏ ุงูููุชุฌุงุช:', currentInvoiceItems.length);
      
      // ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุงูููุชุฌุงุช
      const validatedItems = currentInvoiceItems.map(item => {
        const originalPrice = parseFloat(item.originalPrice) || parseFloat(item.price) || 0;
        const discountAmount = parseFloat(item.discount) || 0;
        const quantity = parseInt(item.quantity) || 1;
        const finalPrice = originalPrice - discountAmount;
        const itemTotal = finalPrice * quantity;
        
        return {
          code: item.code,
          name: item.name,
          originalPrice: originalPrice,
          discount: discountAmount,
          price: finalPrice,
          quantity: quantity,
          total: itemTotal,
          hasDiscount: discountAmount > 0
        };
      });
      
      // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
      const invoiceTotal = validatedItems.reduce((sum, item) => sum + item.total, 0);
      const totalDiscounts = validatedItems.reduce((sum, item) => sum + (item.discount * item.quantity), 0);
      const remaining = invoiceTotal - paid;
      
      console.log('๐ฐ ุงูุญุณุงุจุงุช ุงููุงููุฉ:');
      console.log('   - ุฅุฌูุงูู ุงููุงุชูุฑุฉ:', invoiceTotal.toFixed(2));
      console.log('   - ุฅุฌูุงูู ุงูุฎุตููุงุช:', totalDiscounts.toFixed(2));
      console.log('   - ุงููุฏููุน:', paid.toFixed(2));
      console.log('   - ุงููุชุจูู:', remaining.toFixed(2));
      
      // Create a unique ID for storing the invoice internally.
      const invoiceId =
        'invoice_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      // Build the invoice record.  Use the randomly generated invoice code
      // for the invoice_number field.  Also include the customer code so it can
      // be used later in the customers section or for filtering.
      invoiceRecord = {
        type: 'invoice',
        invoice_number: randomInvoiceCode,
        date: new Date().toISOString(),
        customer_name: customerName,
        customer_code: customerCode,
        total: parseFloat(invoiceTotal.toFixed(2)),
        payment_amount: parseFloat(paid.toFixed(2)),
        remaining_amount: parseFloat(remaining.toFixed(2)),
        status: remaining > 0.01 ? 'ูุนูู' : 'ูุฏููุน',
        // Store the creator (logged in user) for invoice details
        creator_name: (currentUser && currentUser.fullName) ? currentUser.fullName : '',
        creator_role: (currentUser && currentUser.role) ? currentUser.role : '',
        product_code: validatedItems.map(item => item.code).join(', '),
        product_name: validatedItems.map(item => item.name).join(', '),
        quantity: validatedItems.reduce((sum, item) => sum + item.quantity, 0),
        price:
          validatedItems.length > 0
            ? parseFloat(
                (
                  invoiceTotal /
                  validatedItems.reduce((sum, item) => sum + item.quantity, 0)
                ).toFixed(2)
              )
            : 0,
        total_discounts: parseFloat(totalDiscounts.toFixed(2)),
        has_discounts: totalDiscounts > 0 ? 'ูุนู' : 'ูุง',
        discount_percentage:
          invoiceTotal > 0 && totalDiscounts > 0
            ? parseFloat(
                (
                  (totalDiscounts / (invoiceTotal + totalDiscounts)) * 100
                ).toFixed(2)
              )
            : 0,
        id: invoiceId
      };
      
      // ุฅุถุงูุฉ ุงููุงุชูุฑุฉ ููุจูุงูุงุช ุงููุญููุฉ ููุฑุงู ูุจู ุงูุญูุธ
      allData.push(invoiceRecord);

      // Debug: show current number of invoices after adding to allData
      try {
        const invCount = allData.filter(item => item.type === 'invoice').length;
        alert('ุนุฏุฏ ุงูููุงุชูุฑ ุจุนุฏ ุงูุฅุถุงูุฉ: ' + invCount);
      } catch (e) {
        console.log('debug invoice count error', e);
      }
      console.log('๐ ุชู ุฅุถุงูุฉ ุงููุงุชูุฑุฉ ููุจูุงูุงุช ุงููุญููุฉ');
      
      // ุฅุถุงูุฉ ุจูุงูุงุช ุงููุจูุนุงุช ูุงูุฎุตููุงุช ููุจูุงูุงุช ุงููุญููุฉ ููุฑุงู
      validatedItems.forEach((item, index) => {
        // ุฅุถุงูุฉ ุจูุงูุงุช ุงูุจูุน
        const saleId = 'sale_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2, 5);
        const localSaleRecord = {
          type: 'sale',
          product_code: item.code,
          product_name: item.name,
          quantity: item.quantity,
          price: parseFloat(item.price.toFixed(2)),
          total: parseFloat(item.total.toFixed(2)),
          invoice_number: invoiceRecord.invoice_number,
          customer_name: customerName,
          customer_code: customerCode,
          date: new Date().toISOString(),
          status: 'ููุชูู',
          original_price: parseFloat(item.originalPrice.toFixed(2)),
          discount_amount: parseFloat(item.discount.toFixed(2)),
          id: saleId
        };
        allData.push(localSaleRecord);
        
        // ุฅุถุงูุฉ ุจูุงูุงุช ุงูุฎุตู ุฅุฐุง ูุฌุฏ
        if (item.discount > 0) {
          const discountId = 'discount_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2, 5);
          const localDiscountRecord = {
            type: 'discount',
            invoice_number: invoiceRecord.invoice_number,
            product_code: item.code,
            product_name: item.name,
            customer_name: customerName,
            customer_code: customerCode,
            original_price: parseFloat(item.originalPrice.toFixed(2)),
            discount_amount: parseFloat(item.discount.toFixed(2)),
            final_price: parseFloat(item.price.toFixed(2)),
            quantity: item.quantity,
            total_discount: parseFloat((item.discount * item.quantity).toFixed(2)),
            discount_percentage: parseFloat(
              ((item.discount / item.originalPrice) * 100).toFixed(2)
            ),
            date: new Date().toISOString(),
            status: 'ูุทุจู',
            id: discountId
          };
          allData.push(localDiscountRecord);
        }
      });
      
      // ุญูุธ ุงูุจูุงูุงุช ูู Firebase ูุชุญุฏูุซ ุฌููุน ุงูุนุฑูุถ ูุน ุฅููุงู ูุคูุช ูููุฒุงููุฉ ุงูุชููุงุฆูุฉ.  ูููู
      // ุจุฅููุงู ูุคูุช ููู autoSyncTimer ุซู ูุญูุธ ุงูุจูุงูุงุช ูู Firebase. ุฅุฐุง ูุฌุญ ุงูุญูุธุ
      // ูุนูุฏ ุชุญููู ุงูุจูุงูุงุช ูู Firebase ูุชุญุฏูุซ allData. ุจุนุฏ ุฐูู ูุนูุฏ ุชุดุบูู
      // ุงููุคูุช (ุฅู ูุงู ููุนููุง) ููุณุชุฏุนู updateAllDisplays ูุฅุธูุงุฑ ุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ.
      (async () => {
        const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
        if (wasAutoSyncActive) {
          clearInterval(window.autoSyncTimer);
          window.autoSyncTimer = null;
        }
        let saveSucceeded = false;
        try {
          await saveDataToFirebase();
          saveSucceeded = true;
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุจูุงูุงุช ุงููุงุชูุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
        }
        if (saveSucceeded) {
          try {
            await loadDataFromFirebase();
          } catch (err) {
            console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุญูุธ ุงููุงุชูุฑุฉ:', err);
          }
        }
        if (wasAutoSyncActive) {
          window.autoSyncTimer = setInterval(() => {
            Promise.resolve(backgroundSync());
          }, 5000);
        }
        updateAllDisplays();
      })();
      
      console.log('๐ ุชู ุชุญุฏูุซ ุฌููุน ุงูุนุฑูุถ - ุงููุงุชูุฑุฉ ุธุงูุฑุฉ ุงูุขู ูู ูุณู ุงูููุงุชูุฑ');
      
      // ูุณุญ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ
      const itemsCount = validatedItems.length;
      const hasDiscounts = totalDiscounts > 0;
      
      currentInvoiceItems = [];
      selectedProduct = null;
      
      // ูุณุญ ุฌููุน ุงูุญููู
      document.getElementById('paid-amount').value = '';
      document.getElementById('customer-name').value = '';
      document.getElementById('customer-code').value = '';
      clearProductInputs();
      
      // ุชุญุฏูุซ ุนุฑุถ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ
      updateInvoiceDisplay();
      
      hideLoading();
      
      // ุฑุณุงูุฉ ุงููุฌุงุญ ูุน ุฅุฑุดุงุฏ ูููุณุชุฎุฏู
      let successMessage = `โ ุชู ุญูุธ ุงููุงุชูุฑุฉ ููุฏ ${invoiceRecord.invoice_number} ุจูุฌุงุญ!`;
      successMessage += `\n๐ฆ ุชู ุญูุธ ${itemsCount} ููุชุฌ`;
      successMessage += `\n๐ฐ ุฅุฌูุงูู ุงููุงุชูุฑุฉ: ${invoiceTotal.toFixed(2)} ุฌ.ู`;
      
      if (hasDiscounts) {
        successMessage += `\n๐ธ ุชู ุชุทุจูู ุฎุตููุงุช ุจูููุฉ ${totalDiscounts.toFixed(2)} ุฌ.ู`;
      }
      
      successMessage += `\n\n๐๏ธ ุงููุงุชูุฑุฉ ูุชุงุญุฉ ุงูุขู ูู ูุณู "ุงูููุงุชูุฑ"`;
      successMessage += `\n๐พ ุชู ุญูุธ ุงูุจูุงูุงุช ูู ุงููุธุงู ุงููุญูู`;
      
      showMessage(successMessage, 'success');
      
      // ุฅุธูุงุฑ ุฑุณุงูุฉ ุฅุถุงููุฉ ููุชูุฌูู
      setTimeout(() => {
        showMessage('๐ก ููููู ุงูุขู ุงูุงูุชูุงู ุฅูู ูุณู "ุงูููุงุชูุฑ" ููุฑุงุฌุนุฉ ุงููุงุชูุฑุฉ ุงููุญููุธุฉ', 'info');
      }, 3500);
      
    } catch (error) {
      hideLoading();
      console.error('๐ฅ ุฎุทุฃ ูู ุญูุธ ุงููุงุชูุฑุฉ:', error);

      // Show an alert with the error message for debugging purposes
      alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุงุชูุฑุฉ: ' + (error && error.message ? error.message : error));

      // Remove any data added for this invoice if a failure occurs.  We rely on the
      // invoiceRecord generated earlier to determine which items to purge.
      if (invoiceRecord && invoiceRecord.invoice_number) {
        const filtered = allData.filter(item =>
          !(
            (item.type === 'invoice' && item.invoice_number === invoiceRecord.invoice_number) ||
            (item.type === 'sale' && item.invoice_number === invoiceRecord.invoice_number) ||
            (item.type === 'discount' && item.invoice_number === invoiceRecord.invoice_number)
          )
        );
        allData.length = 0;
        allData.push(...filtered);
      }
      updateAllDisplays();

      // Close any open modals in case of error
      closeDiscountModal();
      const openModals = document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50');
      openModals.forEach(modal => modal.remove());

      // Build a userโfriendly error message
      let errorMessage = 'โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุงุชูุฑุฉ:\n';
      errorMessage += error.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู';
      errorMessage += '\n\n๐ก ุงูุญููู ุงูููุชุฑุญุฉ:';
      errorMessage += '\nโข ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ ูุญุงูู ูุฑุฉ ุฃุฎุฑู';
      errorMessage += '\nโข ุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ุงููุฏุฎูุฉ';

      showMessage(errorMessage, 'error');
    }
  }

  //
  // ุญูุธ ุงููุงุชูุฑุฉ ูุฅุถุงูุชูุง ุฅูู ูุณู ุงูููุงุชูุฑ. ูุฐู ุงูุฏุงูุฉ ุชูุณุชุฏุนู ุนูุฏ ุงูุถุบุท
  // ุนูู ุฒุฑ "ุญูุธ ุงููุงุชูุฑุฉ". ุชููู ุจุญุณุงุจ ุจูุงูุงุช ุงููุงุชูุฑุฉ ูุงููุจูุนุงุช
  // ูุงูุฎุตููุงุชุ ุญูุธูุง ูู allDataุ ุซู ูุฒุงููุฉ ุงูุจูุงูุงุช ูุน Firebase. ูู
  // ุงูููุงูุฉ ุชููู ุจุญุฐู ุงูุนูุงุตุฑ ุงูุญุงููุฉ ูู ุดุงุดุฉ ุงููุงุชูุฑุฉ ูุนุฑุถ ุฑุณุงูุฉ
  // ูุฌุงุญ ุฎุถุฑุงุก ุนูุฏ ุงูุชูุงู ุงูุนูููุฉ.
  async function saveInvoiceNew() {
    // ุจุณูุท ูุญูุธ ุงููุงุชูุฑุฉ ูุญููุงู ุจุฏูู ุฃู ุนูููุงุช ุดุจูุฉ. ูุนุฑุถ ุฑุณุงูุฉ
    // ูุคูุชุฉ ูุฅุนูุงู ุงููุณุชุฎุฏู ุจุจุฏุก ุนูููุฉ ุงูุญูุธุ ุซู ูููู ุจุฅูุดุงุก
    // ุงูุณุฌูุงุช ุงููุงุฒูุฉ ูุฅุถุงูุชูุง ุฅูู allData ูุชุญุฏูุซ ุงููุงุฌูุฉ ูุจุงุดุฑุฉ.
    try {
      // ุฅุธูุงุฑ ุฑุณุงูุฉ ููุฏ ุงูุญูุธ
      showMessage('๐ ุฌุงุฑู ุญูุธ ุงููุงุชูุฑุฉ...', 'info');
      // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู ูุฅุนูุงู ุงููุณุชุฎุฏู ุจุจุฏุก ุนูููุฉ ุงูุญูุธ
      if (typeof showLoading === 'function') {
        showLoading();
      }

      // ุงูุชุญูู ูู ูุฌูุฏ ุนูุงุตุฑ ูู ุงููุงุชูุฑุฉ
      if (!currentInvoiceItems || currentInvoiceItems.length === 0) {
        showMessage('โ ูุง ุชูุฌุฏ ุนูุงุตุฑ ูู ุงููุงุชูุฑุฉ ููุญูุธ! ูุฌุจ ุฅุถุงูุฉ ููุชุฌุงุช ุฃููุงู', 'error');
        return;
      }

      // ุฌูุน ุจูุงูุงุช ุงูุนููู ูุงูุฏูุนุงุชุ ูุน ููู ุงูุชุฑุงุถูุฉ ูู ุญุงูุฉ ุนุฏู ุฅุฏุฎุงููุง
      // Retrieve the customer name from the input element.  If the field is empty,
      // display an error message and stop the save operation.  Unlike the
      // previous implementation, this makes entering a customer name mandatory.
      const customerNameElem = document.getElementById('customer-name');
      const customerName = (customerNameElem?.value || '').trim();
      if (!customerName) {
        showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู', 'error');
        return;
      }
      // ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ุจุฅุฏุฎุงู ููุฏ ููุนูููุ ูููู ุจุชูููุฏ ููุฏ ุนุดูุงุฆู ูููู ูู
      // ุญุฑููู ูุซูุงุซุฉ ุฃุฑูุงู ูุงุณุชุฎุฏุงูู ููููุฉ ุงูุชุฑุงุถูุฉ. ููุง ูููู ุจููุก ุญูู ุฅุฏุฎุงู
      // ููุฏ ุงูุนููู ุจูุฐุง ุงูููุฏ ููู ูุฑู ุงููุณุชุฎุฏู ุงูููุฏ ุงูููุนููู.
      const rawCustomerCode = (document.getElementById('customer-code')?.value || '').trim();
      let customerCode = rawCustomerCode || generateRandomCustomerCode();
      if (!rawCustomerCode && document.getElementById('customer-code')) {
        document.getElementById('customer-code').value = customerCode;
      }
      // ุงูุญุตูู ุนูู ูููุฉ "ุงููุฏููุน". ุฅุฐุง ูุงูุช ุงูุฎุงูุฉ ูุงุฑุบุฉ ุฃู ุบูุฑ ุฑูููุฉ ุฃู ุตูุฑุ
      // ูุนุชุจุฑ ุฃู ุงููุงุชูุฑุฉ ูุฏููุนุฉ ุจุงููุงููุ ูุณูุชู ุชุนููู ุงููููุฉ ูุงุญูุงู ุจุนุฏ ุญุณุงุจ
      // ุฅุฌูุงูู ุงููุงุชูุฑุฉ. ูุฐุง ูุชูุญ ุญูุธ ุงููุงุชูุฑุฉ ุฏูู ุชุนููู ุนูุฏ ุชุฑู ุงูุฎุงูุฉ ูุงุฑุบุฉ.
      let paidInput = document.getElementById('paid-amount')?.value;
      let paid = parseFloat(paidInput);
      // If the user leaves the paid-amount input blank or enters a non-numeric value,
      // treat it as null (meaning pay later).  Otherwise keep the numeric value.
      // We no longer treat zero as null so that a user can explicitly specify
      // that nothing has been paid yet.
      if (isNaN(paid) || paidInput === '') {
        paid = null;
      }

      // ุงุณุชุฎุฏุงู ุงูุฑูู ุงูุนุดูุงุฆู ุงูุธุงูุฑ ุจุฌุงูุจ "ูุงุชูุฑุฉ ุงูุจูุน" ูุฑูู ุงููุงุชูุฑุฉ
      // ุจุฏูุงู ูู ุงูููุฏ ุงูุนุดูุงุฆู ุงููุฏูู. ุฅุฐุง ูู ููู ูุชุงุญุงูุ ูุชู ุชูููุฏ ุฑูู ุฌุฏูุฏ.
      let invoiceNumber;
      const tempSpan = document.getElementById('temp-invoice-number-display');
      if (tempSpan && tempSpan.dataset && tempSpan.dataset.tempNumber) {
        invoiceNumber = tempSpan.dataset.tempNumber;
      } else {
        invoiceNumber = generateTempInvoiceNumber();
      }
      const invoiceId = 'invoice_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);

      // ุงุณุชุฎุฏุงู ุงูุชูููุช ุงูููุญุฏ ุฅุฐุง ุชููุฑ
      const timestamp = window.systemCurrentDateTimeISO || new Date().toISOString();

      // ุญุณุงุจ ุงูุฅุฌูุงูู ูุงููุชุจูู
      let invoiceTotal = 0;
      currentInvoiceItems.forEach(item => {
        const originalPrice = parseFloat(item.originalPrice) || parseFloat(item.price) || 0;
        const discountAmount = parseFloat(item.discount) || 0;
        const quantity = parseInt(item.quantity) || 1;
        // Use the stored final price on the item if available to avoid
        // recalculating the final price from originalPrice - discountAmount.
        // This prevents doubleโdiscounting or mismatches when the item
        // price has already been updated via editItemDiscount().  Fallback
        // to computing from originalPrice and discountAmount if the price
        // field is missing or invalid.
        let finalPrice;
        if (typeof item.price !== 'undefined' && item.price !== null && !isNaN(parseFloat(item.price))) {
          finalPrice = parseFloat(item.price);
        } else {
          finalPrice = originalPrice - discountAmount;
        }
        invoiceTotal += finalPrice * quantity;
      });
      // ุฅุฐุง ูู ูุชู ุฅุฏุฎุงู ูููุฉ ูููุฏููุนุ ูุนุชุจุฑ ุงููุงุชูุฑุฉ ูุฏููุนุฉ ุจุงููุงูู
      if (paid === null) {
        paid = invoiceTotal;
      }
      const remaining = invoiceTotal - paid;

      // ุฅูุดุงุก ุณุฌู ุงููุงุชูุฑุฉ ูุฅุถุงูุชู ุฅูู allData
      const invoiceRecord = {
        type: 'invoice',
        invoice_number: invoiceNumber,
        date: timestamp,
        customer_name: customerName,
        customer_code: customerCode,
        total: parseFloat(invoiceTotal.toFixed(2)),
        payment_amount: parseFloat(paid.toFixed(2)),
        remaining_amount: parseFloat(remaining.toFixed(2)),
        status: remaining > 0.01 ? 'ูุนูู' : 'ูุฏููุน',
        // Store the creator (logged in user) so invoice details can show who created it
        creator_name: (currentUser && currentUser.fullName) ? currentUser.fullName : '',
        creator_role: (currentUser && currentUser.role) ? currentUser.role : '',
        id: invoiceId
      };
      // Attach payment breakdown if provided via the payment modal
      if (typeof window.currentPaymentVisa !== 'undefined' && typeof window.currentPaymentCash !== 'undefined') {
        const visaAmt = parseFloat(window.currentPaymentVisa) || 0;
        const cashAmt = parseFloat(window.currentPaymentCash) || 0;
        invoiceRecord.visa_amount = parseFloat(visaAmt.toFixed(2));
        invoiceRecord.cash_amount = parseFloat(cashAmt.toFixed(2));
        if (visaAmt > 0 && cashAmt > 0) {
          invoiceRecord.payment_method = 'ูุฎุชูุทุฉ';
        } else if (visaAmt > 0) {
          invoiceRecord.payment_method = 'ููุฒุง';
        } else {
          invoiceRecord.payment_method = 'ูุงุด';
        }
        // Clear global variables after use
        delete window.currentPaymentVisa;
        delete window.currentPaymentCash;
      }
      allData.push(invoiceRecord);

      // ุฅูุดุงุก ุณุฌูุงุช ุงููุจูุนุงุช ูุงูุฎุตููุงุช ุงููุฑุชุจุทุฉ
      currentInvoiceItems.forEach((item, index) => {
        const originalPrice = parseFloat(item.originalPrice) || parseFloat(item.price) || 0;
        const discountAmount = parseFloat(item.discount) || 0;
        const quantity = parseInt(item.quantity) || 1;
        // Use the stored final price on the item if available; otherwise
        // compute from originalPrice and discountAmount.  This ensures
        // consistency with editItemDiscount() where the price field may
        // already represent the discounted value.
        let finalPrice;
        if (typeof item.price !== 'undefined' && item.price !== null && !isNaN(parseFloat(item.price))) {
          finalPrice = parseFloat(item.price);
        } else {
          finalPrice = originalPrice - discountAmount;
        }
        const total = finalPrice * quantity;

        // Determine the purchase price to record at the time of sale.  We look up
        // the most recent purchase for this product from allData.  If found,
        // use its purchase_price; otherwise default to zero.  Recording the
        // purchase price on the sale record allows accurate profit
        // calculations without relying on inventory state.
        let recordedPurchasePrice = 0;
        try {
          const matchingPurchases = allData
            .filter(p => p.type === 'purchase' && p.product_code === item.code)
            .sort((a, b) => new Date(b.date) - new Date(a.date));
          if (matchingPurchases.length > 0) {
            const mostRecent = matchingPurchases[0];
            const priceVal = parseFloat(mostRecent.purchase_price);
            if (!isNaN(priceVal)) recordedPurchasePrice = priceVal;
          }
        } catch (err) {
          // If any error occurs while determining the purchase price, log it and
          // fall back to zero.  This ensures that the sale process continues
          // smoothly.
          console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุฏ ุณุนุฑ ุงูุดุฑุงุก ููููุชุฌ ุฃุซูุงุก ุฅูุดุงุก ุณุฌู ุงููุจูุนุงุช:', err);
        }
        const saleRecord = {
          type: 'sale',
          product_code: item.code,
          product_name: item.name,
          quantity: quantity,
          price: parseFloat(finalPrice.toFixed(2)),
          total: parseFloat(total.toFixed(2)),
          invoice_number: invoiceNumber,
          customer_name: customerName,
          customer_code: customerCode,
          date: timestamp,
          status: 'ููุชูู',
          original_price: parseFloat(originalPrice.toFixed(2)),
          discount_amount: parseFloat(discountAmount.toFixed(2)),
          // Store the purchase price at the time of sale for profit calculations
          purchase_price: parseFloat(recordedPurchasePrice.toFixed(2)),
          id: 'sale_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substring(2, 5)
        };
        allData.push(saleRecord);

        if (discountAmount > 0) {
          const discountRecord = {
            type: 'discount',
            invoice_number: invoiceNumber,
            product_code: item.code,
            product_name: item.name,
            customer_name: customerName,
            customer_code: customerCode,
            original_price: parseFloat(originalPrice.toFixed(2)),
            discount_amount: parseFloat(discountAmount.toFixed(2)),
            final_price: parseFloat(finalPrice.toFixed(2)),
            quantity: quantity,
            total_discount: parseFloat((discountAmount * quantity).toFixed(2)),
            discount_percentage: originalPrice > 0 ? parseFloat(((discountAmount / originalPrice) * 100).toFixed(2)) : 0,
            date: timestamp,
            status: 'ูุทุจู',
            // ุณุฌู ุงุณู ุงููุณุชุฎุฏู ุงูุฐู ุฃูุดุฃ ุงูุฎุตู ูุฑุจุท ุงูุฎุตููุงุช ุจุงููุณุชุฎุฏู
            creator_name: (currentUser && currentUser.fullName) ? currentUser.fullName : ((currentUser && currentUser.username) ? currentUser.username : ''),
            id: 'discount_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substring(2, 5)
          };
          allData.push(discountRecord);
        }
      });

      // ุชุญุฏูุซ ุงููุงุฌูุฉ ูุนุฑุถ ุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ
      updateAllDisplays();

      // ูุณุญ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ ูุงูุญููู
      currentInvoiceItems = [];
      selectedProduct = null;
      if (document.getElementById('paid-amount')) document.getElementById('paid-amount').value = '';
      if (document.getElementById('customer-name')) document.getElementById('customer-name').value = '';
      if (document.getElementById('customer-code')) document.getElementById('customer-code').value = '';
      clearProductInputs();
      updateInvoiceDisplay();

      // ุจุนุฏ ุญูุธ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ ูููู ุจุชุญุฏูุซ ุงูุฑูู ุงููุคูุช ูููุงุชูุฑุฉ
      // ุงูุชุงููุฉ ุจุญูุซ ูุชู ุนุฑุถ ุฑูู ุฌุฏูุฏ ูููู ูู ุฎูุณ ุฃุฑูุงู ุนุดูุงุฆูุฉ. ูุฐุง
      // ูุณุงุนุฏ ุงููุณุชุฎุฏู ุนูู ูุนุฑูุฉ ุฑูู ุงููุงุชูุฑุฉ ุงููุงุฏู.
      updateTempInvoiceNumberDisplay();

      // ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ
      showMessage(`โ ุชู ุญูุธ ุงููุงุชูุฑุฉ ููุฏ ${invoiceNumber} ุจูุฌุงุญ!`, 'success');

      // ุญูุธ ุฌููุน ุงูุชุบููุฑุงุช ูู Firebase ูุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ููุชุฃูุฏ ูู ุงูุชุฒุงูู ุงูููุฑู.
      // ุฃุซูุงุก ุนูููุฉ ุงูุญูุธุ ูููู ุจุฅููุงู ูุคูุช ููุคูุช ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ ูููุน
      // backgroundSync ูู ุชุดุบูู ุนูููุงุช ุญูุธ/ุชุญููู ูุชุฒุงููุฉ ูุฏ ุชุนูุฏ
      // ุจูุงูุงุช ูุฏููุฉ. ุจุนุฏ ุงูุงูุชูุงุก ูู ุงูุญูุธ ูุฅุนุงุฏุฉ ุงูุชุญูููุ ูุณุชุนูุฏ
      // ุงููุฒุงููุฉ ุฅุฐุง ูุงูุช ูุดุทุฉ ูุณุจููุง.
      const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
      if (wasAutoSyncActive) {
        clearInterval(window.autoSyncTimer);
        window.autoSyncTimer = null;
      }
      let saveSucceeded = false;
      try {
        await saveDataToFirebase();
        saveSucceeded = true;
      } catch (err) {
        console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุงุชูุฑุฉ ูู Firebase:', err);
      }
      if (saveSucceeded) {
        try {
          await loadDataFromFirebase();
        } catch (err) {
          console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุญูุธ ุงููุงุชูุฑุฉ:', err);
        }
      }
      if (wasAutoSyncActive) {
        window.autoSyncTimer = setInterval(() => {
          Promise.resolve(backgroundSync());
        }, 5000);
      }
      // ุชุญุฏูุซ ูุงูุฉ ุงูุนุฑูุถ ุจุนุฏ ุงูุญูุธ ูุฅุธูุงุฑ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ูู ุฌููุน ุงูุฃูุณุงู
      updateAllDisplays();
      // ุฅุฎูุงุก ูุคุดุฑ ุงูุชุญููู ุจุนุฏ ุงูุชูุงุก ุนูููุฉ ุงูุญูุธ ูุงููุฒุงููุฉ
      if (typeof hideLoading === 'function') {
        hideLoading();
      }
    } catch (err) {
      console.error('๐ฅ ุฎุทุฃ ูู ุญูุธ ุงููุงุชูุฑุฉ:', err);
      showMessage('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุงุชูุฑุฉ: ' + (err && err.message ? err.message : err), 'error');
      // ุชุฃูุฏ ูู ุฅุฎูุงุก ูุคุดุฑ ุงูุชุญููู ูู ุญุงู ุญุฏูุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ
      if (typeof hideLoading === 'function') {
        hideLoading();
      }
    }
  }

  // Expose the new saveInvoiceNew function on the global window object.
  // In some browsers, functions defined inside script tags may not be
  // automatically attached to the window when the script is loaded.
  // Attaching it explicitly ensures the onclick handler can find and
  // execute it when the "ุญูุธ ุงููุงุชูุฑุฉ" button is clicked.
  window.saveInvoiceNew = saveInvoiceNew;

  // -------------------------------------------------------------------------
  // Helpers for generating random codes and updating the temporary invoice
  // number display.
  //
  // generateRandomCustomerCode(): returns a 5โcharacter string consisting of
  // two letters followed by three digits. The letters are chosen randomly
  // from the English alphabet and converted to lowercase to match the
  // example provided in the user requirements (e.g., "ae432").
  // generateTempInvoiceNumber(): returns a 5โdigit number as a string. The
  // first digit is guaranteed to be nonโzero so that the number always
  // contains five digits.
  // updateTempInvoiceNumberDisplay(): updates the <span> next to the sales
  // invoice heading with a fresh 5โdigit number. Should be called after
  // initialization and whenever a new invoice is started (e.g., after
  // saving the current invoice).
  function generateRandomCustomerCode() {
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const digits = '0123456789';
    let code = '';
    for (let i = 0; i < 2; i++) {
      code += letters.charAt(Math.floor(Math.random() * letters.length));
    }
    for (let i = 0; i < 3; i++) {
      code += digits.charAt(Math.floor(Math.random() * digits.length));
    }
    return code.toLowerCase();
  }

  function generateTempInvoiceNumber() {
    const number = Math.floor(Math.random() * 90000) + 10000;
    return number.toString();
  }

  function updateTempInvoiceNumberDisplay() {
    const span = document.getElementById('temp-invoice-number-display');
    if (span) {
      const num = generateTempInvoiceNumber();
      // Store the raw number on the element so it can be used as the
      // invoice code when saving the invoice.
      span.dataset.tempNumber = num;
      // Display the number with a prefix to indicate invoice number in Arabic.
      span.textContent = `${num}`;
    }
  }

  /**
   * ูุฎุฒู ุงูููุงุชูุฑ ุงููุนููุฉ ูู ูุตูููุฉ ุนุงูููุฉ. ูุฌุจ ุฅูุดุงุก ุงููุตูููุฉ ุฅุฐุง ูู ุชูู
   * ููุฌูุฏุฉ ูุณุจูุงู. ุชุญุชูู ูู ูุงุชูุฑุฉ ูุนููุฉ ุนูู ุฑูู ุงููุงุชูุฑุฉุ ุชุงุฑูุฎ
   * ุงูุชุนูููุ ุจูุงูุงุช ุงูุนูููุ ุฅุฌูุงูู ุงููุงุชูุฑุฉุ ุงููุจูุบ ุงููุฏููุนุ ุงูุฑุตูุฏ
   * ุงููุชุจููุ ููุงุฆูุฉ ุงูุนูุงุตุฑ ุงูุญุงููุฉ ุนูุฏ ุงูุชุนููู. ูุง ูุชู ุชุณุฌูููุง ูู
   * allData ุญุชู ูุชู ุญูุธูุง ุฑุณููุงู.
   */
  if (!window.suspendedInvoices) {
    window.suspendedInvoices = [];
  }

  /**
   * ุชุนููู ุงููุงุชูุฑุฉ ุงูุญุงููุฉ: ุนูุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ ุฃู ุงูููุชุงุญ F6 ูุชู ุฌูุน
   * ุงูุจูุงูุงุช ุงูุญุงููุฉ ูููุงุชูุฑุฉ (ุงูุนูููุ ุงููุจูุบ ุงููุฏููุนุ ุงูุนูุงุตุฑ) ูุฅูุดุงุก
   * ูุงุฆู ููุซู ูุงุชูุฑุฉ ูุนููุฉ ุซู ุฅุถุงูุชู ุฅูู ูุตูููุฉ suspendedInvoices. ุจุนุฏ
   * ุฐูู ูุชู ูุณุญ ูุญุชูู ุงููุงุชูุฑุฉ ุงูุญุงููุฉ ูุจุฏุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ. ูุง ูุชู ุฅุถุงูุฉ
   * ุฃู ุณุฌูุงุช ูุจูุนุงุช ุฃู ุฎุตููุงุช ุฅูู allData ูู ูุฐู ุงููุฑุญูุฉ.
   */
  function suspendCurrentInvoice() {
    try {
      // ุชุฃูุฏ ูู ูุฌูุฏ ุนูุงุตุฑ ูู ุงููุงุชูุฑุฉ
      if (!currentInvoiceItems || currentInvoiceItems.length === 0) {
        showMessage('โ ูุง ุชูุฌุฏ ุนูุงุตุฑ ูู ุงููุงุชูุฑุฉ ูุชุนููููุง!', 'error');
        return;
      }
      // ุงุฌูุน ูุนูููุงุช ุงูุนููู ูุงูุฏูุน
      // Require a customer name when suspending an invoice.  If the input is empty,
      // notify the user and abort the suspension.  This mirrors the save operation
      // where a customer name is also mandatory.
      const customerNameElem = document.getElementById('customer-name');
      const customerName = (customerNameElem?.value || '').trim();
      if (!customerName) {
        showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู', 'error');
        return;
      }
      const customerCode = (document.getElementById('customer-code')?.value || '').trim() || '';
      const paidInput = document.getElementById('paid-amount')?.value;
      let paid = parseFloat(paidInput);
      if (isNaN(paid)) {
        paid = 0;
      }
      // ุญุณุงุจ ุงูุฅุฌูุงูู ูุงููุชุจูู ุงุณุชูุงุฏุงู ุฅูู currentInvoiceItems
      let invoiceTotal = 0;
      currentInvoiceItems.forEach(item => {
        const originalPrice = parseFloat(item.originalPrice) || parseFloat(item.price) || 0;
        const discountAmount = parseFloat(item.discount) || 0;
        const quantity = parseInt(item.quantity) || 1;
        const finalPrice = originalPrice - discountAmount;
        invoiceTotal += finalPrice * quantity;
      });
      const remaining = invoiceTotal - paid;
      // ุงุณุชุฎุฏู ุงูุฑูู ุงููุคูุช ุงูุญุงูู ูุฑูู ุงููุงุชูุฑุฉ ุงููุนููุฉ
      const tempSpan = document.getElementById('temp-invoice-number-display');
      let invoiceNumber = '';
      if (tempSpan && tempSpan.dataset && tempSpan.dataset.tempNumber) {
        invoiceNumber = tempSpan.dataset.tempNumber;
      } else {
        invoiceNumber = generateTempInvoiceNumber();
      }
      // ุฅูุดุงุก ุณุฌู ุงููุงุชูุฑุฉ ุงููุนููุฉ
      // ูุณุฌู ุฃูุถุงู ุงุณู ุงููุณุชุฎุฏู ุงูุฐู ูุงู ุจุงูุชุนููู ููุณุชุทูุน ุงููุณุคูู ุฑุคูุฉ ูู ุนูู ุงููุงุชูุฑุฉ.
      const suspended = {
        invoice_number: invoiceNumber,
        date: new Date().toISOString(),
        customer_name: customerName,
        customer_code: customerCode,
        total: parseFloat(invoiceTotal.toFixed(2)),
        payment_amount: parseFloat(paid.toFixed(2)),
        remaining_amount: parseFloat(remaining.toFixed(2)),
        items: JSON.parse(JSON.stringify(currentInvoiceItems)), // ูุณุฎ ุนููู ููุนูุงุตุฑ
        suspended_by_name: (currentUser && currentUser.fullName) ? currentUser.fullName : ((currentUser && currentUser.username) ? currentUser.username : '')
      };
      window.suspendedInvoices.push(suspended);
      // ุงุญูุธ ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase ุจุนุฏ ุฅุถุงูุฉ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
      if (typeof saveSuspendedInvoices === 'function') {
        saveSuspendedInvoices().catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูููุงุชูุฑ ุงููุนููุฉ ุฃุซูุงุก ุชุนููู ุงููุงุชูุฑุฉ:', err);
        });
      }
      // ุญุฏุซ ูุต ุงูุฒุฑ ููุนูุณ ุนุฏุฏ ุงูููุงุชูุฑ ุงููุนููุฉ ุงูุฌุฏูุฏ
      if (typeof updateSuspendedInvoicesButton === 'function') {
        updateSuspendedInvoicesButton();
      }
      // ูุณุญ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ ูุฅุนุงุฏุฉ ุชููุฆุฉ ุงูุญููู
      currentInvoiceItems = [];
      selectedProduct = null;
      if (document.getElementById('paid-amount')) document.getElementById('paid-amount').value = '';
      if (document.getElementById('customer-name')) document.getElementById('customer-name').value = '';
      if (document.getElementById('customer-code')) document.getElementById('customer-code').value = '';
      clearProductInputs();
      updateInvoiceDisplay();
      // ุชุญุฏูุซ ุงูุฑูู ุงููุคูุช ูููุงุชูุฑุฉ ุงูุชุงููุฉ
      updateTempInvoiceNumberDisplay();
      calculateRemaining();
      showMessage(`โ ุชู ุชุนููู ุงููุงุชูุฑุฉ ุฑูู ${invoiceNumber}. ููููู ุงุณุชุฆูุงููุง ูู ูุงุฆูุฉ ุงูููุงุชูุฑ ุงููุนููุฉ.`, 'success');
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุนููู ุงููุงุชูุฑุฉ:', err);
      showMessage('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุนููู ุงููุงุชูุฑุฉ', 'error');
    }
  }

  /**
   * ุนุฑุถ ูุงุฆูุฉ ุงูููุงุชูุฑ ุงููุนููุฉ ูู ูุงูุฐุฉ ููุจุซูุฉ ุจุญูุซ ูููู ูููุณุชุฎุฏู ุงุฎุชูุงุฑ
   * ูุงุชูุฑุฉ ูุงุณุชุฆูุงููุง. ุชููุดุฆ ูุฐู ุงูุฏุงูุฉ ูุญุชูู ุงููุงุฆูุฉ ุฏููุงููููุงู ุจูุงุกู
   * ุนูู ูุตูููุฉ suspendedInvoices. ุฅุฐุง ูู ุชูุฌุฏ ููุงุชูุฑ ูุนููุฉ ูุชู
   * ุนุฑุถ ุฑุณุงูุฉ ููุงุณุจุฉ.
   */
  function showSuspendedInvoicesList() {
    const modal = document.getElementById('suspended-invoices-modal');
    const listDiv = document.getElementById('suspended-invoices-list');
    if (!modal || !listDiv) return;
    // ุชูุธูู ุงููุงุฆูุฉ ุฃููุงู
    listDiv.innerHTML = '';
    if (!window.suspendedInvoices || window.suspendedInvoices.length === 0) {
      listDiv.innerHTML = '<p class="text-center text-gray-600">ูุง ุชูุฌุฏ ููุงุชูุฑ ูุนููุฉ</p>';
    } else {
      // ุจูุงุก ูุงุฆูุฉ ูู ุงูุฃุฒุฑุงุฑ ููู ูุงุชูุฑุฉ ูุนููุฉ
      window.suspendedInvoices.forEach((inv, idx) => {
        const btn = document.createElement('button');
        btn.className = 'w-full bg-gray-100 hover:bg-gray-200 p-2 rounded mb-2 flex justify-between items-center';
        // ุนุฑุถ ุงุณู ุงููุณุชุฎุฏู ุงูุฐู ูุงู ุจุชุนููู ุงููุงุชูุฑุฉ ุฅู ูุฌุฏ
        const suspendedBy = inv.suspended_by_name ? ' - ' + inv.suspended_by_name : '';
        const dateStr = new Date(inv.date).toLocaleString('ar-EG');
        btn.innerHTML = `<span>ูุงุชูุฑุฉ ุฑูู ${inv.invoice_number}${suspendedBy}</span><span>${dateStr}</span>`;
        btn.onclick = function() { resumeSuspendedInvoice(idx); };
        listDiv.appendChild(btn);
      });
    }
    modal.classList.remove('hidden');
  }

  /**
   * ุงุณุชุฆูุงู ูุงุชูุฑุฉ ูุนููุฉ: ูุชู ููู ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงููุญุฏุฏุฉ ูู ูุงุฆูุฉ
   * suspendedInvoices ุฅูู ุดุงุดุฉ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ ุญุชู ูุชููู ุงููุณุชุฎุฏู ูู
   * ุชุนุฏูููุง ุฃู ุญูุธูุง. ุจุนุฏ ุงูุงุณุชุฆูุงู ุชุชู ุฅุฒุงูุฉ ุงููุงุชูุฑุฉ ูู ูุงุฆูุฉ
   * ุงููุนููุงุช.
   */
  function resumeSuspendedInvoice(index) {
    try {
      if (!window.suspendedInvoices || !window.suspendedInvoices[index]) return;
      const inv = window.suspendedInvoices[index];
      // ุชุญููู ุงูุนูุงุตุฑ
      currentInvoiceItems = JSON.parse(JSON.stringify(inv.items));
      selectedProduct = null;
      // ุชุนุจุฆุฉ ุญููู ุงูุนููู ูุงูุฏูุน
      if (document.getElementById('customer-name')) document.getElementById('customer-name').value = inv.customer_name || '';
      if (document.getElementById('customer-code')) document.getElementById('customer-code').value = inv.customer_code || '';
      if (document.getElementById('paid-amount')) document.getElementById('paid-amount').value = inv.payment_amount != null ? inv.payment_amount : '';
      // ุชุญุฏูุซ ุฑูู ุงููุงุชูุฑุฉ ุงููุคูุช ููุชุทุงุจู ูุน ุงููุงุชูุฑุฉ ุงููุนููุฉ
      const span = document.getElementById('temp-invoice-number-display');
      if (span) {
        span.dataset.tempNumber = inv.invoice_number;
        span.textContent = `${inv.invoice_number}`;
      }
      // ุฅุฒุงูุฉ ุงููุงุชูุฑุฉ ูู ุงููุตูููุฉ
      window.suspendedInvoices.splice(index, 1);
      // ุงุญูุธ ุงูููุงุชูุฑ ุงููุนููุฉ ูู Firebase ุจุนุฏ ุฅุฒุงูุฉ ุงููุงุชูุฑุฉ ุงููุณุชุฃููุฉ
      if (typeof saveSuspendedInvoices === 'function') {
        saveSuspendedInvoices().catch(err => {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูููุงุชูุฑ ุงููุนููุฉ ุฃุซูุงุก ุงุณุชุฆูุงู ุงููุงุชูุฑุฉ:', err);
        });
      }
      // ุญุฏุซ ูุต ุงูุฒุฑ ููุนูุณ ุงูุนุฏุฏ ุงูุฌุฏูุฏ ููููุงุชูุฑ ุงููุนููุฉ
      if (typeof updateSuspendedInvoicesButton === 'function') {
        updateSuspendedInvoicesButton();
      }
      // ุชุญุฏูุซ ุงููุงุฌูุฉ
      updateInvoiceDisplay();
      calculateRemaining();
      // ุฅุบูุงู ุงููุงูุฐุฉ
      closeSuspendedInvoicesModal();
      showMessage(`โน๏ธ ุชู ูุชุญ ุงููุงุชูุฑุฉ ุฑูู ${inv.invoice_number}. ููููู ุชุนุฏูููุง ุฃู ุญูุธูุง.`, 'info');

      // ุจูุฌุฑุฏ ุงุณุชุฆูุงู ุงููุงุชูุฑุฉ ุงููุนููุฉุ ูู ุจุชุญุฏูุซ ุฌููุน ุงูุฃูุณุงู ููุชุฃูุฏ ูู ุฃู
      // ุงูุชุบููุฑุงุช ุชูุนูุณ ูู ูุงุฌูุงุช ูุซู ุงููุฎุฒููุ ุงููุจูุนุงุชุ ุงูุนููุงุก ูุบูุฑูุง.
      // ุฅุฐุง ูุงูุช ุงูุฏุงูุฉ updateAllDisplays ูุนุฑูุฉุ ูุณุชุฏุนููุง ูุนูู ูุฒุงููุฉ ููุฑูุฉ.
      try {
        if (typeof updateAllDisplays === 'function') {
          updateAllDisplays();
        }
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูุนุฑูุถ ุจุนุฏ ุงุณุชุฆูุงู ุงููุงุชูุฑุฉ:', err);
      }
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุฆูุงู ุงููุงุชูุฑุฉ:', err);
      showMessage('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุฆูุงู ุงููุงุชูุฑุฉ', 'error');
    }
  }

  /**
   * ุฅุบูุงู ูุงูุฐุฉ ุงูููุงุชูุฑ ุงููุนููุฉ.
   */
  function closeSuspendedInvoicesModal() {
    const modal = document.getElementById('suspended-invoices-modal');
    if (modal) modal.classList.add('hidden');
  }

  /**
   * ุชุญุฏูุซ ูุต ุฒุฑ "ููุงุชูุฑ ูุนููุฉ" ูุนุฑุถ ุนุฏุฏ ุงูููุงุชูุฑ ุงููุนููุฉ ูู ุงููุธุงู.
   * ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉ ุจุนุฏ ุฅุถุงูุฉ ูุงุชูุฑุฉ ูุนููุฉ ุฃู ุงุณุชุฆูุงููุง
   * ุฃู ุชุญููู ุงูููุงุชูุฑ ุงููุนููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. ุฅุฐุง ูู ููู ุงูุฒุฑ
   * ููุฌูุฏุงู ุฃู ูู ุชูู ูุตูููุฉ suspendedInvoices ูุนุฑูุฉุ ูุชู ุชุฌุงูู
   * ุงูุชุญุฏูุซ ุจูุฏูุก.
   */
  function updateSuspendedInvoicesButton() {
    try {
      const btn = document.getElementById('suspended-invoices-btn');
      if (!btn) return;
      const count = Array.isArray(window.suspendedInvoices) ? window.suspendedInvoices.length : 0;
      btn.textContent = `๐ ููุงุชูุฑ ูุนููุฉ F7 (${count})`;
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ูุต ุฒุฑ ุงูููุงุชูุฑ ุงููุนููุฉ:', err);
    }
  }

  // ุฅุถุงูุฉ ูุณุชูุน ููููุงุชูุญ F6 ู F7 ุนูู ูุณุชูู ุงูุตูุญุฉ ููุชุนููู ููุชุญ ุงููุงุฆูุฉ
  document.addEventListener('keydown', function(event) {
    try {
      if (event.key === 'F6') {
        event.preventDefault();
        suspendCurrentInvoice();
      } else if (event.key === 'F7') {
        event.preventDefault();
        showSuspendedInvoicesList();
      }
    } catch (err) {
      console.warn('โ๏ธ ุฎุทุฃ ูู ุงูุชุนุงูู ูุน ุงุฎุชุตุงุฑุงุช ููุญุฉ ุงูููุงุชูุญ:', err);
    }
  });

  // -------------------------------------------------------------------------
  // Functions for the customer report modal. These allow the user to open a
  // modal window from the customers section, search for a customer by name or
  // code, and display all invoices and summary statistics related to that
  // customer. The modal contains its own search box with suggestion dropdown.
  function openCustomerReportModal() {
    const modal = document.getElementById('customer-report-modal');
    if (modal) {
      modal.classList.remove('hidden');
    }
    // Reset search input and results
    const searchInput = document.getElementById('customer-report-search');
    if (searchInput) {
      searchInput.value = '';
      searchInput.focus();
    }
    const resultsDiv = document.getElementById('customer-report-search-results');
    if (resultsDiv) {
      resultsDiv.innerHTML = '';
      resultsDiv.classList.add('hidden');
    }
    const contentDiv = document.getElementById('customer-report-content');
    if (contentDiv) {
      contentDiv.innerHTML = '';
    }
  }

  function closeCustomerReportModal() {
    const modal = document.getElementById('customer-report-modal');
    if (modal) {
      modal.classList.add('hidden');
    }
  }

  // Perform a search for customers within all invoices based on a query. The
  // query is matched against both the customer name and code (case-insensitive).
  function searchCustomerReport(query) {
    const lower = query.trim().toLowerCase();
    const found = {};
    // Include customers from manualCustomers
    if (Array.isArray(window.manualCustomers)) {
      window.manualCustomers.forEach(function(c) {
        const code = (c.code || '').toString();
        const name = c.name || '';
        const key = `${code}|${name}`;
        if (lower && (code.toLowerCase().includes(lower) || name.toLowerCase().includes(lower))) {
          if (!found[key]) {
            found[key] = { code: code, name: name };
          }
        }
      });
    }
    // Include customers from invoice data
    let invoices = [];
    try {
      if (Array.isArray(allData)) {
        invoices = allData.filter(function(item) { return item.type === 'invoice'; });
      }
    } catch (_) {
      invoices = [];
    }
    invoices.forEach(function(inv) {
      const code = inv.customer_code || '';
      const name = inv.customer_name || '';
      const key = `${code}|${name}`;
      if (lower && (code.toLowerCase().includes(lower) || name.toLowerCase().includes(lower))) {
        if (!found[key]) {
          found[key] = { code: code, name: name };
        }
      }
    });
    return Object.values(found).slice(0, 20);
  }

  // When a customer is selected from the search suggestions, display their
  // summary and invoice details within the modal. This compiles a table of
  // invoices and shows aggregate totals for purchases, payments and remaining.
  function selectCustomerReport(code, name) {
    // Hide suggestions
    const resultsDiv = document.getElementById('customer-report-search-results');
    if (resultsDiv) {
      resultsDiv.classList.add('hidden');
      resultsDiv.innerHTML = '';
    }
    displayCustomerReport(code, name);
  }

  function displayCustomerReport(code, name) {
    const content = document.getElementById('customer-report-content');
    if (!content) return;
    // Gather all invoices for this customer
    // Filter invoices for this customer.  If a code is provided, match strictly
    // on the code; otherwise fall back to matching by name.  This prevents
    // aggregating invoices from multiple customers who share the same name but
    // have different codes.
    const invoices = Array.isArray(allData)
      ? allData.filter(function(item) {
          if (item.type !== 'invoice') return false;
          // Prefer matching by code when available
          if (code && code !== '' && typeof item.customer_code !== 'undefined') {
            return item.customer_code === code;
          }
          // Fallback to matching by name only when no code was supplied
          return item.customer_name === name;
        })
      : [];
    let totalPurchases = 0;
    let totalPaid = 0;
    let totalRemaining = 0;
    // ุฅุฌูุงูู ุงููุฏููุน ุจุงูููุฒุง ูุงููุงุด ููุฌููุนุฉ ุงูููุงุชูุฑ ููุฐุง ุงูุนููู
    let totalVisa = 0;
    let totalCash = 0;
    let invoiceRows = '';
    if (invoices.length > 0) {
      // ูู ุจุญุณุงุจ ุงููุจุงูุบ ุงูุฅุฌูุงููุฉ ุฃููุงู
      invoices.forEach(function(inv) {
        totalPurchases += inv.total;
        totalPaid += inv.payment_amount;
        // Use a fallback when remaining_amount is not defined.  Also ensure
        // that totalRemaining is updated with the correct value.
        const rm = (typeof inv.remaining_amount !== 'undefined' && inv.remaining_amount !== null)
          ? inv.remaining_amount
          : (inv.total - (inv.payment_amount || 0));
        totalRemaining += rm;
        totalVisa += (inv.visa_amount || 0);
        totalCash += (inv.cash_amount || 0);
      });
      // ุซู ุฃูุดุฆ ุตููู ุฌุฏูู ุงูููุงุชูุฑ ูุน ุงูุญููู ุงูุฌุฏูุฏุฉ
      invoiceRows = invoices.map(function(inv) {
        const date = new Date(inv.date).toLocaleDateString('ar-EG');
        const paymentMethod = inv.payment_method || '';
        const visaAmt = (inv.visa_amount != null ? inv.visa_amount : 0).toFixed(2);
        const cashAmt = (inv.cash_amount != null ? inv.cash_amount : 0).toFixed(2);
        // Calculate remaining with fallback and determine the display value.
        const rm = (typeof inv.remaining_amount !== 'undefined' && inv.remaining_amount !== null)
          ? inv.remaining_amount
          : (inv.total - (inv.payment_amount || 0));
        const displayRemaining = rm > 0 ? '-' + rm.toFixed(2) : Math.abs(rm).toFixed(2);
        return '<tr><td class="border px-2 py-1">' + inv.invoice_number + '</td>' +
               '<td class="border px-2 py-1">' + date + '</td>' +
               '<td class="border px-2 py-1">' + inv.total.toFixed(2) + '</td>' +
               '<td class="border px-2 py-1">' + inv.payment_amount.toFixed(2) + '</td>' +
               '<td class="border px-2 py-1">' + displayRemaining + '</td>' +
               '<td class="border px-2 py-1">' + paymentMethod + '</td>' +
               '<td class="border px-2 py-1">' + visaAmt + '</td>' +
               '<td class="border px-2 py-1">' + cashAmt + '</td></tr>';
      }).join('');
    }
    // Always display the delete button.  Previously, the delete button was only
    // shown for manually added customers, which meant you could not remove
    // clients who had invoices attached.  Showing it unconditionally lets
    // the user delete any customer along with their invoices.
    const deleteBtnHtml =
      '<button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded mb-2" ' +
      'onclick="deleteCustomerPopup(\'' + (code || '') + '\', \'' + (name || '') + '\')">๐๏ธ ุญุฐู ุงูุนููู</button>';
    const summaryHtml = `
      <div class="mb-4">
        ${deleteBtnHtml}
        <h4 class="font-bold mb-1">${name || code}${code ? ' (' + code + ')' : ''}</h4>
        <p>ุงูููุฏ: ${code || '-'}</p>
        <p>ุนุฏุฏ ุงูููุงุชูุฑ: ${invoices.length}</p>
        <p>ุฅุฌูุงูู ุงููุดุชุฑูุงุช: ${totalPurchases.toFixed(2)} ุฌ.ู</p>
        <p>ุฅุฌูุงูู ุงููุฏููุน: ${totalPaid.toFixed(2)} ุฌ.ู</p>
        <p>ุฅุฌูุงูู ุงููุชุจูู: ${totalRemaining.toFixed(2)} ุฌ.ู</p>
        <!-- ุฅุธูุงุฑ ุฅุฌูุงูู ุงููุจุงูุบ ุงููุฏููุนุฉ ุญุณุจ ููุน ุงูุฏูุน -->
        <p>ุฅุฌูุงูู ุงููุฏููุน ุจุงูููุฒุง: ${totalVisa.toFixed(2)} ุฌ.ู</p>
        <p>ุฅุฌูุงูู ุงููุฏููุน ููุฏุงู: ${totalCash.toFixed(2)} ุฌ.ู</p>
      </div>`;
    const tableHtml = `
      <table class="w-full border-collapse mb-4">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1">ุฑูู ุงููุงุชูุฑุฉ</th>
            <th class="border px-2 py-1">ุงูุชุงุฑูุฎ</th>
            <th class="border px-2 py-1">ุงูุฅุฌูุงูู</th>
            <th class="border px-2 py-1">ุงููุฏููุน</th>
            <th class="border px-2 py-1">ุงููุชุจูู</th>
            <!-- ุงูุฃุนูุฏุฉ ุงูุฌุฏูุฏุฉ ุงูุฎุงุตุฉ ุจุจูุงูุงุช ุทุฑููุฉ ุงูุฏูุน -->
            <th class="border px-2 py-1">ุทุฑููุฉ ุงูุฏูุน</th>
            <th class="border px-2 py-1">ูุจูุบ ุงูููุฒุง</th>
            <th class="border px-2 py-1">ูุจูุบ ุงููุงุด</th>
          </tr>
        </thead>
        <tbody>${invoiceRows}</tbody>
      </table>`;
    content.innerHTML = summaryHtml + tableHtml;
  }

  // Allow deletion of manually added customers from within the report modal. This function
  // removes the selected customer from the manualCustomers array, updates any
  // associated displays, and shows a confirmation message in the report modal.
async function deleteCustomer(code, name, skipPrompt) {
    // Ask for confirmation before deleting the customer and their invoices unless skipPrompt is true.
    if (!skipPrompt) {
      const confirmMsg = 'ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุนููู ุจูู ุจูุงูุงุชู ูุงูููุงุชูุฑ ุงูุชุงุจุนุฉ ููุ';
      if (!window.confirm(confirmMsg)) {
        return;
      }
    }

    // Remove the customer from the manualCustomers array (if present).
    // If a code is provided, remove any manual customers with that code. If no code
    // is provided, remove all manual customers with the same name.  This ensures
    // that duplicate manual entries (e.g. same name with different codes) do not
    // reappear after deletion.
    if (Array.isArray(window.manualCustomers)) {
      window.manualCustomers = window.manualCustomers.filter(function(c) {
        const cName = (c.name || c.customer_name || '').trim();
        const cCode = (c.code || c.customer_code || '').toString();
        if (code) {
          // When a code is supplied, remove any manual customer whose code matches
          return String(cCode) !== String(code);
        }
        // When no code is supplied, remove any manual customer whose name matches
        return cName !== String(name).trim();
      });
    }

    // Remove all invoices and sales associated with this customer from allData.
    // We match by either customer_code or customer_name so that any record
    // containing the specified code or name is removed.  Only records of
    // type 'invoice' and 'sale' are removed; other data (purchases, employees, etc.)
    // remain untouched.
    if (Array.isArray(allData)) {
      allData = allData.filter(function(item) {
        // Remove invoice, sale, or discount records that belong to this customer.
        // Other categories remain untouched.
        if (item.type !== 'invoice' && item.type !== 'sale' && item.type !== 'discount') {
          return true;
        }
        const itemCode = (item.customer_code || '').toString();
        const itemName = (item.customer_name || '').trim();
        let match = false;
        if (code) {
          match = itemCode && String(itemCode) === String(code);
        } else {
          match = itemName && itemName === String(name).trim();
        }
        // Keep the record only if it does not match
        return !match;
      });
    }

    // Persist the deletion to Firebase and reload the latest data.  To
    // prevent the background autoโsync timer from interfering (which
    // could reintroduce stale data while we are saving), pause the
    // autoSyncTimer if it is active before saving.  After the save and
    // reload complete, restore the autoSyncTimer if it was previously
    // running.
    let wasAutoSyncActive = false;
    if (typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null) {
      wasAutoSyncActive = true;
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (saveErr) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุงูุนููู:', saveErr);
    }
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
        // Reload manual customers from Firebase on each background sync so that
        // additions or deletions performed on other clients are reflected
        // locally.  Errors are logged but do not interrupt the sync.
        if (typeof loadManualCustomersFromFirebase === 'function') {
          try {
            await loadManualCustomersFromFirebase();
          } catch (err) {
            console.warn('โ๏ธ ุชุนุฐุฑ ูุฒุงููุฉ ุงูุนููุงุก ุงููุฏูููู ุฃุซูุงุก ุงููุฒุงููุฉ ุงูุฎูููุฉ:', err);
          }
        }
      } catch (loadErr) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุงูุนููู:', loadErr);
      }
    }
    // Resume autoโsync if it was active before deletion
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }

    // Refresh the customers display and other sections.  Use setTimeout to
    // avoid blocking the current call stack.
    setTimeout(() => {
      try {
        if (typeof updateCustomersDisplay === 'function') {
          updateCustomersDisplay();
        }
        updateAllDisplays();
        // Update the report content to confirm deletion
        const reportContent = document.getElementById('customer-report-content');
        if (reportContent) {
          reportContent.innerHTML = '<div class="p-2 text-center">ุชู ุญุฐู ุงูุนููู ูุฌููุน ููุงุชูุฑู.</div>';
        }
      } catch (updateErr) {
        console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงููุงุฌูุฉ ุจุนุฏ ุญุฐู ุงูุนููู:', updateErr);
      }
    }, 0);
  }

  /**
   * ุชุฃููุฏ ุญุฐู ุฌููุน ุงูุนููุงุก ูุงูููุงุชูุฑ ูุงููุจูุนุงุช ุงููุฑุชุจุทุฉ ุจูู.  ูุฐุง ุงูุฒุฑ ูุชุงุญ ูู
   * ูุณู ุฅุฏุงุฑุฉ ุงูุนููุงุก ููููู ุจุฅูุฑุงุบ ูุงุฆูุฉ ุงูุนููุงุก ุงููุฏููุฉ ูุฅุฒุงูุฉ ูุงูุฉ
   * ุงูููุงุชูุฑ ูุงููุจูุนุงุช ูู ุงููุตูููุฉ global allData.  ุจุนุฏ ุงูุญุฐู ูุชู ุญูุธ
   * ุงูุจูุงูุงุช ูุฅุนุงุฏุฉ ุชุญููููุง ูู Firebase ูุชุญุฏูุซ ุฌููุน ุงูุนุฑูุถ.
   */
async function confirmDeleteAllCustomers(skipPrompt) {
    // Show confirmation dialog only if skipPrompt is not true; if cancelled, do nothing
    if (!skipPrompt) {
      const confirmMsg = 'ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูุนููุงุก ูุฌููุน ููุงุชูุฑูู ููุจูุนุงุชููุ';
      if (!window.confirm(confirmMsg)) {
        return;
      }
    }

    // Clear the manual customers list if it exists
    if (Array.isArray(window.manualCustomers)) {
      window.manualCustomers = [];
    }

    // Filter out invoices, sales and discount records from allData.
    // Removing discounts ensures that the userโsales discounts table stays
    // in sync when invoices are deleted.
    if (Array.isArray(allData)) {
      allData = allData.filter(item => {
        return item.type !== 'invoice' && item.type !== 'sale' && item.type !== 'discount';
      });
    }

    // Attempt to clear the ERP customer nodes directly before saving.  By
    // explicitly clearing these nodes, we ensure that stale customer
    // records (both metadata and simple names) are removed even if
    // saveDataToFirebase encounters an error or filters incorrectly.
    try {
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpCustomers'), []);
    } catch (clearErr) {
      console.warn('โ๏ธ ุชุนุฐุฑ ูุณุญ ูุณุงุฑ erpCustomers ูุจู ุงูุญุฐู:', clearErr);
    }
    try {
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpCustomerNames'), []);
    } catch (clearNamesErr) {
      console.warn('โ๏ธ ุชุนุฐุฑ ูุณุญ ูุณุงุฑ erpCustomerNames ูุจู ุงูุญุฐู:', clearNamesErr);
    }

    // Pause autoโsync to prevent a concurrent background sync from
    // overwriting the deletion with stale data
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    // Persist the changes to Firebase.  Reload only if the save
    // succeeds.  This prevents stale cloud data from overwriting
    // local deletions when save fails.
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุฌููุน ุงูุนููุงุก:', err);
    }
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุฌููุน ุงูุนููุงุก:', err);
      }
    }

    // Resume autoโsync if it was previously active
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }

    // Update displays
    try {
      if (typeof updateCustomersDisplay === 'function') {
        updateCustomersDisplay();
      }
      updateAllDisplays();
      showMessage('โ ุชู ุญุฐู ุฌููุน ุงูุนููุงุก ูุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุจูู ุจูุฌุงุญ', 'success');
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงููุงุฌูุฉ ุจุนุฏ ุญุฐู ุฌููุน ุงูุนููุงุก:', err);
    }
  }

  // Register event listener for the customer report search input once the DOM
  // has loaded. This listener performs live search and displays suggestions
  // under the input field. When a result is clicked, selectCustomerReport
  // is called to render the report.
  document.addEventListener('DOMContentLoaded', function() {
    const reportSearch = document.getElementById('customer-report-search');
    const resultsDiv = document.getElementById('customer-report-search-results');
    if (reportSearch && resultsDiv) {
      reportSearch.addEventListener('input', function() {
        const query = this.value;
        if (!query || query.trim() === '') {
          resultsDiv.innerHTML = '';
          resultsDiv.classList.add('hidden');
          return;
        }
        const results = searchCustomerReport(query);
        if (results.length === 0) {
          resultsDiv.innerHTML = '<div class="p-2">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</div>';
        } else {
          resultsDiv.innerHTML = results.map(c => {
            const code = c.code || '';
            const name = c.name || '';
            // Determine if this entry comes from the manualCustomers list. Only
            // manual entries can actually be removed via deleteCustomer().
            let isManual = false;
            try {
              if (Array.isArray(window.manualCustomers)) {
                isManual = window.manualCustomers.some(function(mc) {
                  const mcName = mc.name || '';
                  const mcCode = (mc.code || '').toString();
                  return mcName === name && mcCode === String(code);
                });
              }
            } catch (_) {
              isManual = false;
            }
            // Build the HTML for each result.  The result row is a flex container
            // with the name/code on the left (clickable to view report) and an
            // optional delete button on the right.  The delete button stops
            // propagation so that clicking it doesn't trigger selectCustomerReport().
            const deleteBtn = `<button onclick="event.stopPropagation(); deleteCustomerPopup('${code}', '${name}')" title="ุญุฐู" class="text-red-600 hover:text-red-700 ml-2">๐๏ธ</button>`;
            return `
              <div class="flex items-center justify-between p-2 hover:bg-gray-100 cursor-pointer" onclick="selectCustomerReport('${code}', '${name}')">
                <span>${name} (${code || '-'})</span>
                ${deleteBtn}
              </div>
            `;
          }).join('');
        }
        resultsDiv.classList.remove('hidden');
      });
    }
  });
  
  function printInvoice() {
    if (currentInvoiceItems.length === 0) {
      showMessage('ูุง ูููู ุทุจุงุนุฉ ูุงุชูุฑุฉ ูุงุฑุบุฉ', 'error');
      return;
    }
    
    const total = currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
    const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
    const remaining = total - paid;

    // Determine the display value for remaining.  A positive remaining
    // (customer owes) will be shown with a minus sign.  A zero or negative
    // remaining (customer paid enough or overpaid) will be shown as the
    // absolute value without a minus sign.
    const displayRemaining = remaining > 0
      ? '-' + remaining.toFixed(2)
      : Math.abs(remaining).toFixed(2);
    const customerName = document.getElementById('customer-name').value.trim() || 'ุนููู ุบูุฑ ูุญุฏุฏ';

    // Generate a random invoice number for the print view.  Since invoices are
    // now numbered randomly when saved, we avoid referencing nextInvoiceNumber
    // here.
    const printInvoiceNumber =
      'INV-' + Math.random().toString(36).substr(2, 8).toUpperCase();
    
    const printContent = `
      <div style="font-family: Arial, sans-serif; direction: rtl; padding: 20px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <h1>Solution ERP</h1>
          <h2>ูุงุชูุฑุฉ ุจูุน</h2>
          <p>ุฑูู ุงููุงุชูุฑุฉ: ${printInvoiceNumber}</p>
          <p>ุงูุชุงุฑูุฎ: ${new Date().toLocaleDateString('ar-EG')}</p>
          <p>ุงูุนููู: ${customerName}</p>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <thead>
            <tr style="background-color: #f5f5f5;">
              <th style="border: 1px solid #ddd; padding: 8px;">ุงูููุฏ</th>
              <th style="border: 1px solid #ddd; padding: 8px;">ุงุณู ุงูููุชุฌ</th>
              <th style="border: 1px solid #ddd; padding: 8px;">ุงูุณุนุฑ</th>
              <th style="border: 1px solid #ddd; padding: 8px;">ุงููููุฉ</th>
              <th style="border: 1px solid #ddd; padding: 8px;">ุงูุฅุฌูุงูู</th>
            </tr>
          </thead>
          <tbody>
            ${currentInvoiceItems.map(item => `
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">${item.code}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${item.name}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${item.price.toFixed(2)} ุฌ.ู</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${item.quantity}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${item.total.toFixed(2)} ุฌ.ู</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div style="text-align: left; font-size: 18px; font-weight: bold;">
          <p>ุงูุฅุฌูุงูู: ${total.toFixed(2)} ุฌ.ู</p>
          <p>ุงููุฏููุน: ${paid.toFixed(2)} ุฌ.ู</p>
          <p>ุงููุชุจูู: ${displayRemaining} ุฌ.ู</p>
        </div>
      </div>
    `;
    
    document.getElementById('print-content').innerHTML = printContent;
    window.print();
  }
  
  // Purchase functions
  function toggleProductMode(mode) {
    const existingSelection = document.getElementById('existing-product-selection');
    const productInputs = document.querySelectorAll('#purchase-product-name, #purchase-product-code');
    
    if (mode === 'existing') {
      existingSelection.classList.remove('hidden');
      productInputs.forEach(input => {
        input.readOnly = true;
        input.classList.add('bg-gray-100');
      });
      updateExistingProductsList();
    } else {
      // Switching to "new" product mode: hide the existing product selector and
      // make the product name/code inputs editable again.  Do not call
      // clearPurchaseInputs() here; the caller is responsible for clearing
      // input values if needed.  Calling clearPurchaseInputs() here would
      // trigger a recursive loop because clearPurchaseInputs() also calls
      // toggleProductMode('new').
      existingSelection.classList.add('hidden');
      productInputs.forEach(input => {
        input.readOnly = false;
        input.classList.remove('bg-gray-100');
      });
    }
  }
  
  function updateExistingProductsList() {
    const inventory = calculateInventory();
    const select = document.getElementById('existing-product-select');
    
    // Clear existing options except the first one
    select.innerHTML = '<option value="">-- ุงุฎุชุฑ ููุชุฌ ูู ุงููุงุฆูุฉ --</option>';
    
    if (Object.keys(inventory).length === 0) {
      select.innerHTML = '<option value="">ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ุงููุธุงู</option>';
      return;
    }
    
    // Add products to dropdown
    Object.values(inventory).forEach(product => {
      const option = document.createElement('option');
      option.value = product.code;
      option.textContent = `${product.name} (${product.code}) - ูุฎุฒูู: ${product.availableStock}`;
      select.appendChild(option);
    });
  }
  
  function selectExistingProduct() {
    const select = document.getElementById('existing-product-select');
    const selectedCode = select.value;
    
    if (!selectedCode) {
      document.getElementById('existing-product-info').textContent = '';
      clearPurchaseInputs();
      return;
    }
    
    const inventory = calculateInventory();
    const product = inventory[selectedCode];
    
    if (product) {
      // Fill in product details
      document.getElementById('purchase-product-name').value = product.name;
      document.getElementById('purchase-product-code').value = product.code;
      document.getElementById('purchase-sale-price').value = product.salePrice.toFixed(2);
      
      // Show product info
      document.getElementById('existing-product-info').innerHTML = `
        ๐ฆ ุงููุฎุฒูู ุงูุญุงูู: <strong>${product.availableStock}</strong> ูุทุนุฉ | 
        ๐ฐ ุณุนุฑ ุงูุจูุน ุงูุญุงูู: <strong>${product.salePrice.toFixed(2)}</strong> ุฌ.ู |
        ๐ ุขุฎุฑ ุณุนุฑ ุดุฑุงุก: <strong>${product.purchasePrice.toFixed(2)}</strong> ุฌ.ู
      `;
      
      // Focus on quantity field
      document.getElementById('purchase-quantity').focus();
    }
  }
  
  async function addPurchase() {
    const productName = document.getElementById('purchase-product-name').value.trim();
    const productCode = document.getElementById('purchase-product-code').value.trim();
    const supplier = document.getElementById('purchase-supplier').value.trim();
    const quantity = parseInt(document.getElementById('purchase-quantity').value) || 0;
    const purchasePrice = parseFloat(document.getElementById('purchase-price').value) || 0;
    const salePrice = parseFloat(document.getElementById('purchase-sale-price').value) || 0;
    
    if (!productName || !productCode || !supplier || quantity <= 0 || purchasePrice <= 0 || salePrice <= 0) {
      showMessage('โ ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุจุดูู ุตุญูุญ', 'error');
      return;
    }

    // Prevent adding a new product with a code that already exists in the system.
    // When the user is in "new product" mode, check the aggregated inventory
    // for an existing product with the same code.  If found, reject the
    // addition and prompt the user to use the "existing product" option instead.
    try {
      const isNewProductMode = document.getElementById('new-product-mode') && document.getElementById('new-product-mode').checked;
      if (isNewProductMode) {
        const inventory = calculateInventory();
        if (inventory && typeof inventory === 'object' && inventory.hasOwnProperty(productCode)) {
          hideLoading && typeof hideLoading === 'function' && hideLoading();
          showMessage('โ ุงูููุฏ ุงููุฏุฎู ูุณุฌู ูุณุจููุง ูููุชุฌ ุขุฎุฑ. ูุฑุฌู ุงุฎุชูุงุฑ ููุฏ ูุฑูุฏ ุฃู ุงุณุชุฎุฏุงู ุฎูุงุฑ "ููุชุฌ ููุฌูุฏ" ูุฅุถุงูุฉ ูููุฉ.', 'error');
          return;
        }
      }
    } catch (dupErr) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุงูุชุญูู ูู ุชูุฑุงุฑ ููุฏ ุงูููุชุฌ:', dupErr);
    }
    
    showLoading();

    // ---------------------------------------------------------------------
    // Temporarily pause the autoโsync timer during the add operation. If
    // backgroundSync() runs while we are saving and reloading data, it can
    // reload stale data or overwrite our new purchase.  We remember
    // whether the timer was active, clear it now, and restore it once
    // the operation is complete.
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    
    const purchase = {
      type: 'purchase',
      product_name: productName,
      product_code: productCode,
      supplier: supplier,
      quantity: parseInt(quantity),
      purchase_price: parseFloat(purchasePrice.toFixed(2)),
      sale_price: parseFloat(salePrice.toFixed(2)),
      total: parseFloat((purchasePrice * quantity).toFixed(2)),
      date: new Date().toISOString(),
      status: 'ููุชูู',
      id: 'purchase_' + Date.now()
    };
    
    // Always add to allData
    allData.push(purchase);

    // ๐ป Update the budget: subtract the cost of this purchase from the current budget.
    // If currentBudget is undefined or NaN, initialize it to zero before adjustment.
    if (typeof window.currentBudget === 'undefined' || isNaN(parseFloat(window.currentBudget))) {
      window.currentBudget = 0;
    }
    window.currentBudget = parseFloat(window.currentBudget) - purchase.total;
    // Reflect the new budget in the UI immediately
    const budgetEl = document.getElementById('budget-amount');
    if (budgetEl) {
      budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
    }
    // Persist the updated budget to Firebase. Wrap in try/catch so that a failure
    // does not interrupt the purchase workflow. If the save fails, the local
    // currentBudget value and UI will still reflect the change.
    try {
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), window.currentBudget);
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูููุฒุงููุฉ ุจุนุฏ ุนูููุฉ ุงูุดุฑุงุก:', err);
    }
    
    // Persist the new purchase to Firebase.  If the save fails, do
    // not reload from Firebase, otherwise we could lose the newly
    // added purchase from local memory.
    let saveSucceeded = false;
    try {
        await saveDataToFirebase();
        saveSucceeded = true;
    } catch (err) {
        console.error('Error saving data to Firebase:', err);
    }
    /*
     * ูุง ูููู ุจุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูู Firebase ูู ูุฐู ุงููุฑุญูุฉ. ุฅุฐุง
     * ูุฌุญ ุงูุญูุธ ุฅูู ุงูุณุญุงุจุฉุ ูุณูููู ูุคูุช ุงููุฒุงููุฉ ุงูุฎูููุฉ ุจุงุณุชุฑุฌุงุน
     * ุฃุญุฏุซ ูุณุฎุฉ ุจุดูู ุฏูุฑู. ุฃูุง ูู ุญุงู ูุดู ุงูุญูุธ ุจุณุจุจ ุนุฏู ุชููุฑ
     * ุงูุงุชุตุงูุ ูุฅู ุงูุจูุงูุงุช ุชุธู ูุญููุธุฉ ูู allData ูุงููุณุฎุฉ ุงููุญููุฉ
     * ุงูุงุญุชูุงุทูุฉ ูุณุชุธูุฑ ูุจุงุดุฑุฉ ูููุณุชุฎุฏู ุจุนุฏ ุงูุชุญุฏูุซ.
     */
    // Clear the input fields and reset to new product mode
    clearPurchaseInputs();
    // Always refresh all displays so the newly added purchase appears
    updateAllDisplays();
    // Resume the autoโsync timer if it was previously active
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
    // Explicitly hide the loading overlay and reset isLoading.  Without
    // this call, isLoading may remain true, preventing other buttons
    // (such as saving invoices) from functioning after adding a purchase.
    if (typeof hideLoading === 'function') {
      hideLoading();
    }
    // Show a success message indicating whether this was a new or existing product
    const isExistingProduct = document.getElementById('existing-product-mode').checked;
    const message = isExistingProduct 
      ? `โ ุชู ุฅุถุงูุฉ ${quantity} ูุทุนุฉ ูู ${productName} ูููุฎุฒูู ุจูุฌุงุญ`
      : `โ ุชู ุฅุถุงูุฉ ุงูููุชุฌ ุงูุฌุฏูุฏ "${productName}" ุจูููุฉ ${quantity} ูุทุนุฉ ุจูุฌุงุญ`;
    showMessage(message, 'success');
  }
  
  function clearPurchaseInputs() {
    document.getElementById('purchase-product-name').value = '';
    document.getElementById('purchase-product-code').value = '';
    document.getElementById('purchase-supplier').value = '';
    document.getElementById('purchase-quantity').value = '';
    document.getElementById('purchase-price').value = '';
    document.getElementById('purchase-sale-price').value = '';
    document.getElementById('existing-product-select').value = '';
    document.getElementById('existing-product-info').textContent = '';
    
    // Reset the radio button to new product mode.  Do not invoke
    // toggleProductMode() here to avoid recursion.  The caller can
    // explicitly call toggleProductMode('new') if needed.
    document.getElementById('new-product-mode').checked = true;
  }
  
  // Employee functions
  /**
   * Returns the next available employee code as a string. It scans
   * existing employees for numeric codes and returns one greater than
   * the maximum found. If no numeric codes exist, returns '1'.
   */
  function getNextEmployeeCode() {
    try {
      const employees = allData ? allData.filter(item => item.type === 'employee') : [];
      const codes = employees
        .map(emp => {
          // support numeric or string codes; attempt to parse as integer
          const code = emp.employee_code || emp.code;
          const num = parseInt(code, 10);
          return isNaN(num) ? null : num;
        })
        .filter(v => v !== null);
      const max = codes.length ? Math.max(...codes) : 0;
      return String(max + 1);
    } catch (err) {
      console.warn('Unable to generate next employee code:', err);
      return '1';
    }
  }
  async function addEmployee() {
    // Gather values from the form
    const nameInput = document.getElementById('employee-name');
    const codeInput = document.getElementById('employee-code');
    const departmentSelect = document.getElementById('employee-department');
    const salaryInput = document.getElementById('employee-salary');
    const ageInput = document.getElementById('employee-age');
    const addressInput = document.getElementById('employee-address');
    const hoursSelect = document.getElementById('employee-hours');
    const lateDeductionsInput = document.getElementById('employee-late-deductions');
    const penaltiesInput = document.getElementById('employee-penalties');

    const name = nameInput ? nameInput.value.trim() : '';
    const manualCode = codeInput ? codeInput.value.trim() : '';
    const department = departmentSelect ? departmentSelect.value : '';
    const salary = parseFloat(salaryInput && salaryInput.value) || 0;
    const age = parseInt(ageInput && ageInput.value) || 0;
    const address = addressInput ? addressInput.value.trim() : '';
    const hours = hoursSelect ? hoursSelect.value.trim() : '';
    const lateDeductions = parseFloat(lateDeductionsInput && lateDeductionsInput.value) || 0;
    const penalties = parseFloat(penaltiesInput && penaltiesInput.value) || 0;
    const incentivesInput = document.getElementById('employee-incentives');
    const incentives = parseFloat(incentivesInput && incentivesInput.value) || 0;
    const advanceInput = document.getElementById('employee-advance');
    const advance = parseFloat(advanceInput && advanceInput.value) || 0;
    const penaltiesReasonInput = document.getElementById('employee-penalties-reason');
    const incentivesReasonInput = document.getElementById('employee-incentives-reason');
    const penaltiesReason = penaltiesReasonInput ? penaltiesReasonInput.value.trim() : '';
    const incentivesReason = incentivesReasonInput ? incentivesReasonInput.value.trim() : '';

    // Validate required fields
    if (!name || !department || salary <= 0 || age < 18) {
      showMessage('โ ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุจุดูู ุตุญูุญ', 'error');
      return;
    }
    // Ensure deductions do not exceed salary (including advance)
    const totalDeductions = lateDeductions + penalties + advance;
    if (totalDeductions >= salary) {
      showMessage('โ ุฅุฌูุงูู ุงูุฎุตููุงุช ูุงูุฌุฒุงุกุงุช ูุงูุณููุฉ ูุง ูููู ุฃู ูุณุงูู ุฃู ูุชุฌุงูุฒ ุงูุฑุงุชุจ ุงูุฃุณุงุณู', 'error');
      return;
    }
    // Determine employee code: use manual input if provided, otherwise auto-generate
    let employeeCode = manualCode || getNextEmployeeCode();
    // Check for duplicate codes
    const existingEmployee = allData.find(item => item.type === 'employee' && item.employee_code && String(item.employee_code) === String(employeeCode));
    if (existingEmployee) {
      showMessage('โ ููุฏ ุงูููุธู ูุณุชุฎุฏู ูุณุจููุงุ ูุฑุฌู ุงุฎุชูุงุฑ ููุฏ ุขุฎุฑ', 'error');
      return;
    }
    showLoading();
    // Calculate net salary
    // Net salary includes incentives in addition to salary minus deductions
    const netSalary = salary - totalDeductions + incentives;
    // Construct employee object, including employee_code
    const employee = {
      type: 'employee',
      employee_name: name,
      employee_code: employeeCode,
      department: department,
      basic_salary: salary,
      late_deductions: lateDeductions,
      penalties: penalties,
      incentives: incentives,
      advance: advance,
      penalties_reason: penaltiesReason,
      incentives_reason: incentivesReason,
      net_salary: netSalary,
      age: age,
      address: address,
      work_hours: hours,
      date: new Date().toISOString(),
      id: 'emp_' + Date.now()
    };
    // Add to unified data array
    allData.push(employee);
    /*
     * Pause the autoโsync timer during the save operation.  If the
     * background synchronization runs while saving, it could reload
     * stale data and overwrite the newly added employee.  Record whether
     * autoSync was active, clear it, save the data, reload from
     * Firebase, then restore the timer afterwards.
     */
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.error('Error saving employee to Firebase:', err);
    }
    // Only reload from Firebase if the save succeeded.  If the save
    // failed, keep the local changes so they are not overwritten by
    // possibly stale cloud data.
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุฅุถุงูุฉ ุงูููุธู:', err);
      }
    }
    // Resume autoโsync if it was active previously
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
    hideLoading();
    // Clear form inputs and prepare next code
    clearEmployeeInputs();
    updateAllDisplays();
    showMessage(`โ ุชู ุฅุถุงูุฉ ุงูููุธู "${name}" ุจูุฌุงุญ\n๐ฐ ุงูุฑุงุชุจ ุงูุฃุณุงุณู: ${salary.toFixed(2)} ุฌ.ู\n๐ธ ุฅุฌูุงูู ุงูุฎุตููุงุช: ${totalDeductions.toFixed(2)} ุฌ.ู\nโจ ุตุงูู ุงูุฑุงุชุจ: ${netSalary.toFixed(2)} ุฌ.ู`, 'success');
  }
  
  function clearEmployeeInputs() {
    document.getElementById('employee-name').value = '';
    document.getElementById('employee-department').value = '';
    document.getElementById('employee-salary').value = '';
    document.getElementById('employee-age').value = '';
    document.getElementById('employee-address').value = '';
    // ุนูุฏ ูุณุญ ุงููููุฐุฌุ ูู ุจุฅุนุงุฏุฉ ุชุนููู ููุงุนูุฏ ุงูุนูู ุฅูู ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ (9 ุต - 5 ู)
    const hoursSelect = document.getElementById('employee-hours');
    if (hoursSelect) {
      hoursSelect.value = '9 ุต - 5 ู';
    }
    document.getElementById('employee-late-deductions').value = '';
    document.getElementById('employee-penalties').value = '';
    const incentivesInput = document.getElementById('employee-incentives');
    if (incentivesInput) {
      incentivesInput.value = '';
    }
    const penaltiesReasonInput = document.getElementById('employee-penalties-reason');
    if (penaltiesReasonInput) {
      penaltiesReasonInput.value = '';
    }
    const incentivesReasonInput = document.getElementById('employee-incentives-reason');
    if (incentivesReasonInput) {
      incentivesReasonInput.value = '';
    }
    document.getElementById('net-salary-display').textContent = '0.00 ุฌ.ู';
    // ุฅุนุงุฏุฉ ุชุนููู ููุฏ ุงูููุธู ููุฑูู ุงูุชุงูู ุงููุชุงุญ
    const codeInput = document.getElementById('employee-code');
    if (codeInput) {
      codeInput.value = getNextEmployeeCode();
    }
  }
  
  function deleteEmployee(employeeId) {
    const employeeIndex = allData.findIndex(item => item.id === employeeId);
    if (employeeIndex === -1) return;
    
    const employee = allData[employeeIndex];
    
    // Create confirmation UI
    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    confirmDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md">
        <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุงูุญุฐู</h3>
        <p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููุธู "${employee.employee_name}"ุ</p>
        <div class="flex gap-3 justify-end">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
            ุฅูุบุงุก
          </button>
          <button onclick="confirmDeleteEmployee('${employeeId}'); this.parentElement.parentElement.parentElement.remove()" 
                  class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
            ุญุฐู
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  }
  
async function confirmDeleteEmployee(employeeId) {
    const employeeIndex = allData.findIndex(item => item.id === employeeId);
    if (employeeIndex !== -1) {
    const employeeName = allData[employeeIndex].employee_name;
    // Remove the employee from the unified data array
    allData.splice(employeeIndex, 1);
    /*
     * Pause the autoโsync timer to prevent concurrent backgroundSync
     * from writing stale data back to Firebase during deletion.
     */
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
      try {
        // Persist the deletion to Firebase; reload only if save succeeds.  This
        // prevents stale data from overwriting local state when the save fails.
        let saveSucceeded = false;
        try {
          await saveDataToFirebase();
          saveSucceeded = true;
        } catch (err) {
          console.error('Error saving data to Firebase:', err);
        }
        if (saveSucceeded) {
          await loadDataFromFirebase();
        }
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุฃู ุฅุนุงุฏุฉ ุชุญููู ุจูุงูุงุช ุญุฐู ุงูููุธู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
      }
      // Resume the autoโsync timer if it was previously active
      if (wasAutoSyncActive) {
        window.autoSyncTimer = setInterval(() => {
          Promise.resolve(backgroundSync());
        }, 5000);
      }
      // Refresh the UI after the save and reload complete
      updateAllDisplays();
      showMessage('โ ุชู ุญุฐู ุงูููุธู "' + employeeName + '" ุจูุฌุงุญ', 'success');
    }
  }
  
  // ุฏุงูุฉ ุชุนุฏูู ุงูููุธู
  function editEmployee(employeeId) {
    const employee = allData.find(item => item.id === employeeId && item.type === 'employee');
    if (!employee) {
      showMessage('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุธู', 'error');
      return;
    }
    
    // ุงูุชูุงูู ูุน ุงูุจูุงูุงุช ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ
    const basicSalary = employee.basic_salary || employee.salary || 0;
    const lateDeductions = employee.late_deductions || 0;
    const penalties = employee.penalties || 0;
    
    const modalDiv = document.createElement('div');
    // Give the edit modal a unique ID so it can be closed programmatically after saving
    modalDiv.id = 'edit-employee-modal';
    modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modalDiv.innerHTML = `
      <div class="bg-white rounded-lg max-w-2xl w-full max-h-full overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-2xl font-bold text-gray-800">โ๏ธ ุชุนุฏูู ุจูุงูุงุช ุงูููุธู</h2>
            <button onclick="this.closest('.fixed').remove()" 
                    class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
              โ
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงูููุธู</label>
                <input type="text" id="edit-employee-name" value="${employee.employee_name}" class="w-full p-3 border rounded-lg">
              </div>
              <!-- ููุฏ ุงูููุธู: ูุธูุฑ ุงูููุฏ ุงูุญุงูู ููุณูุญ ุจุงูุชุนุฏูู -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ููุฏ ุงูููุธู</label>
                <input type="text" id="edit-employee-code" value="${employee.employee_code || ''}" class="w-full p-3 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงููุณูู ุงููุธููู</label>
                <select id="edit-employee-department" class="w-full p-3 border rounded-lg">
                  <option value="ูุฏูุฑ ุชูููุฐู" ${employee.department === 'ูุฏูุฑ ุชูููุฐู' ? 'selected' : ''}>ูุฏูุฑ ุชูููุฐู</option>
                  <option value="ูุฏูุฑ ุนุงู" ${employee.department === 'ูุฏูุฑ ุนุงู' ? 'selected' : ''}>ูุฏูุฑ ุนุงู</option>
                  <option value="ูุฏูุฑ ุชุณููู" ${employee.department === 'ูุฏูุฑ ุชุณููู' ? 'selected' : ''}>ูุฏูุฑ ุชุณููู</option>
                  <option value="ูุฏูุฑ ูุดุชุฑูุงุช" ${employee.department === 'ูุฏูุฑ ูุดุชุฑูุงุช' ? 'selected' : ''}>ูุฏูุฑ ูุดุชุฑูุงุช</option>
                  <option value="ูุฏูุฑ ูุจูุนุงุช" ${employee.department === 'ูุฏูุฑ ูุจูุนุงุช' ? 'selected' : ''}>ูุฏูุฑ ูุจูุนุงุช</option>
                  <option value="ูุดุฑู" ${employee.department === 'ูุดุฑู' ? 'selected' : ''}>ูุดุฑู</option>
                  <option value="ูุงุดูุฑ" ${employee.department === 'ูุงุดูุฑ' ? 'selected' : ''}>ูุงุดูุฑ</option>
                  <option value="ูุณุฆูู ูุดุชุฑูุงุช" ${employee.department === 'ูุณุฆูู ูุดุชุฑูุงุช' ? 'selected' : ''}>ูุณุฆูู ูุดุชุฑูุงุช</option>
                  <option value="ูุญุงุณุจ" ${employee.department === 'ูุญุงุณุจ' ? 'selected' : ''}>ูุญุงุณุจ</option>
                  <option value="ุงููู ุฎุฒูุฉ" ${employee.department === 'ุงููู ุฎุฒูุฉ' ? 'selected' : ''}>ุงููู ุฎุฒูุฉ</option>
                  <option value="ูุณุคู ุชุณููู" ${employee.department === 'ูุณุคู ุชุณููู' ? 'selected' : ''}>ูุณุคู ุชุณููู</option>
                  <option value="ุงููู ูุฎุฒู" ${employee.department === 'ุงููู ูุฎุฒู' ? 'selected' : ''}>ุงููู ูุฎุฒู</option>
                  <option value="ุจุงุฆุน" ${employee.department === 'ุจุงุฆุน' ? 'selected' : ''}>ุจุงุฆุน</option>
                  <option value="ุณุงุฆู" ${employee.department === 'ุณุงุฆู' ? 'selected' : ''}>ุณุงุฆู</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุฑุงุชุจ ุงูุฃุณุงุณู</label>
                <input type="number" id="edit-employee-salary" value="${basicSalary}" class="w-full p-3 border rounded-lg" step="0.01" oninput="calculateEditNetSalary()">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุนูุฑ</label>
                <input type="number" id="edit-employee-age" value="${employee.age}" class="w-full p-3 border rounded-lg" min="18" max="65">
              </div>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุนููุงู</label>
                <input type="text" id="edit-employee-address" value="${employee.address}" class="w-full p-3 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ููุงุนูุฏ ุงูุนูู</label>
                <input type="text" id="edit-employee-hours" value="${employee.work_hours}" class="w-full p-3 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุฎุตููุงุช ุงูุชุฃุฎูุฑ (ุฌ.ู)</label>
                <input type="number" id="edit-employee-late-deductions" value="${lateDeductions}" class="w-full p-3 border rounded-lg" step="0.01" min="0" oninput="calculateEditNetSalary()">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุฌุฒุงุกุงุช (ุฌ.ู)</label>
                <input type="number" id="edit-employee-penalties" value="${penalties}" class="w-full p-3 border rounded-lg" step="0.01" min="0" oninput="calculateEditNetSalary()">
              </div>
              <!-- ุณุจุจ ุงูุฌุฒุงุกุงุช -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุณุจุจ ุงูุฌุฒุงุกุงุช</label>
                <input type="text" id="edit-employee-penalties-reason" value="${employee.penalties_reason || ''}" class="w-full p-3 border rounded-lg">
              </div>
              <!-- ุญูู ุงูุณููุฉ ูู ูุงูุฐุฉ ุงูุชุนุฏูู -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุณููุฉ (ุฌ.ู)</label>
                <input type="number" id="edit-employee-advance" value="${employee.advance || 0}" class="w-full p-3 border rounded-lg" step="0.01" min="0" oninput="calculateEditNetSalary()">
              </div>
              <!-- ุญูู ุงูุญูุงูุฒ ูู ูุงูุฐุฉ ุงูุชุนุฏูู -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุญูุงูุฒ (ุฌ.ู)</label>
                <input type="number" id="edit-employee-incentives" value="${employee.incentives || 0}" class="w-full p-3 border rounded-lg" step="0.01" min="0" oninput="calculateEditNetSalary()">
              </div>
              <!-- ุณุจุจ ุงูุญูุงูุฒ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุณุจุจ ุงูุญูุงูุฒ</label>
                <input type="text" id="edit-employee-incentives-reason" value="${employee.incentives_reason || ''}" class="w-full p-3 border rounded-lg">
              </div>
            </div>
          </div>
          <div class="bg-green-50 p-4 rounded-lg border border-green-200 mb-6">
            <h3 class="font-semibold text-green-800 mb-3">๐ฐ ููุฎุต ุงูุฑุงุชุจ</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-gray-600">ุงูุฑุงุชุจ ุงูุฃุณุงุณู:</span>
                <span id="edit-basic-salary-display" class="font-bold text-blue-600 mr-2">${basicSalary.toFixed(2)} ุฌ.ู</span>
              </div>
              <div>
                <span class="text-gray-600">ุฅุฌูุงูู ุงูุฎุตููุงุช:</span>
                <span id="edit-total-deductions-display" class="font-bold text-red-600 mr-2">${(lateDeductions + penalties + (employee.advance || 0)).toFixed(2)} ุฌ.ู</span>
              </div>
              <div>
                <span class="text-gray-600">ุฅุฌูุงูู ุงูุณูู:</span>
                <span id="edit-total-advance-display" class="font-bold text-blue-600 mr-2">${(employee.advance || 0).toFixed(2)} ุฌ.ู</span>
              </div>
              <div>
                <span class="text-gray-600">ุฅุฌูุงูู ุงูุญูุงูุฒ:</span>
                <span id="edit-total-incentives-display" class="font-bold text-green-600 mr-2">${(employee.incentives || 0).toFixed(2)} ุฌ.ู</span>
              </div>
              <div class="col-span-2 border-t pt-2">
                <span class="text-gray-600">ุตุงูู ุงูุฑุงุชุจ:</span>
                <span id="edit-net-salary-display" class="font-bold text-green-600 text-lg mr-2">${(basicSalary - lateDeductions - penalties - (employee.advance || 0) + (employee.incentives || 0)).toFixed(2)} ุฌ.ู</span>
              </div>
            </div>
            <!-- ุชูุถูุญ ุตูุบุฉ ุงูุฑุงุชุจ ุงูุตุงูู: ูููู ุจุทุฑุญ ุงูุฎุตููุงุช ูุงูุณูู ูู ุงูุฑุงุชุจ ุงูุฃุณุงุณู ุซู ุฅุถุงูุฉ ุงูุญูุงูุฒ -->
            <div class="text-xs text-gray-600 mt-2">ุงูุฑุงุชุจ ุงูุฃุณุงุณู - (ุฅุฌูุงูู ุงูุฎุตููุงุช + ุงูุณูู) + ุงูุญูุงูุฒ</div>
          </div>
          <div class="flex gap-3 justify-end border-t pt-4">
            <button onclick="this.closest('.fixed').remove()" 
                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
              ุฅูุบุงุก
            </button>
            <button onclick="saveEmployeeChanges('${employeeId}')" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
              ๐พ ุญูุธ ุงูุชุบููุฑุงุช
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modalDiv);
  }
  
  // ุฏุงูุฉ ุญุณุงุจ ุตุงูู ุงูุฑุงุชุจ ูู ูุงูุฐุฉ ุงูุชุนุฏูู
  function calculateEditNetSalary() {
    const basicSalary = parseFloat(document.getElementById('edit-employee-salary').value) || 0;
    const lateDeductions = parseFloat(document.getElementById('edit-employee-late-deductions').value) || 0;
    const penalties = parseFloat(document.getElementById('edit-employee-penalties').value) || 0;
    const incentives = parseFloat(document.getElementById('edit-employee-incentives').value) || 0;
    const advance = parseFloat(document.getElementById('edit-employee-advance') && document.getElementById('edit-employee-advance').value) || 0;

    const totalDeductions = lateDeductions + penalties + advance;
    const netSalary = basicSalary - totalDeductions + incentives;

    document.getElementById('edit-basic-salary-display').textContent = basicSalary.toFixed(2) + ' ุฌ.ู';
    document.getElementById('edit-total-deductions-display').textContent = totalDeductions.toFixed(2) + ' ุฌ.ู';
    document.getElementById('edit-net-salary-display').textContent = netSalary.toFixed(2) + ' ุฌ.ู';
    const incentivesDisplay = document.getElementById('edit-total-incentives-display');
    if (incentivesDisplay) {
      incentivesDisplay.textContent = incentives.toFixed(2) + ' ุฌ.ู';
    }
    // Update the advance display in the edit modal summary
    const advanceDisplay = document.getElementById('edit-total-advance-display');
    if (advanceDisplay) {
      advanceDisplay.textContent = advance.toFixed(2) + ' ุฌ.ู';
    }
    
    // ุชุบููุฑ ููู ุตุงูู ุงูุฑุงุชุจ ุญุณุจ ุงููููุฉ
    const netSalaryElement = document.getElementById('edit-net-salary-display');
    if (netSalary <= 0) {
      netSalaryElement.className = 'font-bold text-red-600 text-lg mr-2';
    } else if (netSalary < basicSalary * 0.5) {
      netSalaryElement.className = 'font-bold text-yellow-600 text-lg mr-2';
    } else {
      netSalaryElement.className = 'font-bold text-green-600 text-lg mr-2';
    }
  }
  
  // ุฏุงูุฉ ุญูุธ ุชุบููุฑุงุช ุงูููุธู
  async function saveEmployeeChanges(employeeId) {
    const name = document.getElementById('edit-employee-name').value.trim();
    const newCode = document.getElementById('edit-employee-code')?.value.trim() || '';
    const department = document.getElementById('edit-employee-department').value;
    const salary = parseFloat(document.getElementById('edit-employee-salary').value) || 0;
    const age = parseInt(document.getElementById('edit-employee-age').value) || 0;
    const address = document.getElementById('edit-employee-address').value.trim();
    const hours = document.getElementById('edit-employee-hours').value.trim();
    const lateDeductions = parseFloat(document.getElementById('edit-employee-late-deductions').value) || 0;
    const penalties = parseFloat(document.getElementById('edit-employee-penalties').value) || 0;
    const incentives = parseFloat(document.getElementById('edit-employee-incentives').value) || 0;
    const advance = parseFloat(document.getElementById('edit-employee-advance') && document.getElementById('edit-employee-advance').value) || 0;
    const penaltiesReason = document.getElementById('edit-employee-penalties-reason')?.value.trim() || '';
    const incentivesReason = document.getElementById('edit-employee-incentives-reason')?.value.trim() || '';
    
    if (!name || !department || salary <= 0 || age < 18) {
      showMessage('โ ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุจุดูู ุตุญูุญ', 'error');
      return;
    }

    // If a new employee code is provided and different from current, ensure it is unique
    const employeeIndex = allData.findIndex(item => item.id === employeeId);
    if (employeeIndex === -1) {
      showMessage('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุธู', 'error');
      return;
    }
    const currentEmployee = allData[employeeIndex];
    if (newCode && String(newCode) !== String(currentEmployee.employee_code)) {
      const duplicate = allData.find(item => item.type === 'employee' && item.id !== employeeId && String(item.employee_code) === String(newCode));
      if (duplicate) {
        showMessage('โ ููุฏ ุงูููุธู ูุณุชุฎุฏู ูุณุจููุงุ ูุฑุฌู ุงุฎุชูุงุฑ ููุฏ ุขุฎุฑ', 'error');
        return;
      }
    }
    
    const totalDeductions = lateDeductions + penalties + advance;
    if (totalDeductions >= salary) {
      showMessage('โ ุฅุฌูุงูู ุงูุฎุตููุงุช ูุงูุฌุฒุงุกุงุช ูุงูุณููุฉ ูุง ูููู ุฃู ูุณุงูู ุฃู ูุชุฌุงูุฒ ุงูุฑุงุชุจ ุงูุฃุณุงุณู', 'error');
      return;
    }
    
    const netSalary = salary - totalDeductions + incentives;
    
    // ุชุญุฏูุซ ุจูุงูุงุช ุงูููุธู
    allData[employeeIndex] = {
      ...allData[employeeIndex],
      employee_name: name,
      employee_code: newCode || allData[employeeIndex].employee_code,
      department: department,
      basic_salary: salary,
      late_deductions: lateDeductions,
      penalties: penalties,
      incentives: incentives,
      penalties_reason: penaltiesReason,
      incentives_reason: incentivesReason,
      net_salary: netSalary,
      advance: advance,
      age: age,
      address: address,
      work_hours: hours
    };
    
    // ุญูุธ ูู Firebase ูุน ุฅููุงู ูุคูุช ูููุฒุงููุฉ ุงูุชููุงุฆูุฉ. ุฅุฐุง ูุดู ุงูุญูุธุ ูุง
    // ูููู ุจุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูู ุงูุณุญุงุจุฉ ุญุชู ูุง ุชุถูุน ุงูุชุนุฏููุงุช. ุจุนุฏ
    // ุงูุญูุธ (ุฃู ุงููุดู)ุ ูุณุชุนูุฏ ูุคูุช ุงููุฒุงููุฉ ููุญุฏุซ ุงููุงุฌูุฉ.
    (async () => {
      const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
      if (wasAutoSyncActive) {
        clearInterval(window.autoSyncTimer);
        window.autoSyncTimer = null;
      }
      let saveSucceeded = false;
      try {
        await saveDataToFirebase();
        saveSucceeded = true;
      } catch (err) {
        console.error('Error saving employee to Firebase:', err);
      }
      if (saveSucceeded) {
        try {
          await loadDataFromFirebase();
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุชุญุฏูุซ ุงูููุธู:', err);
        }
      }
      if (wasAutoSyncActive) {
        window.autoSyncTimer = setInterval(() => {
          Promise.resolve(backgroundSync());
        }, 5000);
      }
      // ุชุญุฏูุซ ุงูุนุฑุถ
      updateAllDisplays();
      showMessage(`โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูููุธู "${name}" ุจูุฌุงุญ\n๐ฐ ุงูุฑุงุชุจ ุงูุฃุณุงุณู: ${salary.toFixed(2)} ุฌ.ู\n๐ธ ุฅุฌูุงูู ุงูุฎุตููุงุช: ${totalDeductions.toFixed(2)} ุฌ.ู\nโจ ุตุงูู ุงูุฑุงุชุจ: ${netSalary.toFixed(2)} ุฌ.ู`, 'success');
      // ุฅุบูุงู ุงููุงูุฐุฉ: ุงุณุชุฎุฏู ูุนุฑู ูุญุฏุฏ ูุถูุงู ุฅุฒุงูุฉ ูุงูุฐุฉ ุงูุชุนุฏูู ุงูุตุญูุญุฉ
      const modal = document.getElementById('edit-employee-modal');
      if (modal) {
        modal.remove();
      }
    })();
  }
  
  // ุฏุงูุฉ ุญุณุงุจ ุตุงูู ุงูุฑุงุชุจ ูู ุงููููุฐุฌ ุงูุฑุฆูุณู
  function calculateNetSalary() {
    const basicSalary = parseFloat(document.getElementById('employee-salary').value) || 0;
    const lateDeductions = parseFloat(document.getElementById('employee-late-deductions').value) || 0;
    const penalties = parseFloat(document.getElementById('employee-penalties').value) || 0;
    const incentives = parseFloat(document.getElementById('employee-incentives').value) || 0;
    const advance = parseFloat(document.getElementById('employee-advance') && document.getElementById('employee-advance').value) || 0;

    const totalDeductions = lateDeductions + penalties + advance;
    const netSalary = basicSalary - totalDeductions + incentives;

    // Update displays
    const netSalaryElement = document.getElementById('net-salary-display');
    netSalaryElement.textContent = netSalary.toFixed(2) + ' ุฌ.ู';
    const deductionsDisplay = document.getElementById('total-deductions-display');
    if (deductionsDisplay) deductionsDisplay.textContent = totalDeductions.toFixed(2) + ' ุฌ.ู';
    const incentivesDisplay = document.getElementById('total-incentives-display');
    if (incentivesDisplay) incentivesDisplay.textContent = incentives.toFixed(2) + ' ุฌ.ู';
    // Display the advance separately so that users can see ุฅุฌูุงูู ุงูุณูู on the summary card
    const advanceDisplay = document.getElementById('total-advance-display');
    if (advanceDisplay) advanceDisplay.textContent = advance.toFixed(2) + ' ุฌ.ู';

    // ุชุบููุฑ ููู ุตุงูู ุงูุฑุงุชุจ ุญุณุจ ุงููููุฉ
    if (netSalary <= 0) {
      netSalaryElement.className = 'text-lg font-bold text-red-600';
    } else if (netSalary < basicSalary * 0.5) {
      netSalaryElement.className = 'text-lg font-bold text-yellow-600';
    } else {
      netSalaryElement.className = 'text-lg font-bold text-green-600';
    }
  }

  /**
   * ูุณูุญ ูููุณุชุฎุฏู ุจุชุนุฏูู ุฎูุงุฑุงุช ุณุงุนุงุช ุงูุนูู ูู ูุณู ุงูููุธููู. ุนูุฏ ุงูููุฑ ุนูู
   * ุฒุฑ "โ๏ธ ุชุนุฏูู" ุณูุชู ูุชุญ ูุฑุจุน ุญูุงุฑ ูุชูุญ ูููุณุชุฎุฏู ุฅุฏุฎุงู ููุงุนูุฏ ุนูู ุฌุฏูุฏุฉ.
   * ุฅุฐุง ุชู ุฅุฏุฎุงู ูููุฉ ุฌุฏูุฏุฉุ ูุณูุชู ุฅุถุงูุชูุง ุฅูู ูุงุฆูุฉ ุงูุฎูุงุฑุงุช ูุชุนููููุง
   * ููููุฉ ูุฎุชุงุฑุฉ. ูุจูู ุฎูุงุฑ "9 ุต - 5 ู" ููุฌูุฏุงู ุงูุชุฑุงุถูุงู.
   */
  function editEmployeeHours() {
    try {
      const hoursSelect = document.getElementById('employee-hours');
      if (!hoursSelect) return;
      // ูุฑุงุกุฉ ุงููููุฉ ุงูุญุงููุฉ ูุชุณููู ุงูุชุนุฏูู
      const currentValue = hoursSelect.value || '';
      const newHours = prompt('ุฃุฏุฎู ููุงุนูุฏ ุงูุนูู ุงูุฌุฏูุฏุฉ (ูุซุงู: 9 ุต - 5 ู)', currentValue);
      if (!newHours) return;
      // ุชุญูู ูู ุนุฏู ูุฌูุฏ ุงูุฎูุงุฑ ูุณุจูุงู
      let exists = false;
      for (let i = 0; i < hoursSelect.options.length; i++) {
        if (hoursSelect.options[i].value === newHours) {
          exists = true;
          break;
        }
      }
      if (!exists) {
        const option = document.createElement('option');
        option.value = newHours;
        option.textContent = newHours;
        hoursSelect.appendChild(option);
      }
      hoursSelect.value = newHours;
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ูู ุชุนุฏูู ุณุงุนุงุช ุงูุนูู:', err);
    }
  }

  // Toggle visibility of accounting sub-sections. Each accounting section is wrapped
  // in a container with a unique ID (e.g., 'general-ledger-section'). The toggle
  // function will add or remove the `hidden` class on that container when the
  // corresponding button is clicked. This allows users to expand or collapse
  // each accounting subsection on demand without cluttering the UI.
  function toggleAccountingSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (!section) return;
    // Toggle visibility
    section.classList.toggle('hidden');
    // If the section is now visible, refresh the accounting subsections to ensure up-to-date data
    if (!section.classList.contains('hidden')) {
      // ูุฏ ูุง ุชููู ุงูุฏุงูุฉ ูุนุฑูุฉ ูู ุจุนุถ ุงูุณูุงูุงุชุ ูุฐุง ูุชุญูู ูุจู ุงูุงุณุชุฏุนุงุก
      if (typeof updateAccountingSubsections === 'function') {
        try {
          updateAccountingSubsections();
        } catch (err) {
          console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุฃูุณุงู ุงููุฑุนูุฉ ูููุญุงุณุจุฉ ุนูุฏ ุงูุชุจุฏูู:', err);
        }
      }
    }
  }

  /**
   * ูููู ุจุชุญุฏูุซ ุฌุฏูู ุงูููุฑุฏูู ูู ูุณู ุงููุญุงุณุจุฉ ุงููุฑุนู. ูุชู ุฌูุน ุจูุงูุงุช
   * ุงูููุฑุฏูู ูู ุนูููุงุช ุงูุดุฑุงุก ุงููุณุฌูุฉ ูู allDataุ ูุน ุญุณุงุจ ุฅุฌูุงูู
   * ุงููุดุชุฑูุงุช ูุขุฎุฑ ุชุงุฑูุฎ ูุนุงููุฉ ููู ููุฑุฏ. ุฅุฐุง ูู ุชูุฌุฏ ูุดุชุฑูุงุช ุณูุชู
   * ุนุฑุถ ุฑุณุงูุฉ ุชููุฏ ุจุนุฏู ูุฌูุฏ ุจูุงูุงุช.
   */
  function updateAccountingSuppliers() {
    try {
      // ูุณุชุฎุฏู ุงูุฌุฏูู ุงูุฑุฆูุณู ููููุฑุฏูู ูู ุงููุญุงุณุจุฉ (accounting-suppliers-table) ุจุฏูุงู ูู ุงูุฌุฏูู ุงููุฏูู
      const tbody = document.getElementById('accounting-suppliers-table');
      if (!tbody) return;
      // ุชุฌููุน ุงูููุฑุฏูู ูู ุนูููุงุช ุงูุดุฑุงุก
      const purchases = allData.filter(item => item.type === 'purchase');
      const suppliersMap = {};
      purchases.forEach(p => {
        const name = p.supplier || 'ุบูุฑ ูุนุฑูู';
        if (!suppliersMap[name]) {
          suppliersMap[name] = { name: name, total: 0, lastDate: '' };
        }
        suppliersMap[name].total += p.total || 0;
        const d = p.date ? new Date(p.date) : null;
        if (d) {
          if (!suppliersMap[name].lastDate || d > new Date(suppliersMap[name].lastDate)) {
            suppliersMap[name].lastDate = d.toISOString();
          }
        }
      });
      const suppliers = Object.values(suppliersMap);
      // ุชูููุฏ ุงูุตููู ุฃู ุฅุธูุงุฑ ุฑุณุงูุฉ ูุงุฑุบุฉ
      if (suppliers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ููููุฑุฏูู</td></tr>';
        return;
      }
      // ุชูููุฏ ุตู ููู ููุฑุฏ
      const rows = suppliers.map(s => {
        const lastDate = s.lastDate ? new Date(s.lastDate).toLocaleDateString('ar-EG') : '-';
        return `<tr><td class="border border-gray-300 p-2">${s.name}</td><td class="border border-gray-300 p-2">${s.total.toFixed(2)} ุฌ.ู</td><td class="border border-gray-300 p-2">${lastDate}</td></tr>`;
      }).join('');
      tbody.innerHTML = rows;
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุฌุฏูู ุงูููุฑุฏูู ูู ุงููุญุงุณุจุฉ:', err);
    }
  }

  /**
   * ูููู ุจุชุญุฏูุซ ุฌุฏูู ุงูุนููุงุก ูู ูุณู ุงููุญุงุณุจุฉ ุงููุฑุนู. ูุชู ุฌูุน ุจูุงูุงุช
   * ุงูุนููุงุก ูู ุงูููุงุชูุฑ ุงููุณุฌูุฉ ูู allDataุ ูุน ุญุณุงุจ ุงูุฑุตูุฏ ุงููุชุจูู
   * ูุขุฎุฑ ูุนุงููุฉ ููู ุนููู. ุฅุฐุง ูู ุชูุฌุฏ ููุงุชูุฑ ุณูุชู ุนุฑุถ ุฑุณุงูุฉ ูุงุฑุบุฉ.
   */
  function updateAccountingCustomers() {
    try {
      const tbody = document.getElementById('accounting-customers-table');
      if (!tbody) return;
      // ุชุฌููุน ุงูุนููุงุก ูู ุงูููุงุชูุฑ
      const invoices = allData.filter(item => item.type === 'invoice');
      const customersMap = {};
      invoices.forEach(inv => {
        const name = inv.customer_name || 'ุบูุฑ ูุนุฑูู';
        if (!customersMap[name]) {
          customersMap[name] = { name: name, balance: 0, lastDate: '' };
        }
        const remaining = inv.remaining_amount || (inv.total - (inv.payment_amount || 0));
        customersMap[name].balance += remaining;
        const d = inv.date ? new Date(inv.date) : null;
        if (d) {
          if (!customersMap[name].lastDate || d > new Date(customersMap[name].lastDate)) {
            customersMap[name].lastDate = d.toISOString();
          }
        }
      });
      const customers = Object.values(customersMap);
      if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ููุนููุงุก</td></tr>';
        return;
      }
      const rows = customers.map(c => {
        const lastDate = c.lastDate ? new Date(c.lastDate).toLocaleDateString('ar-EG') : '-';
        return `<tr><td class="border border-gray-300 p-2">${c.name}</td><td class="border border-gray-300 p-2">${c.balance.toFixed(2)} ุฌ.ู</td><td class="border border-gray-300 p-2">${lastDate}</td></tr>`;
      }).join('');
      tbody.innerHTML = rows;
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุฌุฏูู ุงูุนููุงุก ูู ุงููุญุงุณุจุฉ:', err);
    }
  }

  /**
   * ูููู ุจุชุญุฏูุซ ุฌุฏูู ุงูุฑูุงุชุจ ูุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ูู ูุณู ุงููุญุงุณุจุฉ ุงููุฑุนู.
   * ูุนุชูุฏ ุนูู ุจูุงูุงุช ุงูููุธููู ุงููุณุฌูุฉ ูู allDataุ ููุญุณุจ ูุฌููุน
   * ุงูุฎุตููุงุช ููู ููุธู ูุชุญุฏูุซ ุตุงูู ุงูุฑุงุชุจ ุงููุนุฑูุถ.
   */
  function updateAccountingSalaries() {
    try {
      const tbody = document.getElementById('salaries-table');
      if (!tbody) return;
      const employees = allData.filter(item => item.type === 'employee');
      if (employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฑูุงุชุจ</td></tr>';
        return;
      }
      const rows = employees.map(emp => {
        const totalDeductions = (parseFloat(emp.late_deductions || 0) + parseFloat(emp.penalties || 0)).toFixed(2);
        return `<tr><td class="border border-gray-300 p-2">${emp.employee_name}</td><td class="border border-gray-300 p-2">${emp.basic_salary.toFixed(2)} ุฌ.ู</td><td class="border border-gray-300 p-2">${totalDeductions} ุฌ.ู</td><td class="border border-gray-300 p-2">${emp.net_salary.toFixed(2)} ุฌ.ู</td></tr>`;
      }).join('');
      tbody.innerHTML = rows;
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุฌุฏูู ุงูุฑูุงุชุจ ูู ุงููุญุงุณุจุฉ:', err);
    }
  }

  /**
   * ุฅูุดุงุก ุฌุฏูู ุฏูุชุฑ ุงูุฃุณุชุงุฐ ุงูุนุงู ูู ุฌููุน ุงููุนุงููุงุช (ุงููุจูุนุงุชุ ุงููุดุชุฑูุงุชุ ุงููุตุฑููุงุช)
   * ูู allData. ูุชู ุชุฑุชูุจ ุงููุนุงููุงุช ุฒูููุงู ูุญุณุงุจ ุฑุตูุฏ ุฌุงุฑู ูุฒุฏุงุฏ ูุน
   * ุงููุจูุนุงุช ูููู ูุน ุงููุตุฑููุงุช ูุงููุดุชุฑูุงุช. ููุชุจ ุงูุฑุตูุฏ ููู ุตู ุญุชู ุชุธูุฑ
   * ุงูุญุฑูุฉ ุงูุฒูููุฉ ููุฑุตูุฏ.
   */
  function updateGeneralLedger() {
    try {
      const tbody = document.getElementById('general-ledger-table');
      if (!tbody) return;
      // ุงุณุชุฎุฑุงุฌ ุงููุนุงููุงุช ุฐุงุช ุงูุตูุฉ ูุชุฑุชูุจูุง ุญุณุจ ุงูุชุงุฑูุฎ ุชุตุงุนุฏูุงู
      const relevant = (Array.isArray(allData) ? allData : []).filter(item => {
        return item && (item.type === 'invoice' || item.type === 'purchase' || item.type === 'expense');
      }).sort((a, b) => new Date(a.date) - new Date(b.date));
      let balance = 0;
      const rows = [];
      relevant.forEach(item => {
        const dateObj = new Date(item.date);
        const dateStr = !isNaN(dateObj) ? dateObj.toLocaleDateString('ar-EG') : (item.date || '');
        let description = '';
        let debit = 0;
        let credit = 0;
        if (item.type === 'invoice') {
          // ูุจูุนุงุช: ุชุฒูุฏ ุงูุฑุตูุฏ
          credit = parseFloat(item.total || 0);
          description = `ูุงุชูุฑุฉ ${item.invoice_number || item.customer_name || ''}`.trim();
          balance += credit;
        } else if (item.type === 'purchase') {
          // ุงููุดุชุฑูุงุช: ุชููู ุงูุฑุตูุฏ
          debit = parseFloat(item.total || 0);
          description = `ุดุฑุงุก ${item.product_name || item.code || ''}`.trim();
          balance -= debit;
        } else if (item.type === 'expense') {
          // ุงููุตุฑููุงุช: ุชููู ุงูุฑุตูุฏ
          debit = parseFloat(item.amount || 0);
          description = `ูุตุฑูู ${item.expense_type || ''}`.trim();
          balance -= debit;
        }
        rows.push({ dateStr, description, debit, credit, balance: balance });
      });
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูู ุฏูุชุฑ ุงูุฃุณุชุงุฐ ุงูุนุงู</td></tr>';
        return;
      }
      // ุฅูุดุงุก ุตููู HTML
      const html = rows.map(r => {
        return `<tr>
          <td class="border border-gray-300 p-2">${r.dateStr}</td>
          <td class="border border-gray-300 p-2">${r.description}</td>
          <td class="border border-gray-300 p-2 text-red-600">${r.debit ? r.debit.toFixed(2) : ''}</td>
          <td class="border border-gray-300 p-2 text-green-600">${r.credit ? r.credit.toFixed(2) : ''}</td>
          <td class="border border-gray-300 p-2">${r.balance.toFixed(2)}</td>
        </tr>`;
      }).join('');
      tbody.innerHTML = html;
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุฏูุชุฑ ุงูุฃุณุชุงุฐ ุงูุนุงู:', err);
    }
  }

  /**
   * ุชุญุฏูุซ ุฌุฏูู ุงูุฎุฒููุฉ ุจูุงุกู ุนูู ูู ุงููุนุงููุงุช ุงูููุฌูุฏุฉ ูู allData. ูุชู
   * ุญุณุงุจ ุฑุตูุฏ ููุฏู ูุชุบูุฑ ุจุฅุถุงูุฉ ุงููุจูุนุงุช ูุทุฑุญ ุงููุตุฑููุงุช ูุงููุดุชุฑูุงุชุ ุซู
   * ุฅุธูุงุฑ ุงูุฑุตูุฏ ูู ูู ุตู. ุงููุฏู ูู ุฅุธูุงุฑ ุชุญุฑู ุงูุฃููุงู ูู ุงูุฎุฒููุฉ.
   */
  function updateTreasury() {
    try {
      const tbody = document.getElementById('treasury-table');
      if (!tbody) return;
      const relevant = (Array.isArray(allData) ? allData : []).filter(item => {
        return item && (item.type === 'invoice' || item.type === 'purchase' || item.type === 'expense');
      }).sort((a, b) => new Date(a.date) - new Date(b.date));
      let balance = 0;
      const rows = [];
      relevant.forEach(item => {
        const dateObj = new Date(item.date);
        const dateStr = !isNaN(dateObj) ? dateObj.toLocaleDateString('ar-EG') : (item.date || '');
        let operation = '';
        let amount = 0;
        if (item.type === 'invoice') {
          amount = parseFloat(item.total || 0);
          operation = `ุฅูุฑุงุฏ ูู ูุงุชูุฑุฉ ${item.invoice_number || item.customer_name || ''}`.trim();
          balance += amount;
        } else if (item.type === 'purchase') {
          amount = parseFloat(item.total || 0);
          operation = `ุดุฑุงุก ${item.product_name || item.code || ''}`.trim();
          balance -= amount;
        } else if (item.type === 'expense') {
          amount = parseFloat(item.amount || 0);
          operation = `ูุตุฑูู ${item.expense_type || ''}`.trim();
          balance -= amount;
        }
        rows.push({ dateStr, operation, amount, balance });
      });
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุนุงููุงุช ูู ุงูุฎุฒููุฉ</td></tr>';
        return;
      }
      // ุฅูุดุงุก ุตููู HTML
      const html = rows.map(r => {
        return `<tr>
          <td class="border border-gray-300 p-2">${r.dateStr}</td>
          <td class="border border-gray-300 p-2">${r.operation}</td>
          <td class="border border-gray-300 p-2 ${r.amount < 0 ? 'text-red-600' : 'text-green-600'}">${r.amount.toFixed(2)}</td>
          <td class="border border-gray-300 p-2">${r.balance.toFixed(2)}</td>
        </tr>`;
      }).join('');
      tbody.innerHTML = html;
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุฌุฏูู ุงูุฎุฒููุฉ:', err);
    }
  }

  /**
   * ุงุณุชุฏุนุงุก ุชุญุฏูุซ ูู ุงูุฃูุณุงู ุงููุฑุนูุฉ ูููุญุงุณุจุฉ ุญุชู ุชุนูุณ ุงูุจูุงูุงุช ุงูุญุงููุฉ
   * ูู allData. ููุณุชุฏุนู ูุฐุง ุงูุฑูุชูู ุจุนุฏ ุชุญููู ุงูุจูุงูุงุช ุฃู ุชุนุฏูููุง.
   */
  function updateAccountingSubsections() {
    updateAccountingSuppliers();
    updateAccountingCustomers();
    updateAccountingSalaries();
    // ุชุญุฏูุซ ุฏูุชุฑ ุงูุฃุณุชุงุฐ ูุงูุฎุฒููุฉ ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงูุญุงููุฉ
    updateGeneralLedger();
    updateTreasury();
  }
  
  // Accounting functions
  async function addExpense() {
    console.log('๐ ุจุฏุก ุนูููุฉ ุฅุถุงูุฉ ูุตุฑูู...');
    
    const expenseType = document.getElementById('expense-type').value.trim();
    const expenseAmount = parseFloat(document.getElementById('expense-amount').value) || 0;
    const expenseDescription = document.getElementById('expense-description').value.trim();
    
    // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
    if (!expenseType) {
      showMessage('โ ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงููุตุฑูู', 'error');
      document.getElementById('expense-type').focus();
      return;
    }
    
    if (expenseAmount <= 0) {
      showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ ุฃูุจุฑ ูู ุตูุฑ', 'error');
      document.getElementById('expense-amount').focus();
      return;
    }
    
    if (expenseAmount > 1000000) {
      showMessage('โ ุงููุจูุบ ูุจูุฑ ุฌุฏุงู - ุงูุญุฏ ุงูุฃูุตู ููููู ุฌููู', 'error');
      document.getElementById('expense-amount').focus();
      return;
    }
    
    showLoading();
    
    try {
      // ุฅูุดุงุก ุณุฌู ุงููุตุฑูู ูุน ID ูุฑูุฏ
      const expenseId = 'expense_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      const expense = {
        type: 'expense',
        expense_type: expenseType,
        amount: parseFloat(expenseAmount.toFixed(2)),
        description: expenseDescription || 'ูุง ููุฌุฏ ูุตู',
        date: new Date().toISOString(),
        status: 'ููุชูู',
        created_by: currentUser ? currentUser.fullName : 'ูุณุชุฎุฏู ุบูุฑ ูุนุฑูู',
        id: expenseId
      };
      
      console.log('๐พ ุจูุงูุงุช ุงููุตุฑูู:', expense);
      
      // ุฅุถุงูุฉ ููุจูุงูุงุช ุงููุญููุฉ ููุฑุงู
      allData.push(expense);
      console.log('๐ ุชู ุฅุถุงูุฉ ุงููุตุฑูู ููุจูุงูุงุช ุงููุญููุฉ');

      // ๐ป Update the budget: subtract the expense amount from the current budget.
      if (typeof window.currentBudget === 'undefined' || isNaN(parseFloat(window.currentBudget))) {
        window.currentBudget = 0;
      }
      window.currentBudget = parseFloat(window.currentBudget) - expense.amount;
      const budgetEl = document.getElementById('budget-amount');
      if (budgetEl) {
        budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
      }
      // Persist the updated budget to Firebase.  Do not block the UI on failure.
      try {
        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), window.currentBudget);
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูููุฒุงููุฉ ุจุนุฏ ุฅุถุงูุฉ ูุตุฑูู:', err);
      }
      
      // ุญูุธ ูู Firebase ูุน ุฅููุงู ูุคูุช ููุคูุช ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ.
      const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
      if (wasAutoSyncActive) {
        clearInterval(window.autoSyncTimer);
        window.autoSyncTimer = null;
      }
      let saveSucceeded = false;
      try {
        await saveDataToFirebase();
        saveSucceeded = true;
      } catch (err) {
        console.error('Error saving expense to Firebase:', err);
      }
      // Reload only if the save succeeded
      if (saveSucceeded) {
        try {
          await loadDataFromFirebase();
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุฅุถุงูุฉ ุงููุตุฑูู:', err);
        }
      }
      if (wasAutoSyncActive) {
        window.autoSyncTimer = setInterval(() => {
          Promise.resolve(backgroundSync());
        }, 5000);
      }
      
      // ุชุญุฏูุซ ุงูุนุฑูุถ ููุฑุงู ูุถูุงู ุชุฒุงูู ุฌููุน ุงูุฃูุณุงู (ูุซู ุงูุฃุฑุจุงุญ ูุงููุจูุนุงุช ูุงููุตุฑููุงุช)
      updateAllDisplays();
      
      hideLoading();
      clearExpenseInputs();
      
      // ุฑุณุงูุฉ ูุฌุงุญ ููุตูุฉ
      let successMessage = `โ ุชู ุฅุถุงูุฉ ุงููุตุฑูู ุจูุฌุงุญ!`;
      successMessage += `\n๐ ุงูููุน: ${expenseType}`;
      successMessage += `\n๐ฐ ุงููุจูุบ: ${expenseAmount.toFixed(2)} ุฌ.ู`;
      if (expenseDescription) {
        successMessage += `\n๐ ุงููุตู: ${expenseDescription}`;
      }
      successMessage += `\n๐ ุงูุชุงุฑูุฎ: ${new Date().toLocaleDateString('ar-EG')}`;
      successMessage += `\n๐พ ุชู ุญูุธ ุงูุจูุงูุงุช ูู ุงููุธุงู ุงููุญูู`;
      
      showMessage(successMessage, 'success');
      
      console.log('๐ ุชู ุฅุถุงูุฉ ุงููุตุฑูู ุจูุฌุงุญ:', {
        type: expenseType,
        amount: expenseAmount,
        description: expenseDescription,
        id: expenseId
      });
      
    } catch (error) {
      hideLoading();
      console.error('๐ฅ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงููุตุฑูู:', error);
      
      // ุฅุฒุงูุฉ ุงููุตุฑูู ูู ุงูุจูุงูุงุช ุงููุญููุฉ ูู ุญุงูุฉ ุงููุดู
      const expenseIndex = allData.findIndex(item => item.id === expenseId);
      if (expenseIndex !== -1) {
        allData.splice(expenseIndex, 1);
        updateAccountingDisplay();
      }
      
      let errorMessage = 'โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงููุตุฑูู:\n';
      errorMessage += error.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู';
      errorMessage += '\n\n๐ก ุงูุญููู ุงูููุชุฑุญุฉ:';
      errorMessage += '\nโข ุชุฃูุฏ ูู ุตุญุฉ ุงูุจูุงูุงุช ุงููุฏุฎูุฉ';
      errorMessage += '\nโข ุฃุนุฏ ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู';
      
      showMessage(errorMessage, 'error');
    }
  }
  
  // ุฏูุงู ูุณุงุนุฏุฉ ูููุตุฑููุงุช
  function handleExpenseSubmit(event) {
    event.preventDefault();
    console.log('๐ ุชู ุฅุฑุณุงู ูููุฐุฌ ุงููุตุฑูู');
    
    // ุงูุชุญูู ูู ุตุญุฉ ุงููููุฐุฌ ูุจู ุงูุฅุฑุณุงู
    if (validateExpenseForm()) {
      addExpense();
    }
  }
  
  function validateExpenseForm() {
    let isValid = true;
    
    // ุงูุชุญูู ูู ููุน ุงููุตุฑูู
    const expenseType = document.getElementById('expense-type');
    const typeError = document.getElementById('expense-type-error');
    
    if (!expenseType.value.trim()) {
      typeError.classList.remove('hidden');
      typeError.textContent = 'ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงููุตุฑูู';
      expenseType.classList.add('border-red-500');
      isValid = false;
    } else {
      typeError.classList.add('hidden');
      expenseType.classList.remove('border-red-500');
    }
    
    // ุงูุชุญูู ูู ุงููุจูุบ
    const expenseAmount = document.getElementById('expense-amount');
    const amountError = document.getElementById('expense-amount-error');
    const amount = parseFloat(expenseAmount.value) || 0;
    
    if (amount <= 0) {
      amountError.classList.remove('hidden');
      amountError.textContent = 'ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุฃูุจุฑ ูู ุตูุฑ';
      expenseAmount.classList.add('border-red-500');
      isValid = false;
    } else if (amount > 1000000) {
      amountError.classList.remove('hidden');
      amountError.textContent = 'ุงููุจูุบ ูุจูุฑ ุฌุฏุงู - ุงูุญุฏ ุงูุฃูุตู ููููู ุฌููู';
      expenseAmount.classList.add('border-red-500');
      isValid = false;
    } else {
      amountError.classList.add('hidden');
      expenseAmount.classList.remove('border-red-500');
    }
    
    return isValid;
  }
  
  function validateExpenseAmount(input) {
    const amount = parseFloat(input.value) || 0;
    const amountError = document.getElementById('expense-amount-error');
    
    if (amount < 0) {
      input.value = '';
      amountError.classList.remove('hidden');
      amountError.textContent = 'ูุง ูููู ุฃู ูููู ุงููุจูุบ ุณุงูุจุงู';
      input.classList.add('border-red-500');
    } else if (amount > 1000000) {
      amountError.classList.remove('hidden');
      amountError.textContent = 'ุงููุจูุบ ูุจูุฑ ุฌุฏุงู - ุงูุญุฏ ุงูุฃูุตู ููููู ุฌููู';
      input.classList.add('border-red-500');
    } else {
      amountError.classList.add('hidden');
      input.classList.remove('border-red-500');
    }
    
    // ุชุญุฏูุซ ุงููุนุงููุฉ
    updateExpensePreview();
  }
  
  function updateExpensePreview() {
    const expenseType = document.getElementById('expense-type').value;
    const expenseAmount = parseFloat(document.getElementById('expense-amount').value) || 0;
    const expenseDescription = document.getElementById('expense-description').value.trim();
    
    const preview = document.getElementById('expense-preview');
    const previewType = document.getElementById('preview-type');
    const previewAmount = document.getElementById('preview-amount');
    const previewDate = document.getElementById('preview-date');
    const previewDescription = document.getElementById('preview-description');
    const previewDescriptionContainer = document.getElementById('preview-description-container');
    
    if (expenseType || expenseAmount > 0) {
      preview.classList.remove('hidden');
      
      previewType.textContent = expenseType || '-';
      previewAmount.textContent = expenseAmount.toFixed(2) + ' ุฌ.ู';
      previewDate.textContent = new Date().toLocaleDateString('ar-EG');
      
      if (expenseDescription) {
        previewDescription.textContent = expenseDescription;
        previewDescriptionContainer.style.display = 'block';
      } else {
        previewDescriptionContainer.style.display = 'none';
      }
    } else {
      preview.classList.add('hidden');
    }
  }
  
  function clearExpenseForm() {
    document.getElementById('expense-form').reset();
    document.getElementById('expense-preview').classList.add('hidden');
    
    // ุฅุฎูุงุก ุฑุณุงุฆู ุงูุฎุทุฃ
    document.getElementById('expense-type-error').classList.add('hidden');
    document.getElementById('expense-amount-error').classList.add('hidden');
    
    // ุฅุฒุงูุฉ ุชูุณูู ุงูุฎุทุฃ
    document.getElementById('expense-type').classList.remove('border-red-500');
    document.getElementById('expense-amount').classList.remove('border-red-500');
    
    showMessage('๐ ุชู ูุณุญ ุงููููุฐุฌ', 'info');
  }
  
  function testExpenseSystem() {
    console.log('๐งช ุจุฏุก ุงุฎุชุจุงุฑ ูุธุงู ุงููุตุฑููุงุช...');
    
    // ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ูุตุฑูู ุชุฌุฑูุจู
    const testExpense = {
      type: 'expense',
      expense_type: 'ุงุฎุชุจุงุฑ ุงููุธุงู',
      amount: 1.00,
      description: 'ูุตุฑูู ุชุฌุฑูุจู ูุงุฎุชุจุงุฑ ุงููุธุงู - ' + new Date().toLocaleString('ar-EG'),
      date: new Date().toISOString(),
      status: 'ููุชูู',
      created_by: currentUser ? currentUser.fullName : 'ูุณุชุฎุฏู ุชุฌุฑูุจู',
      id: 'test_expense_' + Date.now()
    };
    
    // ุฅุถุงูุฉ ููุจูุงูุงุช ุงููุญููุฉ
    allData.push(testExpense);
    
    // ุญูุธ ูู Firebase
    saveDataToFirebase();
    
    // ุชุญุฏูุซ ุงูุนุฑูุถ
    updateAccountingDisplay();
    
    let testMessage = '๐งช ูุชุงุฆุฌ ุงุฎุชุจุงุฑ ูุธุงู ุงููุตุฑููุงุช:\n\n';
    testMessage += 'โ ุชู ุฅูุดุงุก ูุตุฑูู ุชุฌุฑูุจู ุจูุฌุงุญ\n';
    testMessage += 'โ ุชู ุฅุถุงูุฉ ุงูุจูุงูุงุช ูููุธุงู ุงููุญูู\n';
    testMessage += 'โ ุชู ุชุญุฏูุซ ุงูุนุฑูุถ ูุงูุฌุฏุงูู\n';
    testMessage += `โ ุนุฏุฏ ุงููุตุฑููุงุช ุงูุญุงูู: ${allData.filter(item => item.type === 'expense').length}\n\n`;
    testMessage += '๐พ ุงููุตุฑููุงุช ูุญููุธุฉ ูุญููุงู ูู ุงููุธุงู';
    
    showMessage(testMessage, 'success');
    
    console.log('๐ ุงูุชูู ุงุฎุชุจุงุฑ ูุธุงู ุงููุตุฑููุงุช ุจูุฌุงุญ');
  }
  
  function clearExpenseInputs() {
    clearExpenseForm();
  }
  
  function switchAccountingView(viewType) {
    const dailyBtn = document.getElementById('daily-view-btn');
    const monthlyBtn = document.getElementById('monthly-view-btn');
    const yearlyBtn = document.getElementById('yearly-view-btn');
    const dailyView = document.getElementById('daily-accounting');
    const monthlyView = document.getElementById('monthly-accounting');
    const yearlyView = document.getElementById('yearly-accounting');
    
    // Reset all buttons
    dailyBtn.className = 'px-6 py-2 rounded-md text-gray-600 hover:text-gray-800 font-medium transition-colors';
    monthlyBtn.className = 'px-6 py-2 rounded-md text-gray-600 hover:text-gray-800 font-medium transition-colors';
    yearlyBtn.className = 'px-6 py-2 rounded-md text-gray-600 hover:text-gray-800 font-medium transition-colors';
    
    // Hide all views
    dailyView.classList.add('hidden');
    monthlyView.classList.add('hidden');
    yearlyView.classList.add('hidden');
    
    if (viewType === 'daily') {
      dailyBtn.className = 'px-6 py-2 rounded-md bg-cyan-600 text-white font-medium transition-colors';
      dailyView.classList.remove('hidden');
    } else if (viewType === 'monthly') {
      monthlyBtn.className = 'px-6 py-2 rounded-md bg-cyan-600 text-white font-medium transition-colors';
      monthlyView.classList.remove('hidden');
    } else {
      yearlyBtn.className = 'px-6 py-2 rounded-md bg-cyan-600 text-white font-medium transition-colors';
      yearlyView.classList.remove('hidden');
    }
    
    updateAccountingDisplay();
  }
  
  function deleteExpense(expenseId) {
    const expenseIndex = allData.findIndex(item => item.id === expenseId);
    if (expenseIndex === -1) return;
    
    const expense = allData[expenseIndex];
    
    // Create confirmation UI
    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    confirmDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md">
        <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุงูุญุฐู</h3>
        <!--
          Cast amount to a number before using toFixed().  Some expense
          records loaded from Firebase may store amount as a string (e.g., "50.00").
          Calling toFixed() on a string would throw an error and prevent the
          confirmation popโup from rendering, leaving stale expenses in the UI.
        -->
        ${(() => {
          const amt = parseFloat(expense.amount) || 0;
          return `<p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุตุฑูู "${expense.expense_type}" ุจูููุฉ ${amt.toFixed(2)} ุฌ.ูุ</p>`;
        })()}
        <div class="flex gap-3 justify-end">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
            ุฅูุบุงุก
          </button>
          <button onclick="confirmDeleteExpense('${expenseId}'); this.parentElement.parentElement.parentElement.remove()" 
                  class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
            ุญุฐู
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  }
  
async function confirmDeleteExpense(expenseId) {
    const expenseIndex = allData.findIndex(item => item.id === expenseId);
    if (expenseIndex !== -1) {
      const expense = allData[expenseIndex];
      // Remove the expense from the unified data array
      allData.splice(expenseIndex, 1);
      /*
       * Pause the background sync timer to prevent it from writing stale data
       * back to Firebase while we process this deletion.  Without pausing,
       * backgroundSync could overwrite the deletion by saving a previous
       * snapshot of `allData`.
       */
      const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
      if (wasAutoSyncActive) {
        clearInterval(window.autoSyncTimer);
        window.autoSyncTimer = null;
      }
      try {
        // Persist the deletion to Firebase; reload only if save succeeds
        let saveSucceeded = false;
        try {
          await saveDataToFirebase();
          saveSucceeded = true;
        } catch (err) {
          console.error('Error saving data to Firebase:', err);
        }
        if (saveSucceeded) {
          await loadDataFromFirebase();
        }
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุฃู ุฅุนุงุฏุฉ ุชุญููู ุจูุงูุงุช ุญุฐู ุงููุตุฑูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
      }
      // Resume the background sync if it was previously running
      if (wasAutoSyncActive) {
        window.autoSyncTimer = setInterval(() => {
          Promise.resolve(backgroundSync());
        }, 5000);
      }
      // Restore the budget by adding back the expense amount that was previously deducted.
      try {
        if (typeof window.currentBudget === 'undefined' || isNaN(parseFloat(window.currentBudget))) {
          window.currentBudget = 0;
        }
        const amt = parseFloat(expense.amount) || 0;
        window.currentBudget = parseFloat(window.currentBudget) + amt;
        // Update the budget display
        const budgetEl = document.getElementById('budget-amount');
        if (budgetEl) {
          budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
        }
        // Persist updated budget to Firebase
        try {
          await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), window.currentBudget);
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูููุฒุงููุฉ ุจุนุฏ ุญุฐู ุงููุตุฑูู:', err);
        }
      } catch (budgetErr) {
        console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุนุงุฏุฉ ุงูููุฒุงููุฉ ุจุนุฏ ุญุฐู ุงููุตุฑูู:', budgetErr);
      }
      // Update accounting views after the save and reload complete
      // ุงุณุชุฏุนุงุก updateAllDisplays ุจุฏูุงู ูู updateAccountingDisplay ููุท ูุถูุงู ุชุญุฏูุซ ุฌููุน ุงูุฃูุณุงู
      updateAllDisplays();
      showMessage(`โ ุชู ุญุฐู ูุตุฑูู "${expense.expense_type}" ุจูุฌุงุญ`, 'success');
    }
  }
  
  function updateAccountingDisplay() {
    updateFinancialOverview();
    updateDailyAccounting();
    updateMonthlyAccounting();
    updateYearlyAccounting();
    updateExpensesDetails();

    // ุชุญุฏูุซ ุงูุฃูุณุงู ุงููุฑุนูุฉ ูููุญุงุณุจุฉ (ุงูููุฑุฏููุ ุงูุนููุงุกุ ุงูุฑูุงุชุจ) ููุฒุงููุฉ ุงูุจูุงูุงุช ูุน ุจููุฉ ุงููุธุงู
    updateAccountingSubsections();

    // ุชุฃูุฏ ูู ุชุญุฏูุซ ุนุฑุถ ุงูููุฒุงููุฉ ููุนูุณ ุงููููุฉ ุงูุญุงููุฉ ูู window.currentBudget.  ูุนุฑุถ
    // ูุฐุง ุจุทุงูุฉ ุงูููุฒุงููุฉ ูููุงู ูุฃู ุชุบููุฑุงุช ุชูุช ุฃุซูุงุก ุนูููุงุช ุงูุดุฑุงุก ุฃู ุงููุตุฑููุงุช.
    try {
      if (typeof window.currentBudget !== 'undefined') {
        const budgetEl = document.getElementById('budget-amount');
        if (budgetEl) {
          budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
        }
      }
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุนุฑุถ ุงูููุฒุงููุฉ ุฃุซูุงุก ุชุญุฏูุซ ุงููุญุงุณุจุฉ:', err);
    }
  }
  
  function updateDailyAccounting() {
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    // Get all days in current month
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const dailyData = {};
    
    // Initialize all days
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
      dailyData[dateKey] = {
        date: new Date(currentYear, currentMonth, day),
        sales: 0,
        purchaseCosts: 0,
        expenses: 0,
        profit: 0
      };
    }
    
    // Compute daily sales revenue and cost of goods sold using sale records
    // Use robust revenue calculation: if `sale.total` exists, treat it as the total revenue
    // for that sale. Otherwise fall back to unit price * quantity. This ensures that
    // legacy sale records lacking a `price` field (only having `total`) are handled
    // correctly, preventing negative profits due to zero revenue.
    const salesRecords = allData.filter(item => item.type === 'sale');
    const inventoryMap = calculateInventory();
    salesRecords.forEach(sale => {
      const saleDate = new Date(sale.date);
      if (saleDate.getMonth() !== currentMonth || saleDate.getFullYear() !== currentYear) return;
      const dateKey = `${saleDate.getFullYear()}-${(saleDate.getMonth() + 1).toString().padStart(2, '0')}-${saleDate.getDate().toString().padStart(2, '0')}`;
      if (!dailyData[dateKey]) return;
      const quantity = parseFloat(sale.quantity) || 0;
      // Derive revenue. Prefer the explicit total if present; otherwise multiply unit price by quantity
      let revenue;
      if (typeof sale.total !== 'undefined' && !isNaN(parseFloat(sale.total))) {
        revenue = parseFloat(sale.total);
      } else {
        const unitPrice = parseFloat(sale.price);
        revenue = (!isNaN(unitPrice) ? unitPrice : 0) * quantity;
      }
      // Derive cost of goods sold using the latest purchase price
      // Prefer the purchase price recorded on the sale record; fallback to inventory purchase price
      let purchasePrice;
      if (typeof sale.purchase_price !== 'undefined' && !isNaN(parseFloat(sale.purchase_price))) {
        purchasePrice = parseFloat(sale.purchase_price);
      } else {
        purchasePrice = (inventoryMap[sale.product_code] && inventoryMap[sale.product_code].purchasePrice) || 0;
      }
      const cost = purchasePrice * quantity;
      dailyData[dateKey].sales += revenue;
      dailyData[dateKey].purchaseCosts += cost;
    });
    // Compute expenses
    const expenseRecords = allData.filter(item => 
      item.type === 'expense' && 
      new Date(item.date).getMonth() === currentMonth &&
      new Date(item.date).getFullYear() === currentYear
    );
    expenseRecords.forEach(expense => {
      const date = new Date(expense.date);
      const dateKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
      if (dailyData[dateKey]) {
        dailyData[dateKey].expenses += (expense.amount || 0);
      }
    });
    // Compute profits per day based solely on sales minus cost of goods sold.  We exclude
    // other expenses from this calculation so that the profit reflects the margin on
    // sales only.  Expenses are displayed separately in the table.
    Object.keys(dailyData).forEach(key => {
      const data = dailyData[key];
      data.profit = Math.max(0, data.sales - data.purchaseCosts);
    });
    
    // Update daily profits table
    const dailyProfitsTable = document.getElementById('daily-profits-table');
    const dailyExpensesTable = document.getElementById('daily-expenses-table');
    
    const dailyDataArray = Object.values(dailyData).filter(data => 
      data.sales > 0 || data.purchaseCosts > 0 || data.expenses > 0
    ).reverse(); // Show recent days first
    
    if (dailyDataArray.length === 0) {
      dailyProfitsTable.innerHTML = '<tr><td colspan="5" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุฑุจุงุญ ููููุฉ</td></tr>';
      dailyExpensesTable.innerHTML = '<tr><td colspan="5" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุตุฑููุงุช ููููุฉ</td></tr>';
    } else {
      const dayNames = ['ุงูุฃุญุฏ', 'ุงูุงุซููู', 'ุงูุซูุงุซุงุก', 'ุงูุฃุฑุจุนุงุก', 'ุงูุฎููุณ', 'ุงูุฌูุนุฉ', 'ุงูุณุจุช'];
      
      dailyProfitsTable.innerHTML = dailyDataArray.map(data => `
        <tr class="hover:bg-green-50">
          <td class="border border-gray-300 p-3 font-medium">${data.date.toLocaleDateString('ar-EG')}</td>
          <td class="border border-gray-300 p-3 text-blue-600">${dayNames[data.date.getDay()]}</td>
          <td class="border border-gray-300 p-3 text-blue-600 font-bold">${data.sales.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-3 text-red-600">${(data.purchaseCosts + data.expenses).toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-3 font-bold ${data.profit >= 0 ? 'text-green-600' : 'text-red-600'}">${data.profit.toFixed(2)} ุฌ.ู</td>
        </tr>
      `).join('');
      
      dailyExpensesTable.innerHTML = dailyDataArray.map(data => `
        <tr class="hover:bg-red-50">
          <td class="border border-gray-300 p-3 font-medium">${data.date.toLocaleDateString('ar-EG')}</td>
          <td class="border border-gray-300 p-3 text-blue-600">${dayNames[data.date.getDay()]}</td>
          <td class="border border-gray-300 p-3 text-red-600">${data.expenses.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-3 text-purple-600">${data.purchaseCosts.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-3 font-bold text-red-600">${(data.expenses + data.purchaseCosts).toFixed(2)} ุฌ.ู</td>
        </tr>
      `).join('');
    }
    
    // Update today's summary based on sale records
    const today = new Date();
    const todayStr = today.toDateString();
    // Filter sales that occurred today
    const todaySalesRecords = allData.filter(item => 
      item.type === 'sale' && 
      new Date(item.date).toDateString() === todayStr
    );
    let todaySales = 0;
    let todayCostOfGoods = 0;
    const inventoryMapDaily = calculateInventory();
    todaySalesRecords.forEach(sale => {
      const qty = parseFloat(sale.quantity) || 0;
      // Determine revenue for today: use total if available; otherwise price * quantity
      let revenue;
      if (typeof sale.total !== 'undefined' && !isNaN(parseFloat(sale.total))) {
        revenue = parseFloat(sale.total);
      } else {
        const unitPriceTmp = parseFloat(sale.price);
        const unitPrice = (!isNaN(unitPriceTmp) ? unitPriceTmp : 0);
        revenue = unitPrice * qty;
      }
      todaySales += revenue;
      const purchasePrice = (inventoryMapDaily[sale.product_code] && inventoryMapDaily[sale.product_code].purchasePrice) || 0;
      todayCostOfGoods += purchasePrice * qty;
    });
    // Expenses for today
    const todayExpensesRecords = allData.filter(item => 
      item.type === 'expense' && 
      new Date(item.date).toDateString() === todayStr
    );
    const todayExpensesAmount = todayExpensesRecords.reduce((sum, exp) => sum + (exp.amount || 0), 0);
    const todayProfit = todaySales - todayCostOfGoods - todayExpensesAmount;
    const todayProfitMargin = todaySales > 0 ? ((todayProfit / todaySales) * 100) : 0;
    document.getElementById('today-profit').textContent = todayProfit.toFixed(2) + ' ุฌ.ู';
    document.getElementById('today-sales-amount').textContent = todaySales.toFixed(2) + ' ุฌ.ู';
    document.getElementById('today-expenses-amount').textContent = (todayCostOfGoods + todayExpensesAmount).toFixed(2) + ' ุฌ.ู';
    document.getElementById('today-profit-margin').textContent = todayProfitMargin.toFixed(1) + '%';
  }
  
  function updateFinancialOverview() {
    // Calculate totals across all data (not limited to current year)
    // This ensures that financial overview cards always reflect the full dataset,
    // rather than only the current year.  It sums revenue, costs and expenses
    // regardless of date to provide a comprehensive view.

    // Compute sales-based revenue and profits rather than relying on invoice totals.
    const sales = allData.filter(item => item.type === 'sale');
    const inventory = calculateInventory();
    let totalRevenue = 0;
    let profitFromSales = 0;
    sales.forEach(sale => {
      const quantity = parseFloat(sale.quantity) || 0;
      // Compute revenue: use sale.total if defined; otherwise unit price * quantity
      let revenue;
      if (typeof sale.total !== 'undefined' && !isNaN(parseFloat(sale.total))) {
        revenue = parseFloat(sale.total);
      } else {
        const unitPriceTmp = parseFloat(sale.price);
        const unitPrice = (!isNaN(unitPriceTmp) ? unitPriceTmp : 0);
        revenue = unitPrice * quantity;
      }
      totalRevenue += revenue;
      // Determine unit price for profit calculation. If price is undefined, derive from total/quantity
      let unitPriceForProfit;
      const priceVal = parseFloat(sale.price);
      if (!isNaN(priceVal) && priceVal !== 0) {
        unitPriceForProfit = priceVal;
      } else if (typeof sale.total !== 'undefined' && !isNaN(parseFloat(sale.total)) && quantity !== 0) {
        unitPriceForProfit = parseFloat(sale.total) / quantity;
      } else {
        unitPriceForProfit = 0;
      }
      // Prefer using the purchase price recorded on the sale record (if available) for profit calculations.
      // Falling back to the latest purchase price from inventory ensures backward compatibility with
      // older records that do not have a purchase_price field.
      let purchasePrice;
      if (typeof sale.purchase_price !== 'undefined' && !isNaN(parseFloat(sale.purchase_price))) {
        purchasePrice = parseFloat(sale.purchase_price);
      } else {
        purchasePrice = (inventory[sale.product_code] && inventory[sale.product_code].purchasePrice) || 0;
      }
      profitFromSales += (unitPriceForProfit - purchasePrice) * quantity;
    });

    // Sum the total cost of purchases for display (supply cost)
    const purchases = allData.filter(item => item.type === 'purchase');
    const totalPurchasesCost = purchases.reduce((sum, purchase) => sum + (purchase.total || 0), 0);

    // Sum expenses recorded in the accounting module (ุงููุฏููุนุงุช ูุงููุตุฑููุงุช ุงูุฃุฎุฑู)
    const expenses = allData.filter(item => item.type === 'expense');
    const totalExpenses = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);

    /*
     * Combine purchase costs with other expenses for the purpose of the
     * "ุฅุฌูุงูู ุงููุตุฑููุงุช" card.  Many users expect ุฃู ุชูููุฉ ุงููุดุชุฑูุงุช
     * ุชุนุชุจุฑ ุฌุฒุกูุง ูู ุงููุตุฑููุงุช ุงูุฅุฌูุงููุฉ ูุฃููุง ุชูุซู ุชุฏููุงุช ููุฏูุฉ ุฎุงุฑุฌุฉ ูู
     * ุงูููุฒุงููุฉ.  ูุฐูู ูุญุณุจ ุฅุฌูุงูู ุงููุตุฑููุงุช ุนูู ุงููุญู ุงูุชุงูู:
     *   ุงููุตุฑููุงุช (expenses) + ุชูููุฉ ุงููุดุชุฑูุงุช (purchase costs)
     * ููุนุฑุถ ูุฐุง ุงููุฌููุน ูู ุจุทุงูุฉ ุงููุตุฑููุงุช.  ูุจูู ุฅุฌูุงูู ุชูููุฉ ุงููุดุชุฑูุงุช
     * ูุนุฑูุถูุง ูู ุจุทุงูุชู ุงููููุตูุฉ ููุฒูุฏ ูู ุงูุดูุงููุฉ.
     */
    const combinedExpenses = totalExpenses + totalPurchasesCost;

    // Profit is derived solely from sales minus the cost of goods sold.  We do not
    // subtract accounting expenses here so that the profit reflects the margin on
    // sales.  Expenses are displayed separately in their own card and tables.
    // Prevent negative profits due to discounting; clamp at zero
    const totalProfits = Math.max(0, profitFromSales);

    // Update display values
    const profitsEl = document.getElementById('total-profits');
    const revenueEl = document.getElementById('total-revenue');
    const expensesEl = document.getElementById('total-expenses');
    const purchasesEl = document.getElementById('total-purchases-cost');
    if (profitsEl) {
      profitsEl.textContent = totalProfits.toFixed(2) + ' ุฌ.ู';
    }
    if (revenueEl) {
      revenueEl.textContent = totalRevenue.toFixed(2) + ' ุฌ.ู';
    }
    // Display the combined expenses (expenses + purchases) in the expenses card
    if (expensesEl) {
      expensesEl.textContent = combinedExpenses.toFixed(2) + ' ุฌ.ู';
    }
    // Display the standalone total purchase cost in its own card
    if (purchasesEl) {
      purchasesEl.textContent = totalPurchasesCost.toFixed(2) + ' ุฌ.ู';
    }
  }
  
  function updateMonthlyAccounting() {
    const currentYear = new Date().getFullYear();
    const monthNames = [
      'ููุงูุฑ', 'ูุจุฑุงูุฑ', 'ูุงุฑุณ', 'ุฃุจุฑูู', 'ูุงูู', 'ููููู',
      'ููููู', 'ุฃุบุณุทุณ', 'ุณุจุชูุจุฑ', 'ุฃูุชูุจุฑ', 'ููููุจุฑ', 'ุฏูุณูุจุฑ'
    ];
    
    // Group data by month
    const monthlyData = {};
    
    for (let month = 0; month < 12; month++) {
      const monthKey = `${currentYear}-${month.toString().padStart(2, '0')}`;
      monthlyData[monthKey] = {
        name: monthNames[month],
        sales: 0,
        purchaseCosts: 0,
        expenses: 0,
        profit: 0
      };
    }
    
    // Compute monthly revenue, cost of goods sold and expenses using sale and expense records
    const salesRecords = allData.filter(item => item.type === 'sale');
    const inventoryMap = calculateInventory();
    salesRecords.forEach(sale => {
      const date = new Date(sale.date);
      if (date.getFullYear() !== currentYear) return;
      const monthKey = `${date.getFullYear()}-${date.getMonth().toString().padStart(2, '0')}`;
      if (!monthlyData[monthKey]) return;
      const quantity = parseFloat(sale.quantity) || 0;
      // Use sale.total if available to compute revenue; fall back to unit price * quantity
      let revenue;
      if (typeof sale.total !== 'undefined' && !isNaN(parseFloat(sale.total))) {
        revenue = parseFloat(sale.total);
      } else {
        const unitPriceTmp = parseFloat(sale.price);
        const unitPrice = (!isNaN(unitPriceTmp) ? unitPriceTmp : 0);
        revenue = unitPrice * quantity;
      }
      // Prefer the purchase price recorded on the sale record; fallback to inventory purchase price
      let purchasePrice;
      if (typeof sale.purchase_price !== 'undefined' && !isNaN(parseFloat(sale.purchase_price))) {
        purchasePrice = parseFloat(sale.purchase_price);
      } else {
        purchasePrice = (inventoryMap[sale.product_code] && inventoryMap[sale.product_code].purchasePrice) || 0;
      }
      const cost = purchasePrice * quantity;
      monthlyData[monthKey].sales += revenue;
      monthlyData[monthKey].purchaseCosts += cost;
    });
    // Sum expenses by month
    const expenseRecords = allData.filter(item => item.type === 'expense' && new Date(item.date).getFullYear() === currentYear);
    expenseRecords.forEach(expense => {
      const date = new Date(expense.date);
      const monthKey = `${date.getFullYear()}-${date.getMonth().toString().padStart(2, '0')}`;
      if (monthlyData[monthKey]) {
        monthlyData[monthKey].expenses += (expense.amount || 0);
      }
    });
    // Compute profit for each month based solely on sales minus cost of goods sold.  We exclude
    // other expenses from this calculation so that the profit reflects the margin on
    // sales only.  Expenses are displayed separately in the table.
    Object.keys(monthlyData).forEach(key => {
      const data = monthlyData[key];
      data.profit = Math.max(0, data.sales - data.purchaseCosts);
    });
    
    // Update monthly profits table
    const monthlyProfitsTable = document.getElementById('monthly-profits-table');
    const monthlyExpensesTable = document.getElementById('monthly-expenses-table');
    
    const monthlyDataArray = Object.values(monthlyData).filter(data => 
      data.sales > 0 || data.purchaseCosts > 0 || data.expenses > 0
    );
    
    if (monthlyDataArray.length === 0) {
      monthlyProfitsTable.innerHTML = '<tr><td colspan="4" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุฑุจุงุญ ุดูุฑูุฉ</td></tr>';
      monthlyExpensesTable.innerHTML = '<tr><td colspan="4" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุตุฑููุงุช ุดูุฑูุฉ</td></tr>';
      return;
    }
    
    monthlyProfitsTable.innerHTML = monthlyDataArray.map(data => `
      <tr class="hover:bg-green-50">
        <td class="border border-gray-300 p-3 font-medium">${data.name}</td>
        <td class="border border-gray-300 p-3 text-blue-600 font-bold">${data.sales.toFixed(2)} ุฌ.ู</td>
        <td class="border border-gray-300 p-3 text-red-600">${(data.purchaseCosts + data.expenses).toFixed(2)} ุฌ.ู</td>
        <td class="border border-gray-300 p-3 font-bold ${data.profit >= 0 ? 'text-green-600' : 'text-red-600'}">${data.profit.toFixed(2)} ุฌ.ู</td>
      </tr>
    `).join('');
    
    monthlyExpensesTable.innerHTML = monthlyDataArray.map(data => `
      <tr class="hover:bg-red-50">
        <td class="border border-gray-300 p-3 font-medium">${data.name}</td>
        <td class="border border-gray-300 p-3 text-red-600">${data.expenses.toFixed(2)} ุฌ.ู</td>
        <td class="border border-gray-300 p-3 text-purple-600">${data.purchaseCosts.toFixed(2)} ุฌ.ู</td>
        <td class="border border-gray-300 p-3 font-bold text-red-600">${(data.expenses + data.purchaseCosts).toFixed(2)} ุฌ.ู</td>
      </tr>
    `).join('');
  }
  
  function updateYearlyAccounting() {
    // Group data by year
    const yearlyData = {};
    
    // Aggregate yearly revenue, cost of goods sold and expenses using sale and expense records
    const salesRecords = allData.filter(item => item.type === 'sale');
    const inventoryMap = calculateInventory();
    salesRecords.forEach(sale => {
      const year = new Date(sale.date).getFullYear();
      if (!yearlyData[year]) {
        yearlyData[year] = { sales: 0, purchaseCosts: 0, expenses: 0 };
      }
      const quantity = parseFloat(sale.quantity) || 0;
      // Determine revenue: prefer total field if available; otherwise price * quantity
      let revenue;
      if (typeof sale.total !== 'undefined' && !isNaN(parseFloat(sale.total))) {
        revenue = parseFloat(sale.total);
      } else {
        const unitPriceTmp = parseFloat(sale.price);
        const unitPrice = (!isNaN(unitPriceTmp) ? unitPriceTmp : 0);
        revenue = unitPrice * quantity;
      }
      // Prefer the purchase price recorded on the sale record; fallback to inventory purchase price
      let purchasePrice;
      if (typeof sale.purchase_price !== 'undefined' && !isNaN(parseFloat(sale.purchase_price))) {
        purchasePrice = parseFloat(sale.purchase_price);
      } else {
        purchasePrice = (inventoryMap[sale.product_code] && inventoryMap[sale.product_code].purchasePrice) || 0;
      }
      const cost = purchasePrice * quantity;
      yearlyData[year].sales += revenue;
      yearlyData[year].purchaseCosts += cost;
    });
    // Add expenses per year
    const expenseRecords = allData.filter(item => item.type === 'expense');
    expenseRecords.forEach(expense => {
      const year = new Date(expense.date).getFullYear();
      if (!yearlyData[year]) {
        yearlyData[year] = { sales: 0, purchaseCosts: 0, expenses: 0 };
      }
      yearlyData[year].expenses += (expense.amount || 0);
    });
    
    const yearlyProfitsTable = document.getElementById('yearly-profits-table');
    const yearlyExpensesTable = document.getElementById('yearly-expenses-table');
    
    const years = Object.keys(yearlyData).sort((a, b) => b - a);
    
    if (years.length === 0) {
      yearlyProfitsTable.innerHTML = '<tr><td colspan="5" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุฑุจุงุญ ุณูููุฉ</td></tr>';
      yearlyExpensesTable.innerHTML = '<tr><td colspan="4" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุตุฑููุงุช ุณูููุฉ</td></tr>';
      return;
    }
    
    yearlyProfitsTable.innerHTML = years.map(year => {
      const data = yearlyData[year];
      // Compute total costs (purchase costs + other expenses) for display purposes
      const totalCosts = data.purchaseCosts + data.expenses;
      // We compute profits based solely on sales minus purchase costs.  Expenses are
      // displayed separately and do not affect the profit figure.  This provides
      // a clearer view of sales margin for the year.
      const netProfit = Math.max(0, data.sales - data.purchaseCosts);
      const profitMargin = data.sales > 0 ? ((netProfit / data.sales) * 100) : 0;
      
      return `
        <tr class="hover:bg-green-50">
          <td class="border border-gray-300 p-3 font-bold text-blue-600">${year}</td>
          <td class="border border-gray-300 p-3 text-blue-600 font-bold">${data.sales.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-3 text-red-600">${totalCosts.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-3 font-bold ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">${netProfit.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-3 font-bold ${profitMargin >= 0 ? 'text-green-600' : 'text-red-600'}">${profitMargin.toFixed(1)}%</td>
        </tr>
      `;
    }).join('');
    
    yearlyExpensesTable.innerHTML = years.map(year => {
      const data = yearlyData[year];
      const totalExpenses = data.expenses + data.purchaseCosts;
      
      return `
        <tr class="hover:bg-red-50">
          <td class="border border-gray-300 p-3 font-bold text-blue-600">${year}</td>
          <td class="border border-gray-300 p-3 text-red-600">${data.expenses.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-3 text-purple-600">${data.purchaseCosts.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-3 font-bold text-red-600">${totalExpenses.toFixed(2)} ุฌ.ู</td>
        </tr>
      `;
    }).join('');
    
    // Update yearly summary
    const currentYear = new Date().getFullYear();
    const currentYearData = yearlyData[currentYear] || { sales: 0, purchaseCosts: 0, expenses: 0 };
    const yearlyNetProfit = currentYearData.sales - currentYearData.purchaseCosts - currentYearData.expenses;
    const yearlyProfitMargin = currentYearData.sales > 0 ? ((yearlyNetProfit / currentYearData.sales) * 100) : 0;
    // ROI is based on the cost of goods sold (purchaseCosts) rather than the entire purchases total
    const yearlyROI = currentYearData.purchaseCosts > 0 ? ((yearlyNetProfit / currentYearData.purchaseCosts) * 100) : 0;
    
    document.getElementById('yearly-net-profit').textContent = yearlyNetProfit.toFixed(2) + ' ุฌ.ู';
    document.getElementById('yearly-profit-margin').textContent = yearlyProfitMargin.toFixed(1) + '%';
    document.getElementById('yearly-roi').textContent = yearlyROI.toFixed(1) + '%';
  }
  
  function updateExpensesDetails() {
    const expenses = allData.filter(item => item.type === 'expense');
    const tbody = document.getElementById('expenses-details-table');
    
    if (expenses.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุตุฑููุงุช ูุณุฌูุฉ</td></tr>';
      return;
    }
    
    // Sort expenses by date (newest first)
    expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    tbody.innerHTML = expenses.map(expense => `
      <tr class="hover:bg-gray-50">
        <td class="border border-gray-300 p-3">${new Date(expense.date).toLocaleDateString('ar-EG')}</td>
        <td class="border border-gray-300 p-3 font-medium">${expense.expense_type}</td>
        <td class="border border-gray-300 p-3 font-bold text-red-600">${expense.amount.toFixed(2)} ุฌ.ู</td>
        <td class="border border-gray-300 p-3 text-gray-600">${expense.description || '-'}</td>
        <td class="border border-gray-300 p-3 text-gray-600">${expense.created_by || 'ุบูุฑ ูุญุฏุฏ'}</td>
        <td class="border border-gray-300 p-3">
          <button onclick="deleteExpense('${expense.id}')" 
                  class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
            ๐๏ธ ุญุฐู
          </button>
        </td>
      </tr>
    `).join('');
    
    // Update expenses list as well
    updateExpensesList();
  }
  
  // Expenses List Management
  let filteredExpenses = [];
  let currentExpensesPage = 1;
  let expensesPerPage = 25;
  let expensesSortField = 'date';
  let expensesSortDirection = 'desc';
  
  function updateExpensesList() {
    const expenses = allData.filter(item => item.type === 'expense');
    
    // Update filter options
    updateExpensesFilterOptions(expenses);
    
    // Apply filters
    filteredExpenses = applyExpensesFilters(expenses);
    
    // Apply sorting
    sortExpensesData();
    
    // Update statistics
    updateExpensesStatistics();
    
    // Update table
    updateExpensesTable();
    
    // Update pagination
    updateExpensesListPagination();
  }
  
  function updateExpensesFilterOptions(expenses) {
    // Update created by filter
    const createdByFilter = document.getElementById('filter-created-by');
    const creators = [...new Set(expenses.map(e => e.created_by).filter(c => c))];
    
    createdByFilter.innerHTML = '<option value="">ุฌููุน ุงููุณุชุฎุฏููู</option>';
    creators.forEach(creator => {
      const option = document.createElement('option');
      option.value = creator;
      option.textContent = creator;
      createdByFilter.appendChild(option);
    });
  }
  
  function applyExpensesFilters(expenses) {
    const typeFilter = document.getElementById('filter-expense-type').value;
    const dateFromFilter = document.getElementById('filter-date-from').value;
    const dateToFilter = document.getElementById('filter-date-to').value;
    const createdByFilter = document.getElementById('filter-created-by').value;
    
    return expenses.filter(expense => {
      // Type filter
      if (typeFilter && expense.expense_type !== typeFilter) return false;
      
      // Date range filter
      const expenseDate = new Date(expense.date).toDateString();
      if (dateFromFilter && new Date(expenseDate) < new Date(dateFromFilter)) return false;
      if (dateToFilter && new Date(expenseDate) > new Date(dateToFilter)) return false;
      
      // Created by filter
      if (createdByFilter && expense.created_by !== createdByFilter) return false;
      
      return true;
    });
  }
  
  function sortExpensesData() {
    filteredExpenses.sort((a, b) => {
      let aValue = a[expensesSortField];
      let bValue = b[expensesSortField];
      
      // Handle date sorting
      if (expensesSortField === 'date') {
        aValue = new Date(aValue);
        bValue = new Date(bValue);
      }
      
      // Handle amount sorting
      if (expensesSortField === 'amount') {
        aValue = parseFloat(aValue);
        bValue = parseFloat(bValue);
      }
      
      // Handle string sorting
      if (typeof aValue === 'string') {
        aValue = aValue.toLowerCase();
        bValue = bValue.toLowerCase();
      }
      
      if (expensesSortDirection === 'asc') {
        return aValue > bValue ? 1 : -1;
      } else {
        return aValue < bValue ? 1 : -1;
      }
    });
  }
  
  function updateExpensesStatistics() {
    const totalCount = allData.filter(item => item.type === 'expense').length;
    const filteredCount = filteredExpenses.length;
    
    document.getElementById('total-expenses-count').textContent = totalCount;
    document.getElementById('filtered-expenses-count').textContent = filteredCount;
    
    if (filteredCount === 0) {
      document.getElementById('filtered-total-amount').textContent = '0.00';
      document.getElementById('filtered-avg-amount').textContent = '0.00';
      document.getElementById('filtered-highest-amount').textContent = '0.00';
      document.getElementById('filtered-lowest-amount').textContent = '0.00';
      return;
    }
    
    const amounts = filteredExpenses.map(e => e.amount);
    const totalAmount = amounts.reduce((sum, amount) => sum + amount, 0);
    const avgAmount = totalAmount / filteredCount;
    const highestAmount = Math.max(...amounts);
    const lowestAmount = Math.min(...amounts);
    
    document.getElementById('filtered-total-amount').textContent = totalAmount.toFixed(2);
    document.getElementById('filtered-avg-amount').textContent = avgAmount.toFixed(2);
    document.getElementById('filtered-highest-amount').textContent = highestAmount.toFixed(2);
    document.getElementById('filtered-lowest-amount').textContent = lowestAmount.toFixed(2);
  }
  
  function updateExpensesTable() {
    const tbody = document.getElementById('expenses-list-table');
    
    if (filteredExpenses.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุตุฑููุงุช ุชุทุงุจู ุงูููุงุชุฑ ุงููุญุฏุฏุฉ</td></tr>';
      return;
    }
    
    // Calculate pagination
    const startIndex = (currentExpensesPage - 1) * expensesPerPage;
    const endIndex = expensesPerPage === 'all' ? filteredExpenses.length : startIndex + parseInt(expensesPerPage);
    const pageExpenses = filteredExpenses.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageExpenses.map(expense => {
      const expenseTypeIcon = getExpenseTypeIcon(expense.expense_type);
      
      return `
        <tr class="hover:bg-gray-50">
          <td class="border border-gray-300 p-3">
            <div class="font-medium">${new Date(expense.date).toLocaleDateString('ar-EG')}</div>
            <div class="text-xs text-gray-500">${new Date(expense.date).toLocaleTimeString('ar-EG')}</div>
          </td>
          <td class="border border-gray-300 p-3">
            <div class="flex items-center gap-2">
              <span class="text-lg">${expenseTypeIcon}</span>
              <span class="font-medium">${expense.expense_type}</span>
            </div>
          </td>
          <td class="border border-gray-300 p-3 font-bold text-red-600 text-center">
            ${expense.amount.toFixed(2)} ุฌ.ู
          </td>
          <td class="border border-gray-300 p-3 text-gray-600 max-w-xs">
            <div class="truncate" title="${expense.description || 'ูุง ููุฌุฏ ูุตู'}">
              ${expense.description || '-'}
            </div>
          </td>
          <td class="border border-gray-300 p-3 text-gray-600">
            <div class="flex items-center gap-1">
              <span class="text-sm">๐ค</span>
              <span class="text-sm">${expense.created_by || 'ุบูุฑ ูุญุฏุฏ'}</span>
            </div>
          </td>
          <td class="border border-gray-300 p-3">
            <div class="flex gap-2">
              <button onclick="viewExpenseDetails('${expense.id}')" 
                      class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs">
                ๐๏ธ ุนุฑุถ
              </button>
              <button onclick="deleteExpense('${expense.id}')" 
                      class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                ๐๏ธ ุญุฐู
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }
  
  function getExpenseTypeIcon(expenseType) {
    const icons = {
      'ุฅูุฌุงุฑ': '๐ข',
      'ููุฑุจุงุก': 'โก',
      'ููุงู': '๐ง',
      'ุฑูุงุชุจ': '๐ฐ',
      'ุตูุงูุฉ': '๐ง',
      'ูููุฏ': 'โฝ',
      'ุชุณููู': '๐ข',
      'ูุตุฑููุงุช ุฅุฏุงุฑูุฉ': '๐',
      'ููุงุฏ ุฎุงู': '๐ฆ',
      'ุดุญู ูุชูุตูู': '๐',
      'ุงุชุตุงูุงุช ูุฅูุชุฑูุช': '๐',
      'ุชุฃูููุงุช': '๐ก๏ธ',
      'ุถุฑุงุฆุจ ูุฑุณูู': '๐',
      'ุฃุฎุฑู': 'โ'
    };
    return icons[expenseType] || '๐ธ';
  }
  
  function updateExpensesListPagination() {
    const totalPages = expensesPerPage === 'all' ? 1 : Math.ceil(filteredExpenses.length / parseInt(expensesPerPage));
    
    document.getElementById('page-info').textContent = `ุตูุญุฉ ${currentExpensesPage} ูู ${totalPages}`;
    
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    
    prevBtn.disabled = currentExpensesPage <= 1;
    nextBtn.disabled = currentExpensesPage >= totalPages;
    
    if (prevBtn.disabled) {
      prevBtn.classList.add('bg-gray-300');
      prevBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
    } else {
      prevBtn.classList.remove('bg-gray-300');
      prevBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
    }
    
    if (nextBtn.disabled) {
      nextBtn.classList.add('bg-gray-300');
      nextBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
    } else {
      nextBtn.classList.remove('bg-gray-300');
      nextBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
    }
  }
  
  function filterExpensesList() {
    currentExpensesPage = 1;
    updateExpensesList();
  }
  
  function clearExpensesFilters() {
    document.getElementById('filter-expense-type').value = '';
    document.getElementById('filter-date-from').value = '';
    document.getElementById('filter-date-to').value = '';
    document.getElementById('filter-created-by').value = '';
    
    currentExpensesPage = 1;
    updateExpensesList();
    
    showMessage('๐ ุชู ูุณุญ ุฌููุน ุงูููุงุชุฑ', 'info');
  }
  
  function sortExpensesList(field) {
    if (expensesSortField === field) {
      expensesSortDirection = expensesSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      expensesSortField = field;
      expensesSortDirection = 'desc';
    }
    
    // Update sort icons
    document.querySelectorAll('[id^="sort-"][id$="-icon"]').forEach(icon => {
      icon.textContent = 'โ๏ธ';
    });
    
    const currentIcon = document.getElementById(`sort-${field}-icon`);
    if (currentIcon) {
      currentIcon.textContent = expensesSortDirection === 'asc' ? 'โ' : 'โ';
    }
    
    updateExpensesList();
  }
  
  function changeExpensesPage(direction) {
    const totalPages = expensesPerPage === 'all' ? 1 : Math.ceil(filteredExpenses.length / parseInt(expensesPerPage));
    
    currentExpensesPage += direction;
    
    if (currentExpensesPage < 1) currentExpensesPage = 1;
    if (currentExpensesPage > totalPages) currentExpensesPage = totalPages;
    
    updateExpensesTable();
    updateExpensesListPagination();
  }
  
  function updateExpensesListPagination() {
    const perPageSelect = document.getElementById('expenses-per-page');
    expensesPerPage = perPageSelect.value === 'all' ? 'all' : parseInt(perPageSelect.value);
    
    currentExpensesPage = 1;
    updateExpensesList();
  }
  
  function viewExpenseDetails(expenseId) {
    const expense = allData.find(item => item.id === expenseId && item.type === 'expense');
    if (!expense) {
      showMessage('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุตุฑูู', 'error');
      return;
    }
    
    const modalDiv = document.createElement('div');
    modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modalDiv.innerHTML = `
      <div class="bg-white rounded-lg max-w-2xl w-full max-h-full overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-2xl font-bold text-gray-800">๐ธ ุชูุงุตูู ุงููุตุฑูู</h2>
            <button onclick="this.closest('.fixed').remove()" 
                    class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
              โ
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <h3 class="font-semibold text-red-800 mb-3">ูุนูููุงุช ุงููุตุฑูู</h3>
              <div class="space-y-2 text-sm">
                <div><strong>ููุน ุงููุตุฑูู:</strong> ${getExpenseTypeIcon(expense.expense_type)} ${expense.expense_type}</div>
                <div><strong>ุงููุจูุบ:</strong> <span class="text-red-600 font-bold text-lg">${expense.amount.toFixed(2)} ุฌ.ู</span></div>
                <div><strong>ุงูุชุงุฑูุฎ:</strong> ${new Date(expense.date).toLocaleDateString('ar-EG')}</div>
                <div><strong>ุงูููุช:</strong> ${new Date(expense.date).toLocaleTimeString('ar-EG')}</div>
              </div>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
              <h3 class="font-semibold text-blue-800 mb-3">ูุนูููุงุช ุฅุถุงููุฉ</h3>
              <div class="space-y-2 text-sm">
                <div><strong>ุงูููุดุฆ:</strong> ${expense.created_by || 'ุบูุฑ ูุญุฏุฏ'}</div>
                <div><strong>ุงูุญุงูุฉ:</strong> <span class="text-green-600 font-bold">${expense.status || 'ููุชูู'}</span></div>
                <div><strong>ูุนุฑู ุงููุตุฑูู:</strong> <span class="font-mono text-xs">${expense.id}</span></div>
              </div>
            </div>
          </div>
          ${expense.description ? `
            <div class="mt-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
              <h3 class="font-semibold text-gray-800 mb-3">๐ ุงููุตู</h3>
              <p class="text-gray-700">${expense.description}</p>
            </div>
          ` : ''}
          <div class="flex gap-3 justify-end mt-6 border-t pt-4">
            <button onclick="deleteExpense('${expense.id}'); this.closest('.fixed').remove()" 
                    class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg">
              ๐๏ธ ุญุฐู ุงููุตุฑูู
            </button>
            <button onclick="this.closest('.fixed').remove()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
              โ ุฅุบูุงู
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modalDiv);
  }
  
  function exportExpensesToCSV() {
    if (filteredExpenses.length === 0) {
      showMessage('ูุง ุชูุฌุฏ ูุตุฑููุงุช ูุชุตุฏูุฑูุง', 'error');
      return;
    }
    
    const headers = ['ุงูุชุงุฑูุฎ', 'ููุน ุงููุตุฑูู', 'ุงููุจูุบ', 'ุงููุตู', 'ุงูููุดุฆ'];
    const csvContent = [
      headers.join(','),
      ...filteredExpenses.map(expense => [
        new Date(expense.date).toLocaleDateString('ar-EG'),
        expense.expense_type,
        expense.amount.toFixed(2),
        expense.description || '',
        expense.created_by || ''
      ].join(','))
    ].join('\n');
    
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `expenses_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showMessage(`โ ุชู ุชุตุฏูุฑ ${filteredExpenses.length} ูุตุฑูู ุฅูู ููู CSV`, 'success');
  }
  
  function printExpensesList() {
    if (filteredExpenses.length === 0) {
      showMessage('ูุง ุชูุฌุฏ ูุตุฑููุงุช ููุทุจุงุนุฉ', 'error');
      return;
    }
    
    const totalAmount = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
    
    const printContent = `
      <div style="font-family: Arial, sans-serif; direction: rtl; padding: 20px;">
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin: 0;">Solution ERP</h1>
          <h2 style="color: #374151; margin: 10px 0;">ูุงุฆูุฉ ุงููุตุฑููุงุช</h2>
          <p style="margin: 5px 0;">ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${new Date().toLocaleDateString('ar-EG')}</p>
          <p style="margin: 5px 0;">ุนุฏุฏ ุงููุตุฑููุงุช: ${filteredExpenses.length}</p>
          <p style="margin: 5px 0; font-weight: bold; color: #dc2626;">ุฅุฌูุงูู ุงููุจูุบ: ${totalAmount.toFixed(2)} ุฌ.ู</p>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
          <thead>
            <tr style="background-color: #e5e7eb;">
              <th style="border: 1px solid #d1d5db; padding: 12px; text-align: right;">ุงูุชุงุฑูุฎ</th>
              <th style="border: 1px solid #d1d5db; padding: 12px; text-align: right;">ููุน ุงููุตุฑูู</th>
              <th style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">ุงููุจูุบ</th>
              <th style="border: 1px solid #d1d5db; padding: 12px; text-align: right;">ุงููุตู</th>
              <th style="border: 1px solid #d1d5db; padding: 12px; text-align: right;">ุงูููุดุฆ</th>
            </tr>
          </thead>
          <tbody>
            ${filteredExpenses.map(expense => `
              <tr>
                <td style="border: 1px solid #d1d5db; padding: 10px;">${new Date(expense.date).toLocaleDateString('ar-EG')}</td>
                <td style="border: 1px solid #d1d5db; padding: 10px;">${expense.expense_type}</td>
                <td style="border: 1px solid #d1d5db; padding: 10px; text-align: center; font-weight: bold; color: #dc2626;">${expense.amount.toFixed(2)} ุฌ.ู</td>
                <td style="border: 1px solid #d1d5db; padding: 10px;">${expense.description || '-'}</td>
                <td style="border: 1px solid #d1d5db; padding: 10px;">${expense.created_by || 'ุบูุฑ ูุญุฏุฏ'}</td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr style="background-color: #f9fafb;">
              <td colspan="2" style="border: 1px solid #d1d5db; padding: 12px; text-align: right; font-weight: bold;">ุงูุฅุฌูุงูู:</td>
              <td style="border: 1px solid #d1d5db; padding: 12px; text-align: center; font-weight: bold; font-size: 18px; color: #dc2626;">${totalAmount.toFixed(2)} ุฌ.ู</td>
              <td colspan="2" style="border: 1px solid #d1d5db; padding: 12px;"></td>
            </tr>
          </tfoot>
        </table>
        <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #d1d5db; color: #6b7280;">
          <p style="margin: 5px 0;">Solution ERP - ูุธุงู ุฅุฏุงุฑุฉ ุงูุฃุนูุงู ุงููุชูุงูู</p>
        </div>
      </div>
    `;
    
    document.getElementById('print-content').innerHTML = printContent;
    window.print();
  }
  
  // Update all displays
  function updateAllDisplays() {
    // Sequentially update each section of the UI.  Wrap each call in a
    // try/catch so that a failure in one section does not prevent
    // subsequent sections from rendering.  Log errors to the console
    // for easier debugging.
    // Build the custom expenses list from allData before updating displays.
    // Without this, expenses saved in Firebase would not repopulate the
    // custom expenses table after a refresh.  Wrap in try/catch to avoid
    // aborting display updates if the helper is undefined.
    try {
      if (typeof initializeCustomExpenses === 'function') {
        initializeCustomExpenses();
      }
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชููุฆุฉ ูุงุฆูุฉ ุงููุตุฑููุงุช ุงููุฎุตุตุฉ:', err);
    }

    const displayFunctions = [
      updatePurchasesDisplay,
      updateInventoryDisplay,
      updateEmployeesDisplay,
      updateInvoicesDisplay,
      updateCustomersDisplay,
      updateAccountsDisplay,
      updateDiscountsDisplay,
      updateAccountingDisplay,
      updateReturnsDisplay,
      // ุชุญุฏูุซ ุฌุฏุงูู ุฌูุณุงุช ุงูุฏุฎูู ูุงููุดุทูู
      updateLoginSessionsDisplay
    ];
    displayFunctions.forEach(fn => {
      try {
        if (typeof fn === 'function') {
          fn();
        }
      } catch (err) {
        console.error('โ๏ธ ุฎุทุฃ ูู ุชุญุฏูุซ ุงููุณู ' + (fn && fn.name ? fn.name : 'ูุฌููู') + ':', err);
      }
    });

    // After updating the standard sections, refresh the user sales selector and
    // its display.  Without this, the list of users or the summary numbers
    // may become stale after creating new accounts or saving new invoices,
    // returns or discounts.  We wrap this in a try/catch to ensure
    // that errors here don't block other updates.
    try {
      const selectorEl = document.getElementById('user-sales-selector');
      if (selectorEl) {
        const previousSelection = selectorEl.value;
        // Repopulate the selector with the latest users; this also clears
        // existing options.  The function gracefully handles missing users.
        populateUserSalesSelector();
        // Attempt to restore the previously selected value if it still
        // exists among the new options.  This prevents user selections
        // from resetting unexpectedly during data refreshes.
        const newSelector = document.getElementById('user-sales-selector');
        if (previousSelection && newSelector) {
          newSelector.value = previousSelection;
        }
        // Always update the user sales display using the current value of
        // the selector.  If no user is selected, the function will reset
        // the summaries and tables appropriately.
        updateUserSalesDisplay(newSelector ? newSelector.value : '');
      }
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ูุณู ูุจูุนุงุช ุงููุณุชุฎุฏู:', err);
    }
  }

  /**
   * Populate the user selector for the "ูุจูุนุงุช ุงููุณุชุฎุฏู" section.  This
   * function reads the global `users` object, extracts each user's full
   * name (or username if fullName is missing), de-duplicates the list, and
   * populates the dropdown.  A default option prompting the user to
   * choose a user is always added first.  Any errors are logged to
   * the console.
   */
  function populateUserSalesSelector() {
    try {
      const selector = document.getElementById('user-sales-selector');
      if (!selector) return;
      // Clear any existing options
      selector.innerHTML = '';
      // Add a default placeholder option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'ุงุฎุชุฑ ูุณุชุฎุฏู';
      selector.appendChild(defaultOption);
      // Collect unique user names from the users object
      const userEntries = Object.values(users || {});
      const names = userEntries.map(u => u.fullName || u.username).filter(n => n && n.trim() !== '');
      const uniqueNames = Array.from(new Set(names));
      uniqueNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        selector.appendChild(opt);
      });
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ูุงุฆูุฉ ุงููุณุชุฎุฏููู ููุณู ูุจูุนุงุช ุงููุณุชุฎุฏู:', err);
    }
  }

  /**
   * Update the display of user sales for the selected user.  This function
   * filters invoices, returns and discount records in `allData` by the
   * selected user's name and populates the summary cards and tables.
   * If no user is selected (empty string), the tables show a prompt
   * instructing the user to select a user.
   */
  function updateUserSalesDisplay(userName) {
    try {
      // Summary elements
      const totalSalesEl = document.getElementById('user-sales-total-sales');
      const invoiceCountEl = document.getElementById('user-sales-invoice-count');
      const returnsCountEl = document.getElementById('user-sales-returns-count');
      const discountsTotalEl = document.getElementById('user-sales-discounts-total');
      const invoicesTbody = document.getElementById('user-sales-invoices-table');
      const returnsTbody = document.getElementById('user-sales-returns-table');
      const discountsTbody = document.getElementById('user-sales-discounts-table');
      if (!userName) {
        // Reset summaries
        if (totalSalesEl) totalSalesEl.textContent = '0.00 ุฌ.ู';
        if (invoiceCountEl) invoiceCountEl.textContent = '0';
        if (returnsCountEl) returnsCountEl.textContent = '0';
        if (discountsTotalEl) discountsTotalEl.textContent = '0.00 ุฌ.ู';
        // Reset tables with prompt
        if (invoicesTbody) invoicesTbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">ุงุฎุชุฑ ูุณุชุฎุฏู ูุนุฑุถ ุงูููุงุชูุฑ</td></tr>';
        if (returnsTbody) returnsTbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 p-4">ุงุฎุชุฑ ูุณุชุฎุฏู ูุนุฑุถ ุงููุฑุชุฌุนุงุช</td></tr>';
        if (discountsTbody) discountsTbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 p-4">ุงุฎุชุฑ ูุณุชุฎุฏู ูุนุฑุถ ุงูุฎุตููุงุช</td></tr>';
        return;
      }
      // Filter invoice records by creator_name
      const invoices = allData.filter(item => item.type === 'invoice' && item.creator_name === userName);
      const returns = allData.filter(item => item.type === 'return' && item.returned_by_name === userName);
      const discounts = allData.filter(item => item.type === 'discount' && item.creator_name === userName);
      // Compute summary metrics
      const totalSales = invoices.reduce((sum, inv) => sum + (parseFloat(inv.total) || 0), 0);
      const invoiceCount = invoices.length;
      const returnsCount = returns.length;
      const discountsTotal = discounts.reduce((sum, disc) => sum + (parseFloat(disc.total_discount) || 0), 0);
      if (totalSalesEl) totalSalesEl.textContent = totalSales.toFixed(2) + ' ุฌ.ู';
      if (invoiceCountEl) invoiceCountEl.textContent = invoiceCount;
      if (returnsCountEl) returnsCountEl.textContent = returnsCount;
      if (discountsTotalEl) discountsTotalEl.textContent = discountsTotal.toFixed(2) + ' ุฌ.ู';
      // Populate invoices table
      if (invoicesTbody) {
        if (invoices.length === 0) {
          invoicesTbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">ูุง ุชูุฌุฏ ููุงุชูุฑ ููุฐุง ุงููุณุชุฎุฏู</td></tr>';
        } else {
          invoicesTbody.innerHTML = invoices.map(inv => {
            const dateStr = new Date(inv.date).toLocaleDateString('ar-EG');
            return `
              <tr class="hover:bg-green-50">
                <td class="border border-gray-300 p-2">${inv.invoice_number}</td>
                <td class="border border-gray-300 p-2">${dateStr}</td>
                <td class="border border-gray-300 p-2">${inv.customer_name || ''}</td>
                <td class="border border-gray-300 p-2">${(inv.total || 0).toFixed(2)} ุฌ.ู</td>
                <td class="border border-gray-300 p-2">${(inv.payment_amount != null ? inv.payment_amount : 0).toFixed(2)} ุฌ.ู</td>
                <td class="border border-gray-300 p-2">${(inv.remaining_amount != null ? inv.remaining_amount : 0).toFixed(2)} ุฌ.ู</td>
              </tr>
            `;
          }).join('');
        }
      }
      // Populate returns table
      if (returnsTbody) {
        if (returns.length === 0) {
          returnsTbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 p-4">ูุง ุชูุฌุฏ ูุฑุชุฌุนุงุช ููุฐุง ุงููุณุชุฎุฏู</td></tr>';
        } else {
          returnsTbody.innerHTML = returns.map(ret => {
            const dateStr = new Date(ret.date).toLocaleDateString('ar-EG');
            return `
              <tr class="hover:bg-red-50">
                <td class="border border-gray-300 p-2">${dateStr}</td>
                <td class="border border-gray-300 p-2">${ret.product_code}</td>
                <td class="border border-gray-300 p-2">${ret.product_name}</td>
                <td class="border border-gray-300 p-2">${(parseFloat(ret.quantity) || 0)}</td>
                <td class="border border-gray-300 p-2">${ret.reason || ''}</td>
              </tr>
            `;
          }).join('');
        }
      }
      // Populate discounts table
      if (discountsTbody) {
        if (discounts.length === 0) {
          discountsTbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 p-4">ูุง ุชูุฌุฏ ุฎุตููุงุช ููุฐุง ุงููุณุชุฎุฏู</td></tr>';
        } else {
          discountsTbody.innerHTML = discounts.map(dis => {
            const dateStr = new Date(dis.date).toLocaleDateString('ar-EG');
            return `
              <tr class="hover:bg-purple-50">
                <td class="border border-gray-300 p-2">${dis.invoice_number || ''}</td>
                <td class="border border-gray-300 p-2">${dateStr}</td>
                <td class="border border-gray-300 p-2">${dis.product_name || ''}</td>
                <td class="border border-gray-300 p-2">${(parseFloat(dis.discount_amount) || 0).toFixed(2)} ุฌ.ู</td>
                <td class="border border-gray-300 p-2">${(parseFloat(dis.discount_percentage) || 0).toFixed(1)}%</td>
              </tr>
            `;
          }).join('');
        }
      }
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ูุจูุนุงุช ุงููุณุชุฎุฏู:', err);
    }
  }
  
  // Account management functions
  function addNewAccount() {
    const username = document.getElementById('new-username').value.trim();
    const password = document.getElementById('new-password').value.trim();
    const fullName = document.getElementById('new-fullname').value.trim();
    const role = document.getElementById('new-role').value;
    
    // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ูุน ุฑุณุงุฆู ูุงุถุญุฉ
    if (!username) {
      showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณุชุฎุฏู', 'error');
      return;
    }
    
    if (!password) {
      showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ', 'error');
      return;
    }
    
    if (password.length < 6) {
      showMessage('โ ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู', 'error');
      return;
    }
    
    if (!fullName) {
      showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ุงูุงุณู ุงููุงูู', 'error');
      return;
    }
    
    if (!role) {
      showMessage('โ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุฏูุฑ ุงููุธููู', 'error');
      return;
    }
    
    if (users[username]) {
      showMessage('โ ุงุณู ุงููุณุชุฎุฏู ููุฌูุฏ ุจุงููุนูุ ูุฑุฌู ุงุฎุชูุงุฑ ุงุณู ุขุฎุฑ', 'error');
      return;
    }
    
    // Get selected permissions
    const permissions = [];
    const permissionCheckboxes = [
      { id: 'perm-sales', value: 'sales' },
      { id: 'perm-purchases', value: 'purchases' },
      { id: 'perm-inventory', value: 'inventory' },
      { id: 'perm-employees', value: 'employees' },
      { id: 'perm-invoices', value: 'invoices' },
      { id: 'perm-customers', value: 'customers' },
      { id: 'perm-accounts', value: 'accounts' },
      { id: 'perm-discounts', value: 'discounts' },
      { id: 'perm-accounting', value: 'accounting' },
      { id: 'perm-returns', value: 'returns' },
      { id: 'perm-user-sales', value: 'user-sales' },
      // ุตูุงุญูุฉ ุงูุฅุนุฏุงุฏุงุช: ุชู ุฅุถุงูุชูุง ูุชุชูุงูู ูุน ุฃูุณุงู ุงููุธุงู
      { id: 'perm-settings', value: 'settings' }
    ];
    
    permissionCheckboxes.forEach(perm => {
      if (document.getElementById(perm.id).checked) {
        permissions.push(perm.value);
      }
    });
    
    if (permissions.length === 0) {
      showMessage('โ ูุฑุฌู ุงุฎุชูุงุฑ ุตูุงุญูุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู', 'error');
      return;
    }
    
    // Add accounts permission for admins only
    if (role === 'ูุฏูุฑ ุงููุธุงู') {
      // ุงููุฏูุฑ ุงููุธุงู ููุชูู ุตูุงุญูุฉ ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช ุจุดูู ุชููุงุฆู
      permissions.push('accounts');
    }
    
    // Create new user
    users[username] = {
      password: password,
      role: role,
      fullName: fullName,
      permissions: permissions,
      createdAt: new Date().toISOString().split('T')[0],
      status: 'ูุดุท'
    };
    
    // Save users to Firebase with pause/resume of autoโsync and reload only on success.
    // Use an async IIFE to allow awaiting inside this nonโasync function.
    (async () => {
      // Pause the autoโsync timer to prevent backgroundSync from reloading stale data
      const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
      if (wasAutoSyncActive) {
        clearInterval(window.autoSyncTimer);
        window.autoSyncTimer = null;
      }
      let saveSucceeded = false;
      try {
        await saveDataToFirebase();
        saveSucceeded = true;
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุญุณุงุจุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
      }
      // Reload from Firebase only if the save succeeded.  If the save fails,
      // retain local changes so they are not overwritten by stale cloud data.
      if (saveSucceeded) {
        try {
          await loadDataFromFirebase();
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุญูุธ ุงูุญุณุงุจ:', err);
        }
      }
      // Restore the autoโsync timer if it was previously active
      if (wasAutoSyncActive) {
        window.autoSyncTimer = setInterval(() => {
          Promise.resolve(backgroundSync());
        }, 5000);
      }
      // Clear the account form and update the accounts list after saving
      clearAccountForm();
      updateAccountsDisplay();
      showMessage(`โ ุชู ุฅูุดุงุก ุญุณุงุจ "${fullName}" ุจูุฌุงุญ!`, 'success');
    })();
  }
  
  function clearAccountForm() {
    document.getElementById('new-username').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('new-fullname').value = '';
    document.getElementById('new-role').value = '';
    
    // Clear all permission checkboxes
    const permissionCheckboxes = ['perm-sales', 'perm-purchases', 'perm-inventory', 'perm-employees', 'perm-invoices', 'perm-customers', 'perm-accounting'];
    permissionCheckboxes.forEach(id => {
      document.getElementById(id).checked = false;
    });
  }
  
  function toggleAccountStatus(username) {
    if (users[username]) {
      const oldStatus = users[username].status;
      users[username].status = users[username].status === 'ูุดุท' ? 'ูุนุทู' : 'ูุดุท';
      
      // Save users to Firebase with autoโsync pause/resume and reload only on success.
      (async () => {
        const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
        if (wasAutoSyncActive) {
          clearInterval(window.autoSyncTimer);
          window.autoSyncTimer = null;
        }
        let saveSucceeded = false;
        try {
          await saveDataToFirebase();
          saveSucceeded = true;
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุญุงูุฉ ุงูุญุณุงุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
        }
        if (saveSucceeded) {
          try {
            await loadDataFromFirebase();
          } catch (err) {
            console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุชุญุฏูุซ ุงูุญุงูุฉ:', err);
          }
        }
        if (wasAutoSyncActive) {
          window.autoSyncTimer = setInterval(() => {
            Promise.resolve(backgroundSync());
          }, 5000);
        }
        // Update the accounts display and show a success message
        updateAccountsDisplay();
        const action = users[username].status === 'ูุดุท' ? 'ุชูุนูู' : 'ุชุนุทูู';
        showMessage(`โ ุชู ${action} ุญุณุงุจ "${users[username].fullName}" ุจูุฌุงุญ`, 'success');
      })();
    }
  }
  
  function deleteAccount(username) {
    if (username === 'ibrahim' || username === currentUser.username) {
      return;
    }
    
    // Create confirmation UI instead of using confirm()
    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    confirmDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md">
        <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุงูุญุฐู</h3>
        <p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุญุณุงุจ "${users[username].fullName}"ุ</p>
        <div class="flex gap-3 justify-end">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
            ุฅูุบุงุก
          </button>
          <button onclick="confirmDeleteAccount('${username}'); this.parentElement.parentElement.parentElement.remove()" 
                  class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
            ุญุฐู
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  }

  /**
   * ูุชุญ ูุงูุฐุฉ ูุชุนุฏูู ุจูุงูุงุช ุญุณุงุจ ูุณุชุฎุฏู. ุฅุฐุง ูุงู ุงูุญุณุงุจ ุงููุฑุงุฏ ุชุนุฏููู ูู ุญุณุงุจ
   * ุงููุฏูุฑ (ุงููุณุชุฎุฏู ุงูุฑุฆูุณู)ุ ุณููุทูุจ ูู ุงููุณุชุฎุฏู ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ ยซ123456ยป
   * ููุณูุงุญ ุจุงูุชุนุฏูู. ุชูุนุฑุถ ูู ุงููููุฐุฌ ุญููู ูุชุนุฏูู ุงูุงุณู ุงููุงููุ ูููุฉ
   * ุงููุฑูุฑุ ุงูุฏูุฑ ุงููุธููู ูุงูุตูุงุญูุงุช. ุจุนุฏ ุงูููุฑ ุนูู ุฒุฑ ุงูุญูุธ ูุชู
   * ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ saveAccountChanges ูุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุงูุฐุงูุฑุฉ ููุงุนุฏุฉ
   * ุงูุจูุงูุงุช.
   *
   * @param {string} username ุงุณู ุงููุณุชุฎุฏู ุงูุฐู ุณูุชู ุชุนุฏูู ุญุณุงุจู
   */
function openEditAccountModal(username, skipAdminCheck = false) {
    const user = users[username];
    if (!user) {
      showMessage('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุญุณุงุจ ุงููุทููุจ', 'error');
      return;
    }
    // If the account is the primary admin, display a custom password modal instead of
    // using a browser prompt.  When the correct password is entered the modal will
    // call openEditAccountModal again with skipAdminCheck=true.
    if (username === 'ibrahim' && !skipAdminCheck) {
      showAdminPasswordModal(username);
      return;
    }
    // ุฅูุดุงุก ูุงูุฐุฉ ุงูุชุนุฏูู
    const modalDiv = document.createElement('div');
    modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    // ุชุญุถูุฑ ููู ุงูุตูุงุญูุงุช ููุชู ุชููุฆุฉ ูุฑุจุนุงุช ุงูุงุฎุชูุงุฑ
    const hasPerm = perm => user.permissions && user.permissions.includes(perm);
    modalDiv.innerHTML = `
      <div class="bg-white rounded-lg max-w-xl w-full max-h-full overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-2xl font-bold text-gray-800">โ๏ธ ุชุนุฏูู ุงูุญุณุงุจ</h2>
            <button onclick="this.closest('.fixed').remove()" 
                    class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
              โ
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงููุณุชุฎุฏู</label>
                <!-- Allow username to be edited.  Provide an id so saveAccountChanges can
                     read the updated value.  Do not disable the field. -->
                <input type="text" id="edit-account-username" value="${username}" class="w-full p-3 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุงุณู ุงููุงูู</label>
                <input type="text" id="edit-account-fullname" value="${user.fullName}" class="w-full p-3 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ</label>
                <input type="text" id="edit-account-password" value="${user.password}" class="w-full p-3 border rounded-lg">
              </div>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุฏูุฑ ุงููุธููู</label>
                <select id="edit-account-role" class="w-full p-3 border rounded-lg">
                  <!-- ุฃุถู ุฎูุงุฑ "ูุฏูุฑ ุงููุธุงู" ูุชุณููู ุชุนุฏูู ุญุณุงุจ ุงููุฏูุฑ ุงูุญุงูู -->
                  <option value="" ${!user.role ? 'selected' : ''}>ุงุฎุชุฑ ุงููุณูู ุงููุธููู</option>
                  <option value="ูุฏูุฑ ุงููุธุงู" ${user.role === 'ูุฏูุฑ ุงููุธุงู' ? 'selected' : ''}>ูุฏูุฑ ุงููุธุงู</option>
                  <option value="ูุฏูุฑ ุชูููุฐู" ${user.role === 'ูุฏูุฑ ุชูููุฐู' ? 'selected' : ''}>ูุฏูุฑ ุชูููุฐู</option>
                  <option value="ูุฏูุฑ ุนุงู" ${user.role === 'ูุฏูุฑ ุนุงู' ? 'selected' : ''}>ูุฏูุฑ ุนุงู</option>
                  <option value="ูุฏูุฑ ุชุณููู" ${user.role === 'ูุฏูุฑ ุชุณููู' ? 'selected' : ''}>ูุฏูุฑ ุชุณููู</option>
                  <option value="ูุฏูุฑ ูุดุชุฑูุงุช" ${user.role === 'ูุฏูุฑ ูุดุชุฑูุงุช' ? 'selected' : ''}>ูุฏูุฑ ูุดุชุฑูุงุช</option>
                  <option value="ูุฏูุฑ ูุจูุนุงุช" ${user.role === 'ูุฏูุฑ ูุจูุนุงุช' ? 'selected' : ''}>ูุฏูุฑ ูุจูุนุงุช</option>
                  <option value="ูุดุฑู" ${user.role === 'ูุดุฑู' ? 'selected' : ''}>ูุดุฑู</option>
                  <option value="ูุงุดูุฑ" ${user.role === 'ูุงุดูุฑ' ? 'selected' : ''}>ูุงุดูุฑ</option>
                  <option value="ูุณุฆูู ูุดุชุฑูุงุช" ${user.role === 'ูุณุฆูู ูุดุชุฑูุงุช' ? 'selected' : ''}>ูุณุฆูู ูุดุชุฑูุงุช</option>
                  <option value="ูุญุงุณุจ" ${user.role === 'ูุญุงุณุจ' ? 'selected' : ''}>ูุญุงุณุจ</option>
                  <option value="ุงููู ุฎุฒูุฉ" ${user.role === 'ุงููู ุฎุฒูุฉ' ? 'selected' : ''}>ุงููู ุฎุฒูุฉ</option>
                  <option value="ูุณุคู ุชุณููู" ${user.role === 'ูุณุคู ุชุณููู' ? 'selected' : ''}>ูุณุคู ุชุณููู</option>
                  <option value="ุงููู ูุฎุฒู" ${user.role === 'ุงููู ูุฎุฒู' ? 'selected' : ''}>ุงููู ูุฎุฒู</option>
                  <option value="ุจุงุฆุน" ${user.role === 'ุจุงุฆุน' ? 'selected' : ''}>ุจุงุฆุน</option>
                  <option value="ุณุงุฆู" ${user.role === 'ุณุงุฆู' ? 'selected' : ''}>ุณุงุฆู</option>
                </select>
              </div>
              <div>
                <h4 class="text-md font-semibold mb-2 text-gray-700">ุงูุตูุงุญูุงุช</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-sales" type="checkbox" ${hasPerm('sales') ? 'checked' : ''}>
                    <!-- ุงุณุชุฎุฏู ููุณ ุชุณููุฉ ุงููุณู ููุง ูู ุดุฑูุท ุงูุชููู -->
                    <span class="text-sm">๐ฐ ูุงุชูุฑุฉ ุงูุจูุน</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-purchases" type="checkbox" ${hasPerm('purchases') ? 'checked' : ''}>
                    <span class="text-sm">๐ ุงููุดุชุฑูุงุช</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-inventory" type="checkbox" ${hasPerm('inventory') ? 'checked' : ''}>
                    <span class="text-sm">๐ฆ ุงููุฎุฒูู</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-employees" type="checkbox" ${hasPerm('employees') ? 'checked' : ''}>
                    <span class="text-sm">๐ฅ ุงูููุธููู</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-invoices" type="checkbox" ${hasPerm('invoices') ? 'checked' : ''}>
                    <span class="text-sm">๐ ุงูููุงุชูุฑ</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-customers" type="checkbox" ${hasPerm('customers') ? 'checked' : ''}>
                    <span class="text-sm">๐ค ุงูุนููุงุก</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-accounts" type="checkbox" ${hasPerm('accounts') ? 'checked' : ''}>
                    <span class="text-sm">๐ ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-discounts" type="checkbox" ${hasPerm('discounts') ? 'checked' : ''}>
                    <span class="text-sm">๐ธ ุงูุฎุตููุงุช</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-accounting" type="checkbox" ${hasPerm('accounting') ? 'checked' : ''}>
                    <span class="text-sm">๐ ุงููุญุงุณุจุฉ</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-returns" type="checkbox" ${hasPerm('returns') ? 'checked' : ''}>
                    <span class="text-sm">๐ ุงููุฑุชุฌุนุงุช</span>
                  </label>

                  <!-- ุตูุงุญูุฉ ูุจูุนุงุช ุงููุณุชุฎุฏู ูู ุดุงุดุฉ ุชุนุฏูู ุงูุญุณุงุจ -->
                  <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                    <input class="rounded" id="edit-perm-user-sales" type="checkbox" ${hasPerm('user-sales') ? 'checked' : ''}>
                    <span class="text-sm">๐ค๐ผ ูุจูุนุงุช ุงููุณุชุฎุฏู</span>
                  </label>
                <!-- Permission for accessing the settings section -->
                <label class="flex items-center space-x-2 bg-white p-3 rounded border">
                  <input class="rounded" id="edit-perm-settings" type="checkbox" ${hasPerm('settings') ? 'checked' : ''}>
                  <span class="text-sm">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</span>
                </label>
                </div>
              </div>
            </div>
          </div>
          <div class="flex gap-3 justify-end border-t pt-4">
            <button onclick="this.closest('.fixed').remove()" 
                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
              ุฅูุบุงุก
            </button>
            <button 
                    onclick="(async () => { await saveAccountChanges('${username}'); this.closest('.fixed').remove(); })()"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
              ๐พ ุญูุธ ุงูุชุบููุฑุงุช
            </button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modalDiv);
  }

  /**
   * ุญูุธ ุงูุชุนุฏููุงุช ุงูุชู ุชู ุฅุฏุฎุงููุง ูู ูุงูุฐุฉ ุชุนุฏูู ุงูุญุณุงุจ. ุชููู ูุฐู
   * ุงูุฏุงูุฉ ุจูุฑุงุกุฉ ุงูููู ูู ูููุฐุฌ ุงูุชุนุฏูู ูุชุญุฏูุซ ูุงุฆู ุงููุณุชุฎุฏู ูู
   * ุงูุฐุงูุฑุฉุ ุซู ุชููู ุจุญูุธ ุงูุจูุงูุงุช ุฅูู Firebase ูุฅุนุงุฏุฉ ุชุญููููุง
   * ูุชุญุฏูุซ ุงููุงุฌูุฉ. ููุง ูุชู ุฅุถุงูุฉ ุตูุงุญูุฉ "accounts" ุชููุงุฆูุงู
   * ูููุณุชุฎุฏููู ุฐูู ุงูุฏูุฑ "ูุฏูุฑ ุงููุธุงู"ุ ูุชุถุงู ุตูุงุญูุฉ "discounts"
   * ูุฌููุน ุงูุญุณุงุจุงุช. ุจุนุฏ ุงูุญูุธุ ูุชู ุฅุบูุงู ูุงูุฐุฉ ุงูุชุนุฏูู ูุนุฑุถ ุฑุณุงูุฉ
   * ูุฌุงุญ.
   *
   * @param {string} username ุงุณู ุงููุณุชุฎุฏู ุงูุฐู ุณูุชู ุชุนุฏูู ุจูุงูุงุชู
   */
  async function saveAccountChanges(username) {
    const user = users[username];
    if (!user) {
      showMessage('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุญุณุงุจ', 'error');
      return;
    }
    // Allow the username to be changed.  Read the value from the editable field if present.
    const usernameField = document.getElementById('edit-account-username');
    const newUsername = usernameField ? usernameField.value.trim() : username;
    // Validate the new username: it must not be empty and must be unique if changed.
    if (!newUsername) {
      showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณุชุฎุฏู', 'error');
      return;
    }
    if (newUsername !== username && users[newUsername]) {
      showMessage('โ ุงุณู ุงููุณุชุฎุฏู ููุฌูุฏ ุจุงููุนูุ ูุฑุฌู ุงุฎุชูุงุฑ ุงุณู ุขุฎุฑ', 'error');
      return;
    }
    const fullName = document.getElementById('edit-account-fullname').value.trim();
    const password = document.getElementById('edit-account-password').value.trim();
    const role = document.getElementById('edit-account-role').value;
    // ุฌูุน ุงูุตูุงุญูุงุช ุงููุฎุชุงุฑุฉ
    const permissions = [];
    const permIds = [
      { id: 'edit-perm-sales', value: 'sales' },
      { id: 'edit-perm-purchases', value: 'purchases' },
      { id: 'edit-perm-inventory', value: 'inventory' },
      { id: 'edit-perm-employees', value: 'employees' },
      { id: 'edit-perm-invoices', value: 'invoices' },
      { id: 'edit-perm-customers', value: 'customers' },
      { id: 'edit-perm-accounts', value: 'accounts' },
      { id: 'edit-perm-discounts', value: 'discounts' },
      { id: 'edit-perm-accounting', value: 'accounting' },
      { id: 'edit-perm-returns', value: 'returns' },
      { id: 'edit-perm-user-sales', value: 'user-sales' },
      { id: 'edit-perm-settings', value: 'settings' }
    ];
    permIds.forEach(item => {
      const checkbox = document.getElementById(item.id);
      if (checkbox && checkbox.checked) {
        permissions.push(item.value);
      }
    });
    // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
    if (!fullName) {
      showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ุงูุงุณู ุงููุงูู', 'error');
      return;
    }
    if (!password) {
      showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ', 'error');
      return;
    }
    if (password.length < 6) {
      showMessage('โ ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู', 'error');
      return;
    }
    if (!role) {
      showMessage('โ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุฏูุฑ ุงููุธููู', 'error');
      return;
    }
    if (permissions.length === 0) {
      showMessage('โ ูุฑุฌู ุงุฎุชูุงุฑ ุตูุงุญูุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู', 'error');
      return;
    }
    // ุฅุถุงูุฉ ุตูุงุญูุฉ accounts ูู ุญุงู ูุงู ุงูุฏูุฑ "ูุฏูุฑ ุงููุธุงู" ุฃู ูู ุญุงู ูุงู ุงุณู ุงููุณุชุฎุฏู ูู ุงูุญุณุงุจ ุงูุฃุณุงุณู
    // ูุถูุงู ุงุญุชูุงุธ ุญุณุงุจ ุงููุฏูุฑ ุจุตูุงุญูุฉ ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช ุญุชู ุนูุฏ ุชุบููุฑ ุงูุฏูุฑ ุฅูู ูุณูู ุขุฎุฑ.
    if ((role === 'ูุฏูุฑ ุงููุธุงู' || username === 'ibrahim') && !permissions.includes('accounts')) {
      permissions.push('accounts');
    }
    // ูุง ูุถูู ุฃู ุตูุงุญูุงุช ุฅุถุงููุฉ ุจุดูู ุชููุงุฆูุ ุจุงุณุชุซูุงุก accounts ูููุฏูุฑ ุงููุธุงู
    // ุชุญุฏูุซ ุงููุณุชุฎุฏูุ ูุน ุงูุชุนุงูู ูุน ุชุบููุฑ ุงุณู ุงููุณุชุฎุฏู.
    const updatedUser = {
      ...user,
      fullName: fullName,
      password: password,
      role: role,
      permissions: permissions,
      // ูุง ูุบูุฑ ุชุงุฑูุฎ ุงูุฅูุดุงุก ููุง ุงูุญุงูุฉ ููุง
    };
    // ุฅุฐุง ุชุบูุฑ ุงุณู ุงููุณุชุฎุฏูุ ูุญุฐู ุงูููุชุงุญ ุงููุฏูู ููุถูู ุงูููุชุงุญ ุงูุฌุฏูุฏ
    if (newUsername !== username) {
      delete users[username];
    }
    users[newUsername] = updatedUser;

    // ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุงูุญุงูู ูู ุงูุญุณุงุจ ุงูุฐู ุชู ุชุนุฏูููุ ูู ุจุชุญุฏูุซ currentUser
    // ุญุชู ุชูุนูุณ ุงูุชุบููุฑุงุช ุนูู ุงููุงุฌูุฉ ุงูุญุงููุฉ ููุฑุงู. ูุดูู ุฐูู ุชุญุฏูุซ ุงุณู
    // ุงููุณุชุฎุฏู ูู currentUser ุฅุฐุง ุชู ุชุบููุฑู ููุฐูู ุงูุตูุงุญูุงุช.
    if (currentUser && currentUser.username === username) {
      // ุญุฏุซ ุฎุตุงุฆุต ุงููุณุชุฎุฏู ุงูุญุงูู
      currentUser = { ...updatedUser };
      currentUser.username = newUsername;
    }
    /*
     * Persist the updated account to Firebase and reload from the cloud
     * only if the save succeeds.  To prevent the background
     * autoโsynchronization from interfering (which could reload
     * outdated data while saving), pause the autoSyncTimer if it is
     * active.  Once the save and (conditional) reload complete, restore
     * the timer.  This pattern mirrors the logic used in other
     * add/edit/delete operations to ensure reliability when network
     * connectivity is intermittent.
     */
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.error('Error saving data to Firebase:', err);
    }
    // Reload only if the save succeeded.  If saving fails, retain
    // local changes so they are not overwritten by stale cloud data.
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุชุนุฏูู ุงูุญุณุงุจ:', err);
      }
    }
    // Restore the autoโsync timer if it was previously active
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
    // ุจุนุฏ ุงูุญูุธ ูุฅุนุงุฏุฉ ุงูุชุญูููุ ูู ุจุชุญุฏูุซ ุฌููุน ุงูุนุฑูุถ ูุถูุงู ุงูุนูุงุณ ุงูุชุบููุฑุงุช ูู ูู ุงูุฃูุณุงู
    updateAllDisplays();
    // ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุงูุชููู ุจูุงุกู ุนูู ุงูุตูุงุญูุงุช ุงูุฌุฏูุฏุฉ ูู ุญุงู ูุงู ุงููุณุชุฎุฏู ุงูุญุงูู ูุฏ ุชุบููุฑ
    try {
      updateNavigationPermissions();
    } catch (err) {
      // ุฅุฐุง ูู ุชุชููุฑ ุงูุฏุงูุฉุ ูุชุฌุงูู ุงูุฎุทุฃ
    }

    // ุนุฑุถ ุฑุณุงูุฉ ุงููุฌุงุญ ููุท. ุฅุบูุงู ุงููุงูุฐุฉ ูุชู ุนุจุฑ ุฑุฏ ุงููุนู ูู ุฒุฑ ุงูุญูุธ.
    showMessage(`โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุญุณุงุจ "${fullName}" ุจูุฌุงุญ`, 'success');
  }
  
async function confirmDeleteAccount(username) {
    const deletedUserName = users[username].fullName;
    // Remove the user from the users map
    delete users[username];
    /*
     * Pause the autoโsync to prevent the background interval from
     * overwriting this account deletion with stale data.  Capture
     * whether the timer is active, clear it, then restore it after
     * saving and reloading.
     */
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    // Persist the deletion and reload from Firebase only if the save succeeds.
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.error('Error saving data to Firebase:', err);
    }
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุงูุญุณุงุจ:', err);
      }
    } else {
      console.warn('โ๏ธ ูู ูุชู ุญูุธ ุญุฐู ุงูุญุณุงุจุ ุณูุชู ุงูุงุญุชูุงุธ ุจุงูุชุบููุฑุงุช ูุญูููุง ุญุชู ุชูุชูู ุนูููุฉ ุงูุญูุธ.');
    }
    // Resume autoโsync if needed
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
    // Update the accounts display after saving and reloading
    updateAccountsDisplay();
    showMessage('โ ุชู ุญุฐู ุญุณุงุจ "' + deletedUserName + '" ุจูุฌุงุญ', 'success');
  }

  // -------------------------------------------------------------------
  // ๐ ุฅุฏุงุฑุฉ ุฌูุณุงุช ุงูุฏุฎูู ูุงูุฎุฑูุฌ
  // ุชุญุชูู ูุฐู ุงูุฏูุงู ุนูู ููุทู ุชุณุฌูู ุงูุฏุฎูู ูุงูุฎุฑูุฌ ูููุณุชุฎุฏููู
  // ูุชุญุฏูุซ ุฌุฏุงูู ุณุฌู ุงูุฌูุณุงุช ูุงูุฌูุณุงุช ุงููุดุทุฉ ุจุงูุฅุถุงูุฉ ุฅูู ุญูุธูุง
  // ุฅูู Firebase ูู ูุณุงุฑ ูููุตู.

  async function logLogin(username) {
        try {
          if (!username || !users[username]) return;
          const fullName = users[username].fullName || '';
          const now = new Date();
          const nowIso = now.toISOString();
          // Before creating a new login session for this user, close any
          // existing open sessions for the same username.  This prevents
          // multiple overlapping sessions that could appear as duplicates in
          // the active accounts table.  We mark their logoutTime as the
          // current moment (the same as the new login time) so that they
          // immediately become inactive.
          for (let i = 0; i < loginSessions.length; i++) {
            const session = loginSessions[i];
            if (session && session.username === username && !session.logoutTime) {
              session.logoutTime = nowIso;
            }
          }
          // Add the new login session
          loginSessions.push({ username: username, fullName: fullName, loginTime: nowIso, logoutTime: null });
          await saveLoginSessionsToFirebase();
          updateLoginSessionsDisplay();
        } catch (err) {
          console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุฌูุณุฉ ุงูุฏุฎูู:', err);
        }
  }

  async function logLogout(username, waitForSave = true) {
    try {
      if (!username) return;
      const now = new Date();
      for (let i = loginSessions.length - 1; i >= 0; i--) {
        const session = loginSessions[i];
        if (session && session.username === username && !session.logoutTime) {
          session.logoutTime = now.toISOString();
          break;
        }
      }
      if (waitForSave) {
        await saveLoginSessionsToFirebase();
      } else {
        // Fire-and-forget save without awaiting (useful for beforeunload)
        saveLoginSessionsToFirebase();
      }
      updateLoginSessionsDisplay();
    } catch (err) {
      console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุฎุฑูุฌ ูู ุงูุฌูุณุฉ:', err);
    }
  }

  async function saveLoginSessionsToFirebase() {
    try {
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpSessions'), loginSessions);
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุณุฌูุงุช ุงูุฌูุณุงุช ูู Firebase:', err);
    }
  }

  function updateLoginSessionsDisplay() {
    const historyBody = document.getElementById('login-history-list');
    const activeBody = document.getElementById('active-sessions-list');
    if (!historyBody || !activeBody) return;
    historyBody.innerHTML = '';
    activeBody.innerHTML = '';
    const formatTime = (iso) => {
      if (!iso) return '-';
      try {
        const date = new Date(iso);
        const datePart = date.toLocaleDateString('ar-EG');
        const timePart = date.toLocaleTimeString('ar-EG');
        // ุงุณุชุฎุฏู ูุงุตู ุจูู ุงูุชุงุฑูุฎ ูุงูููุช ูุณูููุฉ ุงููุฑุงุกุฉ
        return `${datePart} - ${timePart}`;
      } catch (_) {
        return iso;
      }
    };
    // Arrange history sessions by most recent login first
    // ุชุฑุชูุจ ุณุฌู ุชุณุฌููุงุช ุงูุฏุฎูู ุจุญุณุจ ุงูููุช ุชูุงุฒููุงู ุจุญูุซ ูุธูุฑ ุขุฎุฑ ุชุณุฌูู ุฏุฎูู ุฃููุงู.
    const sessionsSorted = loginSessions
      .filter((s) => s)
      .sort((a, b) => {
        const aTime = a && a.loginTime ? new Date(a.loginTime).getTime() : 0;
        const bTime = b && b.loginTime ? new Date(b.loginTime).getTime() : 0;
        return bTime - aTime;
      });
    sessionsSorted.forEach((session) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border border-gray-300 p-2">${session.username || ''}</td>
        <td class="border border-gray-300 p-2">${session.fullName || ''}</td>
        <td class="border border-gray-300 p-2">${formatTime(session.loginTime)}</td>
        <td class="border border-gray-300 p-2">${session.logoutTime ? formatTime(session.logoutTime) : '-'}</td>
      `;
      historyBody.appendChild(tr);
    });
        // Display active accounts.  Accounts remain active as long as they are logged in,
        // and after logging out they stay active for one minute.  If multiple
        // sessions exist for the same username, keep only the most recent one.
        // Build a map of the most recent session for each username (caseโinsensitive).
        // Trim whitespace and convert to lowercase to avoid duplicate keys such as
        // "ibrahim" and "ibrahim ".
        const latestSessionByUser = {};
        loginSessions.forEach((s) => {
          if (!s || !s.username) return;
          const key = s.username.toLowerCase().trim();
          const loginMs = s.loginTime ? new Date(s.loginTime).getTime() : 0;
          const existing = latestSessionByUser[key];
          if (!existing || loginMs > existing.loginMs) {
            latestSessionByUser[key] = { session: s, loginMs: loginMs };
          }
        });
        // Determine which of these latest sessions should be considered active.  A
        // session is considered active if it has no recorded logoutTime (i.e. the user
        // has not explicitly logged out) and the login occurred within a recent
        // threshold (5 minutes).  This prevents showing stale sessions from previous
        // logins while still allowing enough time for users to remain listed if they
        // accidentally close their browser without logging out.
        // Build a list of active sessions.  To avoid showing stale sessions
        // indefinitely (e.g. if a user closes the browser without triggering
        // a logout), consider a session active only if it has no recorded
        // logoutTime and its login occurred within the last 5 minutes.
        const nowMs = Date.now();
        const ACTIVE_THRESHOLD_MS = 5 * 60 * 1000; // 5 minutes
        const activeSessions = [];
        Object.values(latestSessionByUser).forEach(({ session, loginMs }) => {
          if (session && !session.logoutTime) {
            // Fallback to compute login timestamp if loginMs is undefined
            const sessionLoginMs = (typeof loginMs === 'number') ? loginMs : (session.loginTime ? new Date(session.loginTime).getTime() : 0);
            if (nowMs - sessionLoginMs <= ACTIVE_THRESHOLD_MS) {
              activeSessions.push(session);
            }
          }
        });
        // Sort active sessions by their login time in descending order
        activeSessions.sort((a, b) => {
          const aMs = a && a.loginTime ? new Date(a.loginTime).getTime() : 0;
          const bMs = b && b.loginTime ? new Date(b.loginTime).getTime() : 0;
          return bMs - aMs;
        });
        activeSessions.forEach((session) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="border border-gray-300 p-2 flex items-center"><span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"></span>${session.username || ''}</td>
            <td class="border border-gray-300 p-2">${session.fullName || ''}</td>
            <td class="border border-gray-300 p-2">${formatTime(session.loginTime)}</td>
          `;
          activeBody.appendChild(tr);
        });
  }

  /**
   * Manual save handler for the header "๐ ุญูุธ" button.  When invoked,
   * this function persists the current inโmemory ERP data to Firebase.
   * It pauses the autoโsync timer while saving to prevent concurrent
   * background synchronization from overwriting the save with stale
   * data.  After a successful save it shows a success message; on
   * failure it logs and displays an error message.  In all cases it
   * resumes the autoโsync timer and updates the UI after the operation.
   */
  async function manualSave() {
    // Pause autoโsync if active
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.error('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุจูุงูุงุช ูุฏูููุง:', err);
      showMessage('โ ุชุนุฐุฑ ุญูุธ ุงูุจูุงูุงุช: ' + (err && err.message ? err.message : err), 'error');
    }
    // Show success message only if the save completed without throwing
    if (saveSucceeded) {
      showMessage('โ ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ', 'success');
    }
    // Refresh the UI regardless of save outcome.  This ensures that
    // any pending changes are reflected in the interface.
    try {
      updateAllDisplays();
    } catch (_) {}
    // Resume autoโsync
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
  }
  
  function updateAccountsDisplay() {
    const tbody = document.getElementById('accounts-list');
    const userArray = Object.entries(users);
    
    if (userArray.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุญุณุงุจุงุช ูุณุฌูุฉ</td></tr>';
      return;
    }
    
    tbody.innerHTML = userArray.map(([username, user]) => {
      const permissionsText = user.permissions.map(perm => {
        const permMap = {
          'sales': '๐ฐ',
          'purchases': '๐',
          'inventory': '๐ฆ',
          'employees': '๐ฅ',
          'invoices': '๐',
          'customers': '๐ค',
          'accounts': '๐',
          'discounts': '๐ธ',
          'accounting': '๐',
          'returns': '๐',
          // Add an icon for the "userโsales" permission so it appears in the
          // accounts table.  Without this entry, the raw permission name would
          // show up without an icon.  Use the same icon as the navigation
          // button (a user and briefcase) to keep the UI consistent.
          'user-sales': '๐ค๐ผ',
          // Use a gear icon for the settings permission so it matches the other icons
          'settings': 'โ๏ธ'
        };
        return permMap[perm] || perm;
      }).join(' ');
      
      const statusClass = user.status === 'ูุดุท' ? 'text-green-600' : 'text-red-600';
      const statusBtnClass = user.status === 'ูุดุท' ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';
      const statusBtnText = user.status === 'ูุดุท' ? 'ุชุนุทูู' : 'ุชูุนูู';
      
      return `
        <tr>
          <td class="border border-gray-300 p-3 font-medium">${username}</td>
          <td class="border border-gray-300 p-3">${user.fullName}</td>
          <td class="border border-gray-300 p-3">
            <span class="font-mono">${user.password}</span>
          </td>
          <td class="border border-gray-300 p-3">${user.role}</td>
          <td class="border border-gray-300 p-3">${permissionsText}</td>
          <td class="border border-gray-300 p-3">${user.createdAt}</td>
          <td class="border border-gray-300 p-3 ${statusClass} font-medium">${user.status}</td>
          <td class="border border-gray-300 p-3">
            <div class="flex gap-2">
              <button onclick="toggleAccountStatus('${username}')" 
                      class="${statusBtnClass} text-white px-2 py-1 rounded text-sm">
                ${statusBtnText}
              </button>
              <button onclick="openEditAccountModal('${username}')" 
                      class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm">
                ุชุนุฏูู
              </button>
              ${username !== 'ibrahim' ? `
                <button onclick="deleteAccount('${username}')" 
                        class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm">
                  ุญุฐู
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
    // Update statistics
    const totalAccounts = userArray.length;
    const activeAccounts = userArray.filter(([_, user]) => user.status === 'ูุดุท').length;
    const adminAccounts = userArray.filter(([_, user]) => user.role === 'ูุฏูุฑ ุงููุธุงู').length;
    const employeeAccounts = totalAccounts - adminAccounts;
    
    document.getElementById('total-accounts').textContent = totalAccounts;
    document.getElementById('active-accounts').textContent = activeAccounts;
    document.getElementById('admin-accounts').textContent = adminAccounts;
    document.getElementById('employee-accounts').textContent = employeeAccounts;
  }
  
  function updatePurchasesDisplay() {
    // Collect purchases and sort them by date in descending order so that
    // the most recently added purchase appears first in the table.  Each
    // purchase record has a `date` field stored as an ISO string.  A newer
    // date yields a larger timestamp, so we subtract to sort descending.
    const purchases = allData
      .filter(item => item.type === 'purchase')
      .sort((a, b) => new Date(b.date) - new Date(a.date));
    const tbody = document.getElementById('purchases-list');
    
    if (purchases.length === 0) {
      // Use colspan 9 to match the number of columns in the purchases table header including the actions column
      tbody.innerHTML = '<tr><td colspan="9" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุดุชุฑูุงุช ูุณุฌูุฉ</td></tr>';
      return;
    }

    // Render each purchase with all relevant fields in the correct order:
    // Date | Product Code | Product Name | Sale Price | Supplier | Quantity | Purchase Price | Total | Actions
    // Include index parameter to allow deletion of individual rows
    tbody.innerHTML = purchases.map((purchase, index) => `
      <tr>
        <td class="border border-gray-300 p-2">${new Date(purchase.date).toLocaleDateString('ar-EG')}</td>
        <td class="border border-gray-300 p-2">${purchase.product_code}</td>
        <td class="border border-gray-300 p-2">${purchase.product_name}</td>
        <td class="border border-gray-300 p-2">${
          // Ensure sale_price is a finite number before calling toFixed.
          (typeof purchase.sale_price === 'number' && isFinite(purchase.sale_price) ? purchase.sale_price : 0).toFixed(2)
        } ุฌ.ู</td>
        <td class="border border-gray-300 p-2">${purchase.supplier || ''}</td>
        <td class="border border-gray-300 p-2">${purchase.quantity || 0}</td>
        <td class="border border-gray-300 p-2">${
          (typeof purchase.purchase_price === 'number' && isFinite(purchase.purchase_price) ? purchase.purchase_price : 0).toFixed(2)
        } ุฌ.ู</td>
        <td class="border border-gray-300 p-2">${
          (typeof purchase.total === 'number' && isFinite(purchase.total) ? purchase.total : 0).toFixed(2)
        } ุฌ.ู</td>
        <td class="border border-gray-300 p-2 text-center">
              <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="editPurchase(${index})">โ๏ธ ุชุนุฏูู</button>
              <button class="text-red-600 hover:text-red-800" onclick="deletePurchase(${index})">๐๏ธ ุญุฐู</button>
        </td>
      </tr>
    `).join('');
  }
  
  /**
   * Helper to return purchases sorted in the same order used in the UI.
   * Sorting by date descending ensures consistent indexing between the
   * displayed table and operations like editing or deletion.  Without this,
   * using the original allData order would delete or edit the wrong row.
   *
   * @returns {Array} sorted array of purchase objects
   */
  function getSortedPurchases() {
    return allData
      .filter(item => item.type === 'purchase')
      .sort((a, b) => new Date(b.date) - new Date(a.date));
  }
  function updateInventoryDisplay() {
    const inventory = calculateInventory();
    const inventoryArray = Object.values(inventory);
    // Sort inventory by the date of the most recent purchase so that products
    // with newer purchases appear first.  If a product lacks a lastPurchaseDate
    // (unlikely, but handle gracefully), treat it as the oldest date.
    inventoryArray.sort((a, b) => {
      const dateA = a.lastPurchaseDate ? new Date(a.lastPurchaseDate) : new Date(0);
      const dateB = b.lastPurchaseDate ? new Date(b.lastPurchaseDate) : new Date(0);
      return dateB - dateA;
    });
    const tbody = document.getElementById('inventory-list');
    
    if (inventoryArray.length === 0) {
      // No products: span all 10 columns to match header layout
      tbody.innerHTML = '<tr><td colspan="10" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ุงููุฎุฒูู</td></tr>';
      document.getElementById('total-products').textContent = '0';
      document.getElementById('in-stock').textContent = '0';
      document.getElementById('low-stock').textContent = '0';
      document.getElementById('out-of-stock').textContent = '0';
      return;
    }
    
    tbody.innerHTML = inventoryArray.map(item => {
      // Determine status based on actual available stock
      let status, statusClass;
      const baseStock = item.availableStock;
      const reservedStock = item.reservedStock || 0;
      const actualStock = item.actualAvailableStock;

      if (actualStock <= 0) {
        status = reservedStock > 0 ? 'ูุญุฌูุฒ' : 'ูุงูุฏ';
        statusClass = 'text-red-600 font-bold';
      } else if (actualStock < 10) {
        status = 'ููุฎูุถ';
        statusClass = 'text-yellow-600 font-bold';
      } else {
        status = 'ูุชููุฑ';
        statusClass = 'text-green-600';
      }

      return `
        <tr ${reservedStock > 0 ? 'class="bg-orange-50"' : ''}>
          <td class="border border-gray-300 p-2">${item.code}</td>
          <td class="border border-gray-300 p-2">${item.name}</td>
          <td class="border border-gray-300 p-2">${item.purchasePrice.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-2">${item.salePrice.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-2">${item.totalPurchases}</td>
          <td class="border border-gray-300 p-2">${item.totalSales}</td>
          <td class="border border-gray-300 p-2 font-bold">${baseStock}</td>
          <td class="border border-gray-300 p-2 ${reservedStock > 0 ? 'text-orange-600 font-bold' : 'text-gray-600'}">${reservedStock}</td>
          <td class="border border-gray-300 p-2 font-bold ${actualStock > 0 ? 'text-green-600' : 'text-red-600'}">${actualStock}</td>
          <td class="border border-gray-300 p-2 ${statusClass}">${status}</td>
        </tr>
      `;
    }).join('');
    
    // Update statistics based on actual available stock
    document.getElementById('total-products').textContent = inventoryArray.length;
    document.getElementById('in-stock').textContent = inventoryArray.filter(item => item.actualAvailableStock >= 10).length;
    document.getElementById('low-stock').textContent = inventoryArray.filter(item => item.actualAvailableStock > 0 && item.actualAvailableStock < 10).length;
    document.getElementById('out-of-stock').textContent = inventoryArray.filter(item => item.actualAvailableStock <= 0).length;
  }
  
  function updateEmployeesDisplay(filterTerm) {
    // Ensure necessary elements exist
    const tbody = document.getElementById('employees-list');
    const countSpan = document.getElementById('employees-count');
    if (!tbody) return;
    // Retrieve all employees from unified data
    const employees = allData.filter(item => item.type === 'employee');
    // Update employees count display
    if (countSpan) {
      countSpan.textContent = employees.length;
    }
    // Determine filter term: use passed value if provided, otherwise read from search input
    let searchTerm = '';
    if (typeof filterTerm === 'string') {
      searchTerm = filterTerm.trim().toLowerCase();
    } else {
      const searchInput = document.getElementById('employee-search');
      searchTerm = searchInput && searchInput.value ? searchInput.value.trim().toLowerCase() : '';
    }
    // Filter employees by name or code if a search term is provided
    const filteredEmployees = searchTerm
      ? employees.filter(emp => {
          const name = emp.employee_name ? emp.employee_name.toLowerCase() : '';
          const code = emp.employee_code ? String(emp.employee_code).toLowerCase() : '';
          return name.includes(searchTerm) || code.includes(searchTerm);
        })
      : employees;
    // If no employees after filtering, show empty message
    if (filteredEmployees.length === 0) {
      // colspan should match the number of table columns (14 including actions)
      // Adjust colspan to match the number of columns (15 including actions)
      tbody.innerHTML = '<tr><td colspan="15" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ููุฌุฏ ููุธููู ูุณุฌููู</td></tr>';
      return;
    }
    // Build rows with new columns (name, code, department, salary, late deductions, penalties, net salary, age, address, hours, actions)
    tbody.innerHTML = filteredEmployees
      .map(employee => {
        const basicSalary = employee.basic_salary || employee.salary || 0;
        const lateDeductions = employee.late_deductions || 0;
        const penalties = employee.penalties || 0;
        const incentives = employee.incentives || 0;
        // Extract reasons for penalties and incentives
        const penaltiesReason = employee.penalties_reason || '';
        const incentivesReason = employee.incentives_reason || '';
        // Calculate net salary including incentives
        const advance = employee.advance || employee.employee_advance || 0;
        const netSalary = employee.net_salary || (basicSalary - lateDeductions - penalties - advance + incentives);
        const empCode = employee.employee_code || '';
        return `
        <tr class="hover:bg-gray-50">
          <td class="border border-gray-300 p-2 font-medium">${employee.employee_name}</td>
          <td class="border border-gray-300 p-2">${empCode}</td>
          <td class="border border-gray-300 p-2">${employee.department}</td>
          <td class="border border-gray-300 p-2 font-bold text-blue-600">${basicSalary.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-2 ${lateDeductions > 0 ? 'text-red-600 font-bold' : 'text-gray-500'}">${lateDeductions > 0 ? lateDeductions.toFixed(2) + ' ุฌ.ู' : '-'}</td>
          <td class="border border-gray-300 p-2 ${penalties > 0 ? 'text-red-600 font-bold' : 'text-gray-500'}">${penalties > 0 ? penalties.toFixed(2) + ' ุฌ.ู' : '-'}</td>
          <td class="border border-gray-300 p-2">${penaltiesReason ? penaltiesReason : '-'}</td>
          <td class="border border-gray-300 p-2 ${advance > 0 ? 'text-red-600 font-bold' : 'text-gray-500'}">${advance > 0 ? advance.toFixed(2) + ' ุฌ.ู' : '-'}</td>
          <td class="border border-gray-300 p-2 ${incentives > 0 ? 'text-green-600 font-bold' : 'text-gray-500'}">${incentives > 0 ? incentives.toFixed(2) + ' ุฌ.ู' : '-'}</td>
          <td class="border border-gray-300 p-2">${incentivesReason ? incentivesReason : '-'}</td>
          <td class="border border-gray-300 p-2 font-bold text-green-600 bg-green-50">${netSalary.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-2">${employee.age || '-'}</td>
          <td class="border border-gray-300 p-2">${employee.address || '-'}</td>
          <td class="border border-gray-300 p-2">${employee.work_hours || '-'}</td>
          <td class="border border-gray-300 p-2">
            <div class="flex gap-2">
              <button onclick="editEmployee('${employee.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm">โ๏ธ ุชุนุฏูู</button>
              <button onclick="deleteEmployee('${employee.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">๐๏ธ ุญุฐู</button>
            </div>
          </td>
        </tr>
        `;
      })
      .join('');
  }

  /**
   * Display predictive suggestions for employees based on the current search input.
   * Shows up to 5 matching employees by name or code. Selecting a suggestion
   * fills the search input and updates the employees list.
   */
  function showEmployeeSuggestions() {
    const searchInput = document.getElementById('employee-search');
    const resultsContainer = document.getElementById('employee-search-results');
    if (!searchInput || !resultsContainer) return;
    const term = searchInput.value.trim().toLowerCase();
    // If empty search term, hide suggestions
    if (!term) {
      resultsContainer.classList.add('hidden');
      resultsContainer.innerHTML = '';
      return;
    }
    const employees = allData.filter(item => item.type === 'employee');
    const matches = employees.filter(emp => {
      const name = emp.employee_name ? emp.employee_name.toLowerCase() : '';
      const code = emp.employee_code ? String(emp.employee_code).toLowerCase() : '';
      return name.includes(term) || code.includes(term);
    });
    // Build suggestion items (max 5)
    const suggestionsHtml = matches.slice(0, 5).map(emp => {
      const displayCode = emp.employee_code ? ` (${emp.employee_code})` : '';
      return `<div class="search-item" onclick="selectEmployeeSuggestion('${emp.employee_code || ''}','${emp.employee_name.replace(/'/g, '&#39;')}')">${emp.employee_name}${displayCode}</div>`;
    }).join('');
    // Populate and show
    resultsContainer.innerHTML = suggestionsHtml || `<div class="search-item text-gray-500">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</div>`;
    resultsContainer.classList.remove('hidden');
  }

  /**
   * Handle selection of an employee suggestion. Fills the search input with the
   * selected employee code (if available) or name and updates the employees list.
   * @param {string} code - The employee code
   * @param {string} name - The employee name
   */
  function selectEmployeeSuggestion(code, name) {
    const searchInput = document.getElementById('employee-search');
    const resultsContainer = document.getElementById('employee-search-results');
    if (searchInput) {
      // Prefer code if available; otherwise use name
      searchInput.value = code || name;
    }
    if (resultsContainer) {
      resultsContainer.classList.add('hidden');
      resultsContainer.innerHTML = '';
    }
    // Refresh the employee table using the selected value
    updateEmployeesDisplay(searchInput.value);
  }

  // Hide employee suggestions when clicking outside of the search or dropdown
  document.addEventListener('click', function(event) {
    const resultsContainer = document.getElementById('employee-search-results');
    const searchInput = document.getElementById('employee-search');
    if (!resultsContainer || !searchInput) return;
    if (resultsContainer.classList.contains('hidden')) return;
    // If click outside both search input and results container, hide dropdown
    if (!resultsContainer.contains(event.target) && event.target !== searchInput) {
      resultsContainer.classList.add('hidden');
      resultsContainer.innerHTML = '';
    }
  });
  
  function updateInvoicesDisplay() {
    // Gather all invoices and sort them by date in descending order so that
    // the most recently saved invoice appears first in the list.  The date
    // property is stored as an ISO string.  Use the numeric comparison of
    // timestamps for sorting.
    const invoices = allData
      .filter(item => item.type === 'invoice')
      .sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA;
      });
    const tbody = document.getElementById('invoices-list');
    
    if (invoices.length === 0) {
      // ุญุฏุฏ ุนุฏุฏ ุงูุฃุนูุฏุฉ ููุดูู ุนููุฏ ููุฏ ุงูุนููู ุงูุฌุฏูุฏ (ุงูุฅุฌูุงูู 12 ุฃุนูุฏุฉ)
      tbody.innerHTML = '<tr><td colspan="12" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ููุงุชูุฑ ูุณุฌูุฉ</td></tr>';
      document.getElementById('total-invoices').textContent = '0';
      document.getElementById('total-sales').textContent = '0.00';
      document.getElementById('pending-payments').textContent = '0.00';
      document.getElementById('today-sales').textContent = '0.00';
      return;
    }
    
    tbody.innerHTML = invoices.map(invoice => {
      // Compute a reliable remaining amount for each invoice. Some older invoices
      // may not have a remaining_amount field; in that case fall back to
      // total minus payment_amount.  This ensures that the remaining value is
      // always defined when rendered in the table.
      const remaining = (typeof invoice.remaining_amount !== 'undefined' && invoice.remaining_amount !== null)
        ? invoice.remaining_amount
        : (invoice.total - (invoice.payment_amount || 0));

      const statusClass = invoice.status === 'ูุฏููุน' ? 'text-green-600' : 'text-red-600';
      
      // Get products for this invoice
      const invoiceProducts = allData.filter(item => 
        item.type === 'sale' && item.invoice_number === invoice.invoice_number
      );
      
      // Calculate totals
      const totalQuantity = invoiceProducts.reduce((sum, p) => sum + p.quantity, 0);
      const productCount = invoiceProducts.length;
      
      // Calculate total discounts for this invoice
      const totalDiscounts = invoiceProducts.reduce((sum, p) => {
        const discountAmount = p.discount_amount || 0;
        return sum + (discountAmount * p.quantity);
      }, 0);
      
      const hasDiscounts = totalDiscounts > 0;
      
      // Create detailed products display with prices and discounts
      const detailedProducts = invoiceProducts.length > 0 
        ? invoiceProducts.map(p => {
            const hasDiscount = p.discount_amount && p.discount_amount > 0;
            const originalPrice = p.original_price || p.price;
            const discountText = hasDiscount ? ` (ุฎุตู: ${p.discount_amount.toFixed(2)})` : '';
            return `${p.product_name}: ${p.quantity} ร ${p.price.toFixed(2)}${discountText} = ${p.total.toFixed(2)} ุฌ.ู`;
          }).join(' | ')
        : 'ุบูุฑ ูุญุฏุฏ';
      
      // Determine the display string for the remaining amount.  A positive
      // remaining indicates a deficit (paid < total) and should be shown
      // with a minus sign.  A zero or negative remaining indicates the
      // customer has paid enough or overpaid and should be shown without a
      // minus sign.
      const displayRemaining = remaining > 0
        ? '-' + remaining.toFixed(2)
        : Math.abs(remaining).toFixed(2);

      // Determine fallback for payment amount.  Some invoices may lack
      // a payment_amount field; in that case, derive it from total and
      // remaining.  We compute remaining above, so use it here.  Ensure
      // that total is defined before subtraction to avoid NaN.
      const paymentAmountValue = (typeof invoice.payment_amount !== 'undefined' && invoice.payment_amount !== null)
        ? invoice.payment_amount
        : ((typeof invoice.total !== 'undefined' && invoice.total !== null) ? (invoice.total - remaining) : 0);

      return `
        <tr class="hover:bg-gray-50 ${hasDiscounts ? 'bg-green-50' : ''}">
          <td class="border border-gray-300 p-2 font-medium text-blue-600">
            ${invoice.invoice_number}
            ${hasDiscounts ? '<div class="text-xs text-green-600">๐ธ ุจุฎุตู</div>' : ''}
          </td>
          <td class="border border-gray-300 p-2">${new Date(invoice.date).toLocaleDateString('ar-EG')}</td>
          <td class="border border-gray-300 p-2">${invoice.customer_name}</td>
          <td class="border border-gray-300 p-2">${invoice.customer_code || ''}</td>
          <td class="border border-gray-300 p-2 text-center font-bold text-blue-600">${productCount}</td>
          <td class="border border-gray-300 p-2 text-center font-bold text-green-600">${totalQuantity}</td>
          <td class="border border-gray-300 p-2 text-sm max-w-xs">
            <div class="truncate" title="${detailedProducts}">${detailedProducts}</div>
            ${hasDiscounts ? `<div class="text-xs text-red-600 font-bold mt-1">ุฅุฌูุงูู ุงูุฎุตู: ${totalDiscounts.toFixed(2)} ุฌ.ู</div>` : ''}
          </td>
          <td class="border border-gray-300 p-2 font-medium">${invoice.total.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-2">${paymentAmountValue.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-2">${displayRemaining} ุฌ.ู</td>
          <!-- ุนุฑุถ ููุน ุงูุฏูุน ููู ูุงุชูุฑุฉ ุฅุฐุง ูุงู ูุชุงุญุงู -->
          <td class="border border-gray-300 p-2">${invoice.payment_method || ''}</td>
          <td class="border border-gray-300 p-2 ${statusClass} font-medium">${invoice.status}</td>
          <td class="border border-gray-300 p-2">
            <button onclick="openInvoiceDetails('${invoice.invoice_number}')" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
              ๐ ูุชุญ ุงููุงุชูุฑุฉ
            </button>
          </td>
        </tr>
      `;
    }).join('');
    
    // Update statistics
    const totalSales = invoices.reduce((sum, inv) => sum + inv.total, 0);
    // Calculate pending payments using a fallback for invoices without a
    // remaining_amount field. If remaining_amount is undefined or null,
    // compute it as total minus payment_amount.  This prevents NaN values
    // and ensures accurate totals.
    const pendingPayments = invoices.reduce((sum, inv) => {
      const rm = (typeof inv.remaining_amount !== 'undefined' && inv.remaining_amount !== null)
        ? inv.remaining_amount
        : (inv.total - (inv.payment_amount || 0));
      return sum + rm;
    }, 0);
    const today = new Date().toDateString();
    const todaySales = invoices
      .filter(inv => new Date(inv.date).toDateString() === today)
      .reduce((sum, inv) => sum + inv.total, 0);
    
    document.getElementById('total-invoices').textContent = invoices.length;
    document.getElementById('total-sales').textContent = totalSales.toFixed(2);
    document.getElementById('pending-payments').textContent = pendingPayments.toFixed(2);
    document.getElementById('today-sales').textContent = todaySales.toFixed(2);
  }

  // Ensure the ุญูุธ ุงููุงุชูุฑุฉ button triggers the payment modal even if inline handlers fail.
  // Attach an event listener once the DOM has fully loaded. This listener calls openPaymentModal
  // and prevents default button behavior.
  document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save-invoice-btn');
    if (saveBtn) {
      saveBtn.addEventListener('click', function(evt) {
        evt.preventDefault();
        // Prevent multiple triggers if the function is already running
        if (isLoading) return;
        openPaymentModal();
      });
    }
  });
  
  function updateCustomersDisplay() {
    const invoices = allData.filter(item => item.type === 'invoice');
    const customers = {};

    invoices.forEach(invoice => {
      // Use customer code if provided to uniquely identify customers;
      // fallback to customer name if no code exists.
      const key = invoice.customer_code || invoice.customer_name;
      if (customers[key]) {
        customers[key].invoiceCount++;
        customers[key].totalPurchases += invoice.total;
        // Always use a reliable remaining value. Some invoices may not have
        // remaining_amount defined, so fall back to total minus payment amount.
        const remaining = (typeof invoice.remaining_amount !== 'undefined' && invoice.remaining_amount !== null)
          ? invoice.remaining_amount
          : (invoice.total - (invoice.payment_amount || 0));
        customers[key].totalDebt += remaining;
        if (new Date(invoice.date) > new Date(customers[key].lastPurchase)) {
          customers[key].lastPurchase = invoice.date;
        }
      } else {
        customers[key] = {
          name: invoice.customer_name,
          code: invoice.customer_code || '',
          invoiceCount: 1,
          totalPurchases: invoice.total,
        // Compute remaining for the initial entry as well, using the same fallback logic
        totalDebt: (typeof invoice.remaining_amount !== 'undefined' && invoice.remaining_amount !== null)
          ? invoice.remaining_amount
          : (invoice.total - (invoice.payment_amount || 0)),
          lastPurchase: invoice.date
        };
      }
    });
    
    // Convert the customers object (built from invoices) into an array
    let customersArray = Object.values(customers);

    /**
     * Merge any manually added customers (e.g. from the customer management section
     * or default entries) into the list derived from invoices.  A manual customer
     * will only be added if a customer with the same code or name does not
     * already exist in the invoice-derived list.  Manual customers are stored
     * globally on window.manualCustomers.
     */
    try {
      if (window.manualCustomers && Array.isArray(window.manualCustomers)) {
        window.manualCustomers.forEach(mc => {
          const exists = customersArray.some(c => {
            // Compare by code if defined, otherwise by name
            if (mc.code && mc.code !== '') {
              return (c.code && String(c.code) === String(mc.code)) || c.name === mc.name;
            }
            return c.name === mc.name;
          });
          if (!exists) {
            // Ensure manual customers have the necessary properties to render
            customersArray.push({
              name: mc.name || '',
              code: mc.code || '',
              invoiceCount: mc.invoiceCount != null ? mc.invoiceCount : 0,
              totalPurchases: mc.totalPurchases != null ? mc.totalPurchases : 0,
              totalDebt: mc.totalDebt != null ? mc.totalDebt : 0,
              lastPurchase: mc.lastPurchase || ''
            });
          }
        });
      }
    } catch (e) {
      console.error('Error merging manual customers:', e);
    }

    // Sort customers by their lastPurchase date in descending order so that
    // the most recently added or recently active customer appears first.  If a
    // customer has no lastPurchase date (e.g. manually added without any
    // invoices), treat their date as the earliest possible time so they
    // appear later in the list.  new Date('') yields NaN, so explicitly
    // default to 0 when parsing.
    try {
      customersArray.sort(function (a, b) {
        const timeA = a && a.lastPurchase ? new Date(a.lastPurchase).getTime() : 0;
        const timeB = b && b.lastPurchase ? new Date(b.lastPurchase).getTime() : 0;
        return timeB - timeA;
      });
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุฑุชูุจ ุงูุนููุงุก ุญุณุจ ุงูุชุงุฑูุฎ:', err);
    }

    const tbody = document.getElementById('customers-list');

    // If there are still no customers after merging manual customers, show an empty message
    if (!customersArray || customersArray.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ููุฌุฏ ุนููุงุก ูุณุฌููู</td></tr>';
      document.getElementById('total-customers').textContent = '0';
      document.getElementById('active-customers').textContent = '0';
      document.getElementById('customers-with-debt').textContent = '0';
      return;
    }

    // Render the customers table
    tbody.innerHTML = customersArray
      .map(customer => {
        // Format date safely; if lastPurchase is falsy, leave empty
        let lastPurchaseFormatted = '';
        try {
          if (customer.lastPurchase) {
            const date = new Date(customer.lastPurchase);
            if (!isNaN(date.getTime())) {
              lastPurchaseFormatted = date.toLocaleDateString('ar-EG');
            }
          }
        } catch (_) {
          lastPurchaseFormatted = '';
        }
        return `
      <tr>
        <td class="border border-gray-300 p-2">
          ${customer.name || ''}${
            customer.code && customer.code !== 'ุจุฏูู ููุฏ'
              ? ` <span class="text-gray-500 text-xs">(${customer.code})</span>`
              : ''
          }
        </td>
        <td class="border border-gray-300 p-2">${customer.invoiceCount}</td>
        <td class="border border-gray-300 p-2">${Number(customer.totalPurchases || 0).toFixed(2)} ุฌ.ู</td>
        <td class="border border-gray-300 p-2">${Number(customer.totalDebt || 0).toFixed(2)} ุฌ.ู</td>
        <td class="border border-gray-300 p-2">${lastPurchaseFormatted}</td>
      </tr>
    `;
      })
      .join('');

    // Update summary counters
    document.getElementById('total-customers').textContent = customersArray.length;
    document.getElementById('active-customers').textContent = customersArray.filter(c => c.invoiceCount > 0).length;
    document.getElementById('customers-with-debt').textContent = customersArray.filter(c => c.totalDebt > 0).length;

    // -----------------------------------------------------------------------
    // ๐งพ ุฅูุบุงุก ุนุฑุถ ุฌุฏุงูู ุงูููุงุชูุฑ ูู ุฃุณูู ูุณู ุงููุดุชุฑูุงุช
    // ุจูุงุกู ุนูู ุทูุจ ุงููุณุชุฎุฏูุ ุชูุช ุฅุฒุงูุฉ ุฌุฏุงูู ุงูููุงุชูุฑ ุงูุชู ูุงูุช ุชุธูุฑ ููู
    // ุนููู ูู ูุณู ุงููุดุชุฑูุงุช. ูุชู ุจุจุณุงุทุฉ ุชูุฑูุบ ุงูุญุงููุฉ ุงููุณุคููุฉ ุนู
    // ูุฐู ุงูุฌุฏุงูู ุฅุฐุง ูุงูุช ููุฌูุฏุฉุ ุฏูู ุฅูุดุงุก ุฃู ูุญุชูู ุฌุฏูุฏ.
    (function() {
      const invoiceSection = document.getElementById('customer-invoices-section');
      if (invoiceSection) {
        invoiceSection.innerHTML = '';
      }
    })();
  }

  // -----------------------------------------------------------------------
  // ๐ ุฅุถุงูุฉ ุนููุฏ ููุฏ ุงูุนููู ุจุดูู ุฏููุงูููู
  // ุจุนุฏ ุชุนุฑูู updateCustomersDisplayุ ูุนูุฏ ุชุนุฑูููุง ููุฏุนู ุงููุณุฎุฉ ุงูุฃุตููุฉ ุซู
  // ูุถูู ุนููุฏูุง ูููุฏ ุงูุนููู ูู ุฌุฏูู ุงูุนููุงุก ุฅุฐุง ูู ููู ููุฌูุฏูุง. ููุง ูููู
  // ุจุฅุถุงูุฉ ุฎููุฉ ููุฏ ููู ุตู ููุฌูุฏ ููุถุจุท ูููุฉ colspan ูู ุญุงูุฉ ุงูุตู ุงููุงุฑุบ.
  (function() {
    const originalUpdateCustomersDisplay = updateCustomersDisplay;
    updateCustomersDisplay = function() {
      // ูุฏุงุก ุงูุฏุงูุฉ ุงูุฃุตููุฉ ูุชุญุฏูุซ ุงูุฌุฏูู ูุงูุฃุฑูุงู ุฃููุงู
      originalUpdateCustomersDisplay();
      try {
        // ุฅุถุงูุฉ ุฑุฃุณ ุนููุฏ ุงูููุฏ ุฅุฐุง ูู ููู ููุฌูุฏุงู
        const table = document.getElementById('customers-list')?.closest('table');
        if (table) {
          const theadRow = table.querySelector('thead tr');
          if (theadRow && !theadRow.querySelector('.customer-code-header')) {
            const th = document.createElement('th');
            th.className = 'border border-gray-300 p-2 customer-code-header';
            th.textContent = 'ููุฏ ุงูุนููู';
            // ุฃุฏุฎู ุงูุฑุฃุณ ุจุนุฏ ุงุณู ุงูุนููู ูุจุงุดุฑุฉ
            theadRow.insertBefore(th, theadRow.children[1]);
          }
        }
        // ูุนุงูุฌุฉ ุตููู ุงูุฌุฏูู ูุฅุถุงูุฉ ุฎููุฉ ุงูููุฏ ูู ูู ุตู
        const tbody = document.getElementById('customers-list');
        if (tbody) {
          Array.from(tbody.querySelectorAll('tr')).forEach(row => {
            // ุฅุฐุง ูุงู ุงูุตู ูุญุชูู ุนูู 5 ุฎูุงูุง (ุฃู ุจุฏูู ุนููุฏ ุงูููุฏ)ุ ุฃุถู ุงูุนููุฏ
            if (row.children && row.children.length === 5) {
              const nameCell = row.children[0];
              let code = '-';
              // ุงูุจุญุซ ุนู span ุฏุงุฎู ุฎููุฉ ุงูุงุณู ููุญุตูู ุนูู ุงูููุฏ ุจูู ุงูุฃููุงุณ
              const span = nameCell.querySelector('span');
              if (span) {
                code = span.textContent.replace(/[()]/g, '').trim();
                span.remove();
                nameCell.textContent = nameCell.textContent.trim();
              }
              const codeCell = document.createElement('td');
              codeCell.className = 'border border-gray-300 p-2';
              codeCell.textContent = code;
              // ุฃุฏุฎู ุฎููุฉ ุงูููุฏ ุจุนุฏ ุฎููุฉ ุงูุงุณู ูุจุงุดุฑุฉ
              row.insertBefore(codeCell, row.children[1]);
            }
            // ุฅุฐุง ูุงู ุตู ูุงุฑุบ ูุงุญุฏ (ูุง ุชูุฌุฏ ุจูุงูุงุช)ุ ุงุถุจุท colspan
            if (row.children.length === 1 && row.cells[0] && row.cells[0].colSpan) {
              const cell = row.cells[0];
              if (cell.colSpan === 5) {
                cell.colSpan = 6;
              }
            }
          });
        }
      } catch (err) {
        console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุนููุฏ ููุฏ ุงูุนููู:', err);
      }
    };
  })();
  
  function updateDiscountsDisplay() {
    // Get all sales with discounts and sort them by date in descending order.
    // Sorting ensures the most recent discounted sales appear at the top of the list.
    const salesWithDiscounts = allData
      .filter(item =>
        item.type === 'sale' &&
        item.discount_amount &&
        item.discount_amount > 0
      )
      .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const tbody = document.getElementById('discounts-list');
    
    if (salesWithDiscounts.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ุฎุตููุงุช ูุทุจูุฉ</td></tr>';
      document.getElementById('total-discounts-count').textContent = '0';
      document.getElementById('total-discounts-amount').textContent = '0.00';
      document.getElementById('today-discounts').textContent = '0.00';
      document.getElementById('avg-discount').textContent = '0.00';
      return;
    }
    
    tbody.innerHTML = salesWithDiscounts.map(sale => {
      const originalPrice = sale.original_price || sale.price;
      const discountAmount = sale.discount_amount;
      const finalPrice = sale.price;
      const discountPercentage = ((discountAmount / originalPrice) * 100).toFixed(1);
      const totalDiscountForItem = discountAmount * sale.quantity;
      
      return `
        <tr class="hover:bg-amber-50">
          <td class="border border-gray-300 p-2 font-medium text-blue-600">${sale.invoice_number}</td>
          <td class="border border-gray-300 p-2">${new Date(sale.date).toLocaleDateString('ar-EG')}</td>
          <td class="border border-gray-300 p-2">${sale.customer_name}</td>
          <td class="border border-gray-300 p-2">${sale.product_name}</td>
          <td class="border border-gray-300 p-2">${originalPrice.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-2 font-bold text-red-600">${discountAmount.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-2 font-bold text-green-600">${finalPrice.toFixed(2)} ุฌ.ู</td>
          <td class="border border-gray-300 p-2 font-bold text-orange-600">${discountPercentage}%</td>
          <td class="border border-gray-300 p-2 text-center">${sale.quantity}</td>
          <td class="border border-gray-300 p-2 font-bold text-red-600">${totalDiscountForItem.toFixed(2)} ุฌ.ู</td>
        </tr>
      `;
    }).join('');
    
    // Calculate statistics
    const totalDiscountsAmount = salesWithDiscounts.reduce((sum, sale) => 
      sum + (sale.discount_amount * sale.quantity), 0
    );
    
    const today = new Date().toDateString();
    const todayDiscounts = salesWithDiscounts
      .filter(sale => new Date(sale.date).toDateString() === today)
      .reduce((sum, sale) => sum + (sale.discount_amount * sale.quantity), 0);
    
    const avgDiscount = salesWithDiscounts.length > 0 ? 
      totalDiscountsAmount / salesWithDiscounts.length : 0;
    
    document.getElementById('total-discounts-count').textContent = salesWithDiscounts.length;
    document.getElementById('total-discounts-amount').textContent = totalDiscountsAmount.toFixed(2);
    document.getElementById('today-discounts').textContent = todayDiscounts.toFixed(2);
    document.getElementById('avg-discount').textContent = avgDiscount.toFixed(2);
  }

  /**
   * ุชุญุฏูุซ ุนุฑุถ ูุณู ุงููุฑุชุฌุนุงุช
   * ูููู ูุฐุง ุงููุณู ุจุนุฑุถ ุฌููุน ุนูููุงุช ุงููุฑุชุฌุน ุงููุณุฌูุฉ ูุน ุญุณุงุจ ุจุนุถ ุงูุฅุญุตุงุฆูุงุช
   * ูุซู ุนุฏุฏ ุนูููุงุช ุงููุฑุชุฌุนุ ุฅุฌูุงูู ุงููููุฉ ุงููุฑุชุฌุนุฉุ ูุฑุชุฌุนุงุช ุงููููุ ููุชูุณุท
   * ุงููููุฉ ูู ูู ุนูููุฉ. ููุง ูุชูุญ ุญุฐู ุฃู ุนูููุฉ ูุฑุชุฌุน.
   */
  function updateReturnsDisplay() {
    // Gather all return records and sort them by date in descending order
    // so that the most recent return appears first in the table.  The date
    // field on each return record is an ISO string.
    const returnRecords = allData
      .filter(item => item.type === 'return')
      .sort((a, b) => new Date(b.date) - new Date(a.date));
    const tbody = document.getElementById('returns-list');
    if (!tbody) return;

    if (returnRecords.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุฑุชุฌุนุงุช ูุณุฌูุฉ</td></tr>';
      document.getElementById('total-returns-count').textContent = '0';
      document.getElementById('total-returns-quantity').textContent = '0';
      document.getElementById('today-returns-count').textContent = '0';
      document.getElementById('avg-return-quantity').textContent = '0';
      return;
    }

    // Populate table rows
    tbody.innerHTML = returnRecords.map((ret, idx) => {
      const dateStr = new Date(ret.date).toLocaleDateString('ar-EG');
      const quantity = parseFloat(ret.quantity) || 0;
      const reason = ret.reason || '';
      const returnedBy = ret.returned_by_name || '';
      return `
        <tr class="hover:bg-lime-50">
          <td class="border border-gray-300 p-2">${dateStr}</td>
          <td class="border border-gray-300 p-2">${ret.product_code}</td>
          <td class="border border-gray-300 p-2">${ret.product_name}</td>
          <td class="border border-gray-300 p-2">${quantity}</td>
          <td class="border border-gray-300 p-2">${reason}</td>
          <td class="border border-gray-300 p-2">${returnedBy}</td>
          <td class="border border-gray-300 p-2 text-center">
            <button class="text-red-600 hover:text-red-800" onclick="deleteReturn(${idx})">๐๏ธ ุญุฐู</button>
          </td>
        </tr>
      `;
    }).join('');

    // Calculate statistics
    const totalCount = returnRecords.length;
    const totalQuantity = returnRecords.reduce((sum, r) => sum + (parseFloat(r.quantity) || 0), 0);
    const todayDateString = new Date().toDateString();
    const todayTotal = returnRecords
      .filter(r => new Date(r.date).toDateString() === todayDateString)
      .reduce((sum, r) => sum + (parseFloat(r.quantity) || 0), 0);
    const avgQty = totalCount > 0 ? (totalQuantity / totalCount).toFixed(1) : 0;

    document.getElementById('total-returns-count').textContent = totalCount;
    document.getElementById('total-returns-quantity').textContent = totalQuantity;
    document.getElementById('today-returns-count').textContent = todayTotal;
    document.getElementById('avg-return-quantity').textContent = avgQty;
  }

  /**
   * ุฅุถุงูุฉ ุนูููุฉ ูุฑุชุฌุน ุฌุฏูุฏุฉ
   * ููุฑุฃ ุงูููู ูู ุญููู ุงููุฏุฎูุงุชุ ูุชุญูู ูู ุตุญุชูุงุ ุซู ูุถูู ุณุฌู ุฌุฏูุฏ
   * ูู ุงูููุน "return" ุฅูู allData. ุจุนุฏ ุงูุฅุถุงูุฉ ูุชู ุชุญุฏูุซ ุงูุนุฑุถ
   * ูุญูุธ ุงูุจูุงูุงุช ูู Firebase.
   */
  async function addReturn() {
    const codeInput = document.getElementById('return-product-code');
    const nameInput = document.getElementById('return-product-name');
    const qtyInput = document.getElementById('return-quantity');
    const reasonInput = document.getElementById('return-reason');
    const productCode = codeInput ? codeInput.value.trim() : '';
    const productName = nameInput ? nameInput.value.trim() : '';
    const quantity = qtyInput ? parseFloat(qtyInput.value) : 0;
    const reason = reasonInput ? reasonInput.value.trim() : '';

    if (!productCode || !productName || !quantity || quantity <= 0) {
      showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ููุฏ ุงูููุชุฌ ูุงุณู ุงูููุชุฌ ูุงููููุฉ ุจุดูู ุตุญูุญ', 'error');
      return;
    }

    // Validate that the return quantity does not exceed the quantity sold.
    // Compute total quantity sold for this product and subtract any previous returns to get net sold quantity.
    try {
      const totalSoldQty = allData
        .filter(item => item.type === 'sale' && item.product_code === productCode)
        .reduce((sum, sale) => sum + (parseFloat(sale.quantity) || 0), 0);
      const totalReturnedQty = allData
        .filter(item => item.type === 'return' && item.product_code === productCode)
        .reduce((sum, ret) => sum + (parseFloat(ret.quantity) || 0), 0);
      const netSold = totalSoldQty - totalReturnedQty;
      // If netSold is zero or negative, no returns can be processed for this product.
      if (netSold <= 0) {
        showMessage('โ ูุง ูููู ุฅุนุงุฏุฉ ูุฐุง ุงูููุชุฌ ูุฃูู ูู ูุชู ุจูุนู ุฃู ุชู ุฅุฑุฌุงุนู ุจุงููุงูู', 'error');
        return;
      }
      if (quantity > netSold) {
        showMessage(`โ ูุง ูููู ุฅุนุงุฏุฉ ูููุฉ ุฃูุจุฑ ูู ุงููุจุงุนุฉ. ุงููููุฉ ุงููุชุจููุฉ ุงูุชู ูููู ุฅุฑุฌุงุนูุง ูู: ${netSold}`, 'error');
        return;
      }
    } catch (validationError) {
      console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญูู ูู ูููุฉ ุงููุฑุชุฌุน:', validationError);
      // ูู ุญุงูุฉ ุญุฏูุซ ุฎุทุฃ ูู ุงูุชุญููุ ูููุน ุงูุฅุถุงูุฉ ูุฅุจูุงุก ุงููุฎุฒูู ูุชุณูุงู
      showMessage('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญูู ูู ุงููููุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.', 'error');
      return;
    }

    const ret = {
      id: Date.now().toString() + '-' + Math.random().toString(36).substring(2, 8),
      type: 'return',
      product_code: productCode,
      product_name: productName,
      quantity: quantity,
      reason: reason,
      date: new Date().toISOString(),
      // ุชุณุฌูู ุงุณู ุงููุณุชุฎุฏู ุงูุฐู ูุงู ุจุนูููุฉ ุงููุฑุชุฌุน
      returned_by_name: (currentUser && currentUser.fullName) ? currentUser.fullName : ((currentUser && currentUser.username) ? currentUser.username : '')
    };
    allData.push(ret);

    // Clear inputs
    if (codeInput) codeInput.value = '';
    if (nameInput) nameInput.value = '';
    if (qtyInput) qtyInput.value = '';
    if (reasonInput) reasonInput.value = '';

    // Update displays and save
    updateAllDisplays();
    try {
      await saveDataToFirebase();
      showMessage('โ ุชู ุฅุถุงูุฉ ุงููุฑุชุฌุน ุจูุฌุงุญ', 'success');
    } catch (err) {
      console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุฑุชุฌุน:', err);
      showMessage('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุฑุชุฌุน ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช', 'error');
    }
  }

  /**
   * ุญุฐู ุนูููุฉ ูุฑุชุฌุน ุงุณุชูุงุฏุงู ุฅูู ูุคุดุฑูุง ูู ูุตูููุฉ returnRecords.
   * ูุชู ุงูุชุฃูุฏ ูู ุตุญุฉ ุงููุคุดุฑุ ุซู ุฅุฒุงูุฉ ุงูุนูุตุฑ ูู allDataุ ูุชุญุฏูุซ
   * ุงูุนุฑุถ ููุงุนุฏุฉ ุงูุจูุงูุงุช.
   */
  /**
   * ุฅุธูุงุฑ ูุงูุฐุฉ ููุจุซูุฉ ููุชุฃููุฏ ูุจู ุญุฐู ุนูููุฉ ูุฑุชุฌุน ูููุฑุฏุฉ.
   * ุชุณุชูุจู ูุฐู ุงูุฏุงูุฉ ุฑูู ุงูุตู ูู ูุตูููุฉ returnRecords (idx)ุ ุซู
   * ุชุจูู ูุงุฌูุฉ ุชุฃููุฏ ุจููุณ ุฃุณููุจ ุฃูุณุงู ุงููุตุฑููุงุช ูุบูุฑูุง. ุฅุฐุง
   * ูุงูู ุงููุณุชุฎุฏู ุนูู ุงูุญุฐูุ ูุชู ุงุณุชุฏุนุงุก confirmDeleteReturn ูุน
   * ุงููุนุฑูู ุงููุฑูุฏ ูููุฑุชุฌุน ููุชุนุงูู ูุน ุงูุญุฐู ุงููุนูู.
   *
   * @param {number} index ูุคุดุฑ ุงูุตู ูู ุฌุฏูู ุงููุฑุชุฌุนุงุช
   */
  function deleteReturn(index) {
    const returnRecords = allData.filter(item => item.type === 'return');
    if (index < 0 || index >= returnRecords.length) return;
    const ret = returnRecords[index];
    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    confirmDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md">
        <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุงูุญุฐู</h3>
        <p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฑุชุฌุน ุงูููุชุฌ "${ret.product_name}" ุจูููุฉ ${parseFloat(ret.quantity) || 0}ุ</p>
        <div class="flex gap-3 justify-end">
          <button onclick="this.parentElement.parentElement.parentElement.remove()"
                  class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
            ุฅูุบุงุก
          </button>
          <button onclick="confirmDeleteReturn('${ret.id}'); this.parentElement.parentElement.parentElement.remove()"
                  class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
            ุญุฐู
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  }

  /**
   * ุชูููุฐ ุงูุญุฐู ุงููุนูู ูุนูููุฉ ุงููุฑุชุฌุน ุจุนุฏ ุงูุชุฃููุฏ ูู ุงููุณุชุฎุฏู.
   * ุชุจุญุซ ูุฐู ุงูุฏุงูุฉ ุนู ุงููุฑุชุฌุน ูู allData ุจุงุณุชุฎุฏุงู ุงููุนุฑูู
   * ุงููุฑูุฏ ุซู ุชุฒููู ูุชุญุฏูุซ ุงูุนุฑุถ ูุชุญูุธ ุงูุจูุงูุงุช ูู Firebase.
   *
   * @param {string} returnId ุงููุนุฑู ุงููุฑูุฏ ูููุฑุชุฌุน
   */
  async function confirmDeleteReturn(returnId) {
    const globalIndex = allData.findIndex(item => item.type === 'return' && item.id === returnId);
    if (globalIndex === -1) return;
    allData.splice(globalIndex, 1);
    updateAllDisplays();
    try {
      await saveDataToFirebase();
      showMessage('๐๏ธ ุชู ุญุฐู ุงููุฑุชุฌุน ุจูุฌุงุญ', 'success');
    } catch (err) {
      console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุฑุชุฌุน:', err);
      showMessage('โ๏ธ ุชุนุฐุฑ ุญุฐู ุงููุฑุชุฌุน ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช', 'error');
    }
  }

  /**
   * ุญุฐู ุฌููุน ุนูููุงุช ุงููุฑุชุฌุน ุฏูุนุฉ ูุงุญุฏุฉ ุจุนุฏ ุงูุชุฃููุฏ ูู ุงููุณุชุฎุฏู. ูุชู
   * ุฅุฒุงูุฉ ูุงูุฉ ุงูุณุฌูุงุช ุงูุชู ููุนูุง 'return' ูู ูุตูููุฉ allDataุ ุซู ุชุญุฏูุซ
   * ุงูุนุฑูุถ ูุญูุธ ุงูุชุนุฏููุงุช ูู Firebase.
   */
  /**
   * ุนุฑุถ ูุงูุฐุฉ ุชุฃููุฏ ูุจู ุญุฐู ุฌููุน ุงููุฑุชุฌุนุงุช ุฏูุนุฉ ูุงุญุฏุฉ. ุฅุฐุง ูุงูู
   * ุงููุณุชุฎุฏูุ ูุชู ุงุณุชุฏุนุงุก confirmDeleteAllReturns ูุชูููุฐ ุงูุญุฐู ุงููุนูู.
   */
  function deleteAllReturns() {
    const returnCount = allData.filter(item => item.type === 'return').length;
    // ุฅุฐุง ูู ุชูุฌุฏ ูุฑุชุฌุนุงุชุ ูุนุฑุถ ุฑุณุงูุฉ ูุนูููุงุช ููุง ูุธูุฑ ูุงูุฐุฉ ุชุฃููุฏ
    if (returnCount === 0) {
      showMessage('โน๏ธ ูุง ุชูุฌุฏ ูุฑุชุฌุนุงุช ูุญุฐููุง', 'info');
      return;
    }
    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    confirmDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md">
        <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุญุฐู ุฌููุน ุงููุฑุชุฌุนุงุช</h3>
        <p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงููุฑุชุฌุนุงุชุ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.</p>
        <div class="flex gap-3 justify-end">
          <button onclick="this.parentElement.parentElement.parentElement.remove()"
                  class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
            ุฅูุบุงุก
          </button>
          <button onclick="confirmDeleteAllReturns(); this.parentElement.parentElement.parentElement.remove()"
                  class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
            ุญุฐู ุงููู
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  }

  /**
   * ุชูููุฐ ุญุฐู ุฌููุน ุนูููุงุช ุงููุฑุชุฌุน ุจุนุฏ ุชุฃููุฏ ุงููุณุชุฎุฏู. ุชููู ุจุฅุฒุงูุฉ
   * ูุงูุฉ ุงูุณุฌูุงุช ุฐุงุช ุงูููุน 'return' ูู allDataุ ุซู ุชุญุฏูุซ ุงูุนุฑุถ
   * ูุชุญูุธ ุงูุชุบููุฑุงุช ูู Firebase.
   */
  async function confirmDeleteAllReturns() {
    // ููุชุฑุฉ ูู ุงูุนูุงุตุฑ ุบูุฑ ุงููุฑุชุฌุนุงุช
    const newData = allData.filter(item => item.type !== 'return');
    allData.splice(0, allData.length, ...newData);
    updateAllDisplays();
    try {
      await saveDataToFirebase();
      showMessage('๐๏ธ ุชู ุญุฐู ุฌููุน ุงููุฑุชุฌุนุงุช ุจูุฌุงุญ', 'success');
    } catch (err) {
      console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุฌููุน ุงููุฑุชุฌุนุงุช:', err);
      showMessage('โ๏ธ ุชุนุฐุฑ ุญุฐู ุงููุฑุชุฌุนุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช', 'error');
    }
  }
  
  // Invoice details function
  function openInvoiceDetails(invoiceNumber) {
    const invoice = allData.find(item => item.type === 'invoice' && item.invoice_number === invoiceNumber);
    if (!invoice) {
      showMessage('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุงุชูุฑุฉ', 'error');
      return;
    }
    
    // Get all products for this invoice
    const invoiceProducts = allData.filter(item => 
      item.type === 'sale' && item.invoice_number === invoiceNumber
    );

    // Compute robust total and payment amounts for this invoice.  Some older
    // records may not have total/payment fields, so fall back to calculating
    // the total from the invoiceProducts and default payment to 0 if needed.
    const invoiceTotalValue = (typeof invoice.total !== 'undefined' && invoice.total !== null)
      ? invoice.total
      : invoiceProducts.reduce((sum, p) => sum + (p.total || 0), 0);
    const paymentAmountValue = (typeof invoice.payment_amount !== 'undefined' && invoice.payment_amount !== null)
      ? invoice.payment_amount
      : 0;

    // Compute a reliable remaining amount.  If the invoice has a remaining_amount
    // field, use it.  Otherwise, derive it from the computed total and payment.
    const remaining = (typeof invoice.remaining_amount !== 'undefined' && invoice.remaining_amount !== null)
      ? invoice.remaining_amount
      : (invoiceTotalValue - paymentAmountValue);

    // Compute the display string for the remaining amount.  When remaining is
    // positive (paid < total), prefix with a minus sign.  Otherwise display
    // the absolute value.  This will be interpolated into the template.
    const displayRemaining = remaining > 0
      ? '-' + remaining.toFixed(2)
      : Math.abs(remaining).toFixed(2);

    // Determine the creator name and role for display.  Some invoices may
    // store these fields under different names (creator_name, creator, created_by).
    // Fallback to blank strings if not available.  The role may also be
    // missing, in which case we omit it.
    const creatorDisplayName = invoice.creator_name || invoice.creator || invoice.created_by || '';
    const creatorDisplayRole = invoice.creator_role || invoice.role || '';
    
    // Create invoice details modal
    const modalDiv = document.createElement('div');
    modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    // Use computed fallback values (invoiceTotalValue and paymentAmountValue)
    // instead of referencing invoice.total and invoice.payment_amount directly.
    modalDiv.innerHTML = `
      <div class="bg-white rounded-lg max-w-4xl w-full max-h-full overflow-y-auto">
        <div class="p-6">
          <!-- Header -->
          <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-2xl font-bold text-gray-800">๐ ุชูุงุตูู ุงููุงุชูุฑุฉ ุฑูู ${invoiceNumber}</h2>
            <button onclick="this.closest('.fixed').remove()" 
                    class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
              โ
            </button>
          </div>
          
          <!-- Invoice Info -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg">
              <h3 class="font-semibold text-blue-800 mb-3">ูุนูููุงุช ุงููุงุชูุฑุฉ</h3>
              <div class="space-y-2 text-sm">
                <div><strong>ุฑูู ุงููุงุชูุฑุฉ:</strong> ${invoice.invoice_number}</div>
                <div><strong>ุงูุชุงุฑูุฎ:</strong> ${new Date(invoice.date).toLocaleDateString('ar-EG')} - ${new Date(invoice.date).toLocaleTimeString('ar-EG')}</div>
                <div><strong>ุงุณู ุงูุนููู:</strong> ${invoice.customer_name}</div>
                <!-- Added customer code so that users can see both the name and code when viewing invoice details -->
                <div><strong>ููุฏ ุงูุนููู:</strong> ${invoice.customer_code || ''}</div>
                <div><strong>ุงูุญุงูุฉ:</strong> <span class="${invoice.status === 'ูุฏููุน' ? 'text-green-600' : 'text-red-600'} font-bold">${invoice.status}</span></div>
                ${creatorDisplayName ? `<div><strong>ุงููุณุชุฎุฏู:</strong> ${creatorDisplayName}</div>` : ''}
                ${creatorDisplayRole ? `<div><strong>ุงูุตูุฉ:</strong> ${creatorDisplayRole}</div>` : ''}
              </div>
            </div>
          <div class="bg-green-50 p-4 rounded-lg">
              <h3 class="font-semibold text-green-800 mb-3">ุงููุจุงูุบ ุงููุงููุฉ</h3>
              <div class="space-y-2 text-sm">
                <!-- Use fallback values for total and payment. This ensures
                     that invoices missing these fields still display
                     correctly in the details modal. -->
                <div><strong>ุฅุฌูุงูู ุงููุงุชูุฑุฉ:</strong> <span class="text-green-600 font-bold">${invoiceTotalValue.toFixed(2)} ุฌ.ู</span></div>
                <div><strong>ุงููุจูุบ ุงููุฏููุน:</strong> ${paymentAmountValue.toFixed(2)} ุฌ.ู</div>
                <div><strong>ุงููุจูุบ ุงููุชุจูู:</strong> <span class="${remaining > 0 ? 'text-red-600' : 'text-green-600'} font-bold">${displayRemaining} ุฌ.ู</span></div>
                <div><strong>ุนุฏุฏ ุงูููุชุฌุงุช:</strong> ${invoiceProducts.length} ููุชุฌ</div>
                <!-- ูุนูููุงุช ุทุฑููุฉ ุงูุฏูุน ูุงููุจุงูุบ ุงูููุตูุฉ -->
                <div><strong>ุทุฑููุฉ ุงูุฏูุน:</strong> ${invoice.payment_method || ''}</div>
                <div><strong>ุงููุฏููุน ุจุงูููุฒุง:</strong> ${invoice.visa_amount ? invoice.visa_amount.toFixed(2) : '0.00'} ุฌ.ู</div>
                <div><strong>ุงููุฏููุน ููุฏุงู:</strong> ${invoice.cash_amount ? invoice.cash_amount.toFixed(2) : '0.00'} ุฌ.ู</div>
              </div>
            </div>
            ${(() => {
              const totalDiscounts = invoiceProducts.reduce((sum, p) => {
                const discountAmount = p.discount_amount || 0;
                return sum + (discountAmount * p.quantity);
              }, 0);
              
              const discountedItems = invoiceProducts.filter(p => p.discount_amount && p.discount_amount > 0);
              
              return totalDiscounts > 0 ? `
                <div class="bg-amber-50 p-4 rounded-lg">
                  <h3 class="font-semibold text-amber-800 mb-3">๐ธ ูุนูููุงุช ุงูุฎุตููุงุช</h3>
                  <div class="space-y-2 text-sm">
                    <div><strong>ุฅุฌูุงูู ุงูุฎุตููุงุช:</strong> <span class="text-red-600 font-bold">${totalDiscounts.toFixed(2)} ุฌ.ู</span></div>
                    <div><strong>ุนุฏุฏ ุงูููุชุฌุงุช ุงููุฎูุถุฉ:</strong> ${discountedItems.length} ููุชุฌ</div>
                    <div><strong>ูุชูุณุท ุงูุฎุตู:</strong> ${discountedItems.length > 0 ? (totalDiscounts / discountedItems.length).toFixed(2) : '0.00'} ุฌ.ู</div>
                    <div><strong>ูุณุจุฉ ุงูุชูููุฑ:</strong> <span class="text-green-600 font-bold">${((totalDiscounts / (invoice.total + totalDiscounts)) * 100).toFixed(1)}%</span></div>
                  </div>
                </div>
              ` : `
                <div class="bg-gray-50 p-4 rounded-lg">
                  <h3 class="font-semibold text-gray-800 mb-3">ูุนูููุงุช ุงูุฎุตููุงุช</h3>
                  <div class="text-center text-gray-500 text-sm">
                    <div class="text-2xl mb-2">๐ซ</div>
                    <div>ูุง ุชูุฌุฏ ุฎุตููุงุช ูุทุจูุฉ ุนูู ูุฐู ุงููุงุชูุฑุฉ</div>
                  </div>
                </div>
              `;
            })()}
          </div>
          
          <!-- Products Table -->
          <div class="mb-6">
            <h3 class="font-semibold text-gray-800 mb-3">๐๏ธ ุชูุงุตูู ุงูููุชุฌุงุช</h3>
            <div class="overflow-x-auto">
              <table class="w-full border-collapse border border-gray-300">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="border border-gray-300 p-3 text-right">ููุฏ ุงูููุชุฌ</th>
                    <th class="border border-gray-300 p-3 text-right">ุงุณู ุงูููุชุฌ</th>
                    <th class="border border-gray-300 p-3 text-center">ุงููููุฉ</th>
                    <th class="border border-gray-300 p-3 text-center">ุณุนุฑ ุงููุญุฏุฉ</th>
                    <th class="border border-gray-300 p-3 text-center">ุงูุฅุฌูุงูู</th>
                  </tr>
                </thead>
                <tbody>
                  ${invoiceProducts.map(product => {
                    const hasDiscount = product.discount_amount && product.discount_amount > 0;
                    const originalPrice = product.original_price || product.price;
                    const discountText = hasDiscount ? ` (ุฎุตู: ${product.discount_amount.toFixed(2)} ุฌ.ู)` : '';
                    const priceClass = hasDiscount ? 'text-green-600 font-bold' : '';
                    
                    return `
                      <tr class="hover:bg-gray-50 ${hasDiscount ? 'bg-green-50' : ''}">
                        <td class="border border-gray-300 p-3 font-mono text-sm">${product.product_code}</td>
                        <td class="border border-gray-300 p-3">
                          ${product.product_name}
                          ${hasDiscount ? '<span class="text-xs text-green-600 block">๐ธ ุชู ุชุทุจูู ุฎุตู</span>' : ''}
                        </td>
                        <td class="border border-gray-300 p-3 text-center font-bold">${product.quantity}</td>
                        <td class="border border-gray-300 p-3 text-center ${priceClass}">
                          ${hasDiscount ? `<div class="text-xs text-gray-500 line-through">${originalPrice.toFixed(2)} ุฌ.ู</div>` : ''}
                          ${product.price.toFixed(2)} ุฌ.ู${discountText}
                        </td>
                        <td class="border border-gray-300 p-3 text-center font-bold text-green-600">${product.total.toFixed(2)} ุฌ.ู</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
                <tfoot class="bg-gray-100">
                  <tr>
                    <td colspan="4" class="border border-gray-300 p-3 text-right font-bold">ุงูุฅุฌูุงูู ุงูููุงุฆู:</td>
                    <td class="border border-gray-300 p-3 text-center font-bold text-green-600 text-lg">${invoice.total.toFixed(2)} ุฌ.ู</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex gap-3 justify-end border-t pt-4">
            <button onclick="printInvoiceDetails('${invoiceNumber}')" 
                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
              ๐จ๏ธ ุทุจุงุนุฉ ุงููุงุชูุฑุฉ
            </button>
            <button onclick="this.closest('.fixed').remove()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
              โ ุฅุบูุงู
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modalDiv);
  }
  
  // Print invoice details function
  function printInvoiceDetails(invoiceNumber) {
    const invoice = allData.find(item => item.type === 'invoice' && item.invoice_number === invoiceNumber);
    // Compute robust total and payment amounts for this invoice.  Some older
    // records may not have total/payment fields, so fall back to calculating
    // the total from the invoiceProducts and default payment to 0 if needed.
    const invoiceTotalValue = (typeof invoice.total !== 'undefined' && invoice.total !== null)
      ? invoice.total
      : invoiceProducts.reduce((sum, p) => sum + (p.total || 0), 0);
    const paymentAmountValue = (typeof invoice.payment_amount !== 'undefined' && invoice.payment_amount !== null)
      ? invoice.payment_amount
      : 0;

    // Determine the remaining amount with a fallback for older records that
    // may lack a remaining_amount field.  If remaining_amount is undefined or
    // null, compute it from the computed total and the payment amount.
    const remaining = (typeof invoice.remaining_amount !== 'undefined' && invoice.remaining_amount !== null)
      ? invoice.remaining_amount
      : (invoiceTotalValue - paymentAmountValue);
    // Determine the display string for the remaining amount.  When the paid
    // amount is less than the total (remaining > 0) prefix with a minus sign.
    // Otherwise display the absolute value.
    const displayRemaining = remaining > 0
      ? '-' + remaining.toFixed(2)
      : Math.abs(remaining).toFixed(2);
    const invoiceProducts = allData.filter(item => 
      item.type === 'sale' && item.invoice_number === invoiceNumber
    );
    
    // Determine the creator name and role for printing. Some invoices may store
    // these fields under different names (creator_name, creator, created_by)
    // and the role may also be stored separately.  We fall back to blank
    // strings if not available.
    const creatorDisplayName = invoice.creator_name || invoice.creator || invoice.created_by || '';
    const creatorDisplayRole = invoice.creator_role || invoice.role || '';

    const printContent = `
      <!-- Ensure the print page uses A3 paper size and appropriate margins.  -->
      <style>
        @media print {
          @page {
            size: A3;
            margin: 1cm;
          }
          body {
            margin: 0;
          }
        }
      </style>
      <div style="font-family: Arial, sans-serif; direction: rtl; padding: 20px; max-width: 1000px; margin: 0 auto;">
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px;">
          <h1 style="color: #2563eb; margin: 0;">Solution ERP</h1>
          <h2 style="color: #374151; margin: 10px 0;">ูุงุชูุฑุฉ ุจูุน</h2>
          <p style="margin: 5px 0;"><strong>ุฑูู ุงููุงุชูุฑุฉ:</strong> ${invoice.invoice_number}</p>
          <p style="margin: 5px 0;"><strong>ุงูุชุงุฑูุฎ:</strong> ${new Date(invoice.date).toLocaleDateString('ar-EG')} - ${new Date(invoice.date).toLocaleTimeString('ar-EG')}</p>
        </div>
        
        <div style="margin-bottom: 30px;">
          <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 10px 0; color: #374151;">ูุนูููุงุช ุงููุงุชูุฑุฉ</h3>
            <p style="margin: 5px 0;"><strong>ุงุณู ุงูุนููู:</strong> ${invoice.customer_name}</p>
            ${invoice.customer_code ? `<p style="margin: 5px 0;"><strong>ููุฏ ุงูุนููู:</strong> ${invoice.customer_code}</p>` : ''}
            <p style="margin: 5px 0;"><strong>ุญุงูุฉ ุงููุงุชูุฑุฉ:</strong> ${invoice.status}</p>
            ${creatorDisplayName ? `<p style="margin: 5px 0;"><strong>ุงููุณุชุฎุฏู:</strong> ${creatorDisplayName}</p>` : ''}
            ${creatorDisplayRole ? `<p style="margin: 5px 0;"><strong>ุงูุตูุฉ:</strong> ${creatorDisplayRole}</p>` : ''}
          </div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
          <thead>
            <tr style="background-color: #e5e7eb;">
              <th style="border: 1px solid #d1d5db; padding: 12px; text-align: right;">ููุฏ ุงูููุชุฌ</th>
              <th style="border: 1px solid #d1d5db; padding: 12px; text-align: right;">ุงุณู ุงูููุชุฌ</th>
              <th style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">ุงููููุฉ</th>
              <th style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">ุณุนุฑ ุงููุญุฏุฉ</th>
              <th style="border: 1px solid #d1d5db; padding: 12px; text-align: center;">ุงูุฅุฌูุงูู</th>
            </tr>
          </thead>
          <tbody>
            ${invoiceProducts.map(product => `
              <tr>
                <td style="border: 1px solid #d1d5db; padding: 10px;">${product.product_code}</td>
                <td style="border: 1px solid #d1d5db; padding: 10px;">${product.product_name}</td>
                <td style="border: 1px solid #d1d5db; padding: 10px; text-align: center; font-weight: bold;">${product.quantity}</td>
                <td style="border: 1px solid #d1d5db; padding: 10px; text-align: center;">${product.price.toFixed(2)} ุฌ.ู</td>
                <td style="border: 1px solid #d1d5db; padding: 10px; text-align: center; font-weight: bold;">${product.total.toFixed(2)} ุฌ.ู</td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr style="background-color: #f9fafb;">
              <td colspan="4" style="border: 1px solid #d1d5db; padding: 12px; text-align: right; font-weight: bold;">ุงูุฅุฌูุงูู ุงูููุงุฆู:</td>
            <td style="border: 1px solid #d1d5db; padding: 12px; text-align: center; font-weight: bold; font-size: 18px; color: #059669;">${invoiceTotalValue.toFixed(2)} ุฌ.ู</td>
            </tr>
          </tfoot>
        </table>
        
        <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px;">
          <h3 style="margin: 0 0 15px 0; color: #374151;">ููุฎุต ุงููุฏููุนุงุช</h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span><strong>ุฅุฌูุงูู ุงููุงุชูุฑุฉ:</strong></span>
            <span style="font-weight: bold; color: #059669;">${invoiceTotalValue.toFixed(2)} ุฌ.ู</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span><strong>ุงููุจูุบ ุงููุฏููุน:</strong></span>
            <span style="font-weight: bold;">${paymentAmountValue.toFixed(2)} ุฌ.ู</span>
          </div>
          <div style="display: flex; justify-content: space-between; border-top: 1px solid #d1d5db; padding-top: 10px;">
            <span><strong>ุงููุจูุบ ุงููุชุจูู:</strong></span>
            <span style="font-weight: bold; color: ${remaining > 0 ? '#dc2626' : '#059669'};">${displayRemaining} ุฌ.ู</span>
          </div>
        </div>
        
        <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #d1d5db; color: #6b7280;">
          <p style="margin: 5px 0;">ุดูุฑุงู ูุชุนุงูููู ูุนูุง</p>
          <p style="margin: 5px 0; font-size: 12px;">Solution ERP - ูุธุงู ุฅุฏุงุฑุฉ ุงูุฃุนูุงู ุงููุชูุงูู</p>
        </div>
      </div>
    `;
    
    document.getElementById('print-content').innerHTML = printContent;
    window.print();
  }
  
  // Debug function
  function debugSystem() {
    console.log('=== ๐ง ุชุดุฎูุต ุดุงูู ูููุธุงู ===');
    console.log('1. ุนุฏุฏ ุงูุจูุงูุงุช ุงููุญููุธุฉ:', allData.length);
    console.log('2. ุงููุณุชุฎุฏู ุงูุญุงูู:', currentUser);
    console.log('3. ุนูุงุตุฑ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ:', currentInvoiceItems.length);
    console.log('4. ุญุงูุฉ ุชุณุฌูู ุงูุฏุฎูู:', isLoggedIn);
    console.log('6. ุชูุงุตูู ุงูุจูุงูุงุช:', allData.map(item => `${item.type}: ${item.id || 'no-id'}`));
    
    // Show comprehensive debug info to user
    const debugInfo = `๐ง ุชุดุฎูุต ุดุงูู ูููุธุงู:
๐ ุงูุจูุงูุงุช:
โข ุงูุจูุงูุงุช ุงููุญููุธุฉ: ${allData.length} ุนูุตุฑ
โข ุงูููุงุชูุฑ: ${allData.filter(item => item.type === 'invoice').length}
โข ุงููุจูุนุงุช: ${allData.filter(item => item.type === 'sale').length}
โข ุงููุดุชุฑูุงุช: ${allData.filter(item => item.type === 'purchase').length}
โข ุงูุฎุตููุงุช: ${allData.filter(item => item.type === 'discount').length}
๐ค ุงููุณุชุฎุฏู:
โข ุงูุงุณู: ${currentUser ? currentUser.fullName : 'ุบูุฑ ูุณุฌู'}
โข ุงูุฏูุฑ: ${currentUser ? currentUser.role : 'ุบูุฑ ูุญุฏุฏ'}
โข ุญุงูุฉ ุงูุฏุฎูู: ${isLoggedIn ? 'โ ูุณุฌู' : 'โ ุบูุฑ ูุณุฌู'}
๐ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ:
โข ุนุฏุฏ ุงูููุชุฌุงุช: ${currentInvoiceItems.length}
โข ุงูููุงุชูุฑ ุงููุนููุฉ: ${window.suspendedInvoices && Array.isArray(window.suspendedInvoices) ? window.suspendedInvoices.length : 0}
๐ ุญุงูุฉ ุงููุธุงู:
๐พ ุงููุธุงู ูุนูู ุจุดูู ุทุจูุนู - ุงูุจูุงูุงุช ูุญููุธุฉ ูุญููุงู
    `;
    
    showMessage(debugInfo, 'info');
  }
  
  // Utility functions
  function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    let bgColor = 'bg-red-500';
    if (type === 'success') bgColor = 'bg-green-500';
    else if (type === 'info') bgColor = 'bg-blue-500';
    
    messageDiv.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 max-w-md ${bgColor}`;
    messageDiv.style.whiteSpace = 'pre-line';
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
      messageDiv.remove();
    }, type === 'info' ? 8000 : 3000);
  }
  
  // Date and Time functions
  function updateDateTime() {
    const now = new Date();
    // Set a global ISO timestamp so that all modules can reference the same
    // date/time.  This variable is updated every second via
    // updateDateTime() and used when creating invoices, sales and
    // discounts to ensure consistent timestamps across related records.
    window.systemCurrentDateTimeISO = now.toISOString();
    const options = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      timeZone: 'Africa/Cairo'
    };
    
    const timeOptions = {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true,
      timeZone: 'Africa/Cairo'
    };
    
    const dayNames = ['ุงูุฃุญุฏ', 'ุงูุงุซููู', 'ุงูุซูุงุซุงุก', 'ุงูุฃุฑุจุนุงุก', 'ุงูุฎููุณ', 'ุงูุฌูุนุฉ', 'ุงูุณุจุช'];
    const monthNames = ['ููุงูุฑ', 'ูุจุฑุงูุฑ', 'ูุงุฑุณ', 'ุฃุจุฑูู', 'ูุงูู', 'ููููู', 'ููููู', 'ุฃุบุณุทุณ', 'ุณุจุชูุจุฑ', 'ุฃูุชูุจุฑ', 'ููููุจุฑ', 'ุฏูุณูุจุฑ'];
    
    const dayName = dayNames[now.getDay()];
    const monthName = monthNames[now.getMonth()];
    const date = `${now.getDate()} ${monthName} ${now.getFullYear()}`;
    const time = now.toLocaleTimeString('ar-EG', timeOptions);
    
    // Update login screen
    const loginDate = document.getElementById('login-current-date');
    const loginTime = document.getElementById('login-current-time');
    const loginDay = document.getElementById('login-day-name');
    
    if (loginDate) loginDate.textContent = date;
    if (loginTime) loginTime.textContent = time;
    if (loginDay) loginDay.textContent = dayName;
    
    // Update main system
    const mainDate = document.getElementById('main-current-date');
    const mainTime = document.getElementById('main-current-time');
    const mainDay = document.getElementById('main-day-name');
    
    if (mainDate) mainDate.textContent = date;
    if (mainTime) mainTime.textContent = time;
    if (mainDay) mainDay.textContent = dayName;
  }
  
  // Initialize app when page loads
  document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    updateAccountsDisplay(); // Initialize accounts display
    
    // Start date/time updates
    updateDateTime();
    setInterval(updateDateTime, 1000); // Update every second
    
    // ุฅุถุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ ูููุตุฑููุงุช
    setupExpenseEventListeners();
  });

  // ุนูุฏ ุฅุบูุงู ุฃู ุชุญุฏูุซ ุงูุตูุญุฉ ูุง ูููู ุจุชุณุฌูู ุงูุฎุฑูุฌ ุชููุงุฆูุงู.
  // ุชู ุชุนุทูู ุงูุณููู ุงูุงูุชุฑุงุถู ุงูุฐู ูุงู ูุณุฌู ููุช ุงูุฎุฑูุฌ ุชููุงุฆูุงู ุนูุฏ
  // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ุฃู ุฅุบูุงููุงุ ูุฃู ุงููุณุชุฎุฏู ูุฑูุฏ ุชุณุฌูู ููุช ุงูุฎุฑูุฌ
  // ููุท ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ ยซุฎุฑูุฌยป. ูุจุงูุชุงูู ูุฅู ุญุฏุซ beforeunload ูุง
  // ููุชุจ ููุช ุงูุฎุฑูุฌ ูู ุณุฌู ุชุณุฌููุงุช ุงูุฏุฎูู.
  window.addEventListener('beforeunload', function() {
    try {
      // Only autoโrecord a logout time if the user has not clicked the
      // manual "ุฎุฑูุฌ" button.  This prevents adding a logout time
      // prematurely while still ensuring sessions are closed when the
      // browser is refreshed or closed unexpectedly.
      if (!manualLogout && currentUser && currentUser.username) {
        // ุณุฌู ุงูุฎุฑูุฌ ููุฌูุณุฉ ุงูุญุงููุฉ ุจุฏูู ุงูุชุธุงุฑ ุงูุญูุธ
        logLogout(currentUser.username, false);
      }
    } catch (_) {
      // ุชุฌุงูู ุฃู ุฎุทุฃ ูุฏ ูุญุฏุซ ุฃุซูุงุก ุชุณุฌูู ุงูุฎุฑูุฌ ุงูุชููุงุฆู
    }
    // Reset the manual flag so it applies only once per logout event
    manualLogout = false;
  });
  
  function setupExpenseEventListeners() {
    // ูุณุชูุน ุชุบููุฑ ููุน ุงููุตุฑูู
    const expenseTypeSelect = document.getElementById('expense-type');
    if (expenseTypeSelect) {
      expenseTypeSelect.addEventListener('change', function() {
        updateExpensePreview();
        
        // ุฅุฒุงูุฉ ุฑุณุงูุฉ ุงูุฎุทุฃ ุนูุฏ ุงูุงุฎุชูุงุฑ
        if (this.value) {
          document.getElementById('expense-type-error').classList.add('hidden');
          this.classList.remove('border-red-500');
        }
      });
    }
    
    // ูุณุชูุน ุชุบููุฑ ูุจูุบ ุงููุตุฑูู
    const expenseAmountInput = document.getElementById('expense-amount');
    if (expenseAmountInput) {
      expenseAmountInput.addEventListener('input', function() {
        validateExpenseAmount(this);
      });
      
      expenseAmountInput.addEventListener('blur', function() {
        // ุชูุณูู ุงููุจูุบ ุนูุฏ ููุฏุงู ุงูุชุฑููุฒ
        const amount = parseFloat(this.value);
        if (amount > 0) {
          this.value = amount.toFixed(2);
          updateExpensePreview();
        }
      });
    }
    
    // ูุณุชูุน ุชุบููุฑ ูุตู ุงููุตุฑูู
    const expenseDescriptionInput = document.getElementById('expense-description');
    if (expenseDescriptionInput) {
      expenseDescriptionInput.addEventListener('input', function() {
        updateExpensePreview();
        
        // ุนุฑุถ ุนุฏุงุฏ ุงูุฃุญุฑู
        const remaining = 200 - this.value.length;
        const label = this.previousElementSibling;
        if (remaining < 20) {
          label.innerHTML = `ุงููุตู (ุงุฎุชูุงุฑู) - <span class="text-orange-600">ูุชุจูู: ${remaining} ุญุฑู</span>`;
        } else {
          label.textContent = 'ุงููุตู (ุงุฎุชูุงุฑู)';
        }
      });
    }
    
    console.log('โ ุชู ุฅุนุฏุงุฏ ูุณุชูุนู ุฃุญุฏุงุซ ุงููุตุฑููุงุช');
  }
  
  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // F6 - Suspend current invoice
    if (e.key === 'F6') {
      e.preventDefault();
      if (isLoggedIn && currentUser.permissions.includes('pending')) {
        suspendCurrentInvoice();
      }
    }
    
    // F7 - Open pending invoices
    if (e.key === 'F7') {
      e.preventDefault();
      if (isLoggedIn && currentUser.permissions.includes('pending')) {
        showSection('pending');
      }
    }
  });
  
  // Search functionality
document.getElementById('product-search').addEventListener('input', function(e) {
    const searchTerm = e.target.value.trim();
    // ุฅุฐุง ุชุทุงุจู ูุตุทูุญ ุงูุจุญุซ ุชูุงูุงู ูุน ููุฏ ุงูููุชุฌ ุฃู ุงุณููุ ูู ุจุฅุถุงูุฉ ุงูููุชุฌ ูุจุงุดุฑุฉ
    // ุฅูู ุงููุงุชูุฑุฉ ุฏูู ุงูุญุงุฌุฉ ูุงุฎุชูุงุฑ ูู ูุงุฆูุฉ ุงููุชุงุฆุฌ. ูุชุญูู ูู ุชููุฑ ุฑุตูุฏ
    // ุงูููุชุฌ ูุจู ุฅุถุงูุชู. ูุชู ุงุณุชุฎุฏุงู calculateInventory() ููุญุตูู ุนูู ุงููุฎุฒูู ุงูุญุงูู.
    if (searchTerm) {
      try {
        const inventory = calculateInventory();
        const exactProduct = Object.values(inventory).find(prod =>
          (prod.code && prod.code.toLowerCase() === searchTerm.toLowerCase()) ||
          (prod.name && prod.name.toLowerCase() === searchTerm.toLowerCase())
        );
        if (exactProduct && exactProduct.availableStock > 0) {
          // ุญุฏุฏ ุงูููุชุฌ ููู ุจุฅุถุงูุชู ูุจุงุดุฑุฉ ุฅูู ุงููุงุชูุฑุฉ
          selectProduct(exactProduct.code, exactProduct.name, exactProduct.salePrice, exactProduct.availableStock);
          setTimeout(() => { addToInvoice(); }, 0);
          return;
        }
      } catch (err) {
        console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ูุญุงููุฉ ุฅุถุงูุฉ ุงูููุชุฌ ุชููุงุฆูุงู:', err);
      }
    }
    // ุฅุฐุง ูู ููู ููุงู ุชุทุงุจู ุชุงูุ ุงุนุฑุถ ุงููุชุงุฆุฌ ุงููุทุงุจูุฉ ุฌุฒุฆูุงู ุจุงูุทุฑููุฉ ุงูุนุงุฏูุฉ
    searchProducts(searchTerm);
  });
  
  // Update search when out-of-stock checkbox changes
  document.getElementById('search-out-of-stock').addEventListener('change', function() {
    const searchTerm = document.getElementById('product-search').value.trim();
    if (searchTerm) {
      searchProducts(searchTerm);
    }
  });
  
  document.getElementById('product-search').addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      hideSearchResults();
    }
  });
  
  // Hide search results when clicking outside
  document.addEventListener('click', function(e) {
    const searchContainer = document.getElementById('product-search').parentElement;
    if (!searchContainer.contains(e.target)) {
      hideSearchResults();
    }
  });
  
  // Auto-calculate when price or quantity changes
  document.getElementById('product-price').addEventListener('input', calculateRemaining);
  document.getElementById('product-quantity').addEventListener('input', function() {
    calculateRemaining();
    // ุชุญุฏูุซ ูุนูููุงุช ุงูููุชุฌ ุนูุฏ ุชุบููุฑ ุงููููุฉ
    if (selectedProduct) {
      updateSelectedProductInfo();
    }
  });
  document.getElementById('paid-amount').addEventListener('input', calculateRemaining);
  
  // Auto-calculate net salary when employee salary fields change
  document.getElementById('employee-salary').addEventListener('input', calculateNetSalary);
  document.getElementById('employee-late-deductions').addEventListener('input', calculateNetSalary);
  document.getElementById('employee-penalties').addEventListener('input', calculateNetSalary);
</script>
<!-- Modal for suspended invoices list (moved outside of login-screen so it remains accessible after login) -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="suspended-invoices-modal">
<div class="bg-white p-4 rounded-lg shadow-lg max-h-96 overflow-y-auto w-96">
<h3 class="text-lg font-bold mb-4">๐ ุงูููุงุชูุฑ ุงููุนููุฉ</h3>
<!-- Suspended invoices buttons will be dynamically injected here -->
<div class="space-y-2" id="suspended-invoices-list"></div>
<button class="mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg w-full" onclick="closeSuspendedInvoicesModal()">ุฅุบูุงู</button>
</div>
</div>
<!-- Script to enable searching invoices by their number. When the user enters
     a search term or clicks the search button, the invoices table will be
     filtered to show only rows whose invoice number includes the term. -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const invoiceSearchInput = document.getElementById('invoice-search-input');
  const invoiceSearchBtn = document.getElementById('invoice-search-btn');
  function filterInvoicesTable() {
    const termRaw = invoiceSearchInput && invoiceSearchInput.value ? invoiceSearchInput.value : '';
    const term = termRaw.trim().toLowerCase();
    const rows = document.querySelectorAll('#invoices-list tr');
    rows.forEach(function(row) {
      const cells = row.querySelectorAll('td');
      // Show placeholder row only when search term is empty
      if (cells.length === 1) {
        row.style.display = term ? 'none' : '';
        return;
      }
      const invoiceNumber = (cells[0].textContent || '').trim().toLowerCase();
      if (!term) {
        row.style.display = '';
      } else if (invoiceNumber.includes(term)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }
  if (invoiceSearchBtn) {
    invoiceSearchBtn.addEventListener('click', filterInvoicesTable);
  }
  if (invoiceSearchInput) {
    invoiceSearchInput.addEventListener('input', function() {
      // If input is cleared, reset the table
      if (!invoiceSearchInput.value) {
        filterInvoicesTable();
      }
    });
  }
});
</script>
<!-- ูุงูุฐุฉ ุชูุฑูุฑ ุงูุนููุงุก. ุชุธูุฑ ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุชูุฑูุฑ" ูู ูุณู ุงูุนููุงุก ูุชุณูุญ
ููุจุญุซ ุนู ุนููู ูุนุฑุถ ุชูุงุตููู ูุฌููุน ุงูููุงุชูุฑ ุงูุฎุงุตุฉ ุจู. -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="customer-report-modal">
<div class="bg-white rounded-lg p-6 w-full max-w-3xl shadow-lg">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-bold">ุชูุฑูุฑ ุงูุนููู</h3>
<button class="text-gray-500 hover:text-gray-700 text-2xl" onclick="closeCustomerReportModal()" type="button">ร</button>
</div>
<div class="mb-4 relative">
<input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="customer-report-search" placeholder="ุงุจุญุซ ุจุงุณู ุงูุนููู ุฃู ุงูููุฏ..." type="text"/>
<div class="search-dropdown hidden absolute left-0 right-0 mt-1 z-50 bg-white border border-gray-300 rounded-lg overflow-auto max-h-60" id="customer-report-search-results"></div>
</div>
<div class="max-h-96 overflow-y-auto" id="customer-report-content"></div>
</div>
</div>
<!-- Custom script for customer search, synchronization, and manual customer management -->
<script>
// Ensure the manualCustomers array exists on the window object.  Previously this
// block also injected a hardโcoded default customer ("ูุญูุฏ ุนูู") every time
// the page loaded, which caused the customer to reappear after being deleted.
// The default customer seeding has been removed to prevent unwanted record
// recreation.  If you need to add initial customers, do so via a controlled
// migration or explicit user action rather than automatic injection.
if (!window.manualCustomers) {
  window.manualCustomers = [];
}

    /**
     * Load the list of manual customers from Firebase and store it on
     * `window.manualCustomers`.  The ERP stores customer metadata (e.g.
     * total purchases, debt, last purchase date) under the `erpCustomers`
     * node.  On page load this array is empty, which causes manually
     * added customers to disappear after a refresh.  This helper fetches
     * the persisted customers and normalizes the property names so that
     * the UI can display them seamlessly alongside invoiceโderived
     * customers.  If the node does not exist or an error occurs, the
     * function silently leaves `window.manualCustomers` unchanged.
     */
    async function loadManualCustomersFromFirebase() {
      try {
        const snap = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpCustomers'));
        if (snap && snap.exists()) {
          const remoteCustomers = snap.val() || [];
          if (Array.isArray(remoteCustomers)) {
            window.manualCustomers = remoteCustomers.map(function (c) {
              if (!c) return { name: '', code: '', invoiceCount: 0, totalPurchases: 0, totalDebt: 0, lastPurchase: '' };
              return {
                name: c.customer_name || c.name || '',
                code: c.customer_code || c.code || '',
                invoiceCount: c.invoiceCount != null ? c.invoiceCount : (c.totalInvoices != null ? c.totalInvoices : 0),
                totalPurchases: c.total_purchases != null ? c.total_purchases : (c.totalPurchases != null ? c.totalPurchases : 0),
                totalDebt: c.total_remaining != null ? c.total_remaining : (c.totalDebt != null ? c.totalDebt : 0),
                lastPurchase: c.lastPurchase || c.last_purchase || ''
              };
            });
          }
        }
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ุงูุนููุงุก ูู Firebase:', err);
      }
    }

  /**
   * Display a confirmation dialog for deleting a customer.  This
   * replicates the UI used for employee deletion.  When confirmed,
   * it calls deleteCustomer with skipPrompt set to true so that no
   * additional browser confirm appears.  Deletion of a customer
   * removes all associated invoices and sales.
   *
   * @param {string} code ุงูููุฏ ุงูุฎุงุต ุจุงูุนููู
   * @param {string} name ุงุณู ุงูุนููู
   */
  function deleteCustomerPopup(code, name) {
    const customerName = name || code || '';
    // Create overlay
    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    confirmDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md">
        <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุงูุญุฐู</h3>
        <p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุนููู \"${customerName}\"ุ ุณูุชู ุญุฐู ุฌููุน ุงูููุงุชูุฑ ูุงููุจูุนุงุช ุงูุฎุงุตุฉ ุจู.</p>
        <div class="flex gap-3 justify-end">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">ุฅูุบุงุก</button>
          <button onclick="deleteCustomer('${code}', '${name}', true); this.parentElement.parentElement.parentElement.remove()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">ุญุฐู</button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  }

  /**
   * Display a confirmation dialog for deleting all customers.  When
   * confirmed, it calls confirmDeleteAllCustomers with skipPrompt
   * set to true to avoid a second browser confirmation.
   */
  function deleteAllCustomersPopup() {
    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    confirmDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md">
        <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุงูุญุฐู</h3>
        <p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูุนููุงุก ูุฌููุน ููุงุชูุฑูู ููุจูุนุงุชููุ</p>
        <div class="flex gap-3 justify-end">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">ุฅูุบุงุก</button>
          <button onclick="confirmDeleteAllCustomers(true); this.parentElement.parentElement.parentElement.remove()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">ุญุฐู</button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  }

  /**
   * Display a confirmation dialog for deleting all purchases. When confirmed,
   * it calls confirmDeleteAllPurchases with skipPrompt set to true.
   */
  function deleteAllPurchasesPopup() {
    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    confirmDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md">
        <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุงูุญุฐู</h3>
        <p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูููุชุฌุงุช ูู ุงููุดุชุฑูุงุชุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
        <div class="flex gap-3 justify-end">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">ุฅูุบุงุก</button>
          <button onclick="confirmDeleteAllPurchases(true); this.parentElement.parentElement.parentElement.remove()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">ุญุฐู</button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  }

  /**
   * Delete all employees after confirmation.  Removes all records of type
   * 'employee' from allData and persists the changes to Firebase.  If
   * skipPrompt is false, displays a browser confirm dialog before
   * proceeding; otherwise, deletion occurs immediately (used by the
   * custom modal).
   */
  async function confirmDeleteAllEmployees(skipPrompt) {
    if (!skipPrompt) {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูููุธูููุ')) {
        return;
      }
    }
    // Remove all employee records
    allData = allData.filter(item => item.type !== 'employee');
    // Pause the autoโsync timer to prevent a concurrent sync from
    // overwriting the deletion with stale data
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    // Persist changes and reload if the save succeeds.  This ensures that
    // cloud data is only reloaded when the deletion was committed.
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุฌููุน ุงูููุธููู:', err);
    }
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุฌููุน ุงูููุธููู:', err);
      }
    }
    // Resume the autoโsync timer if it was previously active
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
    // Refresh UI
    updateAllDisplays();
    showMessage('๐๏ธ ุชู ุญุฐู ุฌููุน ุงูููุธููู ุจูุฌุงุญ', 'success');
  }

  /**
   * Show a confirmation modal for deleting all employees.  On
   * confirmation it calls confirmDeleteAllEmployees with skipPrompt
   * set to true.  The modal uses the same design as other delete
   * confirmations.
   */
  function deleteAllEmployeesPopup() {
    const confirmDiv = document.createElement('div');
    confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    confirmDiv.innerHTML = `
      <div class="bg-white p-6 rounded-lg max-w-md">
        <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุงูุญุฐู</h3>
        <p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูููุธูููุ</p>
        <div class="flex gap-3 justify-end">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">ุฅูุบุงุก</button>
          <button onclick="confirmDeleteAllEmployees(true); this.parentElement.parentElement.parentElement.remove()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">ุญุฐู</button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmDiv);
  }
// NOTE: default customer seeding removed here

/**
 * Normalize Arabic digits to Western numerals.  This helper takes a string and
 * returns a new string with Arabic-Indic digits (ููกูขูฃูคูฅูฆูงูจูฉ) replaced by
 * their Western equivalents (0123456789).  It is used for consistent
 * comparisons when searching for customer codes.
 * @param {string} str
 * @returns {string}
 */
function normalizeDigits(str) {
  const arabicDigits = 'ููกูขูฃูคูฅูฆูงูจูฉ';
  const westernDigits = '0123456789';
  return String(str).replace(/[ู-ูฉ]/g, d => westernDigits[arabicDigits.indexOf(d)]);
}

/**
 * Generate a random customer code that does not clash with existing codes.
 * Scans both the manualCustomers array and existing invoice customer codes
 * stored in allData. The returned code is a 5โdigit string.
 * @returns {string}
 */
function generateUniqueCustomerCode() {
  const existing = new Set();
  // Collect codes from manually added customers
  if (Array.isArray(window.manualCustomers)) {
    window.manualCustomers.forEach(c => {
      if (c.code) {
        existing.add(String(normalizeDigits(c.code)));
      }
    });
  }
  // Collect codes from invoices
  try {
    if (Array.isArray(allData)) {
      allData.forEach(item => {
        if (item.type === 'invoice' && item.customer_code) {
          existing.add(String(normalizeDigits(item.customer_code)));
        }
      });
    }
  } catch (_) {
    // ignore errors reading allData
  }
  let code;
  do {
    code = String(Math.floor(Math.random() * 90000) + 10000);
  } while (existing.has(code));
  return code;
}

document.addEventListener('DOMContentLoaded', function() {
  // Grab references to the customer inputs in both the customers section and the sales invoice section
  const customersNameInput = document.getElementById('customers-customer-name');
  const customersCodeInput = document.getElementById('customers-customer-code');
  const salesNameInput = document.getElementById('customer-name');
  const salesCodeInput = document.getElementById('customer-code');
  const customerSearchInput = document.getElementById('customer-search');
  const customerSearchResults = document.getElementById('customer-search-results');
  const addCustomerBtn = document.getElementById('add-customer-btn');

  // If any of the elements are missing, do nothing
  if (!customersNameInput || !customersCodeInput || !salesNameInput || !salesCodeInput) {
    return;
  }

  /**
   * Synchronize the value between two paired inputs.  If the event originates
   * from the customers section, update the corresponding field in the sales
   * invoice section, and vice versa.  This ensures that the customer name and
   * code remain in sync across both sections.
   *
   * @param {Event} e
   */
  // Flags to prevent infinite recursion when syncing fields. When we
  // programmatically set the value of the paired input, another
  // `input` event is fired which would normally call the sync
  // function again. Wrapping updates with these flags ensures that
  // only userโinitiated changes trigger synchronization.
  let isSyncingName = false;
  let isSyncingCode = false;

  function syncName(e) {
    // If we are already syncing names, do nothing to break the loop
    if (isSyncingName) return;
    isSyncingName = true;
    const value = e.target.value;
    if (e.target === customersNameInput) {
      // Only update the other input if its value differs to avoid
      // unnecessarily firing another event
      if (salesNameInput.value !== value) {
        salesNameInput.value = value;
      }
    } else if (e.target === salesNameInput) {
      if (customersNameInput.value !== value) {
        customersNameInput.value = value;
      }
    }
    isSyncingName = false;
  }

  function syncCode(e) {
    if (isSyncingCode) return;
    isSyncingCode = true;
    const value = e.target.value;
    if (e.target === customersCodeInput) {
      if (salesCodeInput.value !== value) {
        salesCodeInput.value = value;
      }
    } else if (e.target === salesCodeInput) {
      if (customersCodeInput.value !== value) {
        customersCodeInput.value = value;
      }
    }
    isSyncingCode = false;
  }

  customersNameInput.addEventListener('input', syncName);
  salesNameInput.addEventListener('input', syncName);
  customersCodeInput.addEventListener('input', syncCode);
  salesCodeInput.addEventListener('input', syncCode);

  /**
   * Attempt to add a new manual customer based on the current values of the
   * sales invoice name and code fields.  A new customer will only be added
   * when both fields are non-empty and the customer does not already exist
   * in either the invoice-derived list or the manualCustomers array.
   */
  function maybeAddManualCustomer() {
    const name = salesNameInput.value.trim();
    // allow the code to be reassigned if missing
    let code = salesCodeInput.value.trim();
    // If the name is empty, do nothing
    if (!name) return;
    // Auto generate a random code when the user leaves the code field empty.
    if (!code) {
      code = generateUniqueCustomerCode();
      // Populate both the sales invoice and customer management fields with the generated code
      salesCodeInput.value = code;
      if (typeof customersCodeInput !== 'undefined' && customersCodeInput) {
        customersCodeInput.value = code;
      }
    }
    // Normalize digits for comparison
    const normalizedCode = normalizeDigits(code);
    // Check if this customer exists in manualCustomers
    const existsInManual = window.manualCustomers.some(c => {
      if (c.code && String(normalizeDigits(c.code)) !== '') {
        return String(normalizeDigits(c.code)) === normalizedCode || c.name === name;
      }
      return c.name === name;
    });
    // Check if this customer exists in invoices (allData is the main dataset)
    let existsInInvoices = false;
    try {
      existsInInvoices = Array.isArray(allData) && allData.some(item => {
        if (item.type === 'invoice') {
          // Normalize digits in stored codes as well
          const invoiceCode = item.customer_code ? normalizeDigits(item.customer_code) : '';
          return (invoiceCode && invoiceCode === normalizedCode) || item.customer_name === name;
        }
        return false;
      });
    } catch (_) {}
    if (!existsInManual && !existsInInvoices) {
      // ุนูุฏ ุฅูุดุงุก ุนููู ูุฏูู ุจุฏูู ููุงุชูุฑุ ุงุณุชุฎุฏู ุงูุชุงุฑูุฎ ุงูุญุงูู ูุขุฎุฑ ุนูููุฉ ุดุฑุงุก
      // ุญุชู ูุธูุฑ ุงูุนููู ุงูุฌุฏูุฏ ูู ุฃุนูู ุงูุฌุฏูู ุนูุฏ ุงููุฑุฒ.  ูุฐุง ุงูุญูู
      // ุณูุชู ุงุณุชุจุฏุงูู ุจุขุฎุฑ ุนูููุฉ ุดุฑุงุก ูุนููุฉ ุนูุฏูุง ุชุชู ุฅุถุงูุฉ ูุงุชูุฑุฉ.
      window.manualCustomers.push({
        name: name,
        code: code,
        invoiceCount: 0,
        totalPurchases: 0,
        totalDebt: 0,
        lastPurchase: new Date().toISOString()
      });
      // Refresh the customers display to show the newly added customer
      if (typeof updateCustomersDisplay === 'function') {
        updateCustomersDisplay();
      }
    }
  }
  // Add new manual customer when the user leaves the customer code field in either section
  salesCodeInput.addEventListener('change', maybeAddManualCustomer);
  customersCodeInput.addEventListener('change', maybeAddManualCustomer);

  /**
   * Filter the customers table based on the search input.  The search is
   * case-insensitive and also normalizes Arabic-Indic digits to ensure that
   * searching for "9" or "ูฉ" yields the same results.  Rows that do not
   * match the search term will be hidden.
   */
  function filterCustomerTable() {
    const termRaw = (customerSearchInput && customerSearchInput.value) || '';
    const term = normalizeDigits(termRaw).trim().toLowerCase();
    const rows = document.querySelectorAll('#customers-list tr');
    rows.forEach(row => {
      // If this is the placeholder row (no customers), always show it
      if (row.querySelectorAll('td').length === 1) {
        row.style.display = term ? 'none' : '';
        return;
      }
      const rowText = normalizeDigits(row.textContent || '').toLowerCase();
      if (!term) {
        row.style.display = '';
      } else if (rowText.includes(term)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  /**
   * Build a predictive drop-down based on the current search term.  Suggestions
   * are drawn from both manual customers and invoice-derived customers.  The
   * drop-down is shown only when there are matches for the search term.
   */
  function updateCustomerSearchSuggestions() {
    if (!customerSearchInput || !customerSearchResults) return;
    const termRaw = customerSearchInput.value || '';
    const term = normalizeDigits(termRaw).trim().toLowerCase();
    // Reset suggestions
    customerSearchResults.innerHTML = '';
    if (!term) {
      customerSearchResults.classList.add('hidden');
      return;
    }
    // Collect suggestions from manual customers
    let suggestions = [];
    if (window.manualCustomers && Array.isArray(window.manualCustomers)) {
      window.manualCustomers.forEach(c => {
        suggestions.push({ name: c.name || '', code: c.code || '' });
      });
    }
    // Collect suggestions from invoices (allData)
    try {
      if (Array.isArray(allData)) {
        allData.forEach(item => {
          if (item.type === 'invoice') {
            const name = item.customer_name || '';
            const code = item.customer_code || '';
            suggestions.push({ name, code });
          }
        });
      }
    } catch (_) {}
    // Remove duplicate suggestions based on name and normalized code
    const unique = [];
    const seen = new Set();
    suggestions.forEach(s => {
      const key = `${s.name}::${normalizeDigits(s.code || '')}`;
      if (!seen.has(key)) {
        seen.add(key);
        unique.push(s);
      }
    });
    // Filter suggestions using the search term
    const filtered = unique.filter(s => {
      const combined = normalizeDigits(`${s.name} ${s.code || ''}`).toLowerCase();
      return combined.includes(term);
    });
    if (filtered.length === 0) {
      customerSearchResults.classList.add('hidden');
      return;
    }
    // Populate the drop-down with up to 10 suggestions
    filtered.slice(0, 10).forEach(s => {
      const div = document.createElement('div');
      div.className = 'search-item';
      div.dataset.name = s.name;
      div.dataset.code = s.code || '';
      div.innerHTML = `${s.name}${s.code ? ' <span class="text-gray-500 text-xs">(' + s.code + ')</span>' : ''}`;
      div.addEventListener('click', function() {
        // Fill search input and customer fields
        customerSearchInput.value = s.name;
        customersNameInput.value = s.name;
        customersCodeInput.value = s.code || '';
        // Sync sales invoice fields
        salesNameInput.value = s.name;
        salesCodeInput.value = s.code || '';
        // Hide suggestions
        customerSearchResults.classList.add('hidden');
        // Also filter the customers table based on selected name
        filterCustomerTable();
      });
      customerSearchResults.appendChild(div);
    });
    customerSearchResults.classList.remove('hidden');
  }

  // Hide the suggestions drop-down when clicking outside of it or the search input
  document.addEventListener('click', function(event) {
    if (!customerSearchResults) return;
    const target = event.target;
    if (target === customerSearchInput || customerSearchResults.contains(target)) {
      return;
    }
    customerSearchResults.classList.add('hidden');
  });

  // Attach the search input event to both filter the table and update suggestions
  if (customerSearchInput) {
    customerSearchInput.addEventListener('input', function() {
      filterCustomerTable();
      updateCustomerSearchSuggestions();
    });
  }

  /**
   * Add a customer from the management section.  Uses the values from the
   * customersNameInput and customersCodeInput fields.  Performs the same
   * duplicate checks as maybeAddManualCustomer() but without relying on the
   * sales invoice inputs.  This function is bound to the "ุฅุถุงูุฉ ุนููู" button.
   */
  function addCustomerFromManagementSection() {
    const name = customersNameInput.value.trim();
    // allow the code to be reassigned if missing
    let code = customersCodeInput.value.trim();
    // If the name is missing, alert the user and abort the operation
    if (!name) {
      if (typeof showMessage === 'function') {
        showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู', 'error');
      }
      return;
    }
    // Auto generate a random code when the field is empty
    if (!code) {
      code = generateUniqueCustomerCode();
      // Fill both management and sales code fields with the generated code
      customersCodeInput.value = code;
      if (typeof salesCodeInput !== 'undefined' && salesCodeInput) {
        salesCodeInput.value = code;
      }
    }
    const normalizedCode = normalizeDigits(code);
    // Check in manual customers
    const existsInManual = window.manualCustomers.some(c => {
      const cCode = c.code ? normalizeDigits(c.code) : '';
      if (cCode) {
        return cCode === normalizedCode || c.name === name;
      }
      return c.name === name;
    });
    // Check in invoice-derived customers
    let existsInInvoices = false;
    try {
      existsInInvoices = Array.isArray(allData) && allData.some(item => {
        if (item.type === 'invoice') {
          const invoiceCode = item.customer_code ? normalizeDigits(item.customer_code) : '';
          return (invoiceCode && invoiceCode === normalizedCode) || item.customer_name === name;
        }
        return false;
      });
    } catch (_) {}
    if (!existsInManual && !existsInInvoices) {
      // ุนูุฏ ุฅุถุงูุฉ ุนููู ูู ูุณู ุงูุฅุฏุงุฑุฉุ ูู ุจุชุนููู lastPurchase ุฅูู ุงูุชุงุฑูุฎ ุงูุญุงูู
      // ุจุญูุซ ููุธูุฑ ุงูุฌุฏูู ุงูุนููู ุงูุฃุญุฏุซ ุฃููุงู.  ุฅุฐุง ูุงู ูุฐุง ุงูุนููู ุจุนูููุฉ
      // ุดุฑุงุก ูุงุญูุงูุ ุณูุชู ุชุญุฏูุซ lastPurchase ุฅูู ุชุงุฑูุฎ ุงููุงุชูุฑุฉ.
      window.manualCustomers.push({
        name: name,
        code: code,
        invoiceCount: 0,
        totalPurchases: 0,
        totalDebt: 0,
        lastPurchase: new Date().toISOString()
      });
      // ุชุญุฏูุซ ูุณู ุงูุนููุงุก ููุฑุงู ุญุชู ูุฑู ุงููุณุชุฎุฏู ุงูุนููู ุงูุฌุฏูุฏ ุจุฏูู ุงูุชุธุงุฑ ุงููุฒุงููุฉ ุงููุงููุฉ
      try {
        if (typeof updateCustomersDisplay === 'function') {
          updateCustomersDisplay();
        }
        // ูุฐููุ ุญุฏุซ ูู ุงูุฃูุณุงู ุงูุฃุฎุฑู (ูุซู ุงูููุงุชูุฑ ูุงููุฎุฒูู) ูุถูุงู ุงูุชุฒุงูู
        if (typeof updateAllDisplays === 'function') {
          updateAllDisplays();
        }
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูุนุฑูุถ ุจุนุฏ ุฅุถุงูุฉ ุงูุนููู:', err);
      }
      // ุญูุธ ูุงุฆูุฉ ุงูุนููุงุก ุงูุฌุฏูุฏุฉ ูู Firebase. ุฎูุงู ุงูุญูุธุ ูููู ูุคูุชุงู ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ
      // ูููุน ุงููุชุงุจุฉ ุงููุชุฒุงููุฉ. ุจุนุฏ ุงูุญูุธ ูุฅุนุงุฏุฉ ุงูุชุญูููุ ูุณุชุนูุฏ ุงููุคูุช ุฅุฐุง ูุงู ูุดุทุงู.
      (async () => {
        const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
        if (wasAutoSyncActive) {
          clearInterval(window.autoSyncTimer);
          window.autoSyncTimer = null;
        }
        let saveSucceeded = false;
        try {
          await saveDataToFirebase();
          saveSucceeded = true;
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุจูุงูุงุช ุงูุนููุงุก ุจุนุฏ ุฅุถุงูุฉ ุนููู ูุฏูู:', err);
        }
        if (saveSucceeded) {
          try {
            await loadDataFromFirebase();
          } catch (err) {
            console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ุจูุงูุงุช ุงูุนููุงุก ุจุนุฏ ุงูุฅุถุงูุฉ:', err);
          }
        }
        if (wasAutoSyncActive) {
          window.autoSyncTimer = setInterval(() => {
            Promise.resolve(backgroundSync());
          }, 5000);
        }
        // ุชุญุฏูุซ ุงูุนุฑูุถ ููุชุฃูุฏ ูู ุงูุนูุงุณ ุงูุชุบููุฑุงุช ูู ูู ุงูุฃูุณุงู ุจุนุฏ ุงูุงูุชูุงุก ูู ุงููุฒุงููุฉ
        try {
          if (typeof updateAllDisplays === 'function') {
            updateAllDisplays();
          }
        } catch (err) {
          console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูุนุฑูุถ ุจุนุฏ ูุฒุงููุฉ ุงูุนููุงุก:', err);
        }
      })();
    }
    // Clear the input fields and hide suggestions
    customersNameInput.value = '';
    customersCodeInput.value = '';
    customerSearchInput.value = '';
    if (customerSearchResults) customerSearchResults.classList.add('hidden');
    filterCustomerTable();
  }

  // Bind the add button click event
  if (addCustomerBtn) {
    addCustomerBtn.addEventListener('click', addCustomerFromManagementSection);
  }
});
</script>
<script>
function updatePurchasesList() {
  const purchases = allData.filter(item => item.type === 'purchase');
  const tbody = document.getElementById('purchases-list');
  if (!tbody) return;

  if (purchases.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุดุชุฑูุงุช ูุณุฌูุฉ</td></tr>';
    return;
  }

  tbody.innerHTML = purchases.map(purchase => `
    <tr class="hover:bg-gray-50">
      <td class="border border-gray-300 p-3">${new Date(purchase.date).toLocaleDateString('ar-EG')}</td>
      <td class="border border-gray-300 p-3 font-medium">${purchase.product_name || ''}</td>
      <td class="border border-gray-300 p-3">${purchase.supplier || ''}</td>
      <td class="border border-gray-300 p-3">${purchase.quantity || 0}</td>
      <td class="border border-gray-300 p-3">${
        (typeof purchase.purchase_price === 'number' && isFinite(purchase.purchase_price) ? purchase.purchase_price : 0).toFixed(2)
      } ุฌ.ู</td>
      <td class="border border-gray-300 p-3 font-bold text-green-600">${
        (typeof purchase.total === 'number' && isFinite(purchase.total) ? purchase.total : 0).toFixed(2)
      } ุฌ.ู</td>
    </tr>
  `).join('');
}

// Legacy duplicate of addPurchase for backward compatibility. Renamed to avoid overriding the primary implementation.
function addPurchaseLegacy() {
  const name = document.getElementById('purchase-product-name').value.trim();
  const code = document.getElementById('purchase-product-code').value.trim();
  const supplier = document.getElementById('purchase-supplier').value.trim();
  const quantity = parseFloat(document.getElementById('purchase-quantity').value) || 0;
  const price = parseFloat(document.getElementById('purchase-price').value) || 0;
  const salePrice = parseFloat(document.getElementById('purchase-sale-price').value) || 0;

  if (!name || !supplier || quantity <= 0 || price <= 0) {
    alert('ูุฑุฌู ุฅุฏุฎุงู ุฌููุน ุงูุจูุงูุงุช ุงููุทููุจุฉ ุจุดูู ุตุญูุญ');
    return;
  }

  const purchase = {
    id: Date.now(),
    date: new Date().toISOString(),
    type: 'purchase',
    product_name: name,
    product_code: code,
    supplier: supplier,
    quantity: quantity,
    purchase_price: price,
    sale_price: salePrice,
    total: quantity * price
  };

  allData.push(purchase);
  // Persist the updated data to Firebase with autoโsync pause/resume and reload only on success.
  (async () => {
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุดุชุฑูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
    }
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุฅุถุงูุฉ ุงููุดุชุฑูุงุช:', err);
      }
    }
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
    updateAllDisplays();
    if (typeof updatePurchasesList === 'function') updatePurchasesList();
    showToast('โ ุชู ุฅุถุงูุฉ ุงูููุชุฌ ูุชุญุฏูุซ ุงููุฎุฒูู');
  })();

  document.getElementById('purchase-product-name').value = '';
  document.getElementById('purchase-product-code').value = '';
  document.getElementById('purchase-supplier').value = '';
  document.getElementById('purchase-quantity').value = '';
  document.getElementById('purchase-price').value = '';
  document.getElementById('purchase-sale-price').value = '';
}
</script>
<script>
// This block originally attempted to load ERP data from the browser's
// localStorage on page load. Because persistence is now handled by
// Firebase, loading and merging of data is performed in initializeApp().
// The original logic is removed to prevent accidental overwriting of
// allData with empty arrays.
document.addEventListener("DOMContentLoaded", function () {
  // No-op: Firebase loading occurs in initializeApp().
});
</script>
<script>
function updatePurchasesList() {
  const purchases = allData.filter(item => item.type === 'purchase');
  const tbody = document.getElementById('purchases-list');
  if (!tbody) return;

  if (purchases.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุดุชุฑูุงุช ูุณุฌูุฉ</td></tr>';
    return;
  }

  tbody.innerHTML = purchases.map(purchase => `
    <tr class="hover:bg-gray-50">
      <td class="border border-gray-300 p-3">${new Date(purchase.date).toLocaleDateString('ar-EG')}</td>
      <td class="border border-gray-300 p-3">${purchase.product_code || '-'}</td>
      <td class="border border-gray-300 p-3 font-medium">${purchase.product_name || ''}</td>
      <td class="border border-gray-300 p-3">${
        (typeof purchase.sale_price === 'number' && isFinite(purchase.sale_price) ? purchase.sale_price : 0).toFixed(2)
      } ุฌ.ู</td>
      <td class="border border-gray-300 p-3">${purchase.supplier || ''}</td>
      <td class="border border-gray-300 p-3">${purchase.quantity || 0}</td>
      <td class="border border-gray-300 p-3">${
        (typeof purchase.purchase_price === 'number' && isFinite(purchase.purchase_price) ? purchase.purchase_price : 0).toFixed(2)
      } ุฌ.ู</td>
      <td class="border border-gray-300 p-3 font-bold text-green-600">${
        (typeof purchase.total === 'number' && isFinite(purchase.total) ? purchase.total : 0).toFixed(2)
      } ุฌ.ู</td>
    </tr>
  `).join('');
}

function updateInventoryList() {
  // Generate inventory from purchases and sales using calculateInventory().
  const inventoryMap = calculateInventory();
  const inventoryArray = Object.values(inventoryMap);
  const tbody = document.getElementById('inventory-list');
  if (!tbody) return;

  if (inventoryArray.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ุงููุฎุฒูู</td></tr>';
    return;
  }

  tbody.innerHTML = inventoryArray.map(item => `
    <tr class="hover:bg-gray-50">
      <td class="border border-gray-300 p-3">${item.code || '-'}</td>
      <td class="border border-gray-300 p-3 font-medium">${item.name}</td>
      <td class="border border-gray-300 p-3">${item.purchasePrice ? parseFloat(item.purchasePrice).toFixed(2) + ' ุฌ.ู' : '-'}</td>
      <td class="border border-gray-300 p-3">${item.salePrice ? parseFloat(item.salePrice).toFixed(2) + ' ุฌ.ู' : '-'}</td>
      <td class="border border-gray-300 p-3">${item.totalPurchases || 0}</td>
      <td class="border border-gray-300 p-3">${item.totalSales || 0}</td>
      <td class="border border-gray-300 p-3">${item.availableStock || 0}</td>
      <td class="border border-gray-300 p-3">${item.reservedStock || 0}</td>
      <td class="border border-gray-300 p-3 bg-green-50">${item.actualAvailableStock || item.availableStock || 0}</td>
      <td class="border border-gray-300 p-3 text-blue-600">${(item.actualAvailableStock || item.availableStock) > 0 ? 'ูุชููุฑ' : 'ุบูุฑ ูุชููุฑ'}</td>
    </tr>
  `).join('');
}
</script>
<script>
// ูู ูุนุฏ ูุชู ุงุณุชุฎุฏุงู localStorage ูุชุฎุฒูู ุงููุตุฑููุงุช. ุจุฏูุงู ูู ุฐูู
// ูุชู ุชุณุฌูู ูู ูุตุฑูู ูุนูุตุฑ ูู ููุน 'expense' ุฏุงุฎู allData ูุญูุธู ูู Firebase.
let expensesData = [];

function renderExpensesReport() {
  const tbody = document.getElementById('expenses-report');
  if (!tbody) return;
  // ุฌูุจ ุนูุงุตุฑ ุงููุตุฑููุงุช ูู allData
  const expenses = allData.filter(item => item.type === 'expense');
  if (expenses.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="border border-gray-300 p-4 text-center text-gray-500">ูุง ุชูุฌุฏ ูุตุฑููุงุช ูุณุฌูุฉ ุจุนุฏ</td></tr>';
    return;
  }
  tbody.innerHTML = expenses.map(exp => {
    const dateStr = new Date(exp.date).toLocaleDateString('ar-EG');
    const amount = (typeof exp.amount === 'number' ? exp.amount : parseFloat(exp.amount || 0)).toFixed(2);
    const type = exp.expense_type || exp.type;
    return `
      <tr class="hover:bg-gray-50">
        <td class="border border-gray-300 p-2">${dateStr}</td>
        <td class="border border-gray-300 p-2">${type}</td>
        <td class="border border-gray-300 p-2 font-bold text-red-600">${amount} ุฌ.ู</td>
        <td class="border border-gray-300 p-2">${exp.description || '-'}</td>
        <td class="border border-gray-300 p-2">${exp.created_by || exp.user || 'ูุธุงู'}</td>
      </tr>
    `;
  }).join('');
}

async function handleExpenseSubmit(event) {
  event.preventDefault();
  const type = document.getElementById('expense-type').value.trim();
  const amount = parseFloat(document.getElementById('expense-amount').value) || 0;
  const description = document.getElementById('expense-description').value.trim();
  // Use the current user's full name as the creator of the expense.  If no
  // user is logged in, fallback to the string 'ูุธุงู'.  Relying on the
  // currentUser object ensures the creator column reflects the actual
  // logged-in user rather than the entire header text (which may include
  // role or other formatting).
  const user = (currentUser && currentUser.fullName) ? currentUser.fullName : 'ูุธุงู';
  if (!type || amount <= 0) {
    alert('ูุฑุฌู ุฅุฏุฎุงู ููุน ุงููุตุฑูู ูุงููุจูุบ ุจุดูู ุตุญูุญ');
    return;
  }
  // ุฅูุดุงุก ุนูุตุฑ ูุตุฑูู ุฌุฏูุฏ ูุฅุถุงูุชู ุฅูู allData.  ูุณุชุฎุฏู both
  // `created_by` ู `user` ููุญูุงุธ ุนูู ุงูุชูุงูู ูุน ุงููุงุฌูุงุช ุงููุฎุชููุฉ ุงูุชู
  // ุชุนุชูุฏ ุนูู ุฃู ูู ุงูุญูููู.  ูุชู ุชุญููู ุงููุจูุบ ุฅูู ุฑูู ุจูุงุตู ุนุดุฑู.
  const expense = {
    type: 'expense',
    expense_type: type,
    amount: parseFloat(amount.toFixed(2)),
    description: description,
    user: user,
    created_by: user,
    date: new Date().toISOString(),
    id: 'expense_' + Date.now()
  };
  allData.push(expense);

  // Persist the expense to Firebase with autoโsync pause/resume and reload only on success
  {
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.error('Error saving data to Firebase:', err);
    }
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
      } catch (saveErr) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุฅุถุงูุฉ ุงููุตุฑูู:', saveErr);
      }
    }
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
    // After saving and potentially reloading, update the report and reset the form
    renderExpensesReport();
    document.getElementById('expense-form').reset();
    showMessage('โ ุชูุช ุฅุถุงูุฉ ุงููุตุฑูู ุจูุฌุงุญ', 'success');
  }
}

// ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ูุชุญ ุงููุธุงู
document.addEventListener('DOMContentLoaded', renderExpensesReport);
</script>
<script>
// --- Purchases & Inventory localStorage sync script (integrated) ---

// Load purchases into purchases table
function loadPurchases() {
  // Use the global allData array instead of localStorage. Only items
  // marked as purchases are selected.
  const purchases = allData.filter(item => item.type === 'purchase');
  const tbody = document.getElementById("purchases-list");
  if (!tbody) return;
  tbody.innerHTML = "";

  if (!purchases || purchases.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="border border-gray-300 p-4 text-center text-gray-500" colspan="8">ูุง ุชูุฌุฏ ูุดุชุฑูุงุช ูุณุฌูุฉ</td>
      <td class="border border-gray-300 p-2 text-center relative">
        <button class="text-gray-400 text-xl cursor-default">โ๏ธ</button>
      </td>`;
    tbody.appendChild(tr);
    return;
  }

  purchases.forEach((item, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="border border-gray-300 p-2">${item.date || ''}</td>
      <td class="border border-gray-300 p-2">${item.code || ''}</td>
      <td class="border border-gray-300 p-2">${item.name || ''}</td>
      <td class="border border-gray-300 p-2">${item.salePrice || ''}</td>
      <td class="border border-gray-300 p-2">${item.supplier || ''}</td>
      <td class="border border-gray-300 p-2">${item.quantity || ''}</td>
      <td class="border border-gray-300 p-2">${item.purchasePrice || ''}</td>
      <td class="border border-gray-300 p-2">${item.total || ''}</td>
      <td class="border border-gray-300 p-2 text-center relative">
        <button class="text-gray-600 hover:text-blue-600 text-xl" onclick="toggleActionMenu(this)">โ๏ธ</button>
        <div class="hidden absolute bg-white border border-gray-200 rounded-lg shadow-lg right-0 mt-2 w-36 z-50 action-menu">
          <button class="block w-full text-right px-3 py-2 text-sm hover:bg-gray-100" onclick="editPurchase(${index})">โ๏ธ ุชุนุฏูู</button>
          <button class="block w-full text-right px-3 py-2 text-sm hover:bg-red-100 text-red-600" onclick="deletePurchase(${index})">๐๏ธ ุญุฐู</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Add purchase (keeps same inputs from page)
// Legacy duplicate of addPurchase. Renamed to avoid overriding the main implementation
function addPurchaseLegacy2() {
  const name = document.getElementById("purchase-product-name").value.trim();
  const code = document.getElementById("purchase-product-code").value.trim();
  const supplier = document.getElementById("purchase-supplier").value.trim();
  const quantity = parseFloat(document.getElementById("purchase-quantity").value) || 0;
  const purchasePrice = parseFloat(document.getElementById("purchase-price").value) || 0;
  const salePrice = parseFloat(document.getElementById("purchase-sale-price").value) || 0;

  if (!name || !code || !quantity || !purchasePrice) {
    alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฌููุน ุงูุจูุงูุงุช ุงููุทููุจุฉ: ุงูุงุณูุ ุงูููุฏุ ุงููููุฉุ ูุณุนุฑ ุงูุดุฑุงุก.");
    return;
  }

  const newPurchase = {
    date: new Date().toLocaleDateString("ar-EG"),
    code,
    name,
    supplier,
    quantity,
    purchasePrice,
    salePrice,
    total: (quantity * purchasePrice).toFixed(2)
  };

  // Push the new purchase into the ERP data array and persist it to Firebase.
  const purchaseRecord = {
    type: 'purchase',
    product_name: newPurchase.name,
    product_code: newPurchase.code,
    supplier: newPurchase.supplier,
    quantity: newPurchase.quantity,
    purchase_price: parseFloat(newPurchase.purchasePrice),
    sale_price: parseFloat(newPurchase.salePrice),
    total: parseFloat(newPurchase.total),
    date: new Date().toISOString(),
    status: 'ููุชูู',
    id: 'purchase_' + Date.now()
  };
  allData.push(purchaseRecord);
  // Persist the updated purchase with autoโsync pause/resume and reload only on success
  (async () => {
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงููุดุชุฑูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
    }
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุฅุถุงูุฉ ุงููุดุชุฑูุงุช:', err);
      }
    }
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
    updateAllDisplays();
    showToast('โ ุชู ุฅุถุงูุฉ ุงูููุชุฌ ูุชุญุฏูุซ ุงููุฎุฒูู');
  })();
  // clear inputs lightly
  document.getElementById("purchase-product-name").value = "";
  document.getElementById("purchase-product-code").value = "";
  document.getElementById("purchase-supplier").value = "";
  document.getElementById("purchase-quantity").value = "";
  document.getElementById("purchase-price").value = "";
  document.getElementById("purchase-sale-price").value = "";
}

// Edit purchase (simple prompt-based)
async function editPurchase(index) {
  // ุงุนุชูุฏ ุนูู allData ุจุฏูุงู ูู localStorage. ูุญุตู ุนูู ูุงุฆูุฉ ุงููุดุชุฑูุงุช ูู allData
  const purchases = allData.filter(item => item.type === 'purchase');
  const item = purchases[index];
  if (!item) return;
  // ุทูุจ ุจูุงูุงุช ุฌุฏูุฏุฉ ูู ุงููุณุชุฎุฏู ูุน ุงูุงุญุชูุงุธ ุจุงูููู ุงููุฏููุฉ ุฅุฐุง ุฃูุบู ุงูุฅุฏุฎุงู
  const newName = prompt('ุงุณู ุงูููุชุฌ:', item.product_name || item.name || '') || (item.product_name || item.name);
  const newSale = prompt('ุณุนุฑ ุงูุจูุน:', (item.sale_price !== undefined ? item.sale_price : item.salePrice) || '') || (item.sale_price !== undefined ? item.sale_price : item.salePrice || 0);
  const newPrice = prompt('ุณุนุฑ ุงูุดุฑุงุก:', (item.purchase_price !== undefined ? item.purchase_price : item.purchasePrice) || '') || (item.purchase_price !== undefined ? item.purchase_price : item.purchasePrice || 0);
  const newQty = prompt('ุงููููุฉ:', item.quantity || 0) || item.quantity;
  // ุชุญููู ุงูุฃุฑูุงู
  const parsedSale = parseFloat(newSale) || 0;
  const parsedPurchase = parseFloat(newPrice) || 0;
  const parsedQty = parseFloat(newQty) || 0;
  // ุชุญุฏูุซ ุฎุตุงุฆุต ุงูุนูุตุฑ ูุจุงุดุฑุฉ ุจุญูุซ ููุนูุณ ุงูุชุบููุฑ ูู allData
  item.product_name = newName;
  item.name = newName;
  item.sale_price = parsedSale;
  item.salePrice = parsedSale;
  item.purchase_price = parsedPurchase;
  item.purchasePrice = parsedPurchase;
  item.quantity = parsedQty;
  item.total = parseFloat((parsedQty * parsedPurchase).toFixed(2));
  // Persist changes to Firebase with autoโsync pause/resume and reload only on success
  {
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.error('Error saving data to Firebase:', err);
    }
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุชุญุฏูุซ ุงููุดุชุฑูุงุช:', err);
      }
    }
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
    updateAllDisplays();
    showToast('โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงููุดุชุฑูุงุช ุจูุฌุงุญ');
  }
}

// Confirm & delete
// Confirm and delete a purchase.  If skipPrompt is true, the
// builtโin confirmation dialog is bypassed (used by custom modals).
async function confirmDeletePurchase(index, skipPrompt) {
  // If not skipping the prompt, ask the user for confirmation.  This
  // allows calls from older code to still display a simple confirm.
  if (!skipPrompt) {
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูููุชุฌุ ุณูุชู ุญุฐูู ูู ุงููุฎุฒูู ุฃูุถูุง.')) return;
  }
  // Remove the item from allData based on its position in the sorted purchases list
  // Using the same sorted order as updatePurchasesDisplay() ensures the correct
  // record is targeted.  If getSortedPurchases is unavailable, fall back
  // to filtering without sorting.
  const purchases = typeof getSortedPurchases === 'function' ? getSortedPurchases() : allData.filter(item => item.type === 'purchase');
  const item = purchases[index];
  if (item) {
    // Restore the budget by adding back the purchase total, since the budget was
    // reduced when this purchase was recorded.  If currentBudget is
    // undefined, initialize it to zero.  Then update the UI and persist to
    // Firebase.  We wrap persistence in a try/catch so failure does not
    // interrupt deletion.
    try {
      if (typeof window.currentBudget === 'undefined' || isNaN(parseFloat(window.currentBudget))) {
        window.currentBudget = 0;
      }
      const totalCost = parseFloat(item.total) || 0;
      window.currentBudget = parseFloat(window.currentBudget) + totalCost;
      // Update the budget display if present
      const budgetEl = document.getElementById('budget-amount');
      if (budgetEl) {
        budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
      }
      // Persist the updated budget to Firebase; do not block on failure
      try {
        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), window.currentBudget);
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูููุฒุงููุฉ ุจุนุฏ ุญุฐู ุนูููุฉ ุงูุดุฑุงุก:', err);
      }
    } catch (budgetErr) {
      console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุนุงุฏุฉ ุงูููุฒุงููุฉ ุจุนุฏ ุญุฐู ุงููุดุชุฑูุงุช:', budgetErr);
    }
    // Remove from the unified allData array
    const idxInAll = allData.indexOf(item);
    if (idxInAll !== -1) {
      allData.splice(idxInAll, 1);
    }
  }
  /*
   * Temporarily pause the background sync while we persist the deletion.
   * Without pausing, the autoโsync interval could run concurrently and
   * save an outdated snapshot of `allData` back to Firebase, causing
   * deleted purchases to reappear.  We capture whether the sync
   * interval is active, clear it before saving, and then restore the
   * interval once the deletion has fully propagated to the database.
   */
  const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
  if (wasAutoSyncActive) {
    clearInterval(window.autoSyncTimer);
    window.autoSyncTimer = null;
  }
  // Persist the deletion and reload from Firebase to ensure the change is
  // stored permanently, then refresh the display.  We call
  // saveDataToFirebase followed by loadDataFromFirebase sequentially
  // without nesting nested try blocks to simplify error handling.  Any
  // errors will be logged.
  try {
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุงูููุชุฌ:', err);
    }
    if (saveSucceeded) {
      await loadDataFromFirebase();
    }
  } catch (err) {
    console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุงูููุชุฌ:', err);
  }
  // Resume the background sync if it was previously active
  if (wasAutoSyncActive) {
    window.autoSyncTimer = setInterval(() => {
      // Use Promise.resolve() to avoid unhandled promise rejections
      Promise.resolve(backgroundSync());
    }, 5000);
  }
  updateAllDisplays();
  showToast('๐๏ธ ุชู ุญุฐู ุงูููุชุฌ ูุชุญุฏูุซ ุงููุฎุฒูู ุชููุงุฆููุง');
}

// Display a confirmation modal for deleting a purchase.  This
// replicates the same UI used in the employee deletion dialog.  When
// confirmed, it calls confirmDeletePurchase with skipPrompt = true.
function deletePurchase(index) {
  // Determine the purchase item to display its name in the dialog
  // Use the sorted purchases to ensure the index corresponds to the row
  const purchases = typeof getSortedPurchases === 'function' ? getSortedPurchases() : allData.filter(item => item.type === 'purchase');
  const item = purchases[index];
  const productName = item && (item.product_name || item.name) ? (item.product_name || item.name) : 'ูุฐุง ุงูููุชุฌ';
  // Create the overlay
  const confirmDiv = document.createElement('div');
  confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  confirmDiv.innerHTML = `
    <div class="bg-white p-6 rounded-lg max-w-md">
      <h3 class="text-lg font-bold mb-4 text-red-600">ุชุฃููุฏ ุงูุญุฐู</h3>
      <p class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููุชุฌ "${productName}"ุ ุณูุชู ุญุฐูู ูู ุงููุฎุฒูู ุฃูุถูุง.</p>
      <div class="flex gap-3 justify-end">
        <button onclick="this.parentElement.parentElement.parentElement.remove()"
                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
          ุฅูุบุงุก
        </button>
        <button onclick="confirmDeletePurchase(${index}, true); this.parentElement.parentElement.parentElement.remove()"
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
          ุญุฐู
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(confirmDiv);
}

/**
 * Open a modal to edit a purchase record.  It displays input fields
 * prefilled with the purchase's current data.  On save, it updates
 * the record in allData, persists the changes to Firebase, reloads
 * the data, updates the UI, and closes the modal.
 *
 * @param {number} index Index of the purchase in the filtered purchases list
 */
function editPurchase(index) {
  // Find the purchase based on the index within the purchases list
  // Use the same sorted ordering as displayed in the UI to locate the record
  const purchases = typeof getSortedPurchases === 'function' ? getSortedPurchases() : allData.filter(item => item.type === 'purchase');
  const purchase = purchases[index];
  if (!purchase) return;
  // Create modal overlay
  const modalDiv = document.createElement('div');
  modalDiv.id = 'edit-purchase-modal';
  modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
  modalDiv.innerHTML = `
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-full overflow-y-auto p-6">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold text-gray-800">โ๏ธ ุชุนุฏูู ุจูุงูุงุช ุงูููุชุฌ</h2>
        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">โ</button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงูููุชุฌ</label>
          <input type="text" id="edit-purchase-product-name" value="${purchase.product_name}" class="w-full p-3 border rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ููุฏ ุงูููุชุฌ</label>
          <input type="text" id="edit-purchase-product-code" value="${purchase.product_code}" class="w-full p-3 border rounded-lg" disabled>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงูููุฑุฏ</label>
          <input type="text" id="edit-purchase-supplier" value="${purchase.supplier}" class="w-full p-3 border rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ุงููููุฉ</label>
          <input type="number" id="edit-purchase-quantity" value="${purchase.quantity}" class="w-full p-3 border rounded-lg" min="1" step="1">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ุณุนุฑ ุงูุดุฑุงุก (ุฌ.ู)</label>
          <input type="number" id="edit-purchase-price" value="${purchase.purchase_price}" class="w-full p-3 border rounded-lg" step="0.01" min="0">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ุณุนุฑ ุงูุจูุน (ุฌ.ู)</label>
          <input type="number" id="edit-purchase-sale-price" value="${purchase.sale_price}" class="w-full p-3 border rounded-lg" step="0.01" min="0">
        </div>
      </div>
      <div class="flex gap-3 justify-end border-t pt-4 mt-6">
        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">ุฅูุบุงุก</button>
        <button onclick="savePurchaseChanges(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">๐พ ุญูุธ ุงูุชุบููุฑุงุช</button>
      </div>
    </div>
  `;
  document.body.appendChild(modalDiv);
}

// Save the edited purchase data.  Updates the purchase record, persists
// changes to Firebase, reloads data, refreshes the UI, closes the modal,
// and shows a success message.
async function savePurchaseChanges(index) {
  // Find the purchase using the same sorted order as displayed in the UI.
  const purchases = typeof getSortedPurchases === 'function' ? getSortedPurchases() : allData.filter(item => item.type === 'purchase');
  const purchase = purchases[index];
  if (!purchase) return;
  const name = document.getElementById('edit-purchase-product-name').value.trim();
  const supplier = document.getElementById('edit-purchase-supplier').value.trim();
  const quantity = parseInt(document.getElementById('edit-purchase-quantity').value) || 0;
  const purchasePrice = parseFloat(document.getElementById('edit-purchase-price').value) || 0;
  const salePrice = parseFloat(document.getElementById('edit-purchase-sale-price').value) || 0;
  // Validate inputs
  if (!name || !supplier || quantity <= 0 || purchasePrice <= 0 || salePrice <= 0) {
    showMessage('โ ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุจุดูู ุตุญูุญ', 'error');
    return;
  }
  // Capture the old total before updating, so we can adjust the budget
  const oldTotal = parseFloat(purchase.total) || 0;
  // Update the purchase object (by reference inside allData)
  purchase.product_name = name;
  purchase.supplier = supplier;
  purchase.quantity = quantity;
  purchase.purchase_price = parseFloat(purchasePrice.toFixed(2));
  purchase.sale_price = parseFloat(salePrice.toFixed(2));
  purchase.total = parseFloat((purchasePrice * quantity).toFixed(2));
  // Determine the difference between new total and old total to adjust the budget
  const newTotal = purchase.total || 0;
  const delta = newTotal - oldTotal;
  // If delta is positive, the purchase cost increased and should further decrease the budget.
  // If negative, the cost decreased and should restore that difference to the budget.
  try {
    if (typeof window.currentBudget === 'undefined' || isNaN(parseFloat(window.currentBudget))) {
      window.currentBudget = 0;
    }
    window.currentBudget = parseFloat(window.currentBudget) - delta;
    // Update the budget UI
    const budgetEl = document.getElementById('budget-amount');
    if (budgetEl) {
      budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
    }
    // Persist the budget
    try {
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), window.currentBudget);
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูููุฒุงููุฉ ุจุนุฏ ุชุนุฏูู ุงููุดุชุฑูุงุช:', err);
    }
  } catch (err) {
    console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุชุนุฏูู ุงูููุฒุงููุฉ ุจุนุฏ ุชุญุฏูุซ ุงููุดุชุฑูุงุช:', err);
  }
  // Persist the updated purchase with autoโsync pause/resume and reload only on success
  {
    const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
    if (wasAutoSyncActive) {
      clearInterval(window.autoSyncTimer);
      window.autoSyncTimer = null;
    }
    let saveSucceeded = false;
    try {
      await saveDataToFirebase();
      saveSucceeded = true;
    } catch (err) {
      console.error('Error saving updated purchase to Firebase:', err);
    }
    if (saveSucceeded) {
      try {
        await loadDataFromFirebase();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุชุญุฏูุซ ุงูููุชุฌ:', err);
      }
    }
    if (wasAutoSyncActive) {
      window.autoSyncTimer = setInterval(() => {
        Promise.resolve(backgroundSync());
      }, 5000);
    }
    // Refresh all displays (including inventory)
    updateAllDisplays();
    showToast('โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูููุชุฌ ุจูุฌุงุญ');
  }
  // Close modal
  const modal = document.getElementById('edit-purchase-modal');
  if (modal) modal.remove();
}

// Delete all purchases with confirmation. This function prompts the user
// before removing every purchase record from the system. It then saves
// the updated data to Firebase, reloads data from the cloud to ensure
// consistency, refreshes the UI, and shows a success message.
async function confirmDeleteAllPurchases(skipPrompt) {
  // Ask the user for confirmation unless skipPrompt is true; abort if they cancel
  if (!skipPrompt) {
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูููุชุฌุงุช ูู ุงููุดุชุฑูุงุชุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) return;
  }
  // Before deleting, calculate the total cost of all purchases so we can
  // restore this amount back to the budget.  Purchases reduce the budget
  // when recorded, so deleting them should increase the available budget.
  let deletedPurchasesTotal = 0;
  try {
    deletedPurchasesTotal = allData
      .filter(item => item && item.type === 'purchase')
      .reduce((sum, purchase) => sum + (parseFloat(purchase.total) || 0), 0);
  } catch (calcErr) {
    console.warn('โ๏ธ ุชุนุฐุฑ ุญุณุงุจ ุฅุฌูุงูู ุชูููุฉ ุงููุดุชุฑูุงุช ุงููุญุฐููุฉ ุฃุซูุงุก ุญุฐู ุฌููุน ุงููุดุชุฑูุงุช:', calcErr);
  }
  // Adjust the current budget
  try {
    if (typeof window.currentBudget === 'undefined' || isNaN(parseFloat(window.currentBudget))) {
      window.currentBudget = 0;
    }
    window.currentBudget = parseFloat(window.currentBudget) + deletedPurchasesTotal;
    // Update budget display
    const budgetEl = document.getElementById('budget-amount');
    if (budgetEl) {
      budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
    }
    // Persist updated budget to Firebase
    try {
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), window.currentBudget);
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุงูููุฒุงููุฉ ุจุนุฏ ุญุฐู ุฌููุน ุงููุดุชุฑูุงุช:', err);
    }
  } catch (budgetRestoreErr) {
    console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุนุงุฏุฉ ุงูููุฒุงููุฉ ุจุนุฏ ุญุฐู ุฌููุน ุงููุดุชุฑูุงุช:', budgetRestoreErr);
  }
  // Filter out non-purchase items from allData
  const remaining = allData.filter(item => item.type !== 'purchase');
  // Clear the original array and repopulate it with remaining items
  allData.length = 0;
  remaining.forEach(item => allData.push(item));
  /*
   * Pause the background sync to prevent race conditions.  If the
   * autoโsync interval triggers while saving, it could overwrite
   * Firebase with stale data and reintroduce the deleted purchases.
   */
  const wasAutoSyncActive = typeof window.autoSyncTimer !== 'undefined' && window.autoSyncTimer !== null;
  if (wasAutoSyncActive) {
    clearInterval(window.autoSyncTimer);
    window.autoSyncTimer = null;
  }
  // Persist changes to Firebase.  Reload only if the save succeeds.  This
  // prevents cloud data from overwriting local deletions when save fails.
  let saveSucceeded = false;
  try {
    await saveDataToFirebase();
    saveSucceeded = true;
  } catch (err) {
    console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุฌููุน ุงููุดุชุฑูุงุช:', err);
  }
  if (saveSucceeded) {
    try {
      await loadDataFromFirebase();
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุญุฐู ุฌููุน ุงููุดุชุฑูุงุช:', err);
    }
  }
  // Resume the background sync if it was previously active
  if (wasAutoSyncActive) {
    window.autoSyncTimer = setInterval(() => {
      Promise.resolve(backgroundSync());
    }, 5000);
  }
  // Update UI components
  updateAllDisplays();
  // Display success message
  showMessage('๐๏ธ ุชู ุญุฐู ุฌููุน ุงููุดุชุฑูุงุช ุจูุฌุงุญ', 'success');
}

// Sync purchases -> inventory in localStorage
function syncInventory() {
  // Inventory synchronization is now handled by calculateInventory()
  // using the global allData array. No localStorage synchronization is necessary.
  updateInventoryDisplay();
}

// Toggle action menu (pop)
function toggleActionMenu(btn) {
  // hide other menus first
  document.querySelectorAll('.action-menu').forEach(m => {
    if (m !== btn.nextElementSibling) m.classList.add('hidden');
  });
  const menu = btn.nextElementSibling;
  if (menu) menu.classList.toggle('hidden');
}

// Toast
function showToast(message) {
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.className = "fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg text-sm animate-fade-in";
  document.body.appendChild(toast);
  setTimeout(() => { try { toast.remove(); } catch(e){} }, 2800);
}

// Load inventory into inventory table and counters
function loadInventory() {
  // Retrieve inventory using calculateInventory() based on allData.
  const inventory = Object.values(calculateInventory());
  const tbody = document.getElementById("inventory-list");
  const totalProductsEl = document.getElementById("total-products");
  const inStockEl = document.getElementById("in-stock");
  const lowStockEl = document.getElementById("low-stock");
  const outOfStockEl = document.getElementById("out-of-stock");

  if (!tbody) return;

  tbody.innerHTML = "";
  if (!inventory || inventory.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="border border-gray-300 p-4 text-center text-gray-500" colspan="10">ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ุงููุฎุฒูู</td>`;
    tbody.appendChild(tr);
    if (totalProductsEl) totalProductsEl.textContent = "0";
    if (inStockEl) inStockEl.textContent = "0";
    if (lowStockEl) lowStockEl.textContent = "0";
    if (outOfStockEl) outOfStockEl.textContent = "0";
    return;
  }

  let totalProducts = inventory.length;
  let inStockCount = 0, lowStockCount = 0, outOfStockCount = 0;
  inventory.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="border border-gray-300 p-2">${item.code || ''}</td>
      <td class="border border-gray-300 p-2">${item.name || ''}</td>
      <td class="border border-gray-300 p-2">${item.purchasePrice ? parseFloat(item.purchasePrice).toFixed(2) : '0.00'}</td>
      <td class="border border-gray-300 p-2">${item.salePrice ? parseFloat(item.salePrice).toFixed(2) : '0.00'}</td>
      <td class="border border-gray-300 p-2">${item.totalPurchases || '0.00'}</td>
      <td class="border border-gray-300 p-2">${item.totalSales || '0.00'}</td>
      <td class="border border-gray-300 p-2">${item.totalPurchases || 0}</td>
      <td class="border border-gray-300 p-2 bg-orange-100">${item.reservedStock || 0}</td>
      <td class="border border-gray-300 p-2 bg-green-100">${item.availableStock || 0}</td>
      <td class="border border-gray-300 p-2">${item.availableStock > 0 ? 'ูุชููุฑ' : 'ูุงุฒุฑ'}</td>
    `;
    tbody.appendChild(tr);

    const avail = parseFloat(item.availableStock || 0);
    if (avail > 0) inStockCount++;
    if (avail > 0 && avail <= 5) lowStockCount++;
    if (avail === 0) outOfStockCount++;
  });

  if (totalProductsEl) totalProductsEl.textContent = totalProducts;
  if (inStockEl) inStockEl.textContent = inStockCount;
  if (lowStockEl) lowStockEl.textContent = lowStockCount;
  if (outOfStockEl) outOfStockEl.textContent = outOfStockCount;
}

// Hide action menus when clicking outside
document.addEventListener('click', function(event) {
  document.querySelectorAll('.action-menu').forEach(menu => {
    if (!menu.contains(event.target) && !menu.previousElementSibling.contains(event.target)) {
      menu.classList.add('hidden');
    }
  });
});

// Initial load
// ุนูุฏ ุชุญููู ุงูุตูุญุฉ ูุชู ุชุญุฏูุซ ุฌููุน ุงูุนุฑูุถ ูุจุงุดุฑุฉ ุจุฏูุงู ูู ุงุณุชุฏุนุงุก ุฏูุงู ุชุนุชูุฏ ุนูู localStorage
document.addEventListener("DOMContentLoaded", function() {
  updateAllDisplays();
});

</script>
<style>
@keyframes fade-in { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
.animate-fade-in { animation: fade-in 0.25s ease; }
</style>
<script>
// ุฏุงูุฉ ูุชุญุฏูุซ ูุงุฆูุฉ ุงูููุชุฌุงุช ุงูููุฌูุฏุฉ ูู ูุณู ุงููุดุชุฑูุงุช
// Legacy implementation of updateExistingProductsList based on purchases table.
// It has been renamed to avoid overriding the inventory-based implementation defined earlier.
function updateExistingProductsListLegacy() {
  const purchasesList = document.querySelectorAll('#purchases-list tr');
  const select = document.getElementById('existing-product-select');
  if (!select) return;
  select.innerHTML = '<option value="">-- ุงุฎุชุฑ ููุชุฌ ูู ุงููุงุฆูุฉ --</option>';
  purchasesList.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 3) {
      const code = cells[1]?.textContent?.trim();
      const name = cells[2]?.textContent?.trim();
      if (code && name && code !== 'ููุฏ ุงูููุชุฌ') {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = `${name} (${code})`;
        select.appendChild(option);
      }
    }
  });
}

// ุนูุฏ ุชุญููู ุงูุตูุญุฉ ูู ุจุชุญุฏูุซ ูุงุฆูุฉ ุงูููุชุฌุงุช ุงูููุฌูุฏุฉ ุจุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ
window.addEventListener('DOMContentLoaded', function() {
  if (typeof updateExistingProductsList === 'function') {
    updateExistingProductsList();
  }
});

// ุนูุฏ ุฅุถุงูุฉ ูุดุชุฑูุงุช ุฌุฏูุฏุฉ ูู ุจุชุญุฏูุซ ุงููุงุฆูุฉ ุจุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ุจุฏูุงู ูู ุงููุณุฎุฉ ุงููุฏููุฉ
{
  const originalAddPurchase = window.addPurchase;
  window.addPurchase = async function() {
    if (typeof originalAddPurchase === 'function') await originalAddPurchase();
    if (typeof updateExistingProductsList === 'function') updateExistingProductsList();
  };
}
</script>
<!-- Script to add predictive search for customer name and code in the sales invoice.  When typing in either field,
     suggestions from existing customers (manual and invoice-derived) are displayed.  Selecting a suggestion
     populates both fields in the invoice and in the customer management section. -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const invoiceNameInput = document.getElementById('customer-name');
  const invoiceCodeInput = document.getElementById('customer-code');
  const nameResults = document.getElementById('invoice-customer-name-results');
  const codeResults = document.getElementById('invoice-customer-code-results');
  const customersNameField = document.getElementById('customers-customer-name');
  const customersCodeField = document.getElementById('customers-customer-code');

  // References to duplicate warning elements.  These containers will show a message when
  // the user enters a combination of customer name and code that already exists.
  const invoiceDuplicateWarning = document.getElementById('invoice-customer-duplicate-warning');
  const customersDuplicateWarning = document.getElementById('customers-duplicate-warning');

  // Ensure required elements are present
  if (!invoiceNameInput || !invoiceCodeInput || !nameResults || !codeResults) {
    return;
  }

  /**
   * Collect unique customer suggestions from manually added customers and existing invoices.
   * The resulting array contains objects with `name` and `code` properties.  Duplicate entries
   * (based on name and normalized code) are removed.
   * @returns {Array<{name: string, code: string}>}
   */
  function getCustomerSuggestions() {
    const suggestions = [];
    // Include all manual customers
    if (Array.isArray(window.manualCustomers)) {
      window.manualCustomers.forEach(function(c) {
        suggestions.push({ name: c.name || '', code: c.code || '' });
      });
    }
    // Include customers from invoice data stored in allData
    try {
      if (Array.isArray(allData)) {
        allData.forEach(function(item) {
          if (item.type === 'invoice') {
            const name = item.customer_name || '';
            const code = item.customer_code || '';
            suggestions.push({ name: name, code: code });
          }
        });
      }
    } catch (err) {
      // Silently ignore errors when reading allData
    }
    // Remove duplicates by name and normalized code
    const unique = [];
    const seen = new Set();
    suggestions.forEach(function(s) {
      const key = s.name + '::' + normalizeDigits(s.code || '');
      if (!seen.has(key)) {
        seen.add(key);
        unique.push(s);
      }
    });
    return unique;
  }

  /**
   * Determine whether a customer with the specified name and code already exists in the system.
   * A match requires both the normalized name and normalized code to match exactly against any
   * entry in the manual customers list or invoice-derived customer data.  Returns true if a
   * duplicate is found.
   * @param {string} name - The customer name to check
   * @param {string} code - The customer code to check
   * @returns {boolean}
   */
  function customerExists(name, code) {
    const normalizedName = (name || '').trim().toLowerCase();
    const normalizedCode = normalizeDigits(code || '').trim();
    if (!normalizedName || !normalizedCode) {
      return false;
    }
    // Check manual customers
    if (Array.isArray(window.manualCustomers)) {
      for (const c of window.manualCustomers) {
        const cName = (c.name || '').trim().toLowerCase();
        const cCode = normalizeDigits(c.code || '').trim();
        if (cName === normalizedName && cCode === normalizedCode) {
          return true;
        }
      }
    }
    // Check invoice-derived customers in allData
    try {
      if (Array.isArray(allData)) {
        for (const item of allData) {
          if (item.type === 'invoice') {
            const iName = (item.customer_name || '').trim().toLowerCase();
            const iCode = normalizeDigits(item.customer_code || '').trim();
            if (iName === normalizedName && iCode === normalizedCode) {
              return true;
            }
          }
        }
      }
    } catch (err) {
      // ignore any errors reading allData
    }
    return false;
  }

  /**
   * Update the visibility of duplicate warnings based on the current values of the invoice and
   * customer management input fields.  When both fields are non-empty and a duplicate combination
   * exists, the corresponding warning element is shown; otherwise, it is hidden.
   */
  function updateDuplicateWarnings() {
    // Always hide duplicate warnings.  We no longer show alerts when a customer
    // already exists, and instead show invoice details for existing customers.
    if (invoiceDuplicateWarning) invoiceDuplicateWarning.classList.add('hidden');
    if (customersDuplicateWarning) customersDuplicateWarning.classList.add('hidden');
  }

  /**
   * Display suggestions in the provided results container based on the current value of an input.
   * Suggestions are filtered by matching the normalized term against both the customer's name and code.
   * Clicking a suggestion fills the invoice fields and corresponding customer management fields.
   * @param {HTMLInputElement} currentInput - the input element triggering the suggestions
   * @param {HTMLElement} resultsContainer - the container where suggestion items are appended
   */
  function showSuggestions(currentInput, resultsContainer) {
    const term = normalizeDigits(currentInput.value || '').trim().toLowerCase();
    resultsContainer.innerHTML = '';
    if (!term) {
      resultsContainer.classList.add('hidden');
      return;
    }
    const allSuggestions = getCustomerSuggestions();
    const filtered = allSuggestions.filter(function(s) {
      const combined = normalizeDigits((s.name + ' ' + (s.code || ''))).toLowerCase();
      return combined.includes(term);
    });
    if (filtered.length === 0) {
      resultsContainer.classList.add('hidden');
      return;
    }
    filtered.slice(0, 10).forEach(function(s) {
      const div = document.createElement('div');
      div.className = 'search-item';
      div.dataset.name = s.name;
      div.dataset.code = s.code || '';
      // Build the inner HTML with the customer name and code, if present
      div.innerHTML = s.name + (s.code ? ' <span class="text-gray-500 text-xs">(' + s.code + ')</span>' : '');
      div.addEventListener('click', function() {
        invoiceNameInput.value = s.name;
        invoiceCodeInput.value = s.code || '';
        if (customersNameField) customersNameField.value = s.name;
        if (customersCodeField) customersCodeField.value = s.code || '';
        // Hide suggestion dropdowns after selection
        nameResults.classList.add('hidden');
        codeResults.classList.add('hidden');
        // Update duplicate warnings after programmatically setting values
        if (typeof updateDuplicateWarnings === 'function') updateDuplicateWarnings();
      });
      resultsContainer.appendChild(div);
    });
    resultsContainer.classList.remove('hidden');
  }

  // Show suggestions when the user types in the name or code inputs
  invoiceNameInput.addEventListener('input', function() {
    showSuggestions(invoiceNameInput, nameResults);
  });
  invoiceCodeInput.addEventListener('input', function() {
    showSuggestions(invoiceCodeInput, codeResults);
  });

  // Attach event listeners to update duplicate warnings whenever input changes in either section
  invoiceNameInput.addEventListener('input', updateDuplicateWarnings);
  invoiceCodeInput.addEventListener('input', updateDuplicateWarnings);
  if (customersNameField) {
    customersNameField.addEventListener('input', updateDuplicateWarnings);
  }
  if (customersCodeField) {
    customersCodeField.addEventListener('input', updateDuplicateWarnings);
  }
  // Initialize the duplicate warnings on page load
  updateDuplicateWarnings();

  // Hide suggestion lists when clicking outside of the inputs or suggestion containers
  document.addEventListener('click', function(event) {
    const target = event.target;
    if (!nameResults.classList.contains('hidden')) {
      if (target !== invoiceNameInput && !nameResults.contains(target)) {
        nameResults.classList.add('hidden');
      }
    }
    if (!codeResults.classList.contains('hidden')) {
      if (target !== invoiceCodeInput && !codeResults.contains(target)) {
        codeResults.classList.add('hidden');
      }
    }
  });
});
</script>
<!-- Additional helpers for budget management and admin password verification -->
<script>
/**
 * Load the current budget from Firebase. If the budget value does not exist,
 * initialize it with the default value of 2,000,000. Updates the #budget-amount
 * element to reflect the loaded value.
 */
async function loadBudget() {
  try {
    // Load the base budget from Firebase.  If it doesn't exist, initialise it to
    // 2,000,000 and persist.  This base budget represents the starting capital
    // and does not change when purchases or expenses occur.
    let baseVal = null;
    try {
      const baseSnap = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpBaseBudget'));
      if (baseSnap && baseSnap.exists()) {
        baseVal = baseSnap.val();
      }
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ุงูููุฒุงููุฉ ุงูุฃุณุงุณูุฉ ูู Firebase:', err);
    }
    if (baseVal === null || baseVal === undefined) {
      baseVal = 2000000;
      try {
        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBaseBudget'), baseVal);
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูููุฒุงููุฉ ุงูุฃุณุงุณูุฉ ุงูุงูุชุฑุงุถูุฉ ูู Firebase:', err);
      }
    }
    window.baseBudget = baseVal;

    // Load the current available budget from Firebase.  If not found, compute it
    // from the base budget minus total purchases and expenses.
    let currentVal = null;
    try {
      const snap = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'erpBudget'));
      if (snap && snap.exists()) {
        currentVal = snap.val();
      }
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ุงูููุฒุงููุฉ ุงูุญุงููุฉ ูู Firebase:', err);
    }
    if (currentVal === null || currentVal === undefined) {
      // Compute totals from allData if available
      let totalPurchases = 0;
      let totalExpenses = 0;
      try {
        const purchases = Array.isArray(allData) ? allData.filter(item => item.type === 'purchase') : [];
        totalPurchases = purchases.reduce((sum, purchase) => sum + (parseFloat(purchase.total) || 0), 0);
        const expenses = Array.isArray(allData) ? allData.filter(item => item.type === 'expense') : [];
        totalExpenses = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุญุณุงุจ ุฅุฌูุงูู ุงููุดุชุฑูุงุช ูุงููุตุฑููุงุช ุฃุซูุงุก ุชุญููู ุงูููุฒุงููุฉ:', err);
      }
      currentVal = baseVal - totalPurchases - totalExpenses;
      // Persist the computed current budget so that subsequent loads do not recompute
      try {
        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), currentVal);
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูููุฒุงููุฉ ุงููุญุณูุจุฉ ูู Firebase:', err);
      }
    }
    window.currentBudget = currentVal;

    // Update the budget displays
    try {
      if (typeof updateBudgetUI === 'function') {
        updateBudgetUI();
      } else {
        // Fallback to direct UI update if helper is unavailable
        const budgetEl = document.getElementById('budget-amount');
        if (budgetEl) {
          budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ุฌ.ู';
        }
        const baseEl = document.getElementById('base-budget-amount');
        if (baseEl) {
          baseEl.textContent = parseFloat(window.baseBudget).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ุฌ.ู';
        }
      }
    } catch (uiErr) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุนุฑุถ ุงูููุฒุงููุฉ ุนูุฏ ุงูุชุญููู:', uiErr);
    }
  } catch (err) {
    console.warn('โ๏ธ ุชุนุฐุฑ ุชุญููู ุงูููุฒุงููุฉ ูู Firebase:', err);
  }
}

/**
 * Display a modal that allows the user to modify the budget amount.
 */
function editBudget() {
  const modal = document.createElement('div');
  // Assign a unique ID so that saveBudget() can close this specific modal
  modal.id = 'edit-budget-modal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
  modal.innerHTML = `
    <div class="bg-white p-6 rounded-lg max-w-sm w-full">
      <h2 class="text-xl font-bold mb-4">โ๏ธ ุชุนุฏูู ุงูููุฒุงููุฉ</h2>
      <div class="mb-4">
        <!--
          When editing the budget we treat the entered number as an adjustment (increase or
          decrease) rather than a complete replacement.  Therefore we remove the
          minimum restriction to allow negative values and provide a hint to the
          user that this value will be added or subtracted from the budget.  The
          default value is 0 so the user consciously enters the desired adjustment.
        -->
        <!--
          When editing the budget, the user should input the new total budget.  The
          current budget value is prefilled for convenience.  Negative values are
          not allowed because the budget represents available funds.
        -->
        <label class="block text-sm font-medium text-gray-700 mb-2">ุงููุจูุบ ุงูุฌุฏูุฏ (ุฌ.ู)</label>
        <input type="number" id="new-budget-value" class="w-full p-3 border rounded-lg" value="${window.currentBudget || 0}" min="0" step="0.01" placeholder="ุฃุฏุฎู ุงููุจูุบ ุงูุฌุฏูุฏ ููููุฒุงููุฉ">
      </div>
      <div class="flex justify-end gap-3">
        <button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded" onclick="this.closest('#edit-budget-modal').remove()">ุฅูุบุงุก</button>
        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="saveBudget()">ุญูุธ</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
}

/**
 * Save the modified budget to Firebase and update the UI. Removes the modal on completion.
 */
async function saveBudget() {
  // Read the new budget amount from the modal.  If the field is empty or invalid,
  // default to zero.  Negative values are coerced to zero because the budget
  // represents available funds and cannot be negative.
  const rawVal = document.getElementById('new-budget-value') ? document.getElementById('new-budget-value').value : '';
  let newVal = parseFloat(rawVal);
  if (isNaN(newVal) || newVal < 0) newVal = 0;
  try {
    /*
     * When the budget is edited, treat the entered value as the new total
     * starting budget.  To derive the available budget, subtract the sum of
     * recorded purchases and expenses from this base amount.  This ensures
     * that existing transactions continue to reduce the available balance.
     */
    let totalPurchases = 0;
    let totalExpenses = 0;
    try {
      const purchases = Array.isArray(allData) ? allData.filter(item => item.type === 'purchase') : [];
      totalPurchases = purchases.reduce((sum, purchase) => sum + (parseFloat(purchase.total) || 0), 0);
      const expenses = Array.isArray(allData) ? allData.filter(item => item.type === 'expense') : [];
      totalExpenses = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
    } catch (calcErr) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญุณุงุจ ุฅุฌูุงูู ุงููุดุชุฑูุงุช ูุงููุตุฑููุงุช ุฃุซูุงุก ุชุนููู ุงูููุฒุงููุฉ:', calcErr);
    }
    const adjustedBudget = newVal - totalPurchases - totalExpenses;
    // Update the in-memory budget variables
    window.baseBudget = newVal;
    window.currentBudget = adjustedBudget;
    // Persist to Firebase
    try {
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBaseBudget'), newVal);
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูููุฒุงููุฉ ุงูุฃุณุงุณูุฉ ูู Firebase:', err);
    }
    try {
      await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'erpBudget'), adjustedBudget);
    } catch (err) {
      console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูููุฒุงููุฉ ุงููุชุงุญุฉ ูู Firebase:', err);
    }
    // Update UI
    if (typeof updateBudgetUI === 'function') {
      updateBudgetUI();
    }
    // Refresh accounting display
    if (typeof updateAccountingDisplay === 'function') {
      try {
        updateAccountingDisplay();
      } catch (err) {
        console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุนุฑุถ ุงููุญุงุณุจุฉ ุจุนุฏ ุชุบููุฑ ุงูููุฒุงููุฉ:', err);
      }
    } else if (typeof updateAllDisplays === 'function') {
      try {
        updateAllDisplays();
      } catch (err) {}
    }
    showMessage('โ ุชู ุชุญุฏูุซ ุงูููุฒุงููุฉ ุจูุฌุงุญ', 'success');
  } catch (err) {
    console.warn('โ๏ธ ุชุนุฐุฑ ุญูุธ ุงูููุฒุงููุฉ ูู Firebase:', err);
    showMessage('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูููุฒุงููุฉ', 'error');
  }
  // Close modal
  const modal = document.getElementById('edit-budget-modal');
  if (modal) modal.remove();
}

/**
 * Update both the current budget and base budget displays.  This helper reads
 * window.currentBudget and window.baseBudget, formats them with two decimal
 * places, and writes them into the respective elements.  It should be called
 * whenever these values change (e.g. after loading, saving, or modifying
 * purchases/expenses).
 */
function updateBudgetUI() {
  try {
    const budgetEl = document.getElementById('budget-amount');
    if (budgetEl && typeof window.currentBudget !== 'undefined') {
      budgetEl.textContent = parseFloat(window.currentBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
    }
    const baseEl = document.getElementById('base-budget-amount');
    if (baseEl && typeof window.baseBudget !== 'undefined') {
      baseEl.textContent = parseFloat(window.baseBudget).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ุฌ.ู';
    }
  } catch (err) {
    console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ุนุฑุถ ุงูููุฒุงููุฉ:', err);
  }
}

/**
 * Show a password input modal for verifying changes to the admin account.
 * Accepts the username to be modified.  When the correct password (123456) is
 * provided, the modal closes and openEditAccountModal is called again with
 * skipAdminCheck set to true.
 */
function showAdminPasswordModal(username) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
  // Embed the passed username directly into the inline click handler.
  // This fixes a bug where the anonymous function could not access the
  // username variable in its scope, resulting in a ReferenceError.
  modal.innerHTML = `
    <div class="bg-white p-6 rounded-lg max-w-sm w-full">
      <h2 class="text-xl font-bold mb-4">๐ ูููุฉ ูุฑูุฑ ุงููุฏูุฑ</h2>
      <p class="text-sm mb-3 text-gray-600">ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ ูุชุนุฏูู ุญุณุงุจ ูุฏูุฑ ุงููุธุงู</p>
      <input type="password" id="admin-pass-input" class="w-full p-3 border rounded-lg mb-4" placeholder="โขโขโขโขโขโข">
      <div class="flex justify-end gap-3">
        <button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded" onclick="this.closest('.fixed').remove()">ุฅูุบุงุก</button>
      <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="adminPasswordModalContinue('${username}')">ูุชุงุจุนุฉ</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
}

/**
 * Handles the continuation of the admin password modal.  This helper
 * reads the password entered by the user and compares it against
 * window.securitySettings.managerPassword.  If the password matches,
 * the modal is removed and the account editing modal is opened with
 * skipAdminCheck=true.  Otherwise an error message is shown.
 *
 * @param {string} username ุงุณู ุงููุณุชุฎุฏู ุงููุทููุจ ุชุนุฏููู
 */
function adminPasswordModalContinue(username) {
  const passInput = document.getElementById('admin-pass-input');
  if (!passInput) return;
  const pwd = passInput.value;
  if (pwd === window.securitySettings.managerPassword) {
    // Remove the modal
    const modal = passInput.closest('.fixed');
    if (modal) modal.remove();
    openEditAccountModal(username, true);
  } else {
    showMessage('โ ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ', 'error');
  }
}

/**
 * Opens a modal allowing the user to split the invoice total between Visa and Cash.
 * Displays the current invoice items and total, and allows input of Visa and Cash amounts.
 * The default allocation puts the entire invoice total into the cash field.
 * Adjusting one field will automatically update the other so their sum matches the invoice total.
 * When the user confirms, the amounts are stored in global variables, the invoice is marked as fully paid,
 * and saveInvoiceNew() is called to persist the invoice.
 */
function openPaymentModal() {
  // Ensure there are items to save
  if (!currentInvoiceItems || currentInvoiceItems.length === 0) {
    showMessage('โ ูุง ุชูุฌุฏ ุนูุงุตุฑ ูู ุงููุงุชูุฑุฉ ููุญูุธ! ูุฌุจ ุฅุถุงูุฉ ููุชุฌุงุช ุฃููุงู', 'error');
    return;
  }
  // Calculate total for the current invoice
  let invoiceTotal = 0;
  currentInvoiceItems.forEach(item => {
    const originalPrice = parseFloat(item.originalPrice) || parseFloat(item.price) || 0;
    const discount = parseFloat(item.discount) || 0;
    const quantity = parseInt(item.quantity) || 1;
    const finalPrice = originalPrice - discount;
    invoiceTotal += finalPrice * quantity;
  });
  // Populate the invoice items into the modal
  const invoiceContainer = document.getElementById('payment-modal-invoice');
  if (invoiceContainer) {
    const rows = currentInvoiceItems.map((item) => {
      const originalPrice = parseFloat(item.originalPrice) || parseFloat(item.price) || 0;
      const discount = parseFloat(item.discount) || 0;
      const finalPrice = originalPrice - discount;
      const total = finalPrice * (parseInt(item.quantity) || 1);
      return `
        <div class="flex justify-between text-sm border-b py-1">
          <span>${item.name} ร ${item.quantity}</span>
          <span>${total.toFixed(2)} ุฌ.ู</span>
        </div>
      `;
    }).join('');
    invoiceContainer.innerHTML = rows;
  }
  // Set the total amount in the modal
  const totalEl = document.getElementById('payment-modal-total');
  if (totalEl) {
    totalEl.textContent = invoiceTotal.toFixed(2) + ' ุฌ.ู';
  }
  // Initialize inputs
  const visaInput = document.getElementById('visa-payment-input');
  const cashInput = document.getElementById('cash-payment-input');
  if (visaInput) visaInput.value = '0.00';
  if (cashInput) cashInput.value = invoiceTotal.toFixed(2);
  // Set up linked input behavior: when one changes, update the other
  if (visaInput && cashInput) {
    visaInput.oninput = null;
    cashInput.oninput = null;
    visaInput.oninput = function() {
      const visaVal = parseFloat(this.value) || 0;
      const cashVal = invoiceTotal - visaVal;
      cashInput.value = cashVal.toFixed(2);
    };
    cashInput.oninput = function() {
      const cashVal2 = parseFloat(this.value) || 0;
      const visaVal2 = invoiceTotal - cashVal2;
      visaInput.value = visaVal2.toFixed(2);
    };
  }
  // Show the modal
  const modal = document.getElementById('payment-modal');
  if (modal) {
    modal.classList.remove('hidden');
  }
  // Attach cancel behavior
  const cancelBtn = document.getElementById('payment-modal-cancel');
  if (cancelBtn) {
    cancelBtn.onclick = function() {
      const m = document.getElementById('payment-modal');
      if (m) m.classList.add('hidden');
    };
  }
  // Attach confirm behavior
  const confirmBtn = document.getElementById('payment-modal-confirm');
  if (confirmBtn) {
    confirmBtn.onclick = function() {
      let visaVal = parseFloat(visaInput.value) || 0;
      let cashVal = parseFloat(cashInput.value) || 0;
      // Adjust for rounding errors
      const sum = visaVal + cashVal;
      if (Math.abs(sum - invoiceTotal) > 0.01) {
        cashVal = invoiceTotal - visaVal;
      }
      // Store globally so saveInvoiceNew can attach to record
      window.currentPaymentVisa = visaVal;
      window.currentPaymentCash = cashVal;
      // Mark invoice as fully paid in the paid-amount input
      const paidField = document.getElementById('paid-amount');
      if (paidField) {
        paidField.value = invoiceTotal.toFixed(2);
        calculateRemaining();
      }
      // Hide the modal
      const m2 = document.getElementById('payment-modal');
      if (m2) m2.classList.add('hidden');
      // Proceed to save the invoice
      saveInvoiceNew();
    };
  }
}
// Load the budget when the page finishes loading.  This ensures the budget
// card displays the correct value after login or refresh.  If Firebase fails
// to load, the default value remains displayed.
document.addEventListener('DOMContentLoaded', function() {
  if (typeof loadBudget === 'function') {
    loadBudget();
  }
});
</script>
<!-- Payment Modal for splitting invoice total between Visa and Cash -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" id="payment-modal">
<div class="bg-white rounded-lg p-4 w-full max-w-md">
<h2 class="text-xl font-bold mb-2">๐ณ ุชูุงุตูู ุฏูุน ุงููุงุชูุฑุฉ</h2>
<div class="overflow-y-auto max-h-64 border rounded p-2 mb-3 bg-gray-50" id="payment-modal-invoice">
<!-- ุณูุชู ุนุฑุถ ุนูุงุตุฑ ุงููุงุชูุฑุฉ ููุง -->
</div>
<div class="mb-3">
<label class="block text-sm font-medium text-gray-700 mb-1">ุฅุฌูุงูู ุงููุงุชูุฑุฉ</label>
<div class="font-bold text-green-600" id="payment-modal-total"></div>
</div>
<div class="mb-3">
<label class="block text-sm font-medium text-gray-700 mb-1">ุงูููุฒุง (ุฌ.ู)</label>
<input class="w-full p-2 border rounded mb-2" id="visa-payment-input" step="0.01" type="number"/>
<label class="block text-sm font-medium text-gray-700 mb-1">ุงููุงุด (ุฌ.ู)</label>
<input class="w-full p-2 border rounded" id="cash-payment-input" step="0.01" type="number"/>
</div>
<div class="flex justify-end gap-2 mt-4">
<button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded" id="payment-modal-cancel">ุฅูุบุงุก</button>
<button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" id="payment-modal-confirm">ุชุฃููุฏ ูุญูุธ</button>
</div>
</div>
</div>
<div id="expenses-list-stubs" style="display:none;"><select id="filter-expense-type"><option value=""></option></select><select id="filter-created-by"><option value=""></option></select><select id="expenses-per-page" value="all"><option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="all">all</option></select><input id="filter-date-from"/><input id="filter-date-to"/><div id="total-expenses-count">0</div><div id="filtered-expenses-count">0</div><div id="filtered-total-amount">0.00</div><div id="filtered-avg-amount">0.00</div><div id="filtered-highest-amount">0.00</div><div id="filtered-lowest-amount">0.00</div><button id="prev-page-btn"></button><button id="next-page-btn"></button><span id="page-info"></span><table><tbody id="expenses-list-table"></tbody></table></div>
<script>
  // Move the Add Expense form below the accounting views
  document.addEventListener('DOMContentLoaded', function() {
    const accountingContent = document.getElementById('accounting-content');
    const expenseFormElement = document.getElementById('expense-form');
    if (accountingContent && expenseFormElement) {
      // Find the nearest red container that wraps the expense form
      let expenseContainer = expenseFormElement.closest('div.bg-red-50');
      // Fallback: if not found, use the parent of the form
      if (!expenseContainer) {
        expenseContainer = expenseFormElement.parentElement;
      }
      if (expenseContainer && accountingContent.parentNode) {
        // Insert the expense container right after the accounting-content element
        accountingContent.parentNode.insertBefore(expenseContainer, accountingContent.nextSibling);
      }
    }
  });
</script>
<script>
  // Returns section product search functionality
  document.addEventListener('DOMContentLoaded', function() {
    const returnSearchInput = document.getElementById('return-product-search');
    if (returnSearchInput) {
      returnSearchInput.addEventListener('input', function(e) {
        const term = e.target.value.trim();
        if (term) {
          try {
            const inventory = calculateInventory();
            const exactProduct = Object.values(inventory).find(prod =>
              (prod.code && prod.code.toLowerCase() === term.toLowerCase()) ||
              (prod.name && prod.name.toLowerCase() === term.toLowerCase())
            );
            if (exactProduct) {
              selectReturnProduct(exactProduct.code, exactProduct.name);
              return;
            }
          } catch (err) {
            console.warn('โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ ุนู ุงูููุชุฌ ูููุฑุชุฌุน:', err);
          }
        }
        searchProductsForReturn(term);
      });
      returnSearchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          hideReturnSearchResults();
        }
      });
    }
    // Hide return search results when clicking outside
    document.addEventListener('click', function(e) {
      const searchContainer = returnSearchInput && returnSearchInput.parentElement;
      if (searchContainer && !searchContainer.contains(e.target)) {
        hideReturnSearchResults();
      }
    });
  });

  // Search products for returns - includes all products regardless of stock
  function searchProductsForReturn(searchTerm) {
    if (!searchTerm || searchTerm.length < 1) {
      hideReturnSearchResults();
      return;
    }
    const inventory = calculateInventory();
    // Filter by code or name matching search term
    const filtered = Object.values(inventory).filter(product =>
      product.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
      product.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
    showReturnSearchResults(filtered);
  }

  function showReturnSearchResults(products) {
    const resultsDiv = document.getElementById('return-search-results');
    if (!resultsDiv) return;
    if (products.length === 0) {
      resultsDiv.innerHTML = '<div class="search-item text-gray-500 text-center">ูุง ุชูุฌุฏ ููุชุฌุงุช ูุทุงุจูุฉ ููุจุญุซ</div>';
      resultsDiv.classList.remove('hidden');
      return;
    }
    resultsDiv.innerHTML = products.map(product => {
      // Determine color for stock availability (similar to sales search)
      let stockClass = '';
      if (product.availableStock <= 0) {
        stockClass = 'text-red-600 font-bold';
      } else if (product.availableStock < 10) {
        stockClass = 'text-yellow-600';
      } else {
        stockClass = 'text-blue-600';
      }
      return `
        <div class="search-item cursor-pointer" onclick="selectReturnProduct('${product.code}', '${product.name}')">
          <div class="flex justify-between items-center">
            <div>
              <div class="font-medium text-gray-800">${product.name}</div>
              <div class="text-sm text-gray-600">ููุฏ: ${product.code}</div>
            </div>
            <div class="text-left">
              <div class="font-medium text-green-600">${product.salePrice.toFixed(2)} ุฌ.ู</div>
              <div class="text-sm ${stockClass}">
                ูุชููุฑ: ${product.availableStock}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    resultsDiv.classList.remove('hidden');
  }

  function hideReturnSearchResults() {
    const div = document.getElementById('return-search-results');
    if (div) div.classList.add('hidden');
  }

// ===================== ุฅุนุฏุงุฏุงุช ุงูุฃูุงู =====================
/**
 * Update the discount password after validating the current password.
 * The user must enter the correct current password, and supply a
 * non-empty new password.  On success, the settings are saved to
 * Firebase and the input fields are cleared.
 */
async function updateDiscountPassword() {
  const currentInput = document.getElementById('current-discount-password');
  const newInput = document.getElementById('new-discount-password');
  if (!currentInput || !newInput) return;
  const currentVal = currentInput.value;
  const newVal = newInput.value;
  if (currentVal !== window.securitySettings.discountPassword) {
    showMessage('โ ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ ุบูุฑ ุตุญูุญุฉ', 'error');
    return;
  }
  if (!newVal) {
    showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ', 'error');
    return;
  }
  window.securitySettings.discountPassword = newVal;
  try {
    await saveSecuritySettings();
    // Reload the security settings after saving to ensure the in-memory
    // configuration matches what was persisted to Firebase.  This
    // prevents mismatches between the new password and what
    // applyDiscount/applyItemDiscount checks against during the
    // lifetime of the session.
    if (typeof loadSecuritySettings === 'function') {
      await loadSecuritySettings();
    }
    currentInput.value = '';
    newInput.value = '';
    showMessage('โ ุชู ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงูุฎุตู ุจูุฌุงุญ', 'success');
  } catch (err) {
    console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงูุฎุตู:', err);
    showMessage('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงูุฎุตู', 'error');
  }
}

/**
 * Update the manager password after validating the current password.
 * Similar to updateDiscountPassword, but updates the managerPassword.
 */
async function updateManagerPassword() {
  const currentInput = document.getElementById('current-manager-password');
  const newInput = document.getElementById('new-manager-password');
  if (!currentInput || !newInput) return;
  const currentVal = currentInput.value;
  const newVal = newInput.value;
  if (currentVal !== window.securitySettings.managerPassword) {
    showMessage('โ ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ ุบูุฑ ุตุญูุญุฉ', 'error');
    return;
  }
  if (!newVal) {
    showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ', 'error');
    return;
  }
  window.securitySettings.managerPassword = newVal;
  try {
    await saveSecuritySettings();
    // Reload settings after saving to ensure in-memory passwords are up to date
    if (typeof loadSecuritySettings === 'function') {
      await loadSecuritySettings();
    }
    currentInput.value = '';
    newInput.value = '';
    showMessage('โ ุชู ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงููุฏูุฑ ุจูุฌุงุญ', 'success');
  } catch (err) {
    console.warn('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงููุฏูุฑ:', err);
    showMessage('โ๏ธ ุชุนุฐุฑ ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงููุฏูุฑ', 'error');
  }
}

  function selectReturnProduct(code, name) {
    const searchInput = document.getElementById('return-product-search');
    const codeInput = document.getElementById('return-product-code');
    const nameInput = document.getElementById('return-product-name');
    if (searchInput) searchInput.value = `${code} - ${name}`;
    if (codeInput) codeInput.value = code;
    if (nameInput) nameInput.value = name;
    hideReturnSearchResults();
    // Focus on quantity after selecting a product
    const qtyInput = document.getElementById('return-quantity');
    if (qtyInput) {
      if (!qtyInput.value) qtyInput.value = '1';
      qtyInput.focus();
    }
  }
</script>
</body>
</html>